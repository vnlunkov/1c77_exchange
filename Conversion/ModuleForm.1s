////////////////////////////////////////////////////////////////////////////////
// ВСПОМОГАТЕЛЬНЫЕ ПЕРЕМЕННЫЕ МОДУЛЯ
////////////////////////////////////////////////////////////////////////////////

Перем мТаблицаЗамеров;

Перем мКаталогОбмена;
Перем мНастройкиОбмена;

Перем мНеВыгружатьОбъектыПоСсылкам;

Перем мИмяФайлаРегистрСоответствия;
// Перем мИмяФайлаИндексаРегистрСоответствия;

Перем мПараметрыВыгрузки;

Перем мЧтениеXML;
Перем Параметры;
Перем мАлгоритмы;
Перем мЗапросы;
Перем мТаблицаПравилВыгрузки, мТаблицаПравилКонвертацииОбъектов, мТаблицаПравилОчистки;
Перем мИд, мНаименование, мДатаВремяСоздания, мКонфигурацияИсточник, мКонфигурацияПриемник, мВерсияФормата;
Перем ВерсияПлатформыПриемника;

Перем мРежимОбмена;
Перем мКонвертация; // Структура свойств конвертации (Имя, Ид, обработчики событий обмена).
Перем мXMLПравила;

Перем мСписокВыгружаемыхОбъектов;

Перем мКонвертацияПередПолучениемИзмененныхОбъектов;

// Перем мКонвертацияПередВыгрузкойДанных;
Перем мКонвертацияПередВыгрузкойОбъекта;
Перем мКонвертацияПередОтправкойИнформацииОбУдалении;
Перем мКонвертацияПередКонвертациейОбъекта;
Перем мКонвертацияПослеВыгрузкиОбъекта;
Перем мКонвертацияПослеВыгрузкиДанных;
Перем мКонвертацияПослеЗагрузкиПравилОбмена;

Перем мКонвертацияПослеПолученияИнформацииОбУзлахОбмена;
Перем мКонвертацияПередЗагрузкойДанных;
Перем мКонвертацияПередЗагрузкойОбъекта;
Перем мКонвертацияПослеЗагрузкиОбъекта;
Перем мКонвертацияПослеЗагрузкиДанных;

Перем мПустоеЗначение;
Перем мСчетчикВыгруженныхОбъектов;
Перем мXMLАнализатор;
//Перем DOMDocument, rootNode;
Перем мНачалоНовогоЭлемента, мИнструкцияОбработки, мКонецУровня, мКонецДокумента;

Перем мТаблицаНастройкиПараметров;
// Перем ТаблицаНастройкиОтбора;
// Перем ПравилаВыгрузкиСписок;
Перем ТаблицаПараметровДляЗагрузки;

Перем ТипОбъектаДляНастройкиОтбора;
Перем СписокОшибок;

//ЗАГРУЗКА
Перем мЗапоминатьЗагруженныеОбъекты;
Перем мТабЗагруженныхОбъектов;
Перем мСписокВспомогательныхОбъектов;

Перем мКомментироватьВыгрузкуОбъектов;
Перем мВыводСообщений;
Перем ВыводВПротоколИнформационныхСообщений; //???
Перем ТекущийУровеньВложенностиВыгрузитьПоПравилу; //???
Перем мСтруктураОшибки;
Перем ПолеФлагОшибки;
Перем ПолеСтрокаСообщенияОбОшибке;
Перем мСообщенияОбОшибках;
Перем ФайлПротоколаДанных; // Файл для ведения протокола обмена данными.
Перем ИмяФайлаПротоколаОбмена;

Перем ЗначенияДляОтбора[100]; // массив для хранения значений, используется для настройки отбора данных

////////////////////////////////////////////////////////////////////////////////
// ПРЕДВАРИТЕЛЬНОЕ ОПИСАНИЕ ПРОЦЕДУР И ФУНКЦИЙ
////////////////////////////////////////////////////////////////////////////////
Функция НачатьЗамер(ВхФункция, ВхКомментарий = "") Далее
Функция ЗавершитьЗамер(ВхЗамер) Далее

Функция ПолучитьCOMОбъект(ВхИмяКласса) Далее

Функция ПолучитьУникальныйИдентификатор(пСсылка) Далее
Функция ПолучитьСсылкуПоИдентификатору(пИдентификатор) Далее

Функция УстановитьСправочникПоСсылкеV8(Ссылка, Вид, СозданНовыйОбъект=0, НовыеНеСоздавать=0, ОбъектМД="", ЭтоГруппа, Объект="", Знач РежимПоискаОсновногоОбъекта)	Далее
Функция УстановитьДокументПоСсылкеV8(Ссылка, Вид="", СозданНовыйОбъект=0, НовыеНеСоздавать=0, ОбъектМД="", Объект="", Знач РежимПоискаОсновногоОбъекта) Далее
Функция УстановитьРеквизитV8(Реквизит, ТипОбъекта, ВидОбъекта, РеквизитОбъекта) Далее

Функция ВыгрузитьПоПравилу(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, ИмяПКО = "", УзелСсылки = "", Знач ТолькоПолучитьУзелСсылки = 0, НомерПКО = 0, ВыгружатьСсылкиУПодчиненныхОбъектов = 1) Далее
Процедура ВыгрузитьСвойства(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, КоллекцияПКС, УзелКоллекцииСвойств = 0, ОбъектКоллекции = 0, ПравилоРодитель = "", ИмяПредопределенногоЭлемента = "", Знач ВыгрузитьТолькоСсылку = 0) Далее
Функция НайтиПравило(Объект, ИмяПравила = "") Далее
Функция ПривестиНомерКДлине(Знач Стр, Длина) Далее
Функция ДобавитьКПрефиксу(Знач Стр, Добавок = "", Длина = "", Режим = "Слева") Далее
Функция ПолучитьЗначение(Объект, Имя, ВхДата = 0) Далее
Функция ПолучитьДатуV8(ЧастьДата, ЧастьВремя = "00:00:00") Далее    
Функция СоздатьЗапрос(ОбъектВыборки, ТабОтбор) Далее       
// Процедура СохранитьНастройкиОтбора() Далее
Процедура ЗафиксироватьОшибку(ТекстОшибки) Далее
// Процедура УстановитьЗначениеПараметраКонвертации(ИмяПараметра, ЗначениеПараметра) Далее

Функция СоздатьУзел(document, name) Далее
Процедура УстановитьАтрибут(element, name, value) Далее
Функция ЗаписатьЭлемент(document, node, name, value = "") Далее
Процедура ДобавитьПодчиненный(parentNode, childNode) Далее

Процедура ИнициализацияСообщений() Далее

////////////////////////////////////////////////////////////////////////////////
// НАЧАЛО ОБРАБОТЧИКОВ
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// ОКОНЧАНИЕ ОБРАБОТЧИКОВ
////////////////////////////////////////////////////////////////////////////////

//*****************************************************************************
Функция СоздатьРегистрСоответствий()

	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмТекстЗапроса = "
		|create table objects_confirm
		|(	id_src   text not null,
		|	id_dst   text not null,
		|	type_src text not null,
		|	type_dst text not null,
		|	pkg_num integer,
		|	constraint objects_confirm_pk
		|		primary key (id_src, id_dst));
		|";

	ВрмSQLite = ПолучитьCOMОбъект("SQLiteBase");
	ВрмSQLite.Открыть(мИмяФайлаРегистрСоответствия);

	ВрмЗапрос = ВрмSQLite.НовыйЗапрос();
	
	Попытка
		ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;

	ВрмТекстЗапроса = "
		|create table dwnlds
		|(	pkg_num integer not null,
		|	direct   text not null,
		|	acknowl text default '',
		|	constraint dwnlds_pk
		|		primary key (pkg_num));
		|";

	Попытка
		ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;

	ВрмЗапрос = ПолучитьПустоеЗначение();

	ВрмSQLite.Закрыть();
	ВрмSQLite = ПолучитьПустоеЗначение();

	Возврат ВрмВозврат;

КонецФункции

Функция ЗаписатьРегистрСоответствий(ВхИдентификаторИсточник, ВхИдентификаторПриемник, ВхТипИсточник, ВхТипПриемник, ВхНеРегистрировать = 0)

	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмТекстЗапроса = "
		|insert or ignore into
		|	objects_confirm (id_src, id_dst, type_src, type_dst" + ?(ПустоеЗначение(ВхНеРегистрировать) = 0, ", pkg_num", "") + ")
		|values ('" + ВхИдентификаторИсточник + "', '" + ВхИдентификаторПриемник + "', '" + ВхТипИсточник + "', '" + ВхТипПриемник + "'" + ?(ПустоеЗначение(ВхНеРегистрировать) = 0, ", 0", "") + ");
		|";

	ВрмSQLite = ПолучитьCOMОбъект("SQLiteBase");
	ВрмSQLite.Открыть(мИмяФайлаРегистрСоответствия);

	ВрмЗапрос = ВрмSQLite.НовыйЗапрос();
	
	Попытка
		ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;
	
	ВрмЗапрос = ПолучитьПустоеЗначение();

	ВрмSQLite.Закрыть();
	ВрмSQLite = ПолучитьПустоеЗначение();

	Возврат ВрмВозврат;

КонецФункции

Функция РС_ЗакончитьЧтениеСообщения(ВхПакетНомер, ВрмНомерПринятогоКорреспондентом)

	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмТекстЗапроса = "
		|update
		|	dwnlds
		|set acknowl = 'A'
		|where direct = 'O' and pkg_num <= " + ВрмНомерПринятогоКорреспондентом + ";
		|";

	ВрмSQLite = ПолучитьCOMОбъект("SQLiteBase");
	ВрмSQLite.Открыть(мИмяФайлаРегистрСоответствия);

	ВрмЗапрос = ВрмSQLite.НовыйЗапрос();
	
	Попытка
		ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;
	
	ВрмЗапрос = ПолучитьПустоеЗначение();

	ВрмSQLite.Закрыть();
	ВрмSQLite = ПолучитьПустоеЗначение();

	Возврат ВрмВозврат;

КонецФункции

Функция РС_ОбновитьНомерОтправленного(ВхПакетНомер)

	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмТекстЗапроса = "
		|update
		|	objects_confirm
		|set pkg_num = " + ВхПакетНомер + "
		|where pkg_num isnull;
		|";

	ВрмSQLite = ПолучитьCOMОбъект("SQLiteBase");
	ВрмSQLite.Открыть(мИмяФайлаРегистрСоответствия);

	ВрмЗапрос = ВрмSQLite.НовыйЗапрос();
	
	Попытка
		ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;

	ВрмТекстЗапроса = "
		|insert into dwnlds (pkg_num, direct) values (" + ВхПакетНомер + ", 'O');
		|";

	Попытка
		ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;
	
	ВрмЗапрос = ПолучитьПустоеЗначение();

	ВрмSQLite.Закрыть();
	ВрмSQLite = ПолучитьПустоеЗначение();

	Возврат ВрмВозврат;

КонецФункции

Функция РС_ВыбратьИзменения(ВхПакетНомер = 0)

	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмРезультатЗапроса = ПолучитьПустоеЗначение();

	ВрмТекстЗапроса = "
		|select
		|	id_src, type_src, id_dst, type_dst
		|from objects_confirm
		|where pkg_num isnull or pkg_num > ifnull((select max(pkg_num) from dwnlds where direct = 'O' and acknowl = 'A'), 0);
		|";

	ВрмSQLite = ПолучитьCOMОбъект("SQLiteBase");
	ВрмSQLite.Открыть(мИмяФайлаРегистрСоответствия);

	ВрмЗапрос = ВрмSQLite.НовыйЗапрос();
	
	Попытка
		ВрмРезультатЗапроса = ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;
	
	ВрмЗапрос = ПолучитьПустоеЗначение();

	ВрмSQLite.Закрыть();
	ВрмSQLite = ПолучитьПустоеЗначение();

	ВрмВозврат.Установить("Результат", ВрмРезультатЗапроса);

	Возврат ВрмВозврат;

КонецФункции

// Функция ПолучитьСсылкуПоИдентификаторуКорреспондента(ВхИдентификаторПриемник)
Процедура ВыполнитьЗаменуУникальногоИдентификатораПриНеобходимости(
	УникальныйИдентификатор,
	Знач ТипИсточникаСтрокой,
	Знач ТипПриемникаСтрокой,
	Знач РежимПоискаОсновногоОбъекта,
	НайденоСоответствиеОбъекта = 0)

	// ВрмВозврат = СоздатьОбъект("СписокЗначений");
	// ВрмРезультатЗапроса = ПолучитьПустоеЗначение();

	Если РежимПоискаОсновногоОбъекта = 1 Тогда
		Возврат;
	КонецЕсли;

	ВрмТекстЗапроса = "
		|select
		|	id_src as id
		|from objects_confirm
		|where id_dst = '" + УникальныйИдентификатор + "';
		|";

	ВрмSQLite = ПолучитьCOMОбъект("SQLiteBase");
	ВрмSQLite.Открыть(мИмяФайлаРегистрСоответствия);

	ВрмЗапрос = ВрмSQLite.НовыйЗапрос();
	
	Попытка
		ВрмРезультатЗапроса = ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		// ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		// ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;
	
	ВрмЗапрос = ПолучитьПустоеЗначение();

	ВрмSQLite.Закрыть();
	ВрмSQLite = ПолучитьПустоеЗначение();

	Если ПустоеЗначение(ВрмРезультатЗапроса) = 1 Тогда

	Иначе
		
		УникальныйИдентификатор = ВрмРезультатЗапроса.ПолучитьЗначение(ВрмРезультатЗапроса.КоличествоСтрок(), "id");

		// ВрмРезультатЗапроса.ВыбратьСтроки();
		// Пока ВрмРезультатЗапроса.ПолучитьСтроку() = 1 Цикл

		// 	УникальныйИдентификатор = ВрмРезультатЗапроса.id;

		// КонецЦикла;
		НайденоСоответствиеОбъекта = 1;

	КонецЕсли;

	// ВрмСсылка = ПолучитьСсылкуПоИдентификатору(ВрмРезультатЗапроса.ПолучитьЗначение(ВрмРезультатЗапроса.КоличествоСтрок(), "id"));
	// ВрмВозврат.Установить("Результат", ВрмСсылка);

	// Возврат ВрмВозврат;

// КонецФункции
КонецПроцедуры

Функция ПолучитьИдентификаторКорреспондентаПоСсылке(ВхСсылка)

	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмРезультатЗапроса = ПолучитьПустоеЗначение();
	
	ВрмИдентификаторИсточник = ПолучитьУникальныйИдентификатор(ВхСсылка);

	ВрмТекстЗапроса = "
		|select
		|	id_dst as id, type_dst as type
		|from objects_confirm
		|where id_src = '" + ВрмИдентификаторИсточник + "';
		|";

	ВрмSQLite = ПолучитьCOMОбъект("SQLiteBase");
	ВрмSQLite.Открыть(мИмяФайлаРегистрСоответствия);

	ВрмЗапрос = ВрмSQLite.НовыйЗапрос();
	
	Попытка
		ВрмРезультатЗапроса = ВрмЗапрос.ВыполнитьЗапрос(ВрмТекстЗапроса);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;
	
	ВрмЗапрос = ПолучитьПустоеЗначение();

	ВрмSQLite.Закрыть();
	ВрмSQLite = ПолучитьПустоеЗначение();

	Если ПустоеЗначение(ВрмРезультатЗапроса) = 0 Тогда
		ВрмВозврат.Установить("Результат", ВрмРезультатЗапроса.ПолучитьЗначение(ВрмРезультатЗапроса.КоличествоСтрок(), "id"));
	КонецЕсли;

	Возврат ВрмВозврат;

КонецФункции

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ЗАПИСИ XML
////////////////////////////////////////////////////////////////////////////////

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция СоздатьУзел(document, name)
	
	newNode = document.СоздатьУзел("element", name, "");
	
	Возврат newNode;

КонецФункции // СоздатьУзел()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура УстановитьАтрибут(element, name, value)
	//Сообщить("[" + name + "][" + Строка(value) + "]");
	element.УстановитьАтрибут(name, Строка(value));
	
КонецПроцедуры // УстановитьАтрибут()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ЗаписатьЭлемент(document, node, name, value = "")
	
	 childNode = document.СоздатьУзел("element", name, "");
	 Попытка
           childNode.Значение = Строка(value);
     Исключение
           Сообщить("Не удалось записать элемент: "+name+", со значением: "+value);
           childNode.Значение = "";
     КонецПопытки;
	 node.ДобавитьПодчиненный(childNode);
	 
	 Возврат childNode;
    
КонецФункции // одЗаписатьЭлемент()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ЗаписатьПодчиненныйЭлемент(node, name, value = "")
	
	Попытка
		childNode = node.СоздатьПодчиненныйЭлемент(name);
		Если ПустоеЗначение(value) = 0 Тогда
			childNode.Значение = Строка(value);
		КонецЕсли;
	Исключение
		  Сообщить("Не удалось записать элемент: "+name+", со значением: "+value);
		  childNode.Значение = "";
	КонецПопытки;
	
	Возврат childNode;
   
КонецФункции

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ДобавитьПодчиненный(parentNode, childNode)
	
	parentNode.ДобавитьПодчиненный(childNode);

КонецПроцедуры // ДобавитьПодчиненный()

Процедура КлонироватьПодчиненным(parentNode, childNode)
	
	ВрмКопируемыйУзел = parentNode.СоздатьПодчиненныйЭлемент(childNode.Наименование);
	
	Для ВрмИндекс = 1 По childNode.КоличествоАтрибутов() Цикл
		ВрмУзел = childNode.ПолучитьУзелАтрибута(ВрмИндекс);
		ВрмКопируемыйУзел.УстановитьАтрибут(ВрмУзел.Наименование, ВрмУзел.Значение);
	КонецЦикла;

	Для ВрмИндекс = 1 По childNode.КоличествоПодчиненных() Цикл
		ВрмУзел = childNode.ПолучитьПодчиненныйПоНомеру(ВрмИндекс);
		Если ВрмУзел.Тип = 1 Тогда
			КлонироватьПодчиненным(ВрмКопируемыйУзел, ВрмУзел);
		Иначе
			ВрмКопируемыйУзел.Значение = ВрмУзел.Значение;
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры // ДобавитьПодчиненный()

Функция ОтделитьРазделителем(Стр, Разделитель, Режим=0)

	ПраваяЧасть			=	"";
	ПозРазделителя		=	Найти(Стр, Разделитель);
	ДлинаРазделителя	=	СтрДлина(Разделитель);
	Если ПозРазделителя > 0 Тогда
		ПраваяЧасть	=	Сред(Стр,		ПозРазделителя + ?(Режим=2, 0, ДлинаРазделителя));
		Стр			=	СокрЛП(Лев(Стр,	ПозРазделителя - ?(Режим=1, -ДлинаРазделителя+1, 1)));
	КонецЕсли;

	Возврат(ПраваяЧасть);
	
КонецФункции		//	ОтделитьРазделителем()

Функция ДатаИзXML(Стр, СтрВремя="")

	СтрГод   = Стр;
    СтрВремя = ОтделитьРазделителем(СтрГод, "T");
	СтрМесяц = ОтделитьРазделителем(СтрГод, "-");
	СтрДень  = ОтделитьРазделителем(СтрМесяц, "-");

	Возврат Дата(СтрДень + "." + СтрМесяц + "." + СтрГод);
	
КонецФункции

Функция XMLЗначение(Тип, СтрЗначение)

	Если Тип = "Строка" Тогда
		Возврат СтрЗначение;
	ИначеЕсли Тип = "Число" Тогда
		Возврат Число(СтрЗначение);
	ИначеЕсли Тип = "Булево" Тогда
		Если СтрЗначение = "true" Тогда
			Возврат 1;
		Иначе
			Возврат 0;
		КонецЕсли;
	ИначеЕсли Тип = "Дата" Тогда
		Возврат ДатаИзXML(СтрЗначение);
	КонецЕсли; 

КонецФункции
// Читает значение атрибута по имени из указанного объекта, приводит значение
// к указанному примитивному типу.
//
// Параметры:
//  Объект      - объект типа XMLЧтение, спозиционированный на начале элемента,
//                атрибут которого требуется получить.
//  Тип         - Значение типа Тип. Тип атрибута.
//  Имя         - Строка. Имя атрибута.
//
// Возвращаемое значение:
//  Значение атрибута полученное по имени и приведенное к указанному типу.
// 
Функция одАтрибут(Объект, Тип, Имя)

	СтрЗначение = СокрП(Объект.ПолучитьАтрибут(Имя));
	Если ПустаяСтрока(СтрЗначение) = 0 Тогда
		Возврат XMLЗначение(Тип, СтрЗначение);
	ИначеЕсли Тип = "Строка" Тогда
		Возврат ""; 
	ИначеЕсли Тип = "Булево" Тогда
		Возврат 0;
	ИначеЕсли Тип = "Число" Тогда
		Возврат 0;
	ИначеЕсли Тип = "Дата" Тогда
		Возврат Дата(0,0,0);
	КонецЕсли; 
	
КонецФункции

// Читает текст элемента и приводит значение к указанному типу.
//
// Параметры:
//  Объект           - объект типа XMLЧтение, из которого осуществляется чтение.
//  Тип              - тип получаемого значения.
//  ИскатьПоСвойству - для ссылочных типов может быть указано свойство, по которому
//                     следует искать объект: "Код", "Наименование", <ИмяРеквизита>, "Имя" (предопределенного значения).
//
// Возвращаемое значение:
//  Значение xml-элемента, приведенное к соответствующему типу.
//
Функция одЗначениеЭлемента(Объект, Тип, ИскатьПоСвойству = "", ОбрезатьСтрокуСправа = 1)

	Значение = Объект.Значение;

	Если ОбрезатьСтрокуСправа = 1 Тогда
				
		Значение = СокрП(Значение);
		
	КонецЕсли;
	
	// Если (Тип = ТипСтрока)
	// 	ИЛИ (Тип = ТипБулево)
	// 	ИЛИ (Тип = ТипЧисло)
	// 	ИЛИ (Тип = ТипДата)
	// 	ИЛИ (Тип = ТипХранилищеЗначения)
	// 	ИЛИ (Тип = ТипУникальныйИдентификатор)
	// 	ИЛИ (Тип = ТипВидДвиженияНакопления)
	// 	ИЛИ (Тип = ТипВидСчета) Тогда
		
		Возврат XMLЗначение(Тип, Значение);
		
	// Иначе
		
	// 	Возврат одПолучитьЗначениеПоСтроке(Значение, Тип, ИскатьПоСвойству);
		
	// КонецЕсли;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ
////////////////////////////////////////////////////////////////////////////////

Функция ЗапросSOAP(ВхURLВебСервиса, ВхИмяСервиса, ВхТелоЗапроса)

	lResolve = 2 * 1000;
	lConnect = 10 * 1000;
	lSend = 300 * 1000;
	lReceive = 300 * 1000;

	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмВозврат.Установить("СтатусВозврата", 0);
	
	ВрмURI = ВхURLВебСервиса + "/ws/" + ВхИмяСервиса;

	// xmlHTTP = CreateObject("MSXML2.XMLHTTP");
	xmlHTTP = CreateObject("msxml2.serverxmlhttp.6.0");
	

	xmlHTTP.setTimeouts(lResolve, lConnect, lSend, lReceive);
	xmlHTTP.open("POST", ВрмURI, 0);
	xmlHTTP.setRequestHeader("Content-Type", "text/xml; charset=utf-8");
	xmlHTTP.setRequestHeader("Authorization", "Basic YWRtaW46MQ==");
	//xmlHTTP.setRequestHeader("SOAPAction", "FileName");
	Попытка
		xmlHTTP.send(ВхТелоЗапроса);
		// xmlHTTP.WaitForResponse(lResolve);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
		Возврат ВрмВозврат;
	КонецПопытки;
	
	//message(xmlHTTP.responseText);
	
	Если xmlHTTP.Status=200 Тогда
		
		ВрмВозврат.Установить("СтатусВозврата", 1);
		ВрмВозврат.Установить("Результат", xmlHTTP.responseText);
		
	Иначе
		
		ВрмТекстОшибки = "";
		
		Попытка
			fault=xmlHTTP.responseXML.selectSingleNode("//faultstring");
			ВрмТекстОшибки = fault.text;
			//ТекстОшибки = xmlHTTP.responseText;
			fault = ПолучитьПустоеЗначение();
		Исключение
			ВрмТекстОшибки = ОписаниеОшибки();
		КонецПопытки;

		ВрмВозврат.Установить("ОписаниеОшибки", ВрмТекстОшибки);
		
	КонецЕсли;	
	
	xmlHTTP = ПолучитьПустоеЗначение();
	
	Возврат ВрмВозврат;
	
КонецФункции

Функция ПолучитьТекстЗапрооса(ВхИмяМетода, ВхПространствоИмен, ВхПараметры = "")

	ВрмВозврат = 0;

	ВрмПространствоИменПротокола = "http://schemas.xmlsoap.org/soap/envelope/";

	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	
	DOMDocument = ВрмПарсерХМЛ.СоздатьДокумент();
	DOMDocument.Кодировка = "UTF-8";
	//DOMDocument = ПолучитьCOMОбъект("AddIn.XMLParser");;
	
	ВрмУзелКонверт = DOMDocument.СоздатьПодчиненныйЭлемент("soap:Envelope", , ВрмПространствоИменПротокола);
	// rootNode.УстановитьПространствоИмен("http://schemas.xmlsoap.org/soap/envelope/", "soap");

	ВрмУзелТело = ВрмУзелКонверт.СоздатьПодчиненныйЭлемент("soap:Body", , ВрмПространствоИменПротокола);

	ВрмУзелМетод = ВрмУзелТело.СоздатьПодчиненныйЭлемент("m:" + ВхИмяМетода, , ВхПространствоИмен);

	Если ТипЗначенияСтр(ВхПараметры) = "СписокЗначений" Тогда
		
		Для ВрмИндексПараметр = 1 По ВхПараметры.РазмерСписка() Цикл
			
			ВрмПараметрИмя = "";
			ВрмПараметрЗначение = ВхПараметры.ПолучитьЗначение(ВрмИндексПараметр, ВрмПараметрИмя);
			ВрмУзелПараметр = ВрмУзелМетод.СоздатьПодчиненныйЭлемент("m:" + ВрмПараметрИмя, , ВхПространствоИмен);
			ВрмУзелПараметр.Значение = ВрмПараметрЗначение;
			ВрмУзелПараметр.УстановитьПространствоИмен("http://www.w3.org/2001/XMLSchema", "xs");
			ВрмУзелПараметр.УстановитьПространствоИмен("http://www.w3.org/2001/XMLSchema-instance", "xsi");

			ВрмУзелПараметр = ПолучитьПустоеЗначение();

		КонецЦикла;

	КонецЕсли;
	ВрмУзелМетод = ПолучитьПустоеЗначение();
	ВрмУзелТело = ПолучитьПустоеЗначение();

	ВрмВозврат = ВрмУзелКонверт.ПредставлениеXML;
	
	ВрмУзелКонверт = ПолучитьПустоеЗначение();
	
	DOMDocument = ПолучитьПустоеЗначение();
	ВрмПарсерХМЛ = ПолучитьПустоеЗначение();
	
	Возврат ВрмВозврат;

КонецФункции

Функция ОбработатьОтветSOAP(ВхОтветSOAP, ВхИмяТипа, ВхОтладка = 0)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмВозврат.Установить("СтатусВозврата", 0);

	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	
	ВрмДокументXML = ВрмПарсерХМЛ.СоздатьДокумент();
	ВрмДокументXML.ЗагрузитьИзСтроки(ВхОтветSOAP);
	
	Попытка
		ВрмУзелВозврат = ВрмДокументXML.ВыбратьУзел("//m:" + ВхИмяТипа);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
		Возврат ВрмВозврат;
	КонецПопытки;
	
	Для ВрмИндексУзелОбъект = 1 По ВрмУзелВозврат.КоличествоПодчиненных() Цикл
		
		ВрмУзелОбъект = ВрмУзелВозврат.ПолучитьПодчиненныйПоНомеру(ВрмИндексУзелОбъект);
		ВрмИмяУзла = СтрЗаменить(ВрмУзелОбъект.Наименование, "m:", "");
		
		Если Найти(ВрмИмяУзла, "return") > 0 Тогда
			ВрмВозврат.Установить("СтатусВозврата", 1);
			Продолжить;
		ИначеЕсли Найти(ВрмИмяУзла, "fault") > 0 Тогда
			ВрмВозврат.Установить("ОписаниеОшибки", ВрмУзелОбъект.Значение);
			Прервать;
		КонецЕсли;

		ВрмВозврат.Установить(ВрмИмяУзла, ВрмУзелОбъект.Значение);

		Если ВхОтладка = 1 Тогда
			
			message("[" + ВрмИмяУзла + "][" + ВрмУзелОбъект.text + "]");
			
		КонецЕсли;
		
	КонецЦикла;

	ВрмДокументXML = ПолучитьПустоеЗначение();
	ВрмПарсерХМЛ = ПолучитьПустоеЗначение();
	
	Возврат ВрмВозврат;
	
КонецФункции

Функция ПолучитьВерсииСервиса(ВхОтветSOAP)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	
	ВрмДокументXML = ВрмПарсерХМЛ.СоздатьДокумент();
	ВрмДокументXML.Кодировка = "UTF-8";
	ВрмДокументXML.ЗагрузитьИзСтроки(ВхОтветSOAP);
	
	ВрмУзлыОбъекты = ВрмДокументXML.ВыбратьУзлы("//m:return/Value");
	Для ВрмИндексУзелОбъект = 0 По ВрмУзлыОбъекты.КоличествоУзлов - 1 Цикл
		
		ВрмУзелОбъект = ВрмУзлыОбъекты.ПолучитьУзел(ВрмИндексУзелОбъект);
		ВрмВозврат.ДобавитьЗначение(ВрмУзелОбъект.Значение);
		
	КонецЦикла;

	ВрмДокументXML = ПолучитьПустоеЗначение();
	ВрмПарсерХМЛ = ПолучитьПустоеЗначение();

	Возврат ВрмВозврат;

КонецФункции

Функция ПолучитьОписаниеТипа(ВхОбъект)
	
	ВрмСписок = СоздатьОбъект("СписокЗначений");
	ВрмСтрокаОбъект = ЗначениеВСтроку(ВхОбъект);
	ВрмСписок.ИзСтрокиСРазделителями(ВрмСтрокаОбъект);
	ВрмВозврат = ВрмСписок.ПолучитьЗначение(1);
	Если ВрмСписок.РазмерСписка() > 2 Тогда
		ВрмВозврат = ВрмВозврат + "." + ВрмСписок.ПолучитьЗначение(2);
	КонецЕсли;
	
	Возврат ВрмВозврат;
	
КонецФункции

Процедура УстановитьФлагОшибки(Значение = 1)
	
	ПолеФлагОшибки = Значение;
	
КонецПроцедуры

// Функция-свойство: флаг ошибки выполнения обмена данными.
//
// Возвращаемое значение:
//  Булево - флаг ошибки выполнения обмена данными.
//
Функция ФлагОшибки() Экспорт
	
	Если ТипЗначенияСтр(ПолеФлагОшибки) <> "Число" Тогда
		
		ПолеФлагОшибки = 0;
		
	КонецЕсли;
	
	Возврат ПолеФлагОшибки;
	
КонецФункции

// Дополняет строку указанным символом до указанной длины.
//
// Параметры: 
//  Стр          - дополняемая строка;
//  Длина        - требуемая длина результирующей строки;
//  Чем          - символ, которым дополняется строка.
//
// Возвращаемое значение:
//  Строка, дополненная указанным символом до указанной длины.
//
Функция одДополнитьСтроку(Стр, Длина, Чем = " ")

	Результат = СокрЛП(Стр);
	Пока Длина - СтрДлина(Результат) > 0 Цикл
		Результат = Результат + Чем;
	КонецЦикла;

	Возврат Результат;

КонецФункции

//*****************************************************************************

// Функция-свойство: строка, которая содержит сообщение об ошибке при обмене данными.
//
// Возвращаемое значение:
//  Строка - строка, которая содержит сообщение об ошибке при обмене данными.
//
Функция СтрокаСообщенияОбОшибке() Экспорт
	
	Если ТипЗначенияСтр(ПолеСтрокаСообщенияОбОшибке) <> "Строка" Тогда
		
		ПолеСтрокаСообщенияОбОшибке = "";
		
	КонецЕсли;
	
	Возврат ПолеСтрокаСообщенияОбОшибке;
	
КонецФункции

Процедура ВывестиСодержаниеТЗ(ВхТЗ)

	ВрмСтрока = "";
	Для ВрмИндексКолонки = 1 По ВхТЗ.КоличествоКолонок() Цикл
		ВрмЗначение = ВхТЗ.ПолучитьПараметрыКолонки(ВрмИндексКолонки);
		ВрмСтрока = ВрмСтрока + "[" + ВрмЗначение + "]";
	КонецЦикла;
	Сообщить(ВрмСтрока);
	Для ВрмИндексСтроки = 1 По ВхТЗ.КоличествоСтрок() Цикл
		ВрмСтрока = "";
		Для ВрмИндексКолонки = 1 По ВхТЗ.КоличествоКолонок() Цикл
			ВрмЗначение = ВхТЗ.ПолучитьЗначение(ВрмИндексСтроки, ВрмИндексКолонки);
			ВрмСтрока = ВрмСтрока + "[" + ВрмЗначение + "]";
		КонецЦикла;
		Сообщить(ВрмСтрока);
	КонецЦикла;

КонецПроцедуры

Функция СтрокиТаблицыЗначенийВXML(ВхУзел, ВхТЗ)
	
	ВрмВозврат = "";


	// ВрмСтрока = "";
	// Для ВрмИндексКолонки = 1 По ВхТЗ.КоличествоКолонок() Цикл
	// 	ВрмЗначение = ВхТЗ.ПолучитьПараметрыКолонки(ВрмИндексКолонки);
	// 	ВрмСтрока = ВрмСтрока + "[" + ВрмЗначение + "]";
	// КонецЦикла;
	// Сообщить(ВрмСтрока);

	Для ВрмИндексСтроки = 1 По ВхТЗ.КоличествоСтрок() Цикл
		ВрмСтрока = "";
		ВрмУзелСтрока = ЗаписатьПодчиненныйЭлемент(ВхУзел, "record");
		Для ВрмИндексКолонки = 1 По ВхТЗ.КоличествоКолонок() Цикл
			ВрмЗначение = ВхТЗ.ПолучитьЗначение(ВрмИндексСтроки, ВрмИндексКолонки);
			// ВрмСтрока = ВрмСтрока + "[" + ВрмЗначение + "]";
			Если ТипЗначенияСтр(ВрмЗначение) = "ТаблицаЗначений" Тогда
				ВрмУзелТЗ = ЗаписатьПодчиненныйЭлемент(ВрмУзелСтрока, ВхТЗ.ПолучитьПараметрыКолонки(ВрмИндексКолонки), ВхТЗ.ПолучитьЗначение(ВрмИндексСтроки, ВрмИндексКолонки));
				СтрокиТаблицыЗначенийВXML(ВрмУзелТЗ, ВрмЗначение);
			Иначе
				ЗаписатьПодчиненныйЭлемент(ВрмУзелСтрока, ВхТЗ.ПолучитьПараметрыКолонки(ВрмИндексКолонки), ВхТЗ.ПолучитьЗначение(ВрмИндексСтроки, ВрмИндексКолонки));
			КонецЕсли
		КонецЦикла;
		// Сообщить(ВрмСтрока);
	КонецЦикла;

	ВрмВозврат = ВрмВозврат;

	Возврат ВрмВозврат;

КонецФункции

Процедура ТаблицаЗначенийВXML(ВхТЗ, ВхПолноеИмяФайла)
	
	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	ВрмДокументXML = ВрмПарсерХМЛ.СоздатьДокумент();
	ВрмДокументXML.Кодировка = "UTF-8";
	ВрмУзелДокумента = ЗаписатьЭлемент(ВрмДокументXML, ВрмДокументXML, "table");
	
	ВрмСтрокаXML = СтрокиТаблицыЗначенийВXML(ВрмУзелДокумента, ВхТЗ);

	ВрмДокументXML.save(ВхПолноеИмяФайла);
	ВрмДокументXML = ПолучитьПустоеЗначение();

КонецПроцедуры

Процедура СписокЗначенийВXML(ВхСЗ, ВхПолноеИмяФайла)
	
	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	ВрмДокументXML = ВрмПарсерХМЛ.СоздатьДокумент();
	ВрмДокументXML.Кодировка = "UTF-8";
	ВрмУзелДокумента = ЗаписатьЭлемент(ВрмДокументXML, ВрмДокументXML, "table");
	
	Для ВрмИндекс = 1 По ВхСЗ.РазмерСписка() Цикл
		ВрмПредставление = "";
		ВрмЗначение = ВхСЗ.ПолучитьЗначение(ВрмИндекс, ВрмПредставление);
		ВрмУзелСтрока = ЗаписатьПодчиненныйЭлемент(ВрмУзелДокумента, "record");
		ВрмУзелСтрока.УстановитьАтрибут("Индекс", ВрмИндекс);
		ВрмУзелСтрока.УстановитьАтрибут("Представление", ВрмПредставление);
		ВрмУзелСтрока.Значение = Строка(ВрмЗначение);
		
	КонецЦикла;

	ВрмДокументXML.save(ВхПолноеИмяФайла);
	ВрмДокументXML = ПолучитьПустоеЗначение();

КонецПроцедуры

Функция ПолучитьСтрокуТаблицыСписком(ВхТЗ, ВхИндексСтроки)
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	Для ВрмИндексКолонки = 1 По ВхТЗ.КоличествоКолонок() Цикл
		ВрмВозврат.Установить(ВхТЗ.ПолучитьПараметрыКолонки(ВрмИндексКолонки), ВхТЗ.ПолучитьЗначение(ВхИндексСтроки, ВрмИндексКолонки));
	КонецЦикла;
	Возврат ВрмВозврат;
КонецФункции

//*****************************************************************************
Функция ЧислоВХекс(пЧисло)
	
	лМладшиеБиты = пЧисло % 16;
    лСтаршиеБиты = Цел(пЧисло/16);
    
    Если лСтаршиеБиты > 0 Тогда
        лРезультат = ЧислоВХекс(лСтаршиеБиты);
    Иначе
        лРезультат = "";
    КонецЕсли;
    
    ХексСимволы = "0123456789abcdef";
                   
	Возврат лРезультат + Сред(ХексСимволы, лМладшиеБиты + 1, 1);	
    
КонецФункции	// ЧислоВХекс

//*****************************************************************************
Функция ХексВЧисло(пХекс)
	
	лМладшиеБиты = Прав(пХекс, 1);
    лСтаршиеБиты = Лев(пХекс, СтрДлина(пХекс) - 1);
    
    ХексСимволы = "0123456789abcdef";
	
    лРезультат = Найти(ХексСимволы, лМладшиеБиты) - 1;
	
	Если лРезультат = -1 Тогда              
		ош = 1/0; // Ошибка! Параметр не является HEX-значением.
	КонецЕсли;
    
    Если лСтаршиеБиты = "" Тогда
        Возврат лРезультат;
    Иначе
        Возврат ХексВЧисло(лСтаршиеБиты) * 16 + лРезультат;
    КонецЕсли;	
	
КонецФункции	// ХексВЧисло

//*****************************************************************************
Функция СтрокуВХекс(пИсходнаяСтрока)
	
	лДлинаСтроки = СтрДлина(пИсходнаяСтрока);
	лРезультат = "";
	
	Для НомерПозиции = 1 По лДлинаСтроки Цикл
		лСимвол = Сред(пИсходнаяСтрока,НомерПозиции,1);
		лКодСимвола = КодСимв(лСимвол);
		
		лРезультат = лРезультат + ЧислоВХекс(лКодСимвола);
	КонецЦикла;
	
	Возврат лРезультат
	
КонецФункции	// СтрокуВХекс
                              
//*****************************************************************************
Функция ХексВСтроку(пХексСтрока)
	лКоличествоПар = СтрДлина(пХексСтрока) / 2;
	лРезультат = "";
	
	Для лНомерПары = 1 По лКоличествоПар Цикл       
		лНачалоПары = (лНомерПары - 1) * 2 + 1;
		лПараСимволов = Сред(пХексСтрока,лНачалоПары,2);
		
		лРезультат = лРезультат + Симв(ХексВЧисло(лПараСимволов));
	КонецЦикла;
	
	Возврат лРезультат
КонецФункции	// ХексВСтроку

//*****************************************************************************
Функция ПолучитьУникальныйИдентификатор(пСсылка)
	// На выходе должна получиться строка вида "XXYYYYZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ"
	// X - тип ссылка (справочник, документ). Символ в HEX
	// Y - вид (номенклатура, реализация). Число, 4-ре цифры.
	// Z - ИД объекта. Строка в HEX
                                   
	Если ПустоеЗначение(пСсылка) = 1 Тогда
		Возврат "00000000-0000-0000-0000-000000000000";
	КонецЕсли;
	
	// {"B","0","0","84","0","0","         1   "}
	лВнутрСтрока = ЗначениеВСтрокуВнутр(пСсылка);
	
	// "B","0","0","84","0","0","         1   "
	лСтрокаСРазделителями = Сред(лВнутрСтрока,2,СтрДлина(лВнутрСтрока)-2);
	
	лСписок = СоздатьОбъект("СписокЗначений");
	лСписок.ИзСтрокиСРазделителями(лСтрокаСРазделителями);
	
	лТип = лСписок.ПолучитьЗначение(1); // "B"
	лВид = лСписок.ПолучитьЗначение(4); // "84" - предполагается, что это всегда число, 4-ре цифры.
	лИДОбъекта = лСписок.ПолучитьЗначение(7); // "         1   "
	
	// Преобразование только типизированных значений. 
	// Длина идентификатора должна быть равной 13 символов.
	Если СтрДлина(лИДОбъекта) <> 13 Тогда
		Если СтрДлина(лИДОбъекта) = 23 Тогда // "{"O","0","0","0","0","0","      2457   2231945ЦБ "}"
			лВид = СокрЛП(Лев(лИдОбъекта,10));
			лИДОбъекта = Прав(лИДОбъекта,13);
		Иначе	
			ош = 1/0; // Ошибка! Длина идентификатора ожидается 13 символов.
		КонецЕсли;
	КонецЕсли;
	
	// "42008420202020202020202031202020"
	лРезультат = СтрокуВХекс(лТип) + Формат(лВид,"Ч(0)4") + СтрокуВХекс(лИДОбъекта);
                          
	// "42008420-2020-2020-2020-202031202020"
	лРезультат = Лев(лРезультат,8) + "-" + 
		Сред(лРезультат,9,4) + "-" + 
		Сред(лРезультат,13,4) + "-" + 
		Сред(лРезультат,17,4) + "-" + 
		Прав(лРезультат,12);
	          
	Возврат лРезультат;
КонецФункции	// ПолучитьУникальныйИдентификатор

//*****************************************************************************
Функция ПолучитьСсылкуПоИдентификатору(пИдентификатор)
	// На входе строка вида "XXYYYYZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ"
	//   X - тип ссылка (справочник, документ). Символ в HEX
	//   Y - вид (номенклатура, реализация). Число, 4-ре цифры.
	//   Z - ИД объекта. Строка в HEX
	// На выходе ссылка на документ/справочник
	
	Если СтрДлина(пИдентификатор) <> 36 Тогда
		ош = 1/0; // Ошибка! Длина идентификатора ожидается 36 символов.
	КонецЕсли;
	
	// "42008420-2020-2020-2020-202031202020"
	// "42008420202020202020202031202020"
	лСтрока = СтрЗаменить(пИдентификатор,"-","");
	 
	лТип = Лев(лСтрока,2); // "42"
	лВид = Строка(Число(Сред(лСтрока,3,4))); // "84"
	лИДОбъекта = Прав(лСтрока,26); // "20202020202020202031202020"
	  
	// {"B","0","0","84","0","0","         1   "}
	лВнутрСтрока = "{"""+ХексВСтроку(лТип)+""",""0"",""0"","""+лВид+""",""0"",""0"","""+ХексВСтроку(лИДОбъекта)+"""}";
	
	лРезультат = ЗначениеИзСтрокиВнутр(лВнутрСтрока);
	
	Возврат лРезультат;
КонецФункции

//*****************************************************************************
Функция ПолучитьСтрокуВнутреннюю(ВхВид, ВхИд)

	ВрмВозврат = "";

	ВрмТаблицаМетаданные = мНастройкиОбмена.Получить("Метаданные");

	ВрмИндекс = 0;
	ВрмТаблицаМетаданные.НайтиЗначение(ВхВид, ВрмИндекс, "Ид");

	Если ВрмИндекс = 0 Тогда
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмТипСтрока = ВрмТаблицаМетаданные.ПолучитьЗначение(ВрмИндекс, "Тип");

	// ВрмТипСтрока = Лев(ВрмПредставление, Найти(ВрмПредставление, ".") - 1);

	ВрмСимволТип = "";

	Если ВрмТипСтрока = "Документ" Тогда
		ВрмСимволТип = "O";
	ИначеЕсли ВрмТипСтрока = "Справочник" Тогда
		ВрмСимволТип = "B";
	КонецЕсли;

	ВрмУзелИд = Прав(ВхИД, 3);
	ВрмОбъектИд = _StrToID(Лев(ВхИД, 6));
	ВрмПолныйИД = Прав("         " + ВрмОбъектИд + ВрмУзелИд, 13);

	Возврат "{""" + ВрмСимволТип + """,""0"",""0"",""" + ВхВид + """,""0"",""0"",""" + ВрмПолныйИД + """}";

КонецФункции

Функция ПолучитьCOMОбъект(ВхИмяКласса)
	Попытка 
		ВрмВозврат = СоздатьОбъект(ВхИмяКласса);
	Исключение  
		// СообщитьОЗагрузкеВнешнейКомпоненты("1cpp.dll");
		//ЗапросСКЛ = СоздатьОбъект("ODBCRecordset");
	КонецПопытки;

	Возврат ВрмВозврат;

КонецФункции

Процедура ЗаполнитьЗначенияСвойств(ВхПриемник, ВхИсточник, ВхИсключать = "")
	ВрмИмяСвойства = "";
	ВрмСвойстваИсключаемые = СоздатьОбъект("СписокЗначений");
	ВрмСвойстваИсключаемые.ИзСтрокиСРазделителями(ВхИсключать);
	Для ВрмИндексСвойства = 1 По ВхИсточник.РазмерСписка() Цикл
		ВрмЗначениеСовойства = ВхИсточник.ПолучитьЗначение(ВрмИндексСвойства, ВрмИмяСвойства);
		Если ВрмСвойстваИсключаемые.НайтиЗначение(ВрмИмяСвойства) > 0 Тогда
			Продолжить;
		КонецЕсли;
		ВхПриемник.Установить(ВрмИмяСвойства, ВрмЗначениеСовойства);
	КонецЦикла;
КонецПроцедуры

Функция ПолучитьСтатусВозврата(ВхВозврат)
	ВрмВозврат = 0;
	Если ТипЗначенияСтр(ВхВозврат) = "СписокЗначений" Тогда
		ВрмВозврат = Число(ВхВозврат.Получить("СтатусВозврата"));
	КонецЕсли;
	Возврат ВрмВозврат;
КонецФункции

Функция Разархивировать(ВхПолныйПутьАрхива, ВхПуть)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	
	ВрмПутьРаспаковки = Шаблон("[ВхПуть]data\");
	
	ВрмБД = СоздатьОбъект("BinaryData");
    ВрмБД.UnZip(ВхПолныйПутьАрхива + " " + ВрмПутьРаспаковки);
	
	ВрмМаскаПоиска = Шаблон("[ВрмПутьРаспаковки]*.xml");
	ВрмФайл = ФС.НайтиПервыйФайл(ВрмМаскаПоиска);
	Пока ПустаяСтрока(ВрмФайл) = 0 Цикл
		ВрмВозврат.Установить("Результат", Шаблон("[ВрмПутьРаспаковки][ВрмФайл]"));
		ВрмФайл = ФС.НайтиСледующийФайл();
	
	КонецЦикла;
	
	ВрмБД = ПолучитьПустоеЗначение();

	Возврат ВрмВозврат;
	
КонецФункции

Функция Архивировать(ВхПолныйПутьФайла, ВхИмяФайла, ВхПолныйПутьАрхива)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмСтатусВозврата = 0;
	
	ВрмБД = СоздатьОбъект("BinaryData");
	ВрмБД.ПодключитьсяКФайлу(ВхПолныйПутьФайла);
	ВрмБД.pkAppendFile(ВхПолныйПутьАрхива, ВхИмяФайла);
	ВрмБД.Закрыть();
	
	Если ФС.СуществуетФайл(ВхПолныйПутьАрхива) = 1 Тогда
		ВрмСтатусВозврата = 1;
		ВрмВозврат.Установить("Результат", ВхПолныйПутьАрхива);
	КонецЕсли;

	ВрмВозврат.Установить("СтатусВозврата", ВрмСтатусВозврата);
	ВрмБД = ПолучитьПустоеЗначение();
	
	Возврат ВрмВозврат;
	
КонецФункции

Функция РазложитьПолноеИмяФайла(ВхПолноеИмяФайла)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	
	ВрмТекст = СтрЗаменить(ВхПолноеИмяФайла, "\", РазделительСтрок);
	ВрмИмяФайла = СтрПолучитьСтроку(ВрмТекст, СтрКоличествоСтрок(ВрмТекст));
	ВрмКаталог = Лев(ВхПолноеИмяФайла, СтрДлина(ВхПолноеИмяФайла) - СтрДлина(ВрмИмяФайла));
	
	ВрмТекст = СтрЗаменить(ВрмИмяФайла, ".", РазделительСтрок);
	ВрмРасширение = СтрПолучитьСтроку(ВрмТекст, СтрКоличествоСтрок(ВрмТекст));
	ВрмИмяФайлаБезРасширения = Лев(ВрмИмяФайла, СтрДлина(ВрмИмяФайла) - СтрДлина(ВрмРасширение) - 1);
	
	ВрмВозврат.Установить("ИмяФайла", ВрмИмяФайла);
	ВрмВозврат.Установить("Каталог", ВрмКаталог);
	ВрмВозврат.Установить("ИмяФайлаБезРасширения", ВрмИмяФайлаБезРасширения);
	ВрмВозврат.Установить("Расширение", ВрмРасширение);
	
	Возврат ВрмВозврат;
	
КонецФункции

Функция CombineFiles(ВхСписокФайлов, ВхПолныйПуть)

	_str_read=СоздатьОбъект("ADODB.Stream");
    _str_read.Type=1;
	_str_read.Open();
	
	_str_write=СоздатьОбъект("ADODB.Stream");
    _str_write.Type=1;
	_str_write.Open();
	
	for _idx = 1 to ВхСписокФайлов.РазмерСписка() do
	    
		_file = ВхСписокФайлов.ПолучитьЗначение(_idx);
		
		_str_read.LoadFromFile(_file);
        _str_read.CopyTo(_str_write);
	
	enddo;
	
	_str_write.SaveToFile(ВхПолныйПуть, 2);
	
КонецФункции

Функция SplitFile(ВхПолныйПуть, ВхРазмерБайт = 1024)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	
	ВрмЧастиИмениФайла = РазложитьПолноеИмяФайла(ВхПолныйПуть);
	
	ВрмКаталог = ВрмЧастиИмениФайла.Получить("Каталог");
	ВрмИмяФайла = ВрмЧастиИмениФайла.Получить("ИмяФайла");
	
	_idx = 1;
	
	_str_write = СоздатьОбъект("ADODB.Stream");
	_str_write.Type = 1;
	_str_write.Open();
	
	_str_read = СоздатьОбъект("ADODB.Stream");
	_str_read.Type = 1;
	_str_read.Open();
	_str_read.LoadFromFile(ВхПолныйПуть);
	
	while _str_read.EOS = 0 do
		
		ВрмПолныйПутьЧасти = Шаблон("[ВрмКаталог][ВрмИмяФайла].[_idx]");
		_str_read.CopyTo(_str_write, ВхРазмерБайт * 1024);
		_str_write.SaveToFile(ВрмПолныйПутьЧасти, 2);
		_str_write.Position = 0;
        _str_write.SetEOS();
		
		ВрмВозврат.Установить(_idx, ВрмПолныйПутьЧасти);
		_idx = _idx + 1;
	
	enddo;
	
	_str_read.Close();
	_str_write.Close();
	
	Возврат ВрмВозврат;
	
КонецФункции

Function StrToStrBase64(ValSource)
	
	_return = "";
	
	_tmp_file = TempFilesDir() + "_temp.1c";

	_txt = CreateObject("Текст");
	_txt.КодоваяСтраница(0);
	_txt.AddLine(ValSource);
	_txt.Write(_tmp_file);

	// _str = CreateObject("ADODB.Stream");
    // _str.Type=2;
    // _str.Charset="windows-1251";
    // _str.Open();
	// _str.WriteText(ValSource);
    // _str.SaveToFile(_tmp_file, 2);
	// _str.Close();
	
	_bd = CreateObject("BinaryData");
	_bd.LoadFromFile(_tmp_file, 1);
	_bd.SaveToFile(_tmp_file);
	_bd.Close();
    
	_cdo = CreateObject("CDO.Message");
	
	_bp = _cdo.BodyPart;
	_bp.Charset = "windows-1251";
	_bp.ContentTransferEncoding = "base64";
	
	_str = _bp.GetDecodedContentStream();
	_str.Type = 2;
	_str.LoadFromFile(_tmp_file);
	_str.Flush();
	_str.Close();
	
	fs.DeleteFile(_tmp_file);
	
	_str = _bp.GetEncodedContentStream();
	_str.Type = 2;
	
	_return = _str.ReadText();
	_str.Close();

	_cdo = GetEmptyValue();
	
	Return _return;
	
EndFunction

Function StrBase64ToStr(ValSource)
	
	_return = "";
	
	_tmp_file = TempFilesDir() + "_temp.1c";
	
	_cdo = CreateObject("CDO.Message");
    
	_bp = _cdo.BodyPart;
	_bp.Charset = "windows-1251";
	_bp.ContentTransferEncoding = "base64";
	
	_str = _bp.GetEncodedContentStream();
	_str.Type = 2;
	_str.WriteText(ValSource);
	_str.Flush();
	_str.Close();
	
	_str = _bp.GetDecodedContentStream();
	_str.Type = 2;
	_str.SaveToFile(_tmp_file, 2);
	_str.Close();
	
	_bd = CreateObject("BinaryData");
	_bd.LoadFromFile(_tmp_file);
	_bd.Seek(0, 0);
	_bd.SaveToFile(_tmp_file, 1);
	_bd.Close();
	
	_str = CreateObject("ADODB.Stream");
    _str.Type=2; 
    _str.Charset="windows-1251";
    _str.Open();
    _str.LoadFromFile(_tmp_file);
	_str.Flush();
	_return = _str.ReadText();
	_str.Close();
	
	fs.DeleteFile(_tmp_file);
	
	_cdo = GetEmptyValue();
	
	Return _return;
	
EndFunction

Функция FileBase64ToFile(ВхИсточник, ВхПриемник)
	
	_cdo = СоздатьОбъект("CDO.Message");
    
	_bp = _cdo.BodyPart;
	_bp.Charset = "windows-1251";
	_bp.ContentTransferEncoding="base64";
	
    _str_write = _bp.GetEncodedContentStream();
    _str_write.LoadFromFile(ВхИсточник);
    _str_write.Flush();
	
    _bp.SaveToFile(ВхПриемник);
	_str_write.Close();

	_cdo = ПолучитьПустоеЗначение();
	
КонецФункции

Функция FileToFileBase64(ВхИсточник, ВхПриемник)
	
	_cdo = СоздатьОбъект("CDO.Message");
    
	_bp = _cdo.AddAttachment(ВхИсточник);
	
	_bp.Charset = "windows-1251";
	_bp.ContentTransferEncoding = "base64";
	
	_str_write = _bp.GetEncodedContentStream();
	_str_write.Type = 1;
	_str_write.SaveToFile(ВхПриемник, 2);
	_str_write.Close();

	_cdo = ПолучитьПустоеЗначение();
	
КонецФункции

Функция СтрокаВФайл(ВхСтрока, ВхПолныйПуть)
	
	Стрим=СоздатьОбъект("ADODB.Stream");
    Стрим.Type=2;
    Стрим.charset="windows-1251";
    Стрим.Open();
	Стрим.WriteText(ВхСтрока);
	Стрим.SaveToFile(ВхПолныйПуть);
	Стрим.Close();
	
	Возврат 0;

КонецФункции

Функция ФайлВСтроку(ВхПолныйПуть)
	
	ВрмВозврат = "";
	
	Стрим=СоздатьОбъект("ADODB.Stream");
    Стрим.Type=2; 
    Стрим.charset="windows-1251";
    Стрим.Open();
    Стрим.LoadFromFile(ВхПолныйПуть);
	Стрим.Flush();
	ВрмВозврат = Стрим.ReadText();
	Стрим.Close();

	Возврат ВрмВозврат
	
КонецФункции

//*****************************************************************************  

Процедура ЗаполнитьСписокУзловИзБД(ВхСписокУзловОбмена)
	
	ВрмЗапросСКЛ = ПолучитьCOMОбъект("ODBCRecordset");

	ВрмТекстЗапроса ="
		|SELECT
		|	T_DBSET.DBSIGN,
		|	T_SYSTEM.DBSIGN AS DBSELF,
		|	T_DBSET.DBDESCR,
		|	T_DBSET.DBSTATUS,
		|	T_DBSET.DBUUID,
		|	CASE WHEN T_DBSET.DBSTATUS = 'C' THEN 1 ELSE 0 END AS ACTIVE
		|FROM
		|	_1SDBSET T_DBSET
		|INNER JOIN _1SSYSTEM T_SYSTEM ON 1=1
		|WHERE
		|	T_DBSET.DBFMODE != 0";
	
	ВрмТаблицаУзлыОбмена = ВрмЗапросСКЛ.ВыполнитьИнструкцию(ВрмТекстЗапроса);

	ВрмТаблицаУзлыОбмена.ВыбратьСтроки();
	Пока ВрмТаблицаУзлыОбмена.ПолучитьСтроку() = 1 Цикл
		
		ВрмСписокПараметры = СоздатьОбъект("СписокЗначений");
		ВрмСписокПараметры.Установить("descr", СокрЛП(ВрмТаблицаУзлыОбмена.DBDESCR));
		ВрмСписокПараметры.Установить("selected", "1");
		ВрмСписокПараметры.Установить("id_self", СокрЛП(ВрмТаблицаУзлыОбмена.DBSELF));
		ВрмСписокПараметры.Установить("id_remote", СокрЛП(ВрмТаблицаУзлыОбмена.DBSIGN));
		ВрмСписокПараметры.Установить("active", ВрмТаблицаУзлыОбмена.ACTIVE);
		ВрмСписокПараметры.Установить("uuid", ВрмТаблицаУзлыОбмена.DBUUID);

		ВхСписокУзловОбмена.Установить(СокрЛП(ВрмТаблицаУзлыОбмена.DBSIGN), ВрмСписокПараметры);
		
	КонецЦикла;

	мНастройкиОбмена.Установить("СохранитьНастройки", 1);

	ВрмЗапросСКЛ = 0;
	
КонецПроцедуры

Функция АктивироватьУзелОбмена(ВхУзелОбменаИдентификатор, ВхСписокПараметры)
	
	ВрмВозврат = 0;

	ВрмЗапросСКЛ = ПолучитьCOMОбъект("ODBCRecordset");

	//ВрмТекстЗапроса = "UPDATE _1SDBSET SET DBSTATUS = 'C' WHERE RTRIM(DBSIGN) = '" + ВхУзелОбменаИдентификатор + "'";// AND DBSTATUS != 'C'";
	ВрмТекстЗапроса = "UPDATE _1SDBSET SET DBSTATUS = 'C' WHERE RTRIM(DBSIGN) = '" + ВхУзелОбменаИдентификатор + "' AND DBSTATUS != 'C'";

	//Сообщить(ВрмТекстЗапроса);

	ВрмВозврат = ВрмЗапросСКЛ.ВыполнитьИнструкцию(ВрмТекстЗапроса);
	Если ВрмВозврат = 1 Тогда
		Сообщить("Инициализация узла с кодом [" + ВхУзелОбменаИдентификатор + "] успешна завершена.");
		Предупреждение("Необходимо перезапустить ИБ!");
	Иначе
		Сообщить("Узлу с кодом [" + ВхУзелОбменаИдентификатор + "] не требуется активация.");
	КонецЕсли;

	Если ФС.СуществуетФайл(мКаталогОбмена) = 0 Тогда
		ФС.СоздатьКаталог(мКаталогОбмена);
	КонецЕсли;

	ВрмКаталогОбменаУзла = мКаталогОбмена + ВхУзелОбменаИдентификатор + "\";

	Если ФС.СуществуетФайл(ВрмКаталогОбменаУзла) = 0 Тогда
		ФС.СоздатьКаталог(ВрмКаталогОбменаУзла);
	КонецЕсли;

	ВхСписокПараметры.Установить("active", ВрмВозврат);
	ВхСписокПараметры.Установить("path", ВрмКаталогОбменаУзла);

	ЗапросСКЛ = 0;

	Возврат ВрмВозврат;
	
КонецФункции

Процедура ОбновитьНомерОтправленного(ВхУзелОбменаИдентификатор, ВхПакетНомер = 0)

	ЗапросСКЛ = ПолучитьCOMОбъект("ODBCRecordset");

	ВрмСтрокаЗапрос = "
		|UPDATE T_UPDTS
		| SET T_UPDTS.DWNLDID = RIGHT('      ' + RTRIM('" + _IdToStr(ВхПакетНомер) + "'), 6) + LTRIM(T_SYSTEM.DBSIGN)
		|FROM _1SUPDTS T_UPDTS
		|INNER JOIN _1SSYSTEM T_SYSTEM ON T_UPDTS.DBSIGN = '" + ВхУзелОбменаИдентификатор + "' AND T_UPDTS.DWNLDID = 'FFFFFFFFF';
		|
		|INSERT INTO _1SDWNLDS SELECT RIGHT('      ' + RTRIM('" + _IdToStr(ВхПакетНомер) + "'), 6) + LTRIM(DBSIGN) DWNLDID, '" + ВхУзелОбменаИдентификатор + "' DBSIGN, 'O' DIRECT, '' ACKNOWL  FROM _1SSYSTEM;
		|";

	// Сообщить(ВрмСтрокаЗапрос);
	ЗапросСКЛ.ВыполнитьСкалярный(ВрмСтрокаЗапрос);
	ЗапросСКЛ = 0;

КонецПроцедуры

Процедура ЗакончитьЧтениеСообщения(ВхУзелОбменаИдентификатор, ВхПакетНомер, ВрмНомерПринятогоКорреспондентом)

	ЗапросСКЛ = ПолучитьCOMОбъект("ODBCRecordset");

	ВрмСтрокаЗапрос = "
		|UPDATE _1SDWNLDS
		|	SET ACKNOWL = 'A'
		|WHERE DIRECT = 'O' AND DBSIGN = '" + ВхУзелОбменаИдентификатор + "'
		|	AND DWNLDID <= RIGHT('      ' + RTRIM('" + _IdToStr(ВрмНомерПринятогоКорреспондентом) + "'), 6) + LTRIM('" + _IdToStr(ВхУзелОбменаИдентификатор) + "');
		|
		|INSERT INTO _1SDWNLDS 
		|	SELECT
		|		RIGHT('      ' + RTRIM('" + _IdToStr(ВхПакетНомер) + "'), 6) + LTRIM(DBSIGN) DWNLDID,
		|		DBSIGN,
		|		'I' DIRECT,
		|		'A' ACKNOWL
		|	FROM _1SDBSET
		|	WHERE
		|		DBSIGN = '" + ВхУзелОбменаИдентификатор + "';
		|";

	// Сообщить(ВрмСтрокаЗапрос);
	ЗапросСКЛ.ВыполнитьСкалярный(ВрмСтрокаЗапрос);
	ЗапросСКЛ = 0;

КонецПроцедуры

Функция ВыбратьИзменения(ВхУзелОбменаИдентификатор, ВхТаблицаВыгружаемыхМетаданных, ВхПакетНомер = 0)

	ЗапросСКЛ = ПолучитьCOMОбъект("ODBCRecordset");

	ЗапросСКЛ.ВыполнитьСкалярный("
		|UPDATE _1SUPDTS SET DWNLDID = 'FFFFFFFFF' WHERE DBSIGN = '" + ВхУзелОбменаИдентификатор + "' AND DWNLDID = '';
		|
		|IF OBJECT_ID('tempdb..#ТаблВрем', 'U') IS NOT NULL
		|	DROP TABLE #ТаблВрем;
		|
		|CREATE TABLE #ТаблВрем (
		|	TYPEID int);
		|");

	//Собственно вставка строк
	ЗапросСКЛ.Подготовить("INSERT INTO #ТаблВрем (TYPEID) VALUES (?)");
	ВрмВозврат = ЗапросСКЛ.ВыполнитьSQL_ИзТЗ(ВхТаблицаВыгружаемыхМетаданных);

	ВрмСтрокаЗапрос = "
		|SELECT
		// |	TOP 200
		|	T_UPDTS.DBSIGN,
		|	T_UPDTS.TYPEID,
		|	T_UPDTS.OBJID,
		|	T_UPDTS.DELETED,
		|	T_UPDTS.DWNLDID
		|FROM _1SUPDTS T_UPDTS
		|INNER JOIN #ТаблВрем T_TMP
		|	ON T_UPDTS.TYPEID = T_TMP.TYPEID
		|WHERE
		|	T_UPDTS.DBSIGN = '" + ВхУзелОбменаИдентификатор + "'
		|	AND T_UPDTS.DWNLDID > (SELECT MAX(DWNLDID) FROM _1SDWNLDS WHERE DBSIGN = '" + ВхУзелОбменаИдентификатор + "' AND DIRECT = 'O' AND ACKNOWL = 'A')
		// |	AND T_UPDTS.OBJID = '   1XHKHK'
		|";

	// Если ПустаяСтрока(ВхПакетНомер)  = 0 Тогда
	// 	ВрмСтрокаЗапрос = ВрмСтрокаЗапрос + "
	// 	|	AND LTRIM(SUBSTRING(T_UPDTS.DWNLDID, 1, 6)) < '" + ВхПакетНомер + "'";
	// КонецЕсли;

	ВрмСтрокаЗапрос = ВрмСтрокаЗапрос + "
		|ORDER BY T_UPDTS.TYPEID, T_UPDTS.OBJID";

	// Сообщить(ВрмСтрокаЗапрос);

	ВрмВозврат = ЗапросСКЛ.ВыполнитьИнструкцию(ВрмСтрокаЗапрос);

	ЗапросСКЛ.ВыполнитьСкалярный("
	|IF OBJECT_ID('tempdb..#ТаблВрем', 'U') IS NOT NULL
  	|	DROP TABLE #ТаблВрем;
	|");

	ВрмВозврат.НоваяКолонка("Объект");

	Для ВрмИндексСтрокиИзменений = 1 По ВрмВозврат.КоличествоСтрок() Цикл
		
		Если ВрмВозврат.ПолучитьЗначение(ВрмИндексСтрокиИзменений, "DELETED") = "D" Тогда
			Продолжить;
		КонецЕсли;

		ОбъектМетаданныхТекущий = ВрмВозврат.ПолучитьЗначение(ВрмИндексСтрокиИзменений, "TYPEID");
		ИдентификаторОбъектаВнутр = ВрмВозврат.ПолучитьЗначение(ВрмИндексСтрокиИзменений, "OBJID");
		
		ВрмСтрокаОбъектаВнутр = ПолучитьСтрокуВнутреннюю(ОбъектМетаданныхТекущий, ИдентификаторОбъектаВнутр);	
		ВрмОбъект = ЗначениеИзСтрокиВнутр(ВрмСтрокаОбъектаВнутр);
		
		ВрмВозврат.УстановитьЗначение(ВрмИндексСтрокиИзменений, "Объект", ВрмОбъект);

		мСписокВыгружаемыхОбъектов.ДобавитьЗначение(ВрмОбъект);

	КонецЦикла;

	Возврат ВрмВозврат;
КонецФункции

Функция ПолучитьНомерОтправленного(ВхУзелОбменаИдентификатор)

	ВрмВозврат = 0;

	ВрмЗапросСКЛ = ПолучитьCOMОбъект("ODBCRecordset");

	ВрмТекстЗапроса = "SELECT max(DWNLDID) FROM _1SDWNLDS WHERE RTRIM(DBSIGN) = '" + ВхУзелОбменаИдентификатор + "' AND DIRECT = 'O'";
	
	ВрмТаблицаЗначения = ВрмЗапросСКЛ.ВыполнитьИнструкцию(ВрмТекстЗапроса); // Здесь нужно установить блокировку таблицы до записи.
	
	Если ВрмТаблицаЗначения.КоличествоСтрок() = 1 Тогда
		ВрмНомерПакета = ВрмТаблицаЗначения.ПолучитьЗначение(1, 1);
		ВрмВозврат = _StrToId(Лев(ВрмНомерПакета, 6));
	Иначе
		ВрмВозврат = 0;
	КонецЕсли;

	Возврат ВрмВозврат;

КонецФункции

Функция ПолучитьНомерПринятого(ВхУзелОбменаИдентификатор)

	ВрмВозврат = 0;

	ВрмЗапросСКЛ = ПолучитьCOMОбъект("ODBCRecordset");

	ВрмТекстЗапроса = "SELECT max(DWNLDID) FROM _1SDWNLDS WHERE RTRIM(DBSIGN) = '" + ВхУзелОбменаИдентификатор + "' AND DIRECT = 'I'";
	
	ВрмТаблицаЗначения = ВрмЗапросСКЛ.ВыполнитьИнструкцию(ВрмТекстЗапроса); // Здесь нужно установить блокировку таблицы до записи.
	
	Если ВрмТаблицаЗначения.КоличествоСтрок() = 1 Тогда
		ВрмНомерПакета = ВрмТаблицаЗначения.ПолучитьЗначение(1, 1);
		ВрмВозврат = _StrToId(Лев(ВрмНомерПакета, 6));
	Иначе
		ВрмВозврат = 0;
	КонецЕсли;

	Возврат ВрмВозврат;

КонецФункции

Функция УдалитьРегистрациюИзменений(ВхУзелОбменаИдентификатор, ВхПакетНомер = 0)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмПакетИдентификатор = _IdToStr(ВхПакетНомер) + ТекущаяИБКод();
	ВрмТекстЗапроса = "
		|DELETE _1SUPDTS
		|	FROM _1SUPDTS AS UPDTS
		|WHERE UPDTS.DBSIGN = '" + ВхУзелОбменаИдентификатор + "'
		|	AND DWNLDID > ''
		|	AND UPDTS.DWNLDID <= '" + ВрмПакетИдентификатор + "'
		|";

	ВрмЗапросСКЛ = ПолучитьCOMОбъект("ODBCRecordset");

	Попытка
		ВрмРезультат = ВрмЗапросСКЛ.ВыполнитьИнструкцию(ВрмТекстЗапроса);
		ВрмВозврат.Установить("Результат", ВрмРезультат);
		ВрмВозврат.Установить("СтатусВозврата", 1);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", ОписаниеОшибки());
	КонецПопытки;

	Возврат ВрмВозврат;

КонецФункции	// ОчиститьИзмененныеОбъекты()

//Уровень: 1 - администрирование; 2 - изменение данных; 3 - информация; 4 - предупреждение; 5 - ошибка. Значение по умолчанию 3
Процедура ЗаписьЖурналаРегистрацииОбменДанными(Комментарий, Уровень = 3)
	
	Если Уровень = 3 Тогда
		Уровень = 5;
	КонецЕсли;
	
	// ОбъектМетаданных = Неопределено;
	
	// Если     УзелОбменаЗагрузкаДанных <> Неопределено
	// 	И Не УзелОбменаЗагрузкаДанных.Пустая() Тогда
		
	// 	ОбъектМетаданных = УзелОбменаЗагрузкаДанных.Метаданные();
		
	// КонецЕсли;
	
	//ЗаписьЖурналаРегистрации(КлючСообщенияЖурналаРегистрации(), Уровень, ОбъектМетаданных,, Комментарий);
	ЗаписьЖурналаРегистрации(Комментарий, "Обработка", "Обмен данными", , Уровень);
	
КонецПроцедуры

// Возвращает объект типа структура, содержащий все возможные поля
// записи протокола выполнения (сообщения об ошибках и т.п.).
//
// Параметры:
//  Нет.
//
// Возвращаемое значение:
//  Объект типа структура
// 
Функция ПолучитьСтруктуруЗаписиПротокола(КСообщенияОбОшибках = "", Знач СтрокаОшибки = "")

	СтруктураОшибки = ПолучитьПустоеЗначение();
	мСтруктураОшибки.Выгрузить(СтруктураОшибки);
	
	СтрокаМодуля              = "";//ОтделитьРазделителем(СтрокаОшибки, "{");
	ВрмОписаниеОшибки            = "";//ОтделитьРазделителем(СтрокаМодуля, "}: ");
	
	Если ПустаяСтрока(ВрмОписаниеОшибки) = 0 Тогда
		
		СтруктураОшибки.Установить("ОписаниеОшибки", ВрмОписаниеОшибки);
		СтруктураОшибки.Установить("ПозицияМодуля", СтрокаМодуля);
				
	КонецЕсли;
	
	Если ПустаяСтрока(КСообщенияОбОшибках) = 0 Тогда
		
		СтруктураОшибки.Установить("КСообщенияОбОшибках", КСообщенияОбОшибках);
		
	КонецЕсли;
	
	Возврат СтруктураОшибки;
	
КонецФункции

Процедура ИнициализироватьВедениеПротоколаОбмена(ВхУзелОбменаИдентификатор)
	
	// Если ПустаяСтрока(ИмяФайлаПротоколаОбмена) Тогда
		
	// 	ФайлПротоколаДанных = Неопределено;
	// 	ФлагКомментироватьОбработкуОбъектов = ВыводВОкноСообщенийИнформационныхСообщений;		
	// 	Возврат;
		
	// Иначе	
		
	// 	ФлагКомментироватьОбработкуОбъектов = ВыводВПротоколИнформационныхСообщений ИЛИ ВыводВОкноСообщенийИнформационныхСообщений;		
		
	// КонецЕсли;
	
	// Попытка записи в файл протокола обмена.
	Попытка
		
		ВрмИнфо = ПолучитьCOMОбъект("AddIn.V7SysInfo");
		ВрмГлобальноУникальныйИдентификатор = ВрмИнфо.СоздатьGUID();
		ВрмИнфо = ПолучитьПустоеЗначение();
		
		ВрмКаталогПротоколаОбмена = мКаталогОбмена + ВхУзелОбменаИдентификатор + "\Log\";
		Если ФС.СуществуетФайл(ВрмКаталогПротоколаОбмена) = 0 Тогда
			ФС.СоздатьКаталог(ВрмКаталогПротоколаОбмена);
		КонецЕсли;
		
		ИмяФайлаПротоколаОбмена = ВрмКаталогПротоколаОбмена + ВрмГлобальноУникальныйИдентификатор + ".txt";

		ФайлПротоколаДанных = СоздатьОбъект("Текст");
		ФайлПротоколаДанных.КодоваяСтраница(0);
		//ФайлПротоколаДанных.Открыть(ИмяФайлаПротоколаОбмена);
		//Новый ЗаписьТекста(ИмяФайлаПротоколаОбмена, КодировкаТекста.ANSI, , ДописыватьДанныеВПротоколОбмена);
	Исключение
		ФайлПротоколаДанных = ПолучитьПустоеЗначение();
		ВрмОписаниеОшибки = ОписаниеОшибки();
		СтрокаСообщения = Шаблон("Ошибка при попытке записи в файл протокола данных: '[ИмяФайлаПротоколаОбмена]'. Описание ошибки: [ВрмОписаниеОшибки]");
		ЗаписьЖурналаРегистрацииОбменДанными(СтрокаСообщения, 3);
	КонецПопытки;
	
КонецПроцедуры

Процедура ЗавершитьВедениеПротоколаОбмена()
	
	Если ФайлПротоколаДанных = ПолучитьПустоеЗначение() Тогда
		
		Возврат;
				
	КонецЕсли;

	Попытка
		ФайлПротоколаДанных.Записать(ИмяФайлаПротоколаОбмена);
	Исключение
		ФайлПротоколаДанных = ПолучитьПустоеЗначение();
		ВрмОписаниеОшибки = ОписаниеОшибки();
		СтрокаСообщения = Шаблон("Ошибка при попытке записи в файл протокола данных: '[ИмяФайлаПротоколаОбмена]'. Описание ошибки: [ВрмОписаниеОшибки]");
		ЗаписьЖурналаРегистрацииОбменДанными(СтрокаСообщения, 3);
	КонецПопытки;

	ФайлПротоколаДанных = ПолучитьПустоеЗначение()
	
КонецПроцедуры

// Сохраняет в протокол выполнения (или выводит на экран) сообщения указанной структуры.
//
// Параметры:
//  Код               - Число. Код сообщения.
//  СтруктураЗаписи   - Структура. Структура записи протокола.
//  ВзвестиФлагОшибок - Если истина, то - это сообщение об ошибке. Взводится ФлагОшибки.
// 
Функция ЗаписатьВПротоколВыполнения(Код = "",
	СтруктураЗаписи=0,
	ВзвестиФлагОшибок=1,
	Уровень=0,
	Выравнивание=22,
	БезусловнаяЗаписьВПротоколОбмена = 0,
	Знач РезультатВыполненияОбмена = 0) Экспорт
//
	Отступ = "";
	Для Сч = 0 По Уровень-1 Цикл
	Отступ = Отступ + СимволТабуляции;
	КонецЦикла; 

	Если ТипЗначенияСтр(Код) = "Число" Тогда
		
		Если мСообщенияОбОшибках.РазмерСписка() = 0 Тогда
			ИнициализацияСообщений();
		КонецЕсли;
		
		Стр = "";
		Попытка
			
			Стр = мСообщенияОбОшибках.Получить(Код);
		Исключение
			// СписокЗначенийВXML(мСообщенияОбОшибках, "z:\debug_мСообщенияОбОшибках.xml");

			// Сообщить(Шаблон("Индекс ошибки{[Код]}. [ОписаниеОшибки()])"));
		КонецПопытки;

		
		
	Иначе
		
		Стр = Строка(Код);
		
	КонецЕсли;

	Стр = Отступ + Стр;
	
	Если ПустоеЗначение(СтруктураЗаписи) = 0 Тогда
		
		Для ВрмИндексЗаписи = 1 По СтруктураЗаписи.РазмерСписка() Цикл
			
			Ключ = "";
			Значение = СтруктураЗаписи.ПолучитьЗначение(ВрмИндексЗаписи, Ключ);
			Если ПустоеЗначение(Значение) = 1 Тогда
				Продолжить;
			КонецЕсли; 
			Стр  = Стр + РазделительСтрок + Отступ + СимволТабуляции + одДополнитьСтроку(Ключ, Выравнивание) + " =  " + Строка(Значение);
			
		КонецЦикла;
		
	КонецЕсли;
	
	ЛитералПеревода = ?(ПустаяСтрока(СтрокаСообщенияОбОшибке()) = 1, "", РазделительСтрок);
	
	ПолеСтрокаСообщенияОбОшибке = Стр;
	
	Если ВзвестиФлагОшибок = 1 Тогда
		
		УстановитьФлагОшибки();
		
		// РезультатВыполненияОбмена = ?(РезультатВыполненияОбмена = Неопределено,
		// 								Перечисления.РезультатыВыполненияОбмена.Ошибка,
		// 								РезультатВыполненияОбмена);
		//
	КонецЕсли;
	
	// УстановитьРезультатВыполненияОбмена(РезультатВыполненияОбмена);
	
	Если ПустоеЗначение(ФайлПротоколаДанных) = 0 Тогда
		
		Если ВзвестиФлагОшибок = 1 Тогда
			
			// ФайлПротоколаДанных.ДобавитьСтроку(РазделительСтрок + "Ошибка.");
			ФайлПротоколаДанных.ДобавитьСтроку("Ошибка.");
			
		КонецЕсли;
		
		//Если ВзвестиФлагОшибок = 1 ИЛИ БезусловнаяЗаписьВПротоколОбмена = 1 ИЛИ ВыводВПротоколИнформационныхСообщений = 1 Тогда
		Если (ВзвестиФлагОшибок + БезусловнаяЗаписьВПротоколОбмена + ВыводВПротоколИнформационныхСообщений) > 0 Тогда
			
			//ФайлПротоколаДанных.ДобавитьСтроку(РазделительСтрок + СтрокаСообщенияОбОшибке());
			ФайлПротоколаДанных.ДобавитьСтроку(СтрокаСообщенияОбОшибке());
		
		КонецЕсли;
		
	КонецЕсли;
	
	Если РезультатВыполненияОбмена = 0 Тогда
		
		УровеньЖР = 5;
		
	Иначе
		
		УровеньЖР = 3;
		
	КонецЕсли;
	
	// Фиксируем событие в журнале регистрации.
	ЗаписьЖурналаРегистрацииОбменДанными(СтрокаСообщенияОбОшибке(), УровеньЖР);
	
	Возврат СтрокаСообщенияОбОшибке();

КонецФункции

Функция ЗаписатьИнформациюОбОшибкеВПротокол(КСообщенияОбОшибках, СтрокаОшибки, Объект, ТипОбъекта = "")

	ЗП         = ПолучитьСтруктуруЗаписиПротокола(КСообщенияОбОшибках, СтрокаОшибки);
	ЗП.Установить("Объект", Объект);

	Если ПустаяСтрока(ТипОбъекта) = 0 Тогда
		ЗП.Установить("ТипОбъекта", ТипОбъекта);
	КонецЕсли;	

	СтрокаОшибки = ЗаписатьВПротоколВыполнения(КСообщенияОбОшибках, ЗП);	

	Возврат СтрокаОшибки;

КонецФункции

Процедура ЗаписатьИнформациюОбОшибкеОбработчикаОчисткиДанных(КСообщенияОбОшибках, СтрокаОшибки, ИмяПравилаОчисткиДанных, Объект = "", ИмяОбработчика = "")

	ЗП                        = ПолучитьСтруктуруЗаписиПротокола(КСообщенияОбОшибках, СтрокаОшибки);
	ЗП.Установить("ПОД", ИмяПравилаОчисткиДанных);

	Если Объект <> "" Тогда
	ЗП.Установить("Объект", Строка(Объект) + "  (" + ТипЗначенияСтр(Объект) + ")");
	КонецЕсли;

	Если ИмяОбработчика <> "" Тогда
	ЗП.Установить("Обработчик", ИмяОбработчика);
	КонецЕсли;

	СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(КСообщенияОбОшибках, ЗП);

	// Если ПродолжитьПриОшибке = 0 Тогда
	// 	ВызватьИсключение СтрокаСообщенияОбОшибке;
	// КонецЕсли;

КонецПроцедуры

Процедура ЗаписатьИнформациюОбОшибкеЗагрузкиОбработчикаПКО(КСообщенияОбОшибках, СтрокаОшибки, ИмяПравила, Источник = "", 
ТипОбъекта, Объект = 0, ИмяОбработчика)

	ЗП                        = ПолучитьСтруктуруЗаписиПротокола(КСообщенияОбОшибках, СтрокаОшибки);
	ЗП.Установить("ИмяПКО", ИмяПравила);
	ЗП.Установить("ТипОбъекта", ТипОбъекта);
	ЗП.Установить("Обработчик", ИмяОбработчика);

	Если ПустаяСтрока(Источник) = 0 Тогда

		ЗП.Установить("Источник", Источник);

	КонецЕсли;

	Если ПустоеЗначение(Объект) = 0 Тогда

		ЗП.Установить("Объект", Строка(Объект));

	КонецЕсли;

	СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(КСообщенияОбОшибках, ЗП);

	// Если ПродолжитьПриОшибке = 0 Тогда
	// 	ВызватьИсключение СтрокаСообщенияОбОшибке;
	// КонецЕсли;

КонецПроцедуры

Процедура ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(КСообщенияОбОшибках, СтрокаОшибки, ПКО, Источник, ИмяОбработчика)

	ЗП                        = ПолучитьСтруктуруЗаписиПротокола(КСообщенияОбОшибках, СтрокаОшибки);
	ЗП.Установить("ПКО", ПКО.Имя + "  (" + ПКО.Наименование + ")");

	Попытка
		ЗП.Установить("Объект", Строка(Источник) + "  (" + ТипЗначенияСтр(Источник) + ")");
	Исключение
		ЗП.Установить("Объект", "(" + ТипЗначенияСтр(Источник) + ")");
	КонецПопытки;

	ЗП.Установить("Обработчик", ИмяОбработчика);

	СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(КСообщенияОбОшибках, ЗП);

	// Если ПродолжитьПриОшибке = 0 Тогда
	// 	ВызватьИсключение СтрокаСообщенияОбОшибке;
	// КонецЕсли;

КонецПроцедуры

Процедура ЗаписатьИнформациюОбОшибкеОбработчикиПКС(КСообщенияОбОшибках, СтрокаОшибки, ПКО, ПКС, Источник = "", 
ИмяОбработчика = "", Значение = 0)

	ЗП                        = ПолучитьСтруктуруЗаписиПротокола(КСообщенияОбОшибках, СтрокаОшибки);
	ЗП.Установить("ПКО", ПКО.Имя + "  (" + ПКО.Наименование + ")");
	ЗП.Установить("ПКС", ПКС.Имя + "  (" + ПКС.Наименование + ")");

	Попытка
		ЗП.Установить("Объект", Строка(Источник) + "  (" + ТипЗначенияСтр(Источник) + ")");
	Исключение
		ЗП.Установить("Объект", "(" + ТипЗначенияСтр(Источник) + ")");
	КонецПопытки;

	ЗП.Установить("СвойствоПриемника", ПКС.Приемник + "  (" + ПКС.ТипПриемника + ")");

	Если ИмяОбработчика <> "" Тогда
		ЗП.Установить("Обработчик", ИмяОбработчика);
	КонецЕсли;

	Если ПустоеЗначение(Значение) = 0 Тогда
		ЗП.Установить("КонвертируемоеЗначение", Строка(Значение) + "  (" + ТипЗначенияСтр(Значение) + ")");
	КонецЕсли;

	СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(КСообщенияОбОшибках, ЗП);

	// Если ПродолжитьПриОшибке = 0 Тогда
	// 	ВызватьИсключение СтрокаСообщенияОбОшибке;
	// КонецЕсли;

КонецПроцедуры	

Процедура ЗаписатьИнформациюОбОшибкеОбработчикиПВД(КСообщенияОбОшибках, СтрокаОшибки, ИмяПравила, ИмяОбработчика, Объект = 0)

	ЗП                        = ПолучитьСтруктуруЗаписиПротокола(КСообщенияОбОшибках, СтрокаОшибки);
	ЗП.Установить("ПВД", ИмяПравила);

	Если ПустоеЗначение(Объект) = 0 Тогда
		ЗП.Установить("Объект", Строка(Объект) + "  (" + ТипЗначенияСтр(Объект) + ")");
	КонецЕсли;

	ЗП.Установить("Обработчик", ИмяОбработчика);

	СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(КСообщенияОбОшибках, ЗП);

	// Если ПродолжитьПриОшибке = 0 Тогда
	// 	ВызватьИсключение СтрокаСообщенияОбОшибке;
	// КонецЕсли;

КонецПроцедуры

Функция ЗаписатьИнформациюОбОшибкеОбработчикиКонвертации(КСообщенияОбОшибках, СтрокаОшибки, ИмяОбработчика)

	ЗП                        = ПолучитьСтруктуруЗаписиПротокола(КСообщенияОбОшибках, СтрокаОшибки);
	ЗП.Установить("Обработчик", ИмяОбработчика);
	СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(КСообщенияОбОшибках, ЗП);
	Возврат СтрокаСообщенияОбОшибке;

КонецФункции

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ВывестиСообщение(ТекстСообщения, СтатусСообщения = " ")
	
	Сообщить(ТекстСообщения, СтатусСообщения);
	
КонецПроцедуры // ВывестиСообщение()

Процедура ВывестиСостояние(ТекстСостояние)
	
	Если мВыводСообщений = 1 Тогда
		Состояние(ТекстСостояние);
	КонецЕсли;
	
КонецПроцедуры

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПривестиБулевоКЗначению(Булево)
	
	Если Врег(Булево) = "TRUE" Тогда
		
		Возврат 1;
	
	ИначеЕсли Врег(Булево) = "FALSE" Тогда
		
		Возврат 0;
	
	Иначе
		
		Возврат 0;
		
	КонецЕсли;

КонецФункции // ПривестиБулевоКЗначению()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПривестиЗначениеКБулево(Значение)
	
	Если Число(Значение) > 0 Тогда
		
		Возврат "true";
		
	Иначе
		
		Возврат "false";
		
	КонецЕсли;
	
КонецФункции // ПривестиЗначениеКБулево()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПроверитьИмяТипУзла(Узел, ПроверяемоеИмя = "", ТипТега = "", ПроверяемыйТип = "")
	
	Если (ТипТега <> "") И (ПроверяемыйТип <> "") Тогда
		
		Если ТипТега = ПроверяемыйТип Тогда
			
			Если ПроверяемоеИмя <> "" Тогда
				
				Если Узел.СвойстваТекущегоУзла.Имя = ПроверяемоеИмя Тогда
					
					Возврат 1;
					
				Иначе
					
					Возврат 0;
				
				КонецЕсли;
			
			Иначе
				
				Возврат 1;
				
			КонецЕсли;
			
		Иначе
			
			Возврат 0;
			
		КонецЕсли;
		
	Иначе
		
		Если ПроверяемоеИмя <> "" Тогда
			
			Если Узел.СвойстваТекущегоУзла.Имя = ПроверяемоеИмя Тогда
				
				Возврат 1;
				
			Иначе
				
				Возврат 0;
			
			КонецЕсли;
		
		Иначе
			
			ВывестиСообщение("Неверно переданы параметры в функцию ""ПроверитьИмяТипУзла"".", "!!!");
			Возврат 0;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецФункции // ПроверитьИмяТипУзла()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПолучитьДатуV8(ЧастьДата, ЧастьВремя = "00:00:00")
	
	Если (ПустоеЗначение(ЧастьДата) = 1) ИЛИ (ЧастьДата = Дата(1,1,1)) Тогда
		Возврат "0001-01-01T" + ЧастьВремя;
		
	Иначе
		// Год может быть введен неверно
		Год = ДатаГод(ЧастьДата);
		
		// Возможно случайно ошиблись и не доввели дату
		Если Год < 30 Тогда
			Год = 2000 + Год;
			
		ИначеЕсли Год < 100 Тогда
			Год = 1900 + Год;
			
		ИначеЕсли Год < 1000 Тогда
			Год = 1000 + Год;
			
		КонецЕсли;
		
		// Если исправления не помогли, тогда вернем пустой год
		// Иначе данные просто не загрузятся
		Если Год < 1900 Тогда
			Возврат "0001-01-01T" + ЧастьВремя;
		КонецЕсли;
		
		Возврат "" + Год + "-" + Формат(ДатаМесяц(ЧастьДата),"Ч(0)2") + "-" + Формат(ДатаЧисло(ЧастьДата),"Ч(0)2") + "T" + ЧастьВремя;
	
	КонецЕсли;

КонецФункции // ПолучитьДатуV8()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПолучитьПрефиксЧислоНомера(Знач Стр, ЧисловаяЧасть = "", Режим = "")

	Стр	= СокрЛП(Стр);
	Префикс	= Стр;
	Длина = СтрДлина(Стр);
	
	Для Сч = 1 По Длина Цикл
		
		ЧисловаяЧасть = Число(Стр);
		
	    Если (ЧисловаяЧасть > 0) И (СтрДлина(ЧисловаяЧасть) = Длина - Сч + 1) Тогда 
			
			Префикс	= Лев(Префикс, Сч - 1);
			
			Пока Прав(Префикс, 1) = "0" Цикл
			    
				Префикс = Лев(Префикс, СтрДлина(Префикс)-1);
				
			КонецЦикла;
			
			Прервать;		    				
	    Иначе
			
			Стр = Прав(Стр, Длина - Сч);
			
		КонецЕсли;
		
		Если ЧисловаяЧасть < 0 Тогда
			
			ЧисловаяЧасть = - ЧисловаяЧасть;
			
		КонецЕсли;
			
	КонецЦикла;
	              
	Если Режим = "Число" Тогда
	    
		Возврат(ЧисловаяЧасть);
		
	Иначе
		
		Возврат(Префикс);
		
	КонецЕсли;

КонецФункции // ПолучитьПрефиксЧислоНомера()

// Добавляет к префиксу номера или кода подстроку
//
// Параметры:
//  Стр          - Строка. Номер или код;
//  Добавок      - добаляемая к префиксу подстрока;
//  Длина        - требуемая результрирующая длина строки;
//  Режим        - "Слева" - подстрока добавляется слева к префиксу, иначе - справа.
//
// Возвращаемое значение:
//  Строка       - номер или код, к префиксу которого добавлена указанная подстрока.
//
Функция ДобавитьКПрефиксу(Знач Стр, Добавок = "", Длина = "", Режим = "Слева")

	Стр = СтрЗаменить(СокрЛП(Стр)," ","");

	Если ПустаяСтрока(Длина) = 1 Тогда
		Длина = СтрДлина(Стр);
	КонецЕсли;

	ЧисловаяЧасть   = "";
	Префикс         = ПолучитьПрефиксЧислоНомера(Стр, ЧисловаяЧасть);

	Если Режим = "Слева" Тогда
		Результат = СокрЛП(Добавок) + Префикс;
	Иначе
		Результат = Префикс + СокрЛП(Добавок);
	КонецЕсли;

	Пока Длина - СтрДлина(Результат) - СтрДлина(СтрЗаменить(СокрЛП(ЧисловаяЧасть)," ","")) > 0 Цикл
		Результат = Результат + "0";
	КонецЦикла;

	Результат = Результат + СтрЗаменить(СокрЛП(ЧисловаяЧасть)," ","");

	Возврат(Результат);

КонецФункции // ДобавитьКПрефиксу()


//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПривестиНомерКДлине(Знач Стр, Длина)

	Стр = СокрЛП(Стр);

	ЧисловаяЧасть = "";
	Результат = ПолучитьПрефиксЧислоНомера(Стр, ЧисловаяЧасть);

	Пока Длина - СтрДлина(Результат) - СтрДлина(ЧисловаяЧасть) > 0 Цикл
		
		Результат = Результат + "0";
		
	КонецЦикла;

	Результат = Результат + ЧисловаяЧасть;

	Возврат(Результат);

КонецФункции // ПривестиНомерКДлине()


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ РАБОТЫ С ПРАВИЛАМИ
////////////////////////////////////////////////////////////////////////////////

// Инициализирует переменную СообщенияОбОшибках, содержащую соответствия кодов сообщений их описаниям.
//
// Параметры:
//  Нет.
// 
Процедура ИнициализацияСообщений()

	мСообщенияОбОшибках			= СоздатьОбъект("СписокЗначений");
		
	мСообщенияОбОшибках.Установить(2, "Ошибка распаковки файла обмена. Файл заблокирован.");
	мСообщенияОбОшибках.Установить(3, "Указанный файл правил обмена не существует.");
	мСообщенияОбОшибках.Установить(4, "Ошибка при создании COM-объекта Msxml2.DOMDocument");
	мСообщенияОбОшибках.Установить(5, "Ошибка открытия файла обмена");
	мСообщенияОбОшибках.Установить(6, "Ошибка при загрузке правил обмена");
	мСообщенияОбОшибках.Установить(7, "Ошибка формата правил обмена");
	мСообщенияОбОшибках.Установить(8, "Некорректно указано имя файла для выгрузки данных"); // не используется
	мСообщенияОбОшибках.Установить(9, "Ошибка формата файла обмена");
	мСообщенияОбОшибках.Установить(10,"Не указано имя файла для выгрузки данных (Имя файла данных)");
	мСообщенияОбОшибках.Установить(11,"Ссылка на несуществующий объект метаданных в правилах обмена");
	мСообщенияОбОшибках.Установить(12,"Не указано имя файла с правилами обмена (Имя файла правил)");
			
	мСообщенияОбОшибках.Установить(13,"Ошибка получения значения свойства объекта (по имени свойства источника)");
	мСообщенияОбОшибках.Установить(14,"Ошибка получения значения свойства объекта (по имени свойства приемника)");
	
	мСообщенияОбОшибках.Установить(15,"Не указано имя файла для загрузки данных (Имя файла для загрузки)");
			
	мСообщенияОбОшибках.Установить(16,"Ошибка получения значения свойства подчиненного объекта (по имени свойства источника)");
	мСообщенияОбОшибках.Установить(17,"Ошибка получения значения свойства подчиненного объекта (по имени свойства приемника)");
	мСообщенияОбОшибках.Установить(18,"Ошибка при создании обработки с кодом обработчиков");
	мСообщенияОбОшибках.Установить(19,"Ошибка в обработчике события ПередЗагрузкойОбъекта");
	мСообщенияОбОшибках.Установить(20,"Ошибка в обработчике события ПриЗагрузкеОбъекта");
	мСообщенияОбОшибках.Установить(21,"Ошибка в обработчике события ПослеЗагрузкиОбъекта");
	мСообщенияОбОшибках.Установить(22,"Ошибка в обработчике события ПередЗагрузкойДанных (конвертация)");
	мСообщенияОбОшибках.Установить(23,"Ошибка в обработчике события ПослеЗагрузкиДанных (конвертация)");
	мСообщенияОбОшибках.Установить(24,"Ошибка при удалении объекта");
	мСообщенияОбОшибках.Установить(25,"Ошибка при записи документа");
	мСообщенияОбОшибках.Установить(26,"Ошибка записи объекта");
	мСообщенияОбОшибках.Установить(27,"Ошибка в обработчике события ПередОбработкойПравилаОчистки");
	мСообщенияОбОшибках.Установить(28,"Ошибка в обработчике события ПослеОбработкиПравилаОчистки");
	мСообщенияОбОшибках.Установить(29,"Ошибка в обработчике события ПередУдалениемОбъекта");
	
	мСообщенияОбОшибках.Установить(31,"Ошибка в обработчике события ПередОбработкойПравилаВыгрузки");
	мСообщенияОбОшибках.Установить(32,"Ошибка в обработчике события ПослеОбработкиПравилаВыгрузки");
	мСообщенияОбОшибках.Установить(33,"Ошибка в обработчике события ПередВыгрузкойОбъекта");
	мСообщенияОбОшибках.Установить(34,"Ошибка в обработчике события ПослеВыгрузкиОбъекта");
			
	мСообщенияОбОшибках.Установить(41,"Ошибка в обработчике события ПередВыгрузкойОбъекта");
	мСообщенияОбОшибках.Установить(42,"Ошибка в обработчике события ПриВыгрузкеОбъекта");
	мСообщенияОбОшибках.Установить(43,"Ошибка в обработчике события ПослеВыгрузкиОбъекта");
			
	мСообщенияОбОшибках.Установить(45,"Не найдено правило конвертации объектов");
		
	мСообщенияОбОшибках.Установить(48,"Ошибка в обработчике события ПередОбработкойВыгрузки группы свойств");
	мСообщенияОбОшибках.Установить(49,"Ошибка в обработчике события ПослеОбработкиВыгрузки группы свойств");
	мСообщенияОбОшибках.Установить(50,"Ошибка в обработчике события ПередВыгрузкой (объекта коллекции)");
	мСообщенияОбОшибках.Установить(51,"Ошибка в обработчике события ПриВыгрузке (объекта коллекции)");
	мСообщенияОбОшибках.Установить(52,"Ошибка в обработчике события ПослеВыгрузки (объекта коллекции)");
	мСообщенияОбОшибках.Установить(53,"Ошибка в глобальном обработчике события ПередЗагрузкойОбъекта (конвертация)");
	мСообщенияОбОшибках.Установить(54,"Ошибка в глобальном обработчике события ПослеЗагрузкиОбъекта (конвертация)");
	мСообщенияОбОшибках.Установить(55,"Ошибка в обработчике события ПередВыгрузкой (свойства)");
	мСообщенияОбОшибках.Установить(56,"Ошибка в обработчике события ПриВыгрузке (свойства)");
	мСообщенияОбОшибках.Установить(57,"Ошибка в обработчике события ПослеВыгрузки (свойства)");
	
	мСообщенияОбОшибках.Установить(62,"Ошибка в обработчике события ПередВыгрузкойДанных (конвертация)");
	мСообщенияОбОшибках.Установить(63,"Ошибка в обработчике события ПослеВыгрузкиДанных (конвертация)");
	мСообщенияОбОшибках.Установить(64,"Ошибка в глобальном обработчике события ПередКонвертациейОбъекта (конвертация)");
	мСообщенияОбОшибках.Установить(65,"Ошибка в глобальном обработчике события ПередВыгрузкойОбъекта (конвертация)");
	мСообщенияОбОшибках.Установить(66,"Ошибка получения коллекции подчиненных объектов из входящих данных");
	мСообщенияОбОшибках.Установить(67,"Ошибка получения свойства подчиненного объекта из входящих данных");
	мСообщенияОбОшибках.Установить(68,"Ошибка получения свойства объекта из входящих данных");
	
	мСообщенияОбОшибках.Установить(69,"Ошибка в глобальном обработчике события ПослеВыгрузкиОбъекта (конвертация)");
	
	мСообщенияОбОшибках.Установить(71,"Не найдено соответствие для значения Источника");
	
	мСообщенияОбОшибках.Установить(72,"Ошибка при выгрузке данных для узла плана обмена");
	
	мСообщенияОбОшибках.Установить(73,"Ошибка в обработчике события ПоследовательностьПолейПоиска");
	мСообщенияОбОшибках.Установить(74,"Необходимо перезагрузить правила обмена для выгрузки данных.");
	
	мСообщенияОбОшибках.Установить(75,"Ошибка в обработчике события ПослеЗагрузкиПравилОбмена (конвертация)");
	мСообщенияОбОшибках.Установить(76,"Ошибка в обработчике события ПередОтправкойИнформацииОбУдалении (конвертация)");
	мСообщенияОбОшибках.Установить(77,"Ошибка в обработчике события ПриПолученииИнформацииОбУдалении (конвертация)");
	
	мСообщенияОбОшибках.Установить(78,"Ошибка при выполнении алгоритма после загрузки значений параметров");
	
	мСообщенияОбОшибках.Установить(79,"Ошибка в обработчике события ПослеВыгрузкиОбъектаВФайл");
	
	мСообщенияОбОшибках.Установить(80,"Ошибка установки свойства предопределенного элемента.
		|Нельзя помечать на удаление предопределенный элемент. Пометка на удаление для объекта не установлена.");
	//
	мСообщенияОбОшибках.Установить(83,"Ошибка обращения к табличной части объекта. Табличная часть объекта не может быть изменена.");
	мСообщенияОбОшибках.Установить(84,"Коллизия дат запрета изменения.");
	
	мСообщенияОбОшибках.Установить(173,"Ошибка блокировки узла обмена. Возможно синхронизация данных уже выполняется");
	мСообщенияОбОшибках.Установить(174,"Сообщение обмена было принято ранее");
	мСообщенияОбОшибках.Установить(175,"Ошибка в обработчике события ПередПолучениемИзмененныхОбъектов (конвертация)");
	мСообщенияОбОшибках.Установить(176,"Ошибка в обработчике события ПослеПолученияИнформацииОбУзлахОбмена (конвертация)");
		
	мСообщенияОбОшибках.Установить(1000,"Ошибка при создании временного файла выгрузки данных");
		
КонецПроцедуры

Процедура ИнициализироватьМенеджерыИСообщения()

	Если ФС.СуществуетФайл(мИмяФайлаРегистрСоответствия) = 0 Тогда

		СоздатьРегистрСоответствий();
		// ФайлДбф = СоздатьОбъект("XBASE");
		// ФайлДбф.ДобавитьПоле("ref77","S",36,0);
		// ФайлДбф.ДобавитьПоле("ref8","S",36,0);
		
		// ФайлДбф.СоздатьФайл(мИмяФайлаРегистрСоответствия, мИмяФайлаИндексаРегистрСоответствия);
		// ФайлДбф.СоздатьФайл(мИмяФайлаРегистрСоответствия);
		// ФайлДбф.ЗакрытьФайл();
		// Сообщить("Создано хранилище соответствий: " + мИмяФайлаРегистрСоответствия);
		// ФайлДбф = ПолучитьПустоеЗначение();
	// Иначе
	// 	ФайлДбф.ОткрытьФайл(мИмяФайлаРегистрСоответствия, мИмяФайлаИндексаРегистрСоответствия, 0);
	КонецЕсли;
	
	// Если ФС.СуществуетФайл(мИмяФайлаИндексаРегистрСоответствия) = 0 Тогда
	// 	СоздатьИндекс();
	// КонецЕсли;

	// Если ФайлДбф.Открыта() = 0 Тогда
	// 	Сообщить("Ошибка открытия файла: " + ИмяФайлаДБФ);
	// 	СоздатьИндекс();
	// 	Сообщить("Попробуйте ещё раз...");
	// 	СтатусВозврата(0);
	// 	Возврат;
	// КонецЕсли;

	мТабЗагруженныхОбъектов	=	СоздатьОбъект("ТаблицаЗначений");
	мТабЗагруженныхОбъектов.НоваяКолонка("Вид",			"Строка");
	мТабЗагруженныхОбъектов.НоваяКолонка("ТабОбъектов",	"ТаблицаЗначений");

	мЗапоминатьЗагруженныеОбъекты = 1;
	// Если Менеджеры = Неопределено Тогда
	// 	ИнициализацияМенеджеров();
	// КонецЕсли; 

	Если мСообщенияОбОшибках.РазмерСписка() = 0 Тогда
		ИнициализацияСообщений();
	КонецЕсли;
	
КонецПроцедуры

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ИнициализацияТаблицыПравилВыгрузки()
	
	мТаблицаПравилВыгрузки = СоздатьОбъект("ТаблицаЗначений");
	
	мТаблицаПравилВыгрузки.НоваяКолонка("Включить"); // v8 Включить
	мТаблицаПравилВыгрузки.НоваяКолонка("ЭтоГруппа"); // v8 ---
	мТаблицаПравилВыгрузки.НоваяКолонка("Родитель"); // v8 ---
	мТаблицаПравилВыгрузки.НоваяКолонка("Уровень"); // v8 ---
	
	мТаблицаПравилВыгрузки.НоваяКолонка("Код"); // v8 Имя
	мТаблицаПравилВыгрузки.НоваяКолонка("Наименование");
	мТаблицаПравилВыгрузки.НоваяКолонка("Порядок", "Число", 10, 0);
	
	мТаблицаПравилВыгрузки.НоваяКолонка("СпособОтбораДанных");
	мТаблицаПравилВыгрузки.НоваяКолонка("ОбъектВыборки");
	мТаблицаПравилВыгрузки.НоваяКолонка("ОбъектВыборкиМетаданные"); // v8 

	мТаблицаПравилВыгрузки.НоваяКолонка("КодПравилаКонвертации"); // v8 ПравилоКонвертации
	
	мТаблицаПравилВыгрузки.НоваяКолонка("ПередОбработкойПравила", "Число", 1, 0); // v8 ПередОбработкой
	мТаблицаПравилВыгрузки.НоваяКолонка("ИмяОбработчикаПередОбработкой"); // v8
	мТаблицаПравилВыгрузки.НоваяКолонка("ПослеОбработкиПравила", "Число", 1, 0);  // v8 ПослеОбработки
	мТаблицаПравилВыгрузки.НоваяКолонка("ИмяОбработчикаПослеОбработки"); // v8

	мТаблицаПравилВыгрузки.НоваяКолонка("ПередВыгрузкойОбъекта", "Число", 1, 0); // v8 ПередВыгрузкой
	мТаблицаПравилВыгрузки.НоваяКолонка("ИмяОбработчикаПередВыгрузкой"); // v8
	мТаблицаПравилВыгрузки.НоваяКолонка("ПослеВыгрузкиОбъекта", "Число", 1, 0); // v8 ПослеВыгрузки
	мТаблицаПравилВыгрузки.НоваяКолонка("ИмяОбработчикаПослеВыгрузки"); // v8

	мТаблицаПравилВыгрузки.НоваяКолонка("НомерГруппы", "Число", 5, 0); // v8 ---
	
	мТаблицаПравилВыгрузки.НоваяКолонка("Отбор"); // v8 ---
	
	мТаблицаПравилВыгрузки.НоваяКолонка("Комментарий"); // v8 ---
	мТаблицаПравилВыгрузки.НоваяКолонка("Описание"); // v8 ---
	
	мТаблицаПравилВыгрузки.НоваяКолонка("НеВыгружатьОбъектыСозданныеВБазеПриемнике", "Число", 1, 0); // v8
	мТаблицаПравилВыгрузки.НоваяКолонка("СинхронизироватьПоИдентификатору", "Число", 1, 0); // v8

КонецПроцедуры // ИнициализацияПравилВыгрузки()

// Инициализирует колонки таблицы правил очистки данных.
//
// Параметры:
//  Нет.
// 
Процедура ИнициализацияТаблицыПравилОчистки()

	мТаблицаПравилОчистки = СоздатьОбъект("ТаблицаЗначений");

	мТаблицаПравилОчистки.НоваяКолонка("Включить", "Число", 1, 0); // v8
	мТаблицаПравилОчистки.НоваяКолонка("ЭтоГруппа", "Число", 1, 0); // v8

	мТаблицаПравилОчистки.НоваяКолонка("Имя"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("Наименование"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("Порядок", "Число", 10, 0); // v8
	
	мТаблицаПравилОчистки.НоваяКолонка("СпособОтбораДанных"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("ОбъектВыборки"); // v8
	
	мТаблицаПравилОчистки.НоваяКолонка("УдалятьЗаПериод"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("Непосредственно", "Число", 1, 0); // v8

	мТаблицаПравилОчистки.НоваяКолонка("ПередОбработкой"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("ИмяОбработчикаПередОбработкой"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("ПослеОбработки"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("ИмяОбработчикаПослеОбработки"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("ПередУдалением"); // v8
	мТаблицаПравилОчистки.НоваяКолонка("ИмяОбработчикаПередУдалением"); // v8

КонецПроцедуры

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ИнициализацияТаблицыПравилКонвертации()
	
	мТаблицаПравилКонвертацииОбъектов = СоздатьОбъект("ТаблицаЗначений");
	
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Код"); // v8 Имя
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Наименование");
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Порядок", "Число", 10, 0);

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЭтоГруппа", "Число", 1, 0); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЭтоПолеПоиска", "Число", 1, 0); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПравилаГруппы"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПравилаГруппыОтключенные"); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ВидИсточника"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ВидПриемника"); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("УпрощеннаяВыгрузкаСвойства", "Число", 1, 0); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("НуженУзелXMLПриВыгрузке", "Число", 1, 0); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("НуженУзелXMLПриВыгрузкеГруппы", "Число", 1, 0); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ТипИсточника"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ТипПриемника"); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Источник");
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Приемник");

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("КодПравилаКонвертации"); // v8 ПравилоКонвертации

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПолучитьИзВходящихДанных", "Число", 1, 0); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("НеЗамещать", "Число", 1, 0);
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЭтоОбязательноеСвойство", "Число", 1, 0); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("СинхронизироватьПоИдентификатору", "Число", 1, 0); // v8 ---

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПередВыгрузкой", "Число", 1, 0);
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ИмяОбработчикаПередВыгрузкой"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПриВыгрузке", "Число", 1, 0);
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ИмяОбработчикаПриВыгрузке"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПослеВыгрузки", "Число", 1, 0);
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ИмяОбработчикаПослеВыгрузки"); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПослеВыгрузкиВФайл", "Число", 1, 0); // v8 ---
	
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПередОбработкойВыгрузки"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ИмяОбработчикаПередОбработкойВыгрузки"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПослеОбработкиВыгрузки"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ИмяОбработчикаПослеОбработкиВыгрузки"); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЕстьОбработчикПередВыгрузкой", "Число", 1, 0); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЕстьОбработчикПриВыгрузке", "Число", 1, 0); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЕстьОбработчикПослеВыгрузки", "Число", 1, 0); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЕстьОбработчикПередОбработкойВыгрузки", "Число", 1, 0); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЕстьОбработчикПослеОбработкиВыгрузки", "Число", 1, 0); // v8
	
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПриводитьКДлине"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ИмяПараметраДляПередачи"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПоискПоДатеНаРавенство", "Число", 1, 0); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ВыгружатьГруппуЧерезФайл", "Число", 1, 0); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("СтрокаПолейПоиска"); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПередЗагрузкой"); // v8 ---
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПриЗагрузке"); // v8 ---
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПослеЗагрузки"); // v8 ---

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("СвойстваПоиска"); // v8 ---
	
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Свойства"); // v8 ---
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("СвойстваОтключенные"); // v8 ---
	
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Значения"); // v8 ---

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЗначенияПредопределенныхДанных"); // v8
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ЗначенияПредопределенныхДанныхПрочитанные"); // v8

	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Выгруженные"); // v8 ---
	
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("НеЗапоминатьВыгруженные", "Число", 1, 0); // v8 ---
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("НеВыгружатьОбъектыСвойствПоСсылкам", "Число", 1, 0); // v8 ---
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ВсеОбъектыВыгружены", "Число", 1, 0); // v8 ---
	
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПоследовательностьПолейПоиска"); // v8 ---
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли", "Число", 1, 0); // v8 ---
	
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("ГенерироватьНовыйНомерИлиКодЕслиНеУказан", "Число", 1, 0); // v8 ---
	мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("НеСоздаватьЕслиНеНайден", "Число", 1, 0); // v8 ---

КонецПроцедуры // ИнициализацияПравилКонвертацииОбъектов()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ИнициализацияПравилКонвертацииСвойств()
	
	ТаблицаПравилКонвертацииСвойств = СоздатьОбъект("ТаблицаЗначений");
	
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("Код"); // v8 - Имя
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("Наименование");
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("Порядок", "Число", 10, 0);

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ЭтоГруппа", "Число", 1, 0);
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ЭтоПолеПоиска", "Число", 1, 0); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("СвойстваГруппы"); // v8 - ПравилаГруппы
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПравилаГруппыОтключенные"); // v8

	
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ВидИсточника");
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ВидПриемника");

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("УпрощеннаяВыгрузкаСвойства", "Число", 1, 0); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("НуженУзелXMLПриВыгрузке", "Число", 1, 0); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("НуженУзелXMLПриВыгрузкеГруппы", "Число", 1, 0); // v8

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ТипИсточника");
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ТипПриемника");

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("Источник");
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("Приемник");

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("КодПравилаКонвертации"); // v8 - ПравилоКонвертации

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПолучитьИзВходящихДанных", "Число", 1, 0);
	
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("НеЗамещать", "Число", 1, 0);
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ЭтоОбязательноеСвойство", "Число", 1, 0); // v8
	
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПередВыгрузкой", "Число", 1, 0);
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ИмяОбработчикаПередВыгрузкой"); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПриВыгрузке", "Число", 1, 0);
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ИмяОбработчикаПриВыгрузке"); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПослеВыгрузки", "Число", 1, 0);
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ИмяОбработчикаПослеВыгрузки"); // v8

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПередОбработкойВыгрузки", "Число", 1, 0);
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ИмяОбработчикаПередОбработкойВыгрузки"); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПослеОбработкиВыгрузки", "Число", 1, 0);
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ИмяОбработчикаПослеОбработкиВыгрузки"); // v8

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ЕстьОбработчикПередВыгрузкой", "Число", 1, 0); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ЕстьОбработчикПриВыгрузке", "Число", 1, 0); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ЕстьОбработчикПослеВыгрузки", "Число", 1, 0); // v8

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ЕстьОбработчикПередОбработкойВыгрузки", "Число", 1, 0); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ЕстьОбработчикПослеОбработкиВыгрузки", "Число", 1, 0); // v8

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПриводитьКДлине", "Число", 1, 0); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ИмяПараметраДляПередачи"); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ПоискПоДатеНаРавенство", "Число", 1, 0); // v8
	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("ВыгружатьГруппуЧерезФайл", "Число", 1, 0); // v8

	ТаблицаПравилКонвертацииСвойств.НоваяКолонка("СтрокаПолейПоиска"); // v8
	
	Возврат ТаблицаПравилКонвертацииСвойств;

КонецФункции // ИнициализацияПравилКонвертацииСвойств()

//******************************************************************************
//
// Инициализирует колонки таблицы настройки параметров
//
// Параметры:
//  Нет.
// 
Процедура ИнициализацияТаблицыНастройкиПараметров()

	мТаблицаНастройкиПараметров = СоздатьОбъект("ТаблицаЗначений");

	мТаблицаНастройкиПараметров.НоваяКолонка("Имя"); 
	мТаблицаНастройкиПараметров.НоваяКолонка("Наименование"); 
	мТаблицаНастройкиПараметров.НоваяКолонка("Значение");
	мТаблицаНастройкиПараметров.НоваяКолонка("ПередаватьПараметрПриВыгрузке"); // v8
	мТаблицаНастройкиПараметров.НоваяКолонка("ПравилоКонвертации"); // v8
	мТаблицаНастройкиПараметров.НоваяКолонка("ТипЗначения"); // v8 ---
	мТаблицаНастройкиПараметров.НоваяКолонка("ВидЗначения"); // v8 ---
	// мТаблицаНастройкиПараметров.ВидимостьКолонки("Имя",0,); 
	// мТаблицаНастройкиПараметров.ВидимостьКолонки("ТипЗначения",0,); 
	// мТаблицаНастройкиПараметров.ВидимостьКолонки("ВидЗначения",0,);

КонецПроцедуры // ИнициализацияТаблицыПравилОчистки()

Процедура ИнициализацияТаблицыЗамеров()

	мТаблицаЗамеров = СоздатьОбъект("ТаблицаЗначений");

	мТаблицаЗамеров.НоваяКолонка("Функция");
	мТаблицаЗамеров.НоваяКолонка("Замер");
	мТаблицаЗамеров.НоваяКолонка("Количество", "Число", 10, 0);
	мТаблицаЗамеров.НоваяКолонка("Время");

КонецПроцедуры // ИнициализацияТаблицыПравилОчистки()

Функция НачатьЗамер(ВхФункция, ВхКомментарий = "")

	Возврат 0;

	ВрмИндексСтроки = 0;

	Если мТаблицаЗамеров.НайтиЗначение(ВхФункция, ВрмИндексСтроки, "Функция") = 1 Тогда
		мТаблицаЗамеров.ПолучитьСтрокуПоНомеру(ВрмИндексСтроки);
	Иначе
		мТаблицаЗамеров.НоваяСтрока();
		ВрмИндексСтроки = мТаблицаЗамеров.КоличествоСтрок();
		мТаблицаЗамеров.ПолучитьСтрокуПоНомеру(ВрмИндексСтроки);
		мТаблицаЗамеров.Функция = ВхФункция;
		мТаблицаЗамеров.Замер = ЗначениеИзСтрокиВнутр("{""VL"",{}}");
	КонецЕсли;

	ВрмЗамер = мТаблицаЗамеров.Замер;
	ВрмИндексЗамер = ВрмЗамер.РазмерСписка() + 1;

	ВрмТекущийЗамер = ЗначениеИзСтрокиВнутр("{""VL"",{}}");
	ВрмТекущийЗамер.Установить("Н", _getperformancecounter());
	ВрмТекущийЗамер.Установить("Комментарий", """" + ВхКомментарий + """");
	ВрмЗамер.ДобавитьЗначение(ВрмТекущийЗамер);

	ВрмВозврат = ЗначениеИзСтрокиВнутр("{""VL"",{}}");
	ВрмВозврат.Установить("Функция", ВхФункция);
	ВрмВозврат.Установить("ИндексЗамер", ВрмИндексЗамер);

	Возврат ВрмВозврат;

КонецФункции

Функция ЗавершитьЗамер(ВхЗамер)

	Возврат 0;

	ВрмИндексСтроки = 0;
	ВрмО = _getperformancecounter();
	
	ВрмФункция = ВхЗамер.Получить("Функция");
	ВрмИндексЗамер = ВхЗамер.Получить("ИндексЗамер");

	Если мТаблицаЗамеров.НайтиЗначение(ВрмФункция, ВрмИндексСтроки, "Функция") = 1 Тогда
		мТаблицаЗамеров.ПолучитьСтрокуПоНомеру(ВрмИндексСтроки);
	Иначе
		Сообщить("Ошибка поиска замера");
		Возврат 0;
	КонецЕсли;

	ВрмЗамер = мТаблицаЗамеров.Замер;
	ВрмТекущийЗамер = ВрмЗамер.ПолучитьЗначение(ВрмИндексЗамер);
	ВрмН = ВрмТекущийЗамер.Получить("Н");
	ВрмВремя = ВрмО - ВрмН;
	ВхКомментарий = ВрмТекущийЗамер.Получить("Комментарий");
	ВрмТекущийЗамер.Установить("О", ВрмО);
	ВрмТекущийЗамер.Установить("В", ВрмВремя);
	
	мТаблицаЗамеров.Количество = мТаблицаЗамеров.Количество + 1;
	мТаблицаЗамеров.Время = мТаблицаЗамеров.Время + ВрмВремя;
	
	ВрмЗамер.УстановитьЗначение(ВрмИндексЗамер, ВрмТекущийЗамер);

	txt = createobject("text");
	txt.CodePage(0);
	txt.Open("c:\self\1C\local_sql_khk\Exchange\EDI\Out\perf_mon.csv");
	
	txt.AddLine(Шаблон("[ВрмФункция];[ВрмН];[ВрмО];[ВрмВремя];""[ВхКомментарий]"""));
	txt.Write("c:\self\1C\local_sql_khk\Exchange\EDI\Out\perf_mon.csv");

	Возврат 1;

КонецФункции

Функция ПолучитьЗначениеУзлаИзXML()
	
	Узел = мЧтениеXML.ТекущийЭлементВВидеОбъекта();
	Значение = Узел.Значение;
	
	ПозицияПоиска = Найти(Значение, РазделительСтрок);
	
	Если (ПозицияПоиска > 0) Тогда
		Возврат Значение;
	Иначе
		
		Значение = СтрЗаменить(Значение, Симв(10),РазделительСтрок);
		Возврат Значение;
		
	КонецЕсли;
	
КонецФункции

Процедура СоздатьСтруктуруКонвертации()

	ВрмКонвертация = СоздатьОбъект("СписокЗначений");
	ВрмКонвертация.ИзСтрокиСРазделителями("ПередВыгрузкойДанных, ПослеВыгрузкиДанных, ПередПолучениемИзмененныхОбъектов, ПослеПолученияИнформацииОбУзлахОбмена, ПередВыгрузкойОбъекта, ПослеВыгрузкиОбъекта, ПередКонвертациейОбъекта, ПередЗагрузкойОбъекта, ПослеЗагрузкиОбъекта, ПередЗагрузкойДанных, ПослеЗагрузкиДанных, ПриПолученииИнформацииОбУдалении, ПередОтправкойИнформацииОбУдалении, ВерсияФормата, ДатаВремяСоздания");

	мКонвертация = СоздатьОбъект("СписокЗначений");
	Для ВрмИндекс = 1 По ВрмКонвертация.РазмерСписка() Цикл
		ВрмПредставление = ВрмКонвертация.ПолучитьЗначение(ВрмИндекс);
		мКонвертация.Установить(ВрмПредставление, ПолучитьПустоеЗначение());
	КонецЦикла;

	мКонвертация.Установить("УдалятьСопоставленныеОбъектыВПриемникеПриИхУдаленииВИсточнике", 0);

КонецПроцедуры	// СоздатьСтруктуруКонвертации()

// Инициализирует реквизиты обработки и модульные переменные.
//
// Параметры:
//  Нет.
// 
Процедура ИнициализацияРеквизитовИМодульныхПеременных()

	мАлгоритмы    = СоздатьОбъект("СписокЗначений");
	// ДопОбработки = СоздатьОбъект("СписокЗначений");
	мЗапросы      = СоздатьОбъект("СписокЗначений");

	Параметры = СоздатьОбъект("ТаблицаЗначений");

КонецПроцедуры

// Осуществляет загрузку правила выгрузки данных в соответствии с форматом правил обмена.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  НоваяСтрока    - строка дерева значений, описывающая правило выгрузки данных.
// 
Процедура ЗагрузитьПВД_8(ВхУзел)
	
	ВрмИмяПВД = "";
	мТаблицаПравилВыгрузки.НоваяСтрока();
	мТаблицаПравилВыгрузки.ТекущаяСтрока(мТаблицаПравилВыгрузки.КоличествоСтрок());
	
	мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "Включить", ?(одАтрибут(ВхУзел, "Булево", "Отключить") = 0, 1, 0));
	
	ВрмУзел = ВхУзел.ВыбратьУзел("Код");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		ВрмИмяПВД = одЗначениеЭлемента(ВрмУзел, "Строка");
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "Код", ВрмИмяПВД);
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("Наименование");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "Наименование", одЗначениеЭлемента(ВрмУзел, "Строка"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("Порядок");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "Порядок", одЗначениеЭлемента(ВрмУзел, "Число"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("СпособОтбораДанных");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "СпособОтбораДанных", одЗначениеЭлемента(ВрмУзел, "Строка"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("ВыбиратьДанныеДляВыгрузкиОднимЗапросом");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ВыбиратьДанныеДляВыгрузкиОднимЗапросом", одЗначениеЭлемента(ВрмУзел, "Строка"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("НеВыгружатьОбъектыСозданныеВБазеПриемнике");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "НеВыгружатьОбъектыСозданныеВБазеПриемнике", одЗначениеЭлемента(ВрмУзел, "Булево"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("ИмяТипаПриемника");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ИмяТипаПриемника", одЗначениеЭлемента(ВрмУзел, "Булево"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("ОбъектВыборки");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "НеВыгружатьОбъектыСозданныеВБазеПриемнике", одЗначениеЭлемента(ВрмУзел, "Булево"));
		ОбъектВыборки = одЗначениеЭлемента(ВрмУзел, "Строка");
		
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ОбъектВыборки", ОбъектВыборки);
		// Если РежимЗагрузкиИнформацииОПравилахОбмена = 0 Тогда
			
		// 	мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "СинхронизироватьПоИдентификатору", СинхронизироватьПоИдентификаторуПВД(НоваяСтрока.ПравилоКонвертации));
		
		// 	Если ПустаяСтрока(ОбъектВыборки) = 0 Тогда
				
		// 		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ОбъектВыборки", Тип(ОбъектВыборки));

		// 	КонецЕсли;
			
		// 	// Для поддержки отбора с помощью построителя.
		// 	// Если СтрНайти(ОбъектВыборки, "Ссылка.") Тогда
		// 	// 	НоваяСтрока.ИмяОбъектаДляЗапроса = СтрЗаменить(ОбъектВыборки, "Ссылка.", ".");
		// 	// Иначе
		// 	// 	НоваяСтрока.ИмяОбъектаДляЗапросаРегистра = СтрЗаменить(ОбъектВыборки, "Запись.", ".");
		// 	// КонецЕсли;
			
		// КонецЕсли;

	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("КодПравилаКонвертации");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "КодПравилаКонвертации", одЗначениеЭлемента(ВрмУзел, "Строка"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("ПередОбработкойПравила");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ПередОбработкой", одЗначениеЭлемента(ВрмУзел, "Строка"));
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ИмяОбработчикаПередОбработкой", Шаблон("ПВД_[ВрмИмяПВД]_ПередОбработкойПравила"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("ПослеОбработкиПравила");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ПослеОбработки", одЗначениеЭлемента(ВрмУзел, "Строка"));
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ИмяОбработчикаПослеОбработки", Шаблон("ПВД_[ВрмИмяПВД]_ПослеОбработкиПравила"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("ПередВыгрузкойОбъекта");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ПередВыгрузкой", одЗначениеЭлемента(ВрмУзел, "Строка"));
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ИмяОбработчикаПередВыгрузкой", Шаблон("ПВД_[ВрмИмяПВД]_ПередВыгрузкой"));
	КонецЕсли;

	ВрмУзел = ВхУзел.ВыбратьУзел("ПослеВыгрузкиОбъекта");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ПослеВыгрузки", одЗначениеЭлемента(ВрмУзел, "Строка"));
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "ИмяОбработчикаПослеВыгрузки", Шаблон("ПВД_[ВрмИмяПВД]_ПослеВыгрузки"));
	КонецЕсли;

	Если ПустаяСтрока(мТаблицаПравилВыгрузки.ПолучитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "Наименование")) = 1 Тогда
		мТаблицаПравилВыгрузки.УстановитьЗначение(мТаблицаПравилВыгрузки.ТекущаяСтрока(), "Наименование", ВрмИмяПВД);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗагрузитьГруппуПравилВыгрузки(ВхУзел)

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Правило");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьПВД_8(ВрмУзел);
		
	КонецЦикла;

КонецПроцедуры

Процедура ЗагрузитьПравилаВыгрузки(ВхУзел)

	мТаблицаПравилВыгрузки.УдалитьСтроки();

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Группа");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьГруппуПравилВыгрузки(ВрмУзел);
		
	КонецЦикла;

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Правило");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьПВД_8(ВрмУзел);
		
	КонецЦикла;

КонецПроцедуры

// Осуществляет загрузку правила очистки данных в соответствии с форматом правил обмена.
//
// Параметры:
//  НоваяСтрока    - строка дерева значений, описывающая правило очистки данных.
// 
Процедура ЗагрузитьПОД(ВхУзел, ВхУзелКорреспондент)
	
	ВрмИмяПОД = "";
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, ВхУзел.Наименование);
	ВрмОтключить = одАтрибут(ВхУзел, "Булево", "Отключить"); //Число(ВхУзел.ПолучитьАтрибут("Отключить"));

	Если мРежимОбмена <> "Загрузка" Тогда
		ВрмУзелКорреспондент.УстановитьАтрибут("Отключить", ВрмОтключить);
		Возврат;
	КонецЕсли;

	мТаблицаПравилОчистки.НоваяСтрока();
	мТаблицаПравилОчистки.ТекущаяСтрока(мТаблицаПравилОчистки.КоличествоСтрок());

	мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), "Включить", ?(ВрмОтключить = 0, 1, 0));

	Для Сч = 1 По ВхУзел.КоличествоПодчиненных() Цикл
		
		ВрмУзел = ВхУзел.ПолучитьПодчиненныйПоНомеру(Сч);
		ИмяУзла = ВрмУзел.Наименование;
		
		Если      ИмяУзла = "Код" Тогда
			
			ВрмИмяПОД = одЗначениеЭлемента(ВрмУзел, "Строка");
			мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), "Код", ВрмИмяПОД);

		ИначеЕсли ИмяУзла = "Наименование" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Число");
			мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), ИмяУзла, Значение);
		
		ИначеЕсли ИмяУзла = "Порядок" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Число");
			мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "СпособОтбораДанных" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), ИмяУзла, Значение);

		ИначеЕсли ИмяУзла = "ОбъектВыборки" Тогда
			
			// Если РежимЗагрузкиИнформацииОПравилахОбмена = 0 Тогда
			
				Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
				мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), ИмяУзла, Значение);
				
			// КонецЕсли;

		ИначеЕсли ИмяУзла = "УдалятьЗаПериод" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "Непосредственно" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
				мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), ИмяУзла, Значение);

		
		// Обработчики событий

		// ИначеЕсли ИмяУзла = "ПередОбработкойПравила" Тогда
		// 	НоваяСтрока.ПередОбработкой = одЗначениеЭлемента(ПравилаОбмена, ТипСтрока);
		// 	ИмяОбработчика = "ПОД_[ИмяПОД]_ПередОбработкойПравила";
		// 	НоваяСтрока.ИмяОбработчикаПередОбработкой = СтрЗаменить(ИмяОбработчика, "[ИмяПОД]", НоваяСтрока.Имя);
			
		// ИначеЕсли ИмяУзла = "ПослеОбработкиПравила" Тогда
		// 	НоваяСтрока.ПослеОбработки = одЗначениеЭлемента(ПравилаОбмена, ТипСтрока);
		// 	ИмяОбработчика = "ПОД_[ИмяПОД]_ПослеОбработкиПравила";
		// 	НоваяСтрока.ИмяОбработчикаПослеОбработки = СтрЗаменить(ИмяОбработчика, "[ИмяПОД]", НоваяСтрока.Имя);
			
		// ИначеЕсли ИмяУзла = "ПередУдалениемОбъекта" Тогда
		// 	НоваяСтрока.ПередУдалением = одЗначениеЭлемента(ПравилаОбмена, ТипСтрока);
		// 	ИмяОбработчика = "ПОД_[ИмяПОД]_ПередУдалениемОбъекта";
		// 	НоваяСтрока.ИмяОбработчикаПередУдалением = СтрЗаменить(ИмяОбработчика, "[ИмяПОД]", НоваяСтрока.Имя);
			
		КонецЕсли;
		
	КонецЦикла;

	Если ПустаяСтрока(мТаблицаПравилОчистки.Наименование) = 1 Тогда
		мТаблицаПравилОчистки.Наименование = ВрмИмяПОД;
	КонецЕсли;
	
КонецПроцедуры

// Осуществляет загрузку группы правил очистки данных в соответствии с форматом правил обмена.
//
// Параметры:
//  НоваяСтрока    - строка дерева значений, описывающая группу правил очистки данных.
// 
Процедура ЗагрузитьГруппуПОД(ВхУзел, ВхУзелКорреспондент)

	ВрмИмяПОД = "";
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, ВхУзел.Наименование);
	ВрмОтключить = одАтрибут(ВхУзел, "Булево", "Отключить"); //Число(ВхУзел.ПолучитьАтрибут("Отключить"));

	Если мРежимОбмена <> "Загрузка" Тогда
		ВрмУзелКорреспондент.УстановитьАтрибут("Отключить", ВрмОтключить);
		Возврат;
	КонецЕсли;

	мТаблицаПравилОчистки.НоваяСтрока();
	мТаблицаПравилОчистки.ТекущаяСтрока(мТаблицаПравилОчистки.КоличествоСтрок());

	мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), "ЭтоГруппа", 1);
	мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), "Включить", ?(ВрмОтключить = 0, 1, 0));

	Для Сч = 1 По ВхУзел.КоличествоПодчиненных() Цикл
		
		ВрмУзел = ВхУзел.ПолучитьПодчиненныйПоНомеру(Сч);
		ИмяУзла = ВрмУзел.Наименование;
		
		Если      ИмяУзла = "Код" Тогда
			
			ВрмИмяПОД = одЗначениеЭлемента(ВрмУзел, "Строка");
			мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), "Код", ВрмИмяПОД);

		ИначеЕсли ИмяУзла = "Наименование" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), ИмяУзла, Значение);
		
		ИначеЕсли ИмяУзла = "Порядок" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Число");
			мТаблицаПравилОчистки.УстановитьЗначение(мТаблицаПравилОчистки.ТекущаяСтрока(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "Правило" Тогда
			
			ЗагрузитьПОД(ВрмУзел, ВрмУзелКорреспондент);
			
		ИначеЕсли ИмяУзла = "Группа" Тогда
			
			ЗагрузитьГруппуПОД(ВрмУзел, ВрмУзелКорреспондент);
			
		КонецЕсли;
		
	КонецЦикла;

	Если ПустаяСтрока(мТаблицаПравилОчистки.Наименование) = 1 Тогда
		мТаблицаПравилОчистки.Наименование = ВрмИмяПОД;
	КонецЕсли;
	
КонецПроцедуры

// Осуществляет загрузку правил очистки данных.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  ЗаписьXML      - Объект типа XMLЗапись - правила, сохраняемые в файл обмена и
//                   используемые при загрузке данных.
// 
Процедура ЗагрузитьПравилаОчистки(ВхУзел, ВхУзелКорреспондент)

	мТаблицаПравилОчистки.УдалитьСтроки();
	// СтрокиДЗ = мТаблицаПравилОчистки.Строки;
	
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "ПравилаОчисткиДанных");

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Группа");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьГруппуПОД(ВхУзел, ВхУзелКорреспондент);
		
	КонецЦикла;

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Правило");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьПОД(ВхУзел, ВхУзелКорреспондент);
		
	КонецЦикла;

	мТаблицаПравилОчистки.Сортировать("Порядок");
	
КонецПроцедуры

// Осуществляет загрузку алгоритма в соответствии с форматом правил обмена.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  ЗаписьXML      - Объект типа XMLЗапись - правила, сохраняемые в файл обмена и
//                   используемые при загрузке данных.
// 
Процедура ЗагрузитьАлгоритм(ВхУзел, ВхУзелКорреспондент)
	
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "Алгоритм");
	ИспользуетсяПриЗагрузке = одАтрибут(ВхУзел, "Булево", "ИспользуетсяПриЗагрузке"); //Число(ВхУзел.ПолучитьАтрибут("ИспользуетсяПриЗагрузке"));
	Имя                     = одАтрибут(ВхУзел, "Строка", "Имя"); //ВхУзел.ПолучитьАтрибут("Имя");

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Текст");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ИмяУзла = ВрмУзел.Наименование;
		
		Текст = одЗначениеЭлемента(ВрмУзел, "Строка");

		Если ИспользуетсяПриЗагрузке = 1 Тогда
			Если мРежимОбмена = "Загрузка" Тогда
				мАлгоритмы.Установить(Имя, Текст);
			Иначе
				ВрмУзелКорреспондент.УстановитьАтрибут("ИспользуетсяПриЗагрузке", 1);
				ВрмУзелКорреспондент.УстановитьАтрибут("Имя", Имя);
				ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, "Текст", Текст);
			КонецЕсли;
		Иначе
			Если мРежимОбмена <> "Загрузка" Тогда
				мАлгоритмы.Установить(Имя, Текст);
			КонецЕсли;
		КонецЕсли;	
		
	КонецЦикла;

КонецПроцедуры

// Осуществляет загрузку алгоритмов в соответствии с форматом правил обмена.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  ЗаписьXML      - Объект типа XMLЗапись - правила, сохраняемые в файл обмена и
//                   используемые при загрузке данных.
// 
Процедура ЗагрузитьАлгоритмы(ВхУзел, ВхУзелКорреспондент)

	мАлгоритмы.УдалитьВсе();
	
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "Алгоритмы");

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Алгоритм");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл
		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьАлгоритм(ВрмУзел, ВхУзелКорреспондент);
	КонецЦикла;

КонецПроцедуры

// Осуществляет загрузку запроса в соответствии с форматом правил обмена.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  ЗаписьXML      - Объект типа XMLЗапись - правила, сохраняемые в файл обмена и
//                   используемые при загрузке данных.
// 
Процедура ЗагрузитьЗапрос(ВхУзел, ВхУзелКорреспондент)
	
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "Запрос");
	ИспользуетсяПриЗагрузке = одАтрибут(ВхУзел, "Булево", "ИспользуетсяПриЗагрузке"); //Число(ВхУзел.ПолучитьАтрибут("ИспользуетсяПриЗагрузке"));
	Имя                     = одАтрибут(ВхУзел, "Строка", "Имя"); //ВхУзел.ПолучитьАтрибут("Имя");

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Текст");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ИмяУзла = ВрмУзел.Наименование;
		
		Текст = одЗначениеЭлемента(ВрмУзел, "Строка");

		Если ИспользуетсяПриЗагрузке = 1 Тогда
			Если мРежимОбмена = "Загрузка" Тогда
				мАлгоритмы.Установить(Имя, Текст);
			Иначе
				ВрмУзелКорреспондент.УстановитьАтрибут("ИспользуетсяПриЗагрузке", 1);
				ВрмУзелКорреспондент.УстановитьАтрибут("Имя", Имя);
				ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, "Текст", Текст);
			КонецЕсли;
		Иначе
			Если мРежимОбмена <> "Загрузка" Тогда
				мАлгоритмы.Установить(Имя, Текст);
			КонецЕсли;
		КонецЕсли;	
		
	КонецЦикла;
	
КонецПроцедуры

// Осуществляет загрузку запросов в соответствии с форматом правил обмена.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  ЗаписьXML      - Объект типа XMLЗапись - правила, сохраняемые в файл обмена и
//                   используемые при загрузке данных.
// 
Процедура ЗагрузитьЗапросы(ВхУзел, ВхУзелКорреспондент)

	мЗапросы.УдалитьВсе();
	
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "Запросы");

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Запрос");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл
		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьЗапрос(ВрмУзел, ВхУзелКорреспондент);
	КонецЦикла;
	
КонецПроцедуры

// Осуществляет загрузку параметров в соответствии с форматом правил обмена.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
// 
Процедура ЗагрузитьПараметры(ВхУзел, ВхУзелКорреспондент)

	// Параметры = СоздатьОбъект("ТаблицаЗначений");
	мТаблицаНастройкиПараметров.УдалитьСтроки();
	
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "Параметры");
	
	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Параметр");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл
		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);

		// Загрузка по версии правил 2.01.
		Имя                     = одАтрибут(ВрмУзел, "Строка", "Имя");
		Наименование            = одАтрибут(ВрмУзел, "Строка", "Наименование");
		УстанавливатьВДиалоге   = одАтрибут(ВрмУзел, "Булево", "УстанавливатьВДиалоге");
		СтрокаТипаЗначения      = одАтрибут(ВрмУзел, "Строка", "ТипЗначения");
		ИспользуетсяПриЗагрузке = одАтрибут(ВрмУзел, "Булево", "ИспользуетсяПриЗагрузке");
		ПередаватьПараметрПриВыгрузке = одАтрибут(ВрмУзел, "Булево", "ПередаватьПараметрПриВыгрузке");
		ПравилоКонвертации = одАтрибут(ВрмУзел, "Строка", "ПравилоКонвертации");
		АлгоритмПослеЗагрузкиПараметра = одАтрибут(ВрмУзел, "Строка", "ПослеЗагрузкиПараметра");
		
		// Если ПустаяСтрока(АлгоритмПослеЗагрузкиПараметра) = 0 Тогда
			
		// 	СобытияПослеЗагрузкиПараметров.Вставить(Имя, АлгоритмПослеЗагрузкиПараметра);
			
		// КонецЕсли;
		
		// Определяем типы значений и устанавливаем начальные значения.
		// Если ПустаяСтрока(СтрокаТипаЗначения) = 0 Тогда
			
		// 	Попытка
		// 		ТипЗначенияДанных = Тип(СтрокаТипаЗначения);
		// 		ТипОпределен = ИСТИНА;
		// 	Исключение
		// 		ТипОпределен = ЛОЖЬ;
		// 	КонецПопытки;
			
		// Иначе
			
		// 	ТипОпределен = ЛОЖЬ;
			
		// КонецЕсли;
		
		// Если ТипОпределен Тогда
		// 	ЗначениеПараметра = одПолучитьПустоеЗначение(ТипЗначенияДанных);
		// 	Параметры.Вставить(Имя, ЗначениеПараметра);
		// Иначе
		// 	ЗначениеПараметра = "";
		// 	Параметры.Вставить(Имя);
		// КонецЕсли;
		ЗначениеПараметра = ПолучитьПустоеЗначение();
		// Параметры.Установить(Имя, ЗначениеПараметра);

		Параметры.ВставитьКолонку(СокрЛП(Имя));
					
		// Если УстанавливатьВДиалоге = ИСТИНА Тогда
			
		// 	СтрокаТаблицы              = мТаблицаНастройкиПараметров.Добавить();
		// 	СтрокаТаблицы.Наименование = Наименование;
		// 	СтрокаТаблицы.Имя          = Имя;
		// 	СтрокаТаблицы.Значение = ЗначениеПараметра;				
		// 	СтрокаТаблицы.ПередаватьПараметрПриВыгрузке = ПередаватьПараметрПриВыгрузке;
		// 	СтрокаТаблицы.ПравилоКонвертации = ПравилоКонвертации;
			
		// КонецЕсли;
		
		Если (ИспользуетсяПриЗагрузке = 1) И (мРежимОбмена = "Выгрузка") Тогда
			
			ВрмУзелПараметрКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "Параметр");
			ВрмУзелПараметрКорреспондент.УстановитьАтрибут("Имя", Имя);
			ВрмУзелПараметрКорреспондент.УстановитьАтрибут("Наименование", Наименование);

			Если ПустаяСтрока(АлгоритмПослеЗагрузкиПараметра) = 0 Тогда
				ВрмУзелПараметрКорреспондент.УстановитьАтрибут("ПослеЗагрузкиПараметра", АлгоритмПослеЗагрузкиПараметра);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры

// Осуществляет загрузку правила конвертации свойств.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  ТаблицаСвойств - таблица значений, содержащая ПКС.
// 
// Параметры:
//  ПравилаОбмена  - XMLЧтение - объект, содержащий текст правил обмена.
//  ТаблицаСвойств - Таблица значений - таблица ПКС.
//  СвойстваОтключенные - Таблица значений - таблица отключенных ПКС.
//  СвойстваПКО - Структура - уточняющие сведения об изменяемых данных:
//    * ИмяПКО - Строка - Имя ПКО.
//    * СинхронизироватьПоИдентификатору - Булево - признак использования алгоритма поиска по уникальному идентификатору.
//    * ИмяРодителя - Строка - имя родительского ПКО или ПКГС.
//  СтрокаПолейПоиска - Строка - свойства поиска ПКО.
//  ТаблицаПоиска - Таблица значений - таблица ПКС (синхронизирующих).
//
Процедура ЗагрузитьПКС_8(ВхУзел,
	Знач ТаблицаСвойств,
	СвойстваОтключенные,
	СвойстваПКО,
	СтрокаПолейПоиска = "",
	ТаблицаПоиска = 0)
	
	ИмяПКО = ?(ПустаяСтрока(СвойстваПКО.Получить("ИмяПКО")) = 0, СвойстваПКО.Получить("ИмяПКО"), "");
	ИмяРодителя = ?(ПустаяСтрока(СвойстваПКО.Получить("ИмяРодителя")) = 0, СвойстваПКО.Получить("ИмяРодителя"), "");
	СинхронизироватьПоИдентификатору = ?(ПустаяСтрока(СвойстваПКО.Получить("СинхронизироватьПоИдентификатору")) = 0,
		СвойстваПКО.Получить("СинхронизироватьПоИдентификатору"), 0);
	
	ЭтоПолеОтключено        = одАтрибут(ВхУзел, "Булево", "Отключить");
	ЭтоПолеПоиска           = одАтрибут(ВхУзел, "Булево", "Поиск");
	ЭтоОбязательноеСвойство = одАтрибут(ВхУзел, "Булево", "Обязательное");
	
	ВрмТаблицаСвойств = ТаблицаСвойств;

	Если ЭтоПолеОтключено = 1 Тогда
		
		ВрмТаблицаСвойств = СвойстваОтключенные;
		
	ИначеЕсли (ЭтоОбязательноеСвойство = 1) И (ТипЗначенияСтр(ТаблицаПоиска) = "ТаблицаЗначений") Тогда
		
		ВрмТаблицаСвойств = ТаблицаПоиска;
		
	ИначеЕсли (ЭтоПолеПоиска = 1) И (ТипЗначенияСтр(ТаблицаПоиска) = "ТаблицаЗначений") Тогда
		
		ВрмТаблицаСвойств = ТаблицаПоиска;
		
	КонецЕсли;
	
	ВрмИсточник = "";
	ВрмПриемник = "";

	ВрмТаблицаСвойств.НоваяСтрока();
	ВрмТаблицаСвойств.ТекущаяСтрока(ВрмТаблицаСвойств.КоличествоСтрок());
	
	// Значения по умолчанию
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "НеЗамещать", 0);
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ПолучитьИзВходящихДанных", 0);
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЭтоОбязательноеСвойство", ЭтоОбязательноеСвойство);
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЭтоПолеПоиска", ЭтоПолеПоиска);
	
	Для ВрмИндекс = 1 По ВхУзел.КоличествоПодчиненных() Цикл
		
		ВрмУзел = ВхУзел.ПолучитьПодчиненныйПоНомеру(ВрмИндекс);
		ИмяУзла = ВрмУзел.Наименование;
		
		Если ИмяУзла = "Источник" Тогда

			ВрмИсточник = одАтрибут(ВрмУзел, "Строка", "Имя");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "Источник", ВрмИсточник);
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ВидИсточника", одАтрибут(ВрмУзел, "Строка", "Вид"));
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ТипИсточника", одАтрибут(ВрмУзел, "Строка", "Тип"));
			
		ИначеЕсли ИмяУзла = "Приемник" Тогда

			ВрмИсточник = одАтрибут(ВрмУзел, "Строка", "Имя");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "Приемник", ВрмИсточник);
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ВидПриемника", одАтрибут(ВрмУзел, "Строка", "Вид"));
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ТипПриемника", одАтрибут(ВрмУзел, "Строка", "Тип"));
			
			Если ЭтоПолеОтключено = 0 Тогда
				
				// Заполняем переменную "СтрокаПолейПоиска" для поиска по всем реквизитам в ТЧ для которых есть ПКС.
				// ДобавитьПолеКСтрокеПоиска(СтрокаПолейПоиска, НоваяСтрока.Приемник);
				
			КонецЕсли;
			
		ИначеЕсли ИмяУзла = "Код" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "Наименование" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);

		ИначеЕсли ИмяУзла = "Порядок" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Число");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);

		ИначеЕсли ИмяУзла = "НеЗамещать" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "КодПравилаКонвертации" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "ПередВыгрузкой" Тогда

			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЕстьОбработчикПередВыгрузкой", ?(ПустаяСтрока(Значение) = 0, 1, 0));
			
		ИначеЕсли ИмяУзла = "ПриВыгрузке" Тогда

			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЕстьОбработчикПриВыгрузке", ?(ПустаяСтрока(Значение) = 0, 1, 0));

		ИначеЕсли ИмяУзла = "ПослеВыгрузки" Тогда

			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЕстьОбработчикПослеВыгрузки", ?(ПустаяСтрока(Значение) = 0, 1, 0));
			
		ИначеЕсли ИмяУзла = "ПолучитьИзВходящихДанных" Тогда

			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "ПриводитьКДлине" Тогда

			Значение = одЗначениеЭлемента(ВрмУзел, "Число");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "ИмяПараметраДляПередачи" Тогда

			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			
		ИначеЕсли ИмяУзла = "ПоискПоДатеНаРавенство" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);

		КонецЕсли;
		
	КонецЦикла;
	
	// Если НоваяСтрока.ЕстьОбработчикПередВыгрузкой Тогда
		
	// 	ИмяОбработчика = "ПКС_[ИмяПКО][ИмяРодителя][ИмяСвойстваПКС]_ПередВыгрузкойСвойства_[ИмяПКС]_[ДлинаИмениПКО]";
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКО]", ИмяПКО);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяРодителя]", ИмяРодителя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяСвойстваПКС]", ИмяСвойстваПКС(НоваяСтрока));
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКС]", НоваяСтрока.Имя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ДлинаИмениПКО]", СтрДлина(ИмяПКО));
		
	// 	НоваяСтрока.ИмяОбработчикаПередВыгрузкой = ИмяОбработчика;
		
	// КонецЕсли;
	
	// Если НоваяСтрока.ЕстьОбработчикПриВыгрузке Тогда
		
	// 	ИмяОбработчика = "ПКС_[ИмяПКО][ИмяРодителя][ИмяСвойстваПКС]_ПриВыгрузкеСвойства_[ИмяПКС]_[ДлинаИмениПКО]";
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКО]", ИмяПКО);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяРодителя]", ИмяРодителя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяСвойстваПКС]", ИмяСвойстваПКС(НоваяСтрока));
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКС]", НоваяСтрока.Имя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ДлинаИмениПКО]", СтрДлина(ИмяПКО));
		
	// 	НоваяСтрока.ИмяОбработчикаПриВыгрузке = ИмяОбработчика;
		
	// КонецЕсли;
	
	// Если НоваяСтрока.ЕстьОбработчикПослеВыгрузки Тогда
		
	// 	ИмяОбработчика = "ПКС_[ИмяПКО][ИмяРодителя][ИмяСвойстваПКС]_ПослеВыгрузкиСвойства_[ИмяПКС]_[ДлинаИмениПКО]";
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКО]", ИмяПКО);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяРодителя]", ИмяРодителя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяСвойстваПКС]", ИмяСвойстваПКС(НоваяСтрока));
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКС]", НоваяСтрока.Имя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ДлинаИмениПКО]", СтрДлина(ИмяПКО));

	// 	НоваяСтрока.ИмяОбработчикаПослеВыгрузки = ИмяОбработчика;
		
	// КонецЕсли;
	
	// НоваяСтрока.УпрощеннаяВыгрузкаСвойства = НЕ НоваяСтрока.ПолучитьИзВходящихДанных
	// 	И НЕ НоваяСтрока.ЕстьОбработчикПередВыгрузкой
	// 	И НЕ НоваяСтрока.ЕстьОбработчикПриВыгрузке
	// 	И НЕ НоваяСтрока.ЕстьОбработчикПослеВыгрузки
	// 	И ПустаяСтрока(НоваяСтрока.ПравилоКонвертации)
	// 	И НоваяСтрока.ТипИсточника = НоваяСтрока.ТипПриемника
	// 	И (НоваяСтрока.ТипИсточника = "Строка" ИЛИ НоваяСтрока.ТипИсточника = "Число" ИЛИ НоваяСтрока.ТипИсточника = "Булево" ИЛИ НоваяСтрока.ТипИсточника = "Дата");
		
	// НоваяСтрока.НуженУзелXMLПриВыгрузке = НоваяСтрока.ЕстьОбработчикПриВыгрузке ИЛИ НоваяСтрока.ЕстьОбработчикПослеВыгрузки;
	
КонецПроцедуры

Процедура ЗагрузитьПКГС(ВхУзел, ТаблицаСвойств, ТаблицаПоиска, СвойстваОтключенные, СинхронизироватьПоИдентификатору = 0, ИмяПКО = "")

	ВрмТаблицаСвойств = ТаблицаСвойств;

	Если одАтрибут(ВхУзел, "Булево", "Отключить") = 1 Тогда
		
		ВрмТаблицаСвойств = СвойстваОтключенные;
		
	КонецЕсли;

	ВрмТаблицаСвойств.НоваяСтрока();
	ВрмТаблицаСвойств.ТекущаяСтрока(ВрмТаблицаСвойств.КоличествоСтрок());
	
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЭтоГруппа", 1);

	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "СвойстваГруппы", ИнициализацияПравилКонвертацииСвойств());
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ПравилаГруппыОтключенные", ИнициализацияПравилКонвертацииСвойств());
	
	// Значения по умолчанию
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "НеЗамещать", 0);
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ПолучитьИзВходящихДанных", 0);
	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "УпрощеннаяВыгрузкаСвойства", 0);
	
	СтрокаПолейПоиска = "";
	ВрмИсточник = "";
	ВрмПриемник = "";
	
	Для ВрмИндекс = 1 По ВхУзел.КоличествоПодчиненных() Цикл
		
		ВрмУзел = ВхУзел.ПолучитьПодчиненныйПоНомеру(ВрмИндекс);
		ИмяУзла = ВрмУзел.Наименование;
		
		Если Найти("Источник,Приемник", ИмяУзла) > 0 Тогда
			
			ВрмИсточник = одАтрибут(ВрмУзел, "Строка", "Имя");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, ВрмИсточник);
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), Шаблон("Вид[ИмяУзла]а"), одАтрибут(ВрмУзел, "Строка", "Вид"));
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), Шаблон("Тип[ИмяУзла]а"), одАтрибут(ВрмУзел, "Строка", "Тип"));
			
		ИначеЕсли ИмяУзла = "Свойство" Тогда
			
			РодительПКС = ?(ПустоеЗначение(ВрмИсточник) = 1, "_" + ВрмИсточник, "_" + ВрмПриемник);
			
			СвойстваПКО = СоздатьОбъект("СписокЗначений");
			СвойстваПКО.Установить("ИмяПКО", ИмяПКО);
			СвойстваПКО.Установить("ИмяРодителя", РодительПКС);
			СвойстваПКО.Установить("СинхронизироватьПоИдентификатору", СинхронизироватьПоИдентификатору);
			
			ЗагрузитьПКС_8(ВрмУзел, ВрмТаблицаСвойств.СвойстваГруппы, ВрмТаблицаСвойств.ПравилаГруппыОтключенные, СвойстваПКО, СтрокаПолейПоиска);

		ИначеЕсли Найти("ПередОбработкойВыгрузки,ПослеОбработкиВыгрузки", ИмяУзла) > 0 Тогда

			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), Шаблон("ЕстьОбработчик[ИмяУзла]"), ?(ПустаяСтрока(Значение) = 0, 1, 0));
			
		// ИначеЕсли ИмяУзла = "ПослеОбработкиВыгрузки" Тогда
			
		// 	Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		// 	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ПослеОбработкиВыгрузки", Значение);
		// 	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЕстьОбработчикПослеОбработкиВыгрузки", ?(ПустаяСтрока(Значение) = 0, 1, 0));
			
		ИначеЕсли Найти("Код,Наименование,КодПравилаКонвертации", ИмяУзла) > 0 Тогда

			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, одЗначениеЭлемента(ВрмУзел, "Строка"));
			
		ИначеЕсли ИмяУзла = "Порядок" Тогда

			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, одЗначениеЭлемента(ВрмУзел, "Число"));
			
		ИначеЕсли Найти("НеЗамещать,ВыгружатьГруппуЧерезФайл,ПолучитьИзВходящихДанных", ИмяУзла) > 0 Тогда

			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, одЗначениеЭлемента(ВрмУзел, "Булево"));
			
		ИначеЕсли Найти("ПередВыгрузкой,ПриВыгрузке,ПослеВыгрузки", ИмяУзла) > 0 Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), ИмяУзла, Значение);
			ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), Шаблон("ЕстьОбработчик[ИмяУзла]"), ?(ПустаяСтрока(Значение) = 0, 1, 0));
			
		// ИначеЕсли ИмяУзла = "ПриВыгрузке" Тогда

		// 	Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		// 	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ПриВыгрузке", Значение);
		// 	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЕстьОбработчикПриВыгрузке", ?(ПустаяСтрока(Значение) = 0, 1, 0));
			
		// ИначеЕсли ИмяУзла = "ПослеВыгрузки" Тогда

		// 	Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		// 	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ПослеВыгрузки", Значение);
		// 	ВрмТаблицаСвойств.УстановитьЗначение(ВрмТаблицаСвойств.КоличествоСтрок(), "ЕстьОбработчикПослеВыгрузки", ?(ПустаяСтрока(Значение) = 0, 1, 0));
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Если НоваяСтрока.ЕстьОбработчикПередОбработкойВыгрузки Тогда
		
	// 	ИмяОбработчика = "ПКГС_[ИмяПКО][ИмяСвойстваПКС]_ПередОбработкойВыгрузки_[ИмяПКГС]_[ДлинаИмениПКО]";
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКО]", ИмяПКО);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяСвойстваПКС]", ИмяСвойстваПКС(НоваяСтрока));
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКГС]", НоваяСтрока.Имя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ДлинаИмениПКО]", СтрДлина(ИмяПКО));
	// 	НоваяСтрока.ИмяОбработчикаПередОбработкойВыгрузки = ИмяОбработчика;
		
	// КонецЕсли;
	
	// Если НоваяСтрока.ЕстьОбработчикПослеОбработкиВыгрузки Тогда
		
	// 	ИмяОбработчика = "ПКГС_[ИмяПКО][ИмяСвойстваПКС]_ПослеОбработкиВыгрузки_[ИмяПКГС]_[ДлинаИмениПКО]";
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКО]", ИмяПКО);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяСвойстваПКС]", ИмяСвойстваПКС(НоваяСтрока));
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКГС]", НоваяСтрока.Имя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ДлинаИмениПКО]", СтрДлина(ИмяПКО));
	// 	НоваяСтрока.ИмяОбработчикаПослеОбработкиВыгрузки = ИмяОбработчика;
		
	// КонецЕсли;
	
	// Если НоваяСтрока.ЕстьОбработчикПередВыгрузкой Тогда
		
	// 	ИмяОбработчика = "ПКГС_[ИмяПКО][ИмяСвойстваПКС]_ПередВыгрузкойСвойства_[ИмяПКГС]_[ДлинаИмениПКО]";
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКО]", ИмяПКО);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяСвойстваПКС]", ИмяСвойстваПКС(НоваяСтрока));
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКГС]", НоваяСтрока.Имя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ДлинаИмениПКО]", СтрДлина(ИмяПКО));
	// 	НоваяСтрока.ИмяОбработчикаПередВыгрузкой = ИмяОбработчика;

	// КонецЕсли;
	
	// Если НоваяСтрока.ЕстьОбработчикПриВыгрузке Тогда
		
	// 	ИмяОбработчика = "ПКГС_[ИмяПКО][ИмяСвойстваПКС]_ПриВыгрузкеСвойства_[ИмяПКГС]_[ДлинаИмениПКО]";
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКО]", ИмяПКО);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяСвойстваПКС]", ИмяСвойстваПКС(НоваяСтрока));
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКГС]", НоваяСтрока.Имя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ДлинаИмениПКО]", СтрДлина(ИмяПКО));
	// 	НоваяСтрока.ИмяОбработчикаПриВыгрузке = ИмяОбработчика;

	// КонецЕсли;
	
	// Если НоваяСтрока.ЕстьОбработчикПослеВыгрузки Тогда
		
	// 	ИмяОбработчика = "ПКГС_[ИмяПКО][ИмяСвойстваПКС]_ПослеВыгрузкиСвойства_[ИмяПКГС]_[ДлинаИмениПКО]";
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКО]", ИмяПКО);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяСвойстваПКС]", ИмяСвойстваПКС(НоваяСтрока));
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ИмяПКГС]", НоваяСтрока.Имя);
	// 	ИмяОбработчика = СтрЗаменить(ИмяОбработчика, "[ДлинаИмениПКО]", СтрДлина(ИмяПКО));
	// 	НоваяСтрока.ИмяОбработчикаПослеВыгрузки = ИмяОбработчика;
		
	// КонецЕсли;
	
	// НоваяСтрока.СтрокаПолейПоиска = СтрокаПолейПоиска;
	
	// НоваяСтрока.НуженУзелXMLПриВыгрузке = НоваяСтрока.ЕстьОбработчикПриВыгрузке ИЛИ НоваяСтрока.ЕстьОбработчикПослеВыгрузки;
	
	// НоваяСтрока.НуженУзелXMLПриВыгрузкеГруппы = НоваяСтрока.ЕстьОбработчикПослеОбработкиВыгрузки;
	
КонецПроцедуры

// Осуществляет загрузку правил конвертации свойств.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  ТаблицаСвойств - таблица значений, содержащая ПКС.
//  ТаблицаПоиска  - таблица значений, содержащая ПКС (синхронизирующих).
// 
Функция ЗагрузитьСвойства(ВхУзел, СинхронизироватьПоИдентификатору = 0, ИмяПКО = "")
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмСвойства = ИнициализацияПравилКонвертацииСвойств();
	ВрмСвойстваОтключенные = ИнициализацияПравилКонвертацииСвойств();
	ВрмСвойстваПоиска = ИнициализацияПравилКонвертацииСвойств();

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Группа");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьПКГС(ВрмУзел, ВрмСвойства, ВрмСвойстваОтключенные, СинхронизироватьПоИдентификатору, ИмяПКО);
		
	КонецЦикла;

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Свойство");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл
		
		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);

		СвойстваПКО = СоздатьОбъект("СписокЗначений");
		СвойстваПКО.Установить("ИмяПКО", ИмяПКО);
		СвойстваПКО.Установить("ИмяРодителя", "");
		СвойстваПКО.Установить("СинхронизироватьПоИдентификатору", СинхронизироватьПоИдентификатору);
		ЗагрузитьПКС_8(ВрмУзел, ВрмСвойства, ВрмСвойстваОтключенные, СвойстваПКО, , ВрмСвойстваПоиска);
		
	КонецЦикла;
	
	ВрмСвойства.Сортировать("Порядок");
	ВрмСвойстваПоиска.Сортировать("Порядок");
	ВрмСвойстваОтключенные.Сортировать("Порядок");
	
	ВрмВозврат.Установить("СвойстваПоиска", ВрмСвойстваПоиска);
	ВрмВозврат.Установить("Свойства", ВрмСвойства);
	ВрмВозврат.Установить("СвойстваОтключенные",  ВрмСвойстваОтключенные);
	Возврат ВрмВозврат;

КонецФункции


// Осуществляет загрузку правила конвертации значений.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  Значения       - соответствие значений объекта источника - строковым
//                   представлениям объекта приемника.
//  ТипИсточника   - значение типа Тип - тип объекта источника.
// 
Процедура ЗагрузитьПКЗ(ВхУзел, Значения)
	
	Источник = "";
	Приемник = "";

	Для ВрмИндекс = 1 По ВхУзел.КоличествоПодчиненных() Цикл
		
		ВрмУзел = ВхУзел.ПолучитьПодчиненныйПоНомеру(ВрмИндекс);
		ИмяУзла = ВрмУзел.Наименование;
		
		Если      ИмяУзла = "Источник" Тогда
			Источник = одЗначениеЭлемента(ВрмУзел, "Строка");
		ИначеЕсли ИмяУзла = "Приемник" Тогда
			Приемник = одЗначениеЭлемента(ВрмУзел, "Строка");
		КонецЕсли;
		
	КонецЦикла;
	
	Если ПустаяСтрока(Источник) = 0 Тогда
		Значения.Установить(Источник, Приемник);
	КонецЕсли;
	
КонецПроцедуры

// Осуществляет загрузку правил конвертации значений.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  Значения       - соответствие значений объекта источника - строковым
//                   представлениям объекта приемника.
//  ТипИсточника   - значение типа Тип - тип объекта источника.
// 
Функция ЗагрузитьЗначения(ВхУзел)

	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Значение");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);

		ЗагрузитьПКЗ(ВрмУзел, ВрмВозврат);
		
	КонецЦикла;

	Возврат ВрмВозврат;
	
КонецФункции


Процедура ЗагрузитьПравилоКонвертации(ВхУзел, ВхУзелКорреспондент)
	
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "Правило");

	мТаблицаПравилКонвертацииОбъектов.НоваяСтрока();
	мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(мТаблицаПравилКонвертацииОбъектов.КоличествоСтрок());
	
	мТаблицаПравилКонвертацииОбъектов.Выгруженные = СоздатьОбъект("СписокЗначений");
	
	ВрмИмяПКО = "";

	// ТипТега = мЧтениеXML.Спуститься();
	Для ВрмИндекс = 1 По ВхУзел.КоличествоПодчиненных() Цикл
		
		ВрмУзел = ВхУзел.ПолучитьПодчиненныйПоНомеру(ВрмИндекс) ;
		Имя = ВрмУзел.Наименование;
		
		Если (Имя = "Порядок") Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Число");
			
			Порядок = СтрЗаменить(Порядок, ",", РазделительСтрок);
			
			Для Индекс = 1 ПО СтрКоличествоСтрок(Порядок) Цикл
			   
				Попытка
					
					мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "Порядок" + Индекс, Число(СтрПолучитьСтроку(Порядок, Индекс)));
					
				Исключение
					
					мТаблицаПравилКонвертацииОбъектов.НоваяКолонка("Порядок" + Индекс, "Число", 10, 0);
					мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "Порядок" + Индекс, Число(СтрПолучитьСтроку(Порядок, Индекс)));
					
				КонецПопытки;
				
			КонецЦикла;

		ИначеЕсли Имя = "Код" Тогда
			
			ВрмИмяПКО = одЗначениеЭлемента(ВрмУзел, "Строка");
			ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, ВрмИмяПКО);
			мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), Имя, ВрмИмяПКО);
			Продолжить;

		ИначеЕсли (Имя = "ПередВыгрузкой") ИЛИ (Имя = "ПриВыгрузке") ИЛИ (Имя = "ПослеВыгрузки") ИЛИ (Имя = "ПослеВыгрузкиВФайл") Тогда
			
			Значение = 1;

		ИначеЕсли (Имя = "ПередЗагрузкой") ИЛИ (Имя = "ПриЗагрузке") ИЛИ (Имя = "ПослеЗагрузки") Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			
			Если мРежимОбмена = "Загрузка" Тогда

				ИмяОбработчика = Шаблон("ПКО_[ВрмИмяПКО]_[Имя]Объекта");
				мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), Шаблон("ИмяОбработчика[Имя]"), Шаблон("ПКО_[ВрмИмяПКО]_[Имя]Объекта"));
				мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), Шаблон("ЕстьОбработчик[Имя]"), ?(ПустаяСтрока(Значение) = 0, 1, 0));
				
			Иначе
				
				ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, Значение);
				
			КонецЕсли;

		ИначеЕсли Имя = "ПоследовательностьПолейПоиска" Тогда

			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), Шаблон("ЕстьОбработчик[Имя]"), ?(ПустаяСтрока(Значение) = 0, 1, 0));

			Если мРежимОбмена = "Загрузка" Тогда

				ИмяОбработчика = Шаблон("ПКО_[ВрмИмяПКО]_[Имя]Объекта");
				мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), Шаблон("ИмяОбработчика[Имя]"), Шаблон("ПКО_[ВрмИмяПКО]_[Имя]"));
				
				
			Иначе
				
				ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, Значение);
				
			КонецЕсли;
						
		ИначеЕсли Имя = "СинхронизироватьПоИдентификатору" Тогда
			
			ВрмСинхронизироватьПоИдентификатору = одЗначениеЭлемента(ВрмУзел, "Булево");
			ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, ВрмСинхронизироватьПоИдентификатору);
			мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), Имя, ВрмСинхронизироватьПоИдентификатору);
			Продолжить;

		ИначеЕсли Имя = "ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, Значение);

		ИначеЕсли Имя = "ПриПереносеОбъектаПоСсылкеУстанавливатьТолькоGIUD" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, Значение);

		ИначеЕсли Имя = "НеЗамещатьОбъектСозданныйВИнформационнойБазеПриемнике" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, Значение);
		
		ИначеЕсли Имя = "НеЗапоминатьВыгруженные" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			
		ИначеЕсли Имя = "НеВыгружатьОбъектыСвойствПоСсылкам" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			
		ИначеЕсли Имя = "ГенерироватьНовыйНомерИлиКодЕслиНеУказан" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");
			ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, Значение);
			
		ИначеЕсли Имя = "НеСоздаватьЕслиНеНайден" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Булево");

		ИначеЕсли Имя = "Приемник" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, Значение);
		
		ИначеЕсли Имя = "Источник" Тогда
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			ЗаписатьПодчиненныйЭлемент(ВрмУзелКорреспондент, Имя, Значение);
			
		ИначеЕсли Имя = "Свойства" Тогда
			
			ВрмВозврат = ЗагрузитьСвойства(ВрмУзел, ВрмСинхронизироватьПоИдентификатору, ВрмИмяПКО);
			
			мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "СвойстваПоиска", ВрмВозврат.Получить("СвойстваПоиска"));
			мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "Свойства", ВрмВозврат.Получить("Свойства"));
			мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "СвойстваОтключенные", ВрмВозврат.Получить("СвойстваОтключенные"));

			// ТаблицаЗначенийВXML(мТаблицаПравилКонвертацииОбъектов.ПолучитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "Свойства"), Шаблон("z:\debug_Свойства_[ВрмИмяПКО].xml"));
			// ТаблицаЗначенийВXML(мТаблицаПравилКонвертацииОбъектов.ПолучитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "СвойстваПоиска"), Шаблон("z:\debug_СвойстваПоиска_[ВрмИмяПКО].xml"));
			
			Если Число(мТаблицаПравилКонвертацииОбъектов.ПолучитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "СинхронизироватьПоИдентификатору")) = 1 Тогда
				
				Свойства = мТаблицаПравилКонвертацииОбъектов.СвойстваПоиска;
				Свойства.НоваяСтрока();
				Свойства.ТекущаяСтрока(Свойства.КоличествоСтрок());
				Свойства.Наименование	= "{УникальныйИдентификатор}";
				Свойства.Источник		= "{УникальныйИдентификатор}";
				Свойства.Приемник		= "{УникальныйИдентификатор}";

			КонецЕсли;
			
			// ТипТега = мЧтениеXML.Следующий();
			Продолжить;

			
		ИначеЕсли Имя = "Значения" Тогда
			
			// мТаблицаПравилКонвертацииОбъектов.Значения = СоздатьОбъект("СписокЗначений");
			// ЗагрузитьПравилаКонвертацииЗначений();
			ВрмЗначения = ЗагрузитьЗначения(ВрмУзел);
			мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), "ЗначенияПредопределенныхДанныхПрочитанные", ВрмЗначения);
			// ТипТега = мЧтениеXML.Следующий();
			Продолжить;

		ИначеЕсли (Имя = "Комментарий") ИЛИ (Имя = "Описание") Тогда
			
			// ТипТега = мЧтениеXML.Следующий();
			Продолжить;

		Иначе
			
			Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
			// Значение = ПолучитьЗначениеУзлаИзXML();
			
		КонецЕсли;

		// Сообщить(Шаблон("{[Имя]}{[Значение]}"));
		мТаблицаПравилКонвертацииОбъектов.УстановитьЗначение(мТаблицаПравилКонвертацииОбъектов.ТекущаяСтрока(), Имя, Значение);
		
		// ТипТега = мЧтениеXML.Следующий();
	
	КонецЦикла;
	
КонецПроцедуры // ЗагрузитьПравилоКонвертации()

Процедура ЗагрузитьГруппуПравилКонвертации(ВхУзел, ВхУзелКорреспондент)
	
	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Правило");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьПравилоКонвертации(ВрмУзел, ВхУзелКорреспондент);
		// Возврат;
	КонецЦикла;
	
	// ЗагрузитьПравилоКонвертации_РежимыВыгрузкиОбъектовОбмена(ЗаписьXML);
	
КонецПроцедуры

// Осуществляет загрузку правил конвертации объектов.
//
// Параметры:
//  ПравилаОбмена  - Объект типа XMLЧтение.
//  ЗаписьXML      - Объект типа XMLЗапись - правила, сохраняемые в файл обмена и
//                   используемые при загрузке данных.
// 
Процедура ЗагрузитьПравилаКонвертации(ВхУзел, ВхУзелКорреспондент)
	
	ВрмУзелКорреспондент = ЗаписатьПодчиненныйЭлемент(ВхУзелКорреспондент, "ПравилаКонвертацииОбъектов");
	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Группа");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		// ЗагрузитьГруппуПравилКонвертации(ВрмУзел, ВрмУзелКорреспондент);
		ЗагрузитьПравилаКонвертации(ВрмУзел, ВхУзелКорреспондент);
		// Возврат;
	КонецЦикла;

	ВрмВыборкаУзлов = ВхУзел.ВыбратьУзлы("Правило");
	Для ВрмИндекс = 0 По ВрмВыборкаУзлов.КоличествоУзлов - 1 Цикл

		ВрмУзел = ВрмВыборкаУзлов.ПолучитьУзел(ВрмИндекс);
		ЗагрузитьПравилоКонвертации(ВрмУзел, ВрмУзелКорреспондент);
		
	КонецЦикла;

	// ЗагрузитьПравилоКонвертации_РежимыВыгрузкиОбъектовОбмена(ЗаписьXML);
	
КонецПроцедуры

// Осуществляет загрузку правил обмена в соответствии с форматом.
//
// Параметры:
//  Источник       - Объект, из которого осуществляется загрузка правил обмена;
//  ТипИсточника   - Строка, указывающая тип источника: "XMLФайл", "ЧтениеXML", "Строка".
//  Универсальная
Процедура ЗагрузитьПравилаОбмена(Источник = "",	ТипИсточника = "XMLФайл", СтрокаСообщенияОбОшибке = "",	ЗагружатьТолькоЗаголовокПравил = 0)

	// ИнициализироватьМенеджерыИСообщения();
	
	// ЕстьГлобальныйОбработчикПередВыгрузкойОбъекта    = 0;
	// ЕстьГлобальныйОбработчикПослеВыгрузкиОбъекта     = 0;
	
	// ЕстьГлобальныйОбработчикПередКонвертациейОбъекта = 0;
	
	// ЕстьГлобальныйОбработчикПередЗагрузкойОбъекта    = 0;
	// ЕстьГлобальныйОбработчикПослеЗагрузкиОбъекта     = 0;
	
	СоздатьСтруктуруКонвертации();

	ИнициализацияПравилКонвертацииСвойств();

	ИмяВременногоФайлаПравилОбмена = "";
	// Если ПустаяСтрока(Источник) Тогда
		
	// 	Источник = ИмяФайлаПравилОбмена;
		
	// КонецЕсли;

	ВрмПравилаОбмена = Источник;
	
	Если ТипИсточника="XMLФайл" Тогда
		
		Если ПустаяСтрока(Источник) = 1 Тогда
			СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(12);
			Возврат; 
		КонецЕсли;
		
		Если ФС.СуществуетФайл(Источник) = 0 Тогда
			СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(3);
			Возврат;
		КонецЕсли;
		
		ВрмПарсерХМЛ = СоздатьОбъект("AddIn.XMLParser");

		ВрмПравилаОбмена = ВрмПарсерХМЛ.СоздатьДокумент();
		ВрмПравилаОбмена.Загрузить(Источник);
		// ВрмПравилаОбмена.Прочитать();
		
	ИначеЕсли ТипИсточника="Строка" Тогда
		
		ВрмПарсерХМЛ = СоздатьОбъект("AddIn.XMLParser");

		ВрмПравилаОбмена = ВрмПарсерХМЛ.СоздатьДокумент();
		ВрмПравилаОбмена.ЗагрузитьИзСтроки(Источник);
		// ВрмПравилаОбмена.Прочитать();
		
	КонецЕсли;

	ВрмУзелПравилаОбмена = ВрмПравилаОбмена.ВыбратьУзел("ПравилаОбмена");
	Если ПустоеЗначение(ВрмУзелПравилаОбмена) = 1 Тогда
		СтрокаСообщенияОбОшибке = ЗаписатьВПротоколВыполнения(7);
		Возврат;
	КонецЕсли;

	ВрмПравилаОбменаКорреспондент = ВрмПарсерХМЛ.СоздатьДокумент();
	ВрмУзелПравилаОбменаКорреспондент = ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмПравилаОбменаКорреспондент, "ПравилаОбмена");

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ВерсияФормата");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ВерсияФормата", Значение);
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ВерсияФормата", Значение);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("Ид");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("Ид", Значение);
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "Ид", Значение);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("Наименование");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("Наименование", Значение);
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "Наименование", Значение);
	КонецЕсли;
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ДатаВремяСоздания");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Дата");
		мКонвертация.Установить("ДатаВремяСоздания", Значение);
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ДатаВремяСоздания", Значение);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("Источник");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("Источник", Значение);
		мКонвертация.Установить("ВерсияПлатформыИсточника", одАтрибут(ВрмУзел, "Строка", "ВерсияПлатформы"));
		мКонвертация.Установить("СинонимКонфигурации", одАтрибут(ВрмУзел, "Строка", "СинонимКонфигурации"));
		мКонвертация.Установить("ВерсияКонфигурации", одАтрибут(ВрмУзел, "Строка", "ВерсияКонфигурации"));
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "Источник", Значение);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("Приемник");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("Приемник", Значение);
		мКонвертация.Установить("ВерсияПлатформыИсточника", одАтрибут(ВрмУзел, "Строка", "ВерсияПлатформы"));
		мКонвертация.Установить("СинонимКонфигурации", одАтрибут(ВрмУзел, "Строка", "СинонимКонфигурации"));
		мКонвертация.Установить("ВерсияКонфигурации", одАтрибут(ВрмУзел, "Строка", "ВерсияКонфигурации"));
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "Приемник", Значение);
	КонецЕсли;

	Если ЗагружатьТолькоЗаголовокПравил = 1 Тогда
		Возврат;
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("Параметры");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		ЗагрузитьПараметры(ВрмУзел, ВрмУзелПравилаОбменаКорреспондент)
	КонецЕсли;
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПослеЗагрузкиПравилОбмена");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПослеЗагрузкиПравилОбмена", Значение);
		мКонвертация.Установить("ИмяОбработчикаПослеЗагрузкиПравилОбмена", "Конвертация_ПослеЗагрузкиПравилОбмена");
	КонецЕсли;
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПередВыгрузкойДанных");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПередВыгрузкойДанных", Значение);
		мКонвертация.Установить("ИмяОбработчикаПередВыгрузкойДанных", "Конвертация_ПередВыгрузкойДанных");
	КонецЕсли;
			
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПередПолучениемИзмененныхОбъектов");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПередПолучениемИзмененныхОбъектов", Значение);
		мКонвертация.Установить("ИмяОбработчикаПередПолучениемИзмененныхОбъектов", "Конвертация_ПередПолучениемИзмененныхОбъектов");
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПослеПолученияИнформацииОбУзлахОбмена");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПослеПолученияИнформацииОбУзлахОбмена", Значение);
		мКонвертация.Установить("ИмяОбработчикаПослеПолученияИнформацииОбУзлахОбмена", "Конвертация_ПослеПолученияИнформацииОбУзлахОбмена");
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ПослеПолученияИнформацииОбУзлахОбмена", Значение);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПослеВыгрузкиДанных");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПослеВыгрузкиДанных", Значение);
		мКонвертация.Установить("ИмяОбработчикаПослеВыгрузкиДанных", "Конвертация_ПослеВыгрузкиДанных");
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПередОтправкойИнформацииОбУдалении");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПередОтправкойИнформацииОбУдалении", Значение);
		мКонвертация.Установить("ИмяОбработчикаПередОтправкойИнформацииОбУдалении", "Конвертация_ПередОтправкойИнформацииОбУдалении");
	КонецЕсли;
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПередВыгрузкойОбъекта");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПередВыгрузкойОбъекта", Значение);
		мКонвертация.Установить("ИмяОбработчикаПередВыгрузкойОбъекта", "Конвертация_ПередВыгрузкойОбъекта");
		ЕстьГлобальныйОбработчикПередВыгрузкойОбъекта = ?(ПустаяСтрока(мКонвертация.ПередВыгрузкойОбъекта) = 1, 0, 1);
	КонецЕсли;
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПослеВыгрузкиОбъекта");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПослеВыгрузкиОбъекта", Значение);
		мКонвертация.Установить("ИмяОбработчикаПослеВыгрузкиОбъекта", "Конвертация_ПослеВыгрузкиОбъекта");
		ЕстьГлобальныйОбработчикПослеВыгрузкиОбъекта = ?(ПустаяСтрока(мКонвертация.ПослеВыгрузкиОбъекта) = 1, 0, 1);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПередЗагрузкойОбъекта");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПередЗагрузкойОбъекта", Значение);
		мКонвертация.Установить("ИмяОбработчикаПередЗагрузкойОбъекта", "Конвертация_ПередЗагрузкойОбъекта");
		ЕстьГлобальныйОбработчикПередЗагрузкойОбъекта = ?(ПустаяСтрока(мКонвертация.ПередЗагрузкойОбъекта) = 1, 0, 1);
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ПередЗагрузкойОбъекта", Значение);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПослеЗагрузкиОбъекта");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПослеЗагрузкиОбъекта", Значение);
		мКонвертация.Установить("ИмяОбработчикаПослеЗагрузкиОбъекта", "Конвертация_ПослеЗагрузкиОбъекта");
		ЕстьГлобальныйОбработчикПередЗагрузкойОбъекта = ?(ПустаяСтрока(мКонвертация.ПередЗагрузкойОбъекта) = 1, 0, 1);
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ПослеЗагрузкиОбъекта", Значение);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПередКонвертациейОбъекта");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПередКонвертациейОбъекта", Значение);
		мКонвертация.Установить("ИмяОбработчикаПередКонвертациейОбъекта", "Конвертация_ПередКонвертациейОбъекта");
		ЕстьГлобальныйОбработчикПередКонвертациейОбъекта = ?(ПустаяСтрока(мКонвертация.ПередКонвертациейОбъекта) = 1, 0, 1);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПередЗагрузкойДанных");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ИмяОбработчикаПередЗагрузкойДанных", "Конвертация_ПередЗагрузкойДанных");
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ПередЗагрузкойДанных", Значение);
	КонецЕсли;
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПослеЗагрузкиДанных");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ИмяОбработчикаПослеЗагрузкиДанных", "Конвертация_ПослеЗагрузкиДанных");
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ПослеЗагрузкиДанных", Значение);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПослеЗагрузкиПараметров");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПослеЗагрузкиПараметров", Значение);
		мКонвертация.Установить("ИмяОбработчикаПослеЗагрузкиПараметров", "Конвертация_ПослеЗагрузкиПараметров");
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ПослеЗагрузкиПараметров", Значение);
	КонецЕсли;
		
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПриПолученииИнформацииОбУдалении");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Строка");
		мКонвертация.Установить("ПриПолученииИнформацииОбУдалении", Значение);
		мКонвертация.Установить("ИмяОбработчикаПриПолученииИнформацииОбУдалении", "Конвертация_ПриПолученииИнформацииОбУдалении");
		ЗаписатьЭлемент(ВрмПравилаОбменаКорреспондент, ВрмУзелПравилаОбменаКорреспондент, "ПриПолученииИнформацииОбУдалении", Значение);
	КонецЕсли;
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("УдалятьСопоставленныеОбъектыВПриемникеПриИхУдаленииВИсточнике");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		Значение = одЗначениеЭлемента(ВрмУзел, "Число");
		мКонвертация.Установить("УдалятьСопоставленныеОбъектыВПриемникеПриИхУдаленииВИсточнике", Значение);
	КонецЕсли;
					
	// Правила
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПравилаКонвертацииОбъектов");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		мТаблицаПравилКонвертацииОбъектов.УдалитьСтроки();
		ЗагрузитьПравилаКонвертации(ВрмУзел, ВрмУзелПравилаОбменаКорреспондент);
		// ТаблицаЗначенийВXML(мТаблицаПравилКонвертацииОбъектов, "z:\debug_мТаблицаПравилКонвертацииОбъектов.xml");
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПравилаВыгрузкиДанных");
	Если мРежимОбмена = "Загрузка" Тогда

	ИначеЕсли ПустоеЗначение(ВрмУзел) = 0 Тогда
		ЗагрузитьПравилаВыгрузки(ВрмУзел);
	КонецЕсли;
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("ПравилаОчисткиДанных");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		ЗагрузитьПравилаОчистки(ВрмУзел, ВрмУзелПравилаОбменаКорреспондент);
	КонецЕсли;
		
	// Алгоритмы / Запросы / Обработки
	
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("Алгоритмы");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		ЗагрузитьАлгоритмы(ВрмУзел, ВрмУзелПравилаОбменаКорреспондент);
	КонецЕсли;

	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("Запросы");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		ЗагрузитьЗапросы(ВрмУзел, ВрмУзелПравилаОбменаКорреспондент);
	КонецЕсли;
		
	ВрмУзел = ВрмУзелПравилаОбмена.ВыбратьУзел("Обработки");
	Если ПустоеЗначение(ВрмУзел) = 0 Тогда
		// ЗагрузитьОбработки(ВрмУзел, ВрмУзелПравилаОбменаКорреспондент);
	КонецЕсли;

	мXMLПравила = ВрмУзелПравилаОбменаКорреспондент.ПредставлениеXML;

	ВрмУзелПравилаОбмена = ПолучитьПустоеЗначение();
	ВрмПравилаОбменаКорреспондент = ПолучитьПустоеЗначение();
	ВрмУзелПравилаОбмена = ПолучитьПустоеЗначение();
	ВрмПравилаОбмена = ПолучитьПустоеЗначение();

	ВрмПарсерХМЛ = ПолучитьПустоеЗначение();

	// СписокЗначенийВXML(мКонвертация, "z:\debug_мКонвертация.xml");

КонецПроцедуры

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция НайтиПравило(Объект, ИмяПравила = "")
	
	Перем НомерСтроки;
	
	Если ПустаяСтрока(СокрЛП(ИмяПравила)) = 0 Тогда
		
		мТаблицаПравилКонвертацииОбъектов.НайтиЗначение(СокрЛП(ИмяПравила), НомерСтроки, "Код");
		
	ИначеЕсли ТипЗначения(Объект) < 4 Тогда
	
		мТаблицаПравилКонвертацииОбъектов.НайтиЗначение(ТипЗначенияСтр(Объект), НомерСтроки, "Код");
		
	ИначеЕсли ТипЗначения(Объект) < 100 Тогда
	
		мТаблицаПравилКонвертацииОбъектов.НайтиЗначение(ТипЗначенияСтр(Объект) + "Ссылка." + Объект.Вид(), НомерСтроки, "Источник");
		
	Иначе
	
		НомерСтроки = 0;
		
	КонецЕсли;
	
	Возврат НомерСтроки; 

КонецФункции // НайтиПравило()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПолучитьРеквизитПКО(НомерПКО, Реквизит)
	
	Возврат мТаблицаПравилКонвертацииОбъектов.ПолучитьЗначение(НомерПКО, Реквизит);
	
КонецФункции // ПолучитьРеквизитПКО()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, Реквизит)
	
	Возврат КоллекцияПКС.ПолучитьЗначение(НомерПКС, Реквизит);
	
КонецФункции // ПолучитьРеквизитПКС()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДОСТУПА К ДАННЫМ
////////////////////////////////////////////////////////////////////////////////

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ПолучитьЗначение(Объект, Имя, ВхДата = 0)
	
	ВрмЗамер = НачатьЗамер("ПолучитьЗначение", Шаблон("Объект [Строка(Объект)]"));

	Значение = мПустоеЗначение;
	
	Если ТипЗначенияСтр(Объект) = "СписокЗначений" Тогда
		
		Значение = Объект.Получить(Имя);
		
	ИначеЕсли ТипЗначенияСтр(Объект) = "ТаблицаЗначений" Тогда
	
		Значение = Объект.ПолучитьЗначение(Объект.НомерСтроки, Имя);
		
	ИначеЕсли ТипЗначенияСтр(Объект) = "Справочник" Тогда
		
		Если Имя = "ПометкаУдаления" Тогда
			
			Значение = Объект.ПометкаУдаления();
		
		ИначеЕсли Имя = "Код" Тогда
			
			Значение = Объект.Код;
		
		ИначеЕсли Имя = "Наименование" Тогда
			
			Значение = Объект.Наименование;
		
		ИначеЕсли Имя = "ЭтоГруппа" Тогда
			
			Значение = Объект.ЭтоГруппа();
		
		ИначеЕсли Имя = "Родитель" Тогда
			
			Значение = Объект.Родитель;
			
		Иначе
	
			Попытка
			
        		Значение = Объект.ПолучитьАтрибут(Имя);
			
			Исключение
				
				ВывестиСообщение("Ошибка получения значения свойства объекта", "!!!");
				ВывестиСообщение(СимволТабуляции + "Объект: " + Строка(Объект) + ", свойство: " + Имя + ".");
				
			КонецПопытки;
			
			Если ТипЗначенияСтр(Значение) = "НеизвестныйОбъект" Тогда
				
				Значение = мПустоеЗначение;
			    
			КонецЕсли;
			
		КонецЕсли;
		 
	ИначеЕсли ТипЗначенияСтр(Объект) = "Документ" Тогда
		
		Если Имя = "ПометкаУдаления" Тогда
			
			Значение = Объект.ПометкаУдаления();
		
		ИначеЕсли Имя = "НомерДок" Тогда
			
			Значение = Объект.НомерДок;
			
		ИначеЕсли Имя = "ДатаДок" Тогда
			
			Значение = ПолучитьДатуV8(Объект.ДатаДок, Объект.ПолучитьВремя());
		
		ИначеЕсли Имя = "Проведен" Тогда
			
			Значение = Объект.Проведен();
		
		ИначеЕсли Имя = "ТабличнаяЧасть" Тогда
			
			Объект.ВыгрузитьТабличнуюЧасть(Значение);
			
		Иначе
         
			Значение = Объект.ПолучитьАтрибут(Имя);
			
		КонецЕсли;
		
	ИначеЕсли ТипЗначенияСтр(Объект) = "НеизвестныйОбъект" Тогда // Например, константы
		
		Попытка
		
			Значение = Объект.ПолучитьАтрибут(Имя);
		
		Исключение
			
			ВывестиСообщение("Ошибка получения значения свойства объекта", "!!!");
			ВывестиСообщение(СимволТабуляции + "Объект: " + Строка(Объект) + ", свойство: " + Имя + ".");
			
		КонецПопытки;
		
		// Возможно это периодическая константа
		Если ТипЗначенияСтр(Значение) = "НеизвестныйОбъект" Тогда
			
			Попытка
				
				Если ПустоеЗначение(ВхДата) = 1 Тогда
					ВхДата = ТекущаяДата();
				КонецЕсли;

				//Значение = Объект.ПолучитьАтрибут(Имя).Получить(ДатаОкончания);
				Значение = Объект.ПолучитьАтрибут(Имя).Получить(ВхДата);
			
			Исключение
				
				ВывестиСообщение("Ошибка получения значения свойства объекта", "!!!");
				ВывестиСообщение(СимволТабуляции + "Объект: " + Строка(Объект) + ", свойство: " + Имя + ".");
				
			КонецПопытки;
		
		КонецЕсли;
		
		// Тогда уж точно что-то еще нам неизвестное...
		Если ТипЗначенияСтр(Значение) = "НеизвестныйОбъект" Тогда
			
			Значение = мПустоеЗначение;
		
		КонецЕсли;
	
	КонецЕсли;
	
	ЗавершитьЗамер(ВрмЗамер);

	Возврат Значение;

КонецФункции // ПолучитьЗначение()

Функция ПолучитьДанные(ВхУзелОбменаИдентификатор, ВхСписокПараметры)

	ВрмЗамер = НачатьЗамер("ПолучитьДанные");

	ВрмПутьКаталогВходящихСообщений = Шаблон("[мКаталогОбмена][ВхУзелОбменаИдентификатор]\In\");
	Если ФС.СуществуетФайл(ВрмПутьКаталогВходящихСообщений) = 0 Тогда
		ФС.СоздатьКаталог(ВрмПутьКаталогВходящихСообщений);
	КонецЕсли;

	ВрмURLВебСервиса = ВхСписокПараметры.Получить("soap_uri");

	ВрмПараметры = СоздатьОбъект("СписокЗначений");
	ВрмПараметры.Установить("ExchangePlanName", "СН_Обмен_77"); //ВхСписокПараметры.Получить();
	ВрмПараметры.Установить("NodeCode", ВхСписокПараметры.Получить("id_self"));
	ВрмПараметры.Установить("FileID", "");
	ВрмПараметры.Установить("ContinuousOperation", "false");
	ВрмПараметры.Установить("Operation", "");
	ВрмПараметры.Установить("ContinuousOperationAllowed", "false");

	ВрмТелоЗапроса = ПолучитьТекстЗапрооса("UploadData", "http://www.1c.ru/SSL/Exchange_2_0_1_6", ВрмПараметры);
	ВрмВозврат = ЗапросSOAP(ВрмURLВебСервиса, "Exchange_2_0_1_6", ВрмТелоЗапроса);

	Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмВозврат = ОбработатьОтветSOAP(ВрмВозврат.Получить("Результат"), "UploadDataResponse");

	Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмИдСообщения = ВрмВозврат.Получить("FileID");

	ВрмПараметры = СоздатьОбъект("СписокЗначений");
	ВрмПараметры.Установить("FileId", ВрмИдСообщения);
	ВрмПараметры.Установить("BlockSize", "1024");

	ВрмТелоЗапроса = ПолучитьТекстЗапрооса("PrepareGetFile", "http://www.1c.ru/SSL/Exchange_2_0_1_6", ВрмПараметры);
	ВрмВозврат = ЗапросSOAP(ВрмURLВебСервиса, "Exchange_2_0_1_6", ВрмТелоЗапроса);

	Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмВозврат = ОбработатьОтветSOAP(ВрмВозврат.Получить("Результат"), "PrepareGetFileResponse");

	Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;
	
	ВрмИдПередачи = ВрмВозврат.Получить("TransferId");

	ВрмПутьКаталогФайла = Шаблон("[ВрмПутьКаталогВходящихСообщений][ВрмИдПередачи]\");
	Если ФС.СуществуетФайл(ВрмПутьКаталогФайла) = 0 Тогда
		ФС.СоздатьКаталог(ВрмПутьКаталогФайла);
	КонецЕсли;
	
	ВрмПараметры = СоздатьОбъект("СписокЗначений");
	ВрмПараметры.Установить("TransferId", ВрмИдПередачи);
	
	ВрмСписокЧастей = СоздатьОбъект("СписокЗначений");

	Для ВрмИндексЧастиФайла = 1 По Число(ВрмВозврат.Получить("PartQuantity")) Цикл
		
		ВрмПараметры.Установить("PartNumber", Формат(ВрмИндексЧастиФайла, "Ч"));

		ВрмТелоЗапроса = ПолучитьТекстЗапрооса("GetFilePart", "http://www.1c.ru/SSL/Exchange_2_0_1_6", ВрмПараметры);
		ВрмВозврат = ЗапросSOAP(ВрмURLВебСервиса, "Exchange_2_0_1_6", ВрмТелоЗапроса);
		
		ВрмВозврат = ОбработатьОтветSOAP(ВрмВозврат.Получить("Результат"), "GetFilePartResponse");

		Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
			Прервать;
			// Возврат ВрмВозврат;
		КонецЕсли;
		
		ВрмBase64ЧастьФайлаПолныйПуть = Шаблон("[ВрмПутьКаталогФайла]data.zip.b64.[ВрмИндексЧастиФайла]");
		СтрокаВФайл(ВрмВозврат.Получить("PartData"), ВрмBase64ЧастьФайлаПолныйПуть);

		ВрмСписокЧастей.Установить(ВрмИндексЧастиФайла, ВрмBase64ЧастьФайлаПолныйПуть);

	КонецЦикла;
	
	Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	Для ВрмИндексЧастиФайла = 1 По ВрмСписокЧастей.РазмерСписка() Цикл
		
		ВрмЧастьФайлаПолныйПуть = Шаблон("[ВрмПутьКаталогФайла]data.zip.[ВрмИндексЧастиФайла]");
		FileBase64ToFile(ВрмСписокЧастей.ПолучитьЗначение(ВрмИндексЧастиФайла), ВрмЧастьФайлаПолныйПуть);
		
		ВрмСписокЧастей.Установить(ВрмИндексЧастиФайла, ВрмЧастьФайлаПолныйПуть);

	КонецЦикла;
	
	ВрмПолныйПутьАрхива = Шаблон("[ВрмПутьКаталогФайла]data.zip");

	CombineFiles(ВрмСписокЧастей, ВрмПолныйПутьАрхива);

	// ВрмПутьКаталогСообщения = Шаблон("[ВрмПутьКаталогФайла]data\");

	// Если ФС.СуществуетФайл(ВрмПутьКаталогСообщения) = 0 Тогда
	// 	ФС.СоздатьКаталог(ВрмПутьКаталогСообщения);
	// КонецЕсли;
	
	ВрмВозврат = Разархивировать(ВрмПолныйПутьАрхива, ВрмПутьКаталогФайла);
	ВрмВозврат.Установить("СтатусВозврата", 1);
	
	ЗавершитьЗамер(ВрмЗамер);
	Возврат ВрмВозврат;

КонецФункции // ПолучитьДанные()

Функция ОтправитьДанные(ВхУзелОбменаИдентификатор, ВхСписокПараметры, ВхПолноеИмяФайла)
	
	ВрмЗамер = НачатьЗамер("ОтправитьДанные");

	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмИнфо = ПолучитьCOMОбъект("AddIn.V7SysInfo");
	ВрмИдПередачи = ВрмИнфо.СоздатьGUID();
	ВрмИнфо = ПолучитьПустоеЗначение();

	ВрмСоставПути = РазложитьПолноеИмяФайла(ВхПолноеИмяФайла);
	ВрмURLВебСервиса = ВхСписокПараметры.Получить("soap_uri");
	
	ВрмПутьКаталогФайла = ВрмСоставПути.Получить("Каталог");
	ВрмИмяФайла = ВрмСоставПути.Получить("ИмяФайла");

	ВрмПолныйПутьАрхива = Шаблон("[ВрмПутьКаталогФайла]data.zip");

	Архивировать(ВхПолноеИмяФайла, Шаблон("[ВрмИмяФайла]"), ВрмПолныйПутьАрхива);
	ВрмСписокЧастей = SplitFile(ВрмПолныйПутьАрхива);
	ВрмЧастиФайлаКоличество = ВрмСписокЧастей.РазмерСписка();
	Для ВрмИндексЧастиФайла = 1 По ВрмЧастиФайлаКоличество Цикл

		ВывестиСостояние(Шаблон("Файл. Преобразование Base64 части [ВрмИндексЧастиФайла] из [ВрмЧастиФайлаКоличество]"));

		ВрмЧастьФайла = ВрмСписокЧастей.ПолучитьЗначение(ВрмИндексЧастиФайла);

		ВрмЧастиИмениФайла = РазложитьПолноеИмяФайла(ВрмЧастьФайла);
		ВрмКаталог = ВрмЧастиИмениФайла.Получить("Каталог");
		ВрмИмяФайлаБезРасширения = ВрмЧастиИмениФайла.Получить("ИмяФайлаБезРасширения");
		ВрмРасширение = ВрмЧастиИмениФайла.Получить("Расширение");

		ВрмЧастьФайлаBase64 = Шаблон("[ВрмКаталог][ВрмИмяФайлаБезРасширения].b64.[ВрмРасширение]");
		FileToFileBase64(ВрмЧастьФайла, ВрмЧастьФайлаBase64);
		
		ВрмСписокЧастей.УстановитьЗначение(ВрмИндексЧастиФайла, ВрмЧастьФайлаBase64);

	КонецЦикла;
	
	ВрмЧастиФайлаКоличество = ВрмСписокЧастей.РазмерСписка();
	Для ВрмИндексЧастиФайла = 1 По ВрмЧастиФайлаКоличество Цикл
		
		ВывестиСостояние(Шаблон("Транспорт. Отправка части [ВрмИндексЧастиФайла] из [ВрмЧастиФайлаКоличество]"));

		ВрмЧастьФайлаBase64 = ВрмСписокЧастей.ПолучитьЗначение(ВрмИндексЧастиФайла);

		ВрмПараметры = СоздатьОбъект("СписокЗначений");
		ВрмПараметры.Установить("TransferId", ВрмИдПередачи);
		ВрмПараметры.Установить("PartNumber", ВрмИндексЧастиФайла);
		ВрмПараметры.Установить("PartData", ФайлВСтроку(ВрмЧастьФайлаBase64));
	
		ВрмТелоЗапроса = ПолучитьТекстЗапрооса("PutFilePart", "http://www.1c.ru/SSL/Exchange_2_0_1_6", ВрмПараметры);
		ВрмВозврат = ЗапросSOAP(ВрмURLВебСервиса, "Exchange_2_0_1_6", ВрмТелоЗапроса);
	
		Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
			Прервать;
			//Возврат ВрмВозврат;
		КонецЕсли;

		// ВрмЧастиИмениФайла = РазложитьПолноеИмяФайла(ВрмЧастьФайла);
		// ВрмКаталог = ВрмЧастиИмениФайла.Получить("Каталог");
		// ВрмИмяФайлаБезРасширения = ВрмЧастиИмениФайла.Получить("ИмяФайлаБезРасширения");
		// ВрмРасширение = ВрмЧастиИмениФайла.Получить("Расширение");

		// ВрмЧастьФайлаBase64 = Шаблон("[ВрмКаталог][ВрмИмяФайлаБезРасширения].b64.[ВрмРасширение]");
		// FileToFileBase64(ВрмЧастьФайла, ВрмЧастьФайлаBase64);
		
		// ВрмСписокЧастей.УстановитьЗначение(ВрмИндексЧастиФайла, ВрмЧастьФайлаBase64);

	КонецЦикла;

	ВывестиСостояние(Шаблон("Транспорт. Сохранение файла [ВрмИдПередачи] на сервере"));

	ВрмПараметры = СоздатьОбъект("СписокЗначений");
	ВрмПараметры.Установить("TransferId", ВрмИдПередачи);
	ВрмПараметры.Установить("PartQuantity", ВрмСписокЧастей.РазмерСписка());

	ВрмТелоЗапроса = ПолучитьТекстЗапрооса("SaveFileFromParts", "http://www.1c.ru/SSL/Exchange_2_0_1_6", ВрмПараметры);
	ВрмВозврат = ЗапросSOAP(ВрмURLВебСервиса, "Exchange_2_0_1_6", ВрмТелоЗапроса);

	Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
		// Прервать;
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;
	
	ВрмВозврат = ОбработатьОтветSOAP(ВрмВозврат.Получить("Результат"), "SaveFileFromPartsResponse");
	
	Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмИдФайла = ВрмВозврат.Получить("FileId");

	ВывестиСостояние(Шаблон("Транспорт. Обработка пакета [ВрмИдФайла] на сервере"));

	ВрмПараметры = СоздатьОбъект("СписокЗначений");
	ВрмПараметры.Установить("ExchangePlanName", "СН_Обмен_77"); //ВхСписокПараметры.Получить();
	ВрмПараметры.Установить("NodeCode", ВхСписокПараметры.Получить("id_self"));
	ВрмПараметры.Установить("FileID", ВрмИдФайла);
	ВрмПараметры.Установить("ContinuousOperation", "false");
	ВрмПараметры.Установить("Operation", "");
	ВрмПараметры.Установить("ContinuousOperationAllowed", "false");

	ВрмТелоЗапроса = ПолучитьТекстЗапрооса("DownloadData", "http://www.1c.ru/SSL/Exchange_2_0_1_6", ВрмПараметры);
	ВрмВозврат = ЗапросSOAP(ВрмURLВебСервиса, "Exchange_2_0_1_6", ВрмТелоЗапроса);

	ВывестиСостояние("");

	ЗавершитьЗамер(ВрмЗамер);
	Возврат ВрмВозврат;

КонецФункции // ОтправитьДанные()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБРАБОТКИ ВЫГРУЗКИ ПО ПРАВИЛАМ
////////////////////////////////////////////////////////////////////////////////

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ВыгрузитьГруппуСвойств(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, КоллекцияПКС, 
	НомерПКГС, УзелКоллекцииСвойств, ВыгрузитьТолькоСсылку = 0)

	ВрмЗамер = НачатьЗамер("ВыгрузитьГруппуСвойств", Шаблон("Источник [Строка(Источник)]"));

	КоллекцияОбъектов = мПустоеЗначение;
	НеЗамещать        = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "НеЗамещать");
	НеОчищать         = 0;

	
	// Обработчик "ПередОбработкойВыгрузки"
	Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ЕстьОбработчикПередОбработкойВыгрузки") = 1 Тогда
	// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ПередОбработкойВыгрузки") = 1 Тогда
		
		КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Код")));
		
		Отказ = Шаблон("[ПКГС_ПередОбработкойВыгрузки_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, КоллекцияОбъектов, НеЗамещать, НеОчищать)]");
		
		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
			
		КонецЕсли;

	КонецЕсли;

	ВидИсточника = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ВидИсточника");
    ВидПриемника = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ВидПриемника");
	
    // Создание узла коллекции подчиненных объектов
	Если ВидПриемника = "ТабличнаяЧасть" Тогда
		
		УзелКоллекцииОбъектов = СоздатьУзел(document, "ТабличнаяЧасть");
		УстановитьАтрибут(УзелКоллекцииОбъектов, "Имя",	ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник"));
		
		Если НеЗамещать = 1 Тогда
			
			УстановитьАтрибут(УзелКоллекцииОбъектов, "НеЗамещать", "true");
			
		КонецЕсли;
		
		Если НеОчищать = 1 Тогда
			
			УстановитьАтрибут(УзелКоллекцииОбъектов, "НеОчищать", "true");
			
		КонецЕсли;
	
	ИначеЕсли Найти(ВидПриемника, "НаборДвижений") > 0 Тогда
		
		УзелКоллекцииОбъектов = СоздатьУзел(document, "НаборЗаписей");
		УстановитьАтрибут(УзелКоллекцииОбъектов, "Имя",	ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник"));
		
		Если НеЗамещать = 1 Тогда
			
			УстановитьАтрибут(УзелКоллекцииОбъектов, "НеЗамещать", "true");
			
		КонецЕсли;
		
		Если НеОчищать = 1 Тогда
			
			УстановитьАтрибут(УзелКоллекцииОбъектов, "НеОчищать", "true");
			
		КонецЕсли;
		
	Иначе  // это простая группировка
		
		ВыгрузитьСвойства(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "СвойстваГруппы"), 
			УзелКоллекцииСвойств,, СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник")), , ВыгрузитьТолькоСсылку);
		
		// Обработчик "ПослеОбработкиВыгрузки"
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ЕстьОбработчикПослеОбработкиВыгрузки") = 1 Тогда
		// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ПослеОбработкиВыгрузки") = 1 Тогда
			
			КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Код")));
			
			Отказ = Шаблон("[ПКГС_ПослеОбработкиВыгрузки_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, УзелКоллекцииОбъектов)]");
	
		КонецЕсли;
		
		ЗавершитьЗамер(ВрмЗамер);
		Возврат;
		
	КонецЕсли;

	
	// Получение коллекции подчиненных объектов
	
	Если КоллекцияОбъектов <> мПустоеЗначение Тогда
		
		// Инициализировали коллекцию в обработчике ПередОбработкой
		
	ИначеЕсли ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ПолучитьИзВходящихДанных") = 1 Тогда
		
		КоллекцияОбъектов = ПолучитьЗначение(ВходящиеДанные, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник"));
		
	ИначеЕсли ВидИсточника = "ТабличнаяЧасть" Тогда
		
		КоллекцияОбъектов = ПолучитьЗначение(Источник, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Источник"));
		
	ИначеЕсли ПустаяСтрока(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Источник")) = 1 Тогда
		
		КоллекцияОбъектов = ПолучитьЗначение(Источник, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник"));
		
	КонецЕсли;

	Попытка
		
		КоллекцияОбъектов.ВыбратьСтроки();
		
	Исключение
		
		ВывестиСообщение("Ошибка выбора объектов коллекции", "!!!");
		ЗавершитьЗамер(ВрмЗамер);
		Возврат;
		
	КонецПопытки;
	
	Пока КоллекцияОбъектов.ПолучитьСтроку() > 0 Цикл
		
		Индекс = 1 + Индекс;
		КоллекцияОбъектов.ТекущаяСтрока(Индекс);
		
		// Обработчик "ПередВыгрузкой"
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ЕстьОбработчикПередВыгрузкой") = 1 Тогда
		// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ПередВыгрузкой") = 1 Тогда
			
			КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Код")));
			
			Отказ = Шаблон("[ПКГС_ПередВыгрузкой_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, КоллекцияОбъектов, УзелКоллекцииОбъектов)]");
			
			Если Число(Отказ) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
	
		КонецЕсли;
		
		УзелОбъектаКоллекции = СоздатьУзел(document, "Запись");
		СтандартнаяОбработка = 1;
		
		// Обработчик "ПриВыгрузке"
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ЕстьОбработчикПриВыгрузке") = 1 Тогда
		// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ПриВыгрузке") = 1 Тогда
			
			КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Код")));
			
			Отказ = Шаблон("[ПКГС_ПриВыгрузке_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, КоллекцияОбъектов, УзелКоллекцииОбъектов, УзелОбъектаКоллекции, СтандартнаяОбработка)]");
			
			Если Число(Отказ) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
	
		КонецЕсли;

		// Выгрузка свойств объекта коллекции
		
		Если СтандартнаяОбработка = 1 Тогда
			
			СвойстваГруппы = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "СвойстваГруппы");
			
			Если СвойстваГруппы.КоличествоСтрок() > 0 Тогда
				
				ВыгрузитьСвойства(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, СвойстваГруппы, УзелОбъектаКоллекции, 
					КоллекцияОбъектов, СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник")), , ВыгрузитьТолькоСсылку);
				
			Иначе
				
				//	ПО ПРАВИЛУ
				
			КонецЕсли;
			
		КонецЕсли;

		
		// Обработчик "ПослеВыгрузки"
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ЕстьОбработчикПослеВыгрузки") = 1 Тогда
		// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ПослеВыгрузки") = 1 Тогда
			
			КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Код")));
			
			Отказ = Шаблон("[ПКГС_ПослеВыгрузки_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, КоллекцияОбъектов, УзелКоллекцииОбъектов, УзелОбъектаКоллекции)]");
			
			Если Число(Отказ) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
	
		КонецЕсли;
		
		ДобавитьПодчиненный(УзелКоллекцииОбъектов, УзелОбъектаКоллекции);
		
	КонецЦикла;

	
	// Обработчик "ПослеОбработкиВыгрузки"
	Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ЕстьОбработчикПослеОбработкиВыгрузки") = 1 Тогда
	// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ПослеОбработкиВыгрузки") = 1 Тогда
		
		КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКГС, "Код")));
		
		Отказ = Шаблон("[ПКГС_ПослеОбработкиВыгрузки_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, УзелКоллекцииОбъектов)]");
		
		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
			
		КонецЕсли;

	КонецЕсли;

	ДобавитьПодчиненный(УзелКоллекцииСвойств, УзелКоллекцииОбъектов);

	ЗавершитьЗамер(ВрмЗамер);

КонецПроцедуры // ВыгрузитьГруппуСвойств()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ВыгрузитьСубконто(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, КоллекцияПКС, 
	НомерПКС, УзелКоллекцииСвойств = 0, ОбъектКоллекции = 0, ПравилоРодитель = "", Знач ВыгрузитьТолькоСсылку = 0)
	
	ВрмЗамер = НачатьЗамер("ВыгрузитьСубконто", Шаблон("Источник [Строка(Источник)]"));
	
	// Инициализация значения
	Значение = мПустоеЗначение;
	ИмяПКО = "";
	ИмяПКОВидСубконто = "";
	НеЗамещать   = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "НеЗамещать");
	
	Пусто		 = 0;
	Выражение	 = мПустоеЗначение;
	ТипПриемника = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ТипПриемника");
	
	// Обработчик "ПередВыгрузкой"
	Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПередВыгрузкой") = 1 Тогда
		
		КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + ?(ПустаяСтрока(ПравилоРодитель) = 1, "", ПравилоРодитель + "_") + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Код")));
		
		Отказ = Шаблон("[ПКС_ПередВыгрузкой_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКС, НомерПКО, ОбъектКоллекции, Значение, ТипПриемника, ИмяПКО, ИмяПКОВидСубконто, Пусто, Выражение, НеЗамещать, УзелКоллекцииСвойств)]");
		
		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
			
		КонецЕсли;

	КонецЕсли;
	
	Если Значение = мПустоеЗначение Тогда
		
		Если ОбъектКоллекции <> мПустоеЗначение Тогда
			
			Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПолучитьИзВходящихДанных") = 1 Тогда
				
				Значение = ПолучитьЗначение(ВходящиеДанные, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
				
			ИначеЕсли ПустаяСтрока(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Источник")) = 0 Тогда
				
				Значение = ПолучитьЗначение(ВходящиеДанные, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Источник"));
				
			Иначе

				Значение = ПолучитьЗначение(ОбъектКоллекции, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
				
			КонецЕсли;
			
		ИначеЕсли ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПолучитьИзВходящихДанных") = 1 Тогда
			
			Значение = ПолучитьЗначение(ОбъектКоллекции, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
					
		ИначеЕсли ПустаяСтрока(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Источник")) = 0 Тогда
			
			Значение = ПолучитьЗначение(Источник, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Источник"));
			
		Иначе
			
			Значение = ПолучитьЗначение(Источник, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если ТипЗначенияСтр(Значение) <> "ТаблицаЗначений" Тогда
		
		ВывестиСообщение("Коллекция субконто не является таблицей значений", "!!!");
		ЗавершитьЗамер(ВрмЗамер);
		Возврат;
	    
	КонецЕсли;
	
	Значение.ВыбратьСтроки();
	
	Пока Значение.ПолучитьСтроку() > 0 Цикл
		
		ВидСубконто = Значение.Ключ;
		Субконто = Значение.Значение;
		
		//Обработчик "ПриВыгрузке"
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПриВыгрузке") = 1 Тогда
			
			КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + ?(ПустаяСтрока(ПравилоРодитель) = 1, "", ПравилоРодитель + "_") + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Код")));
			
			Отказ = Шаблон("[ПКС_ПриВыгрузке_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКС, НомерПКО, ОбъектКоллекции, Значение, ВидСубконто, Субконто, Пусто, ИмяПКО, ИмяПКОВидСубконто, УзелСвойства)]");
			
			Если Число(Отказ) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
	
		КонецЕсли;
		
		Если ПустоеЗначение(Субконто) = 0 Тогда
			
			УзелСубконто = СоздатьУзел(document, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
			
			// Ключ
			УзелСвойства = СоздатьУзел(document, "Свойство");
			
		
			НомерПКОКлюч = НайтиПравило(, ИмяПКОВидСубконто);
			
			УстановитьАтрибут(УзелСвойства, "Имя", "Ключ");
			УстановитьАтрибут(УзелСвойства, "Тип", ПолучитьРеквизитПКО(НомерПКОКлюч, "Приемник"));
						
			УзелСсылки = ВыгрузитьПоПравилу(document, ВидСубконто,, ИсходящиеДанные,, ИмяПКОВидСубконто,,ВыгрузитьТолькоСсылку, НомерПКОКлюч);
			
			ТипУзлаСсылки = ТипЗначенияСтр(УзелСсылки);
			
			Если УзелСсылки = мПустоеЗначение Тогда
				
				Продолжить;
				
			ИначеЕсли ТипУзлаСсылки = "Строка" Тогда
				
				Если Найти(УзелСсылки, "</Ссылка>") > 0 Тогда
					
					ДобавитьПодчиненный(УзелСвойства, УзелСсылки);
					
				Иначе
					
					ЗаписатьЭлемент(document, УзелСвойства, "Значение", УзелСсылки);
					
				КонецЕсли;
				
			ИначеЕсли ТипУзлаСсылки = "Число" Тогда
				
				ЗаписатьЭлемент(document, УзелСвойства, "Нпп", УзелСсылки);
				
			Иначе
				
				//ДобавитьПодчиненный(УзелСвойства, УзелСсылки.cloneNode(1));
				КлонироватьПодчиненным(УзелСвойства, УзелСсылки);
				
			КонецЕсли;
			
			ДобавитьПодчиненный(УзелСубконто, УзелСвойства);
			
			// Значение
			УзелСвойства = СоздатьУзел(document, "Свойство");
			
			ТипЗначенияСубконто = ТипЗначенияСтр(Субконто);
			
			Если (ИмяПКО = "") И ((ТипЗначенияСубконто = "Строка") ИЛИ (ТипЗначенияСубконто = "Число") ИЛИ (ТипЗначенияСубконто = "Булево") ИЛИ (ТипЗначенияСубконто = "Дата")) Тогда
				
				НомерПКОЗначение = 0;
				ТипПриемника = ТипЗначенияСубконто;
				
			Иначе
			
				НомерПКОЗначение = НайтиПравило(Субконто, ИмяПКО);
				ТипПриемника = ПолучитьРеквизитПКО(НомерПКОЗначение, "Приемник");
				
			КонецЕсли;				
			
			УстановитьАтрибут(УзелСвойства, "Имя", "Значение");
			УстановитьАтрибут(УзелСвойства, "Тип", ТипПриемника);
			
			УзелСсылки = ВыгрузитьПоПравилу(document, Субконто,, ИсходящиеДанные,, ИмяПКО,, ВыгрузитьТолькоСсылку, НомерПКОЗначение);
			
			ТипУзлаСсылки = ТипЗначенияСтр(УзелСсылки);
			
			Если УзелСсылки = мПустоеЗначение Тогда
				
				Продолжить;
				
			ИначеЕсли ТипУзлаСсылки = "Строка" Тогда
				
				Если Найти(УзелСсылки, "</Ссылка>") > 0 Тогда
					
					ДобавитьПодчиненный(УзелСвойства, УзелСсылки);
					
				Иначе
					
					ЗаписатьЭлемент(document, УзелСвойства, "Значение", УзелСсылки);
					
				КонецЕсли;
				
			ИначеЕсли ТипУзлаСсылки = "Число" Тогда
				
				ЗаписатьЭлемент(document, УзелСвойства, "Нпп", УзелСсылки);
				
			Иначе
				
				// ДобавитьПодчиненный(УзелСвойства, УзелСсылки.cloneNode(1));
				КлонироватьПодчиненным(УзелСвойства, УзелСсылки);
				
			КонецЕсли;
			
			ДобавитьПодчиненный(УзелСубконто, УзелСвойства);
			
			// Обработчик "ПослеВыгрузки"
			Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПослеВыгрузки") = 1 Тогда
				
				КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + ?(ПустаяСтрока(ПравилоРодитель) = 1, "", ПравилоРодитель + "_") + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Код")));
				
				Отказ = Шаблон("[ПКС_ПослеВыгрузки_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКС, НомерПКО, ОбъектКоллекции, Значение, ВидСубконто, Субконто, ИмяПКО, ИмяПКОВидСубконто, УзелСвойства, УзелСсылки)]");
		
			КонецЕсли;
				
			ДобавитьПодчиненный(УзелКоллекцииСвойств, УзелСубконто);
				
		КонецЕсли;
		
	КонецЦикла;

	ЗавершитьЗамер(ВрмЗамер);
	
КонецПроцедуры // ВыгрузитьСубконто()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ВыгрузитьСвойства(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, КоллекцияПКС, УзелКоллекцииСвойств = 0, 
	ОбъектКоллекции = 0, ПравилоРодитель = "", ИмяПредопределенногоЭлемента = "", Знач ВыгрузитьТолькоСсылку = 0)
	
	ВрмЗамер = НачатьЗамер("ВыгрузитьСвойства", Шаблон("Источник [Строка(Источник)]"));

	Если УзелКоллекцииСвойств = 0 Тогда
		
		УзелКоллекцииСвойств = Приемник;
		
	КонецЕсли; 							
	
	// Выгружаем имя предопределенного если оно указано
	Если ПустаяСтрока(ИмяПредопределенногоЭлемента) = 0 Тогда
		УзелСвойства = СоздатьУзел(document, "Свойство");
		УстановитьАтрибут(УзелСвойства, "Имя", "{ИмяПредопределенногоЭлемента}");
		УстановитьАтрибут(УзелСвойства, "Тип", "Строка");
		ЗаписатьЭлемент(document, УзелСвойства, "Значение", ИмяПредопределенногоЭлемента);
		ДобавитьПодчиненный(УзелКоллекцииСвойств, УзелСвойства);
	КонецЕсли;
	
	Если ПустоеЗначение(КоллекцияПКС) = 1 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат;
	КонецЕсли;
	
	Для НомерПКС = 1 По КоллекцияПКС.КоличествоСтрок() Цикл
		
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ВидПриемника") = "ВидыСубконтоСчета" Тогда
			
			ВыгрузитьСубконто(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, КоллекцияПКС, НомерПКС, 
				УзелКоллекцииСвойств, ОбъектКоллекции, ПравилоРодитель, ВыгрузитьТолькоСсылку);
			
			Продолжить;

		ИначеЕсли ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Наименование") = "{УникальныйИдентификатор}" Тогда
			
			// СсылкаНаИсточник = ОпределитьСсылкуПоОбъектуИлиСсылке(Источник, ВыгружаетсяОбъект);
			
			УникальныйИдентификатор = ПолучитьУникальныйИдентификатор(Источник);
			
			УзелСвойства = СоздатьУзел(document, "Свойство");
			УстановитьАтрибут(УзелСвойства, "Имя", "{УникальныйИдентификатор}");
			УстановитьАтрибут(УзелСвойства, "Тип", "Строка");
			УстановитьАтрибут(УзелСвойства, "ТипИсточника", ПолучитьРеквизитПКО(НомерПКО, "Источник"));
			УстановитьАтрибут(УзелСвойства, "ТипПриемника", ПолучитьРеквизитПКО(НомерПКО, "Приемник"));
			ЗаписатьЭлемент(document, УзелСвойства, "Значение", УникальныйИдентификатор);
			ДобавитьПодчиненный(УзелКоллекцииСвойств, УзелСвойства);
			
			Продолжить;
			
		КонецЕсли;
		
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ЭтоГруппа") = 1 Тогда
			
			ВыгрузитьГруппуСвойств(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, КоллекцияПКС, НомерПКС, УзелКоллекцииСвойств, ВыгрузитьТолькоСсылку);
			Продолжить;
			
		КонецЕсли;

		//Инициализация конвертируемого значения
        Значение 	      = мПустоеЗначение;
		ИмяПКО		      = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "КодПравилаКонвертации");
		ИмяПКОВидСубконто = "";
		НеЗамещать        = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "НеЗамещать");
		
		Пусто		 = 0;
		Выражение	 = мПустоеЗначение;
		ТипПриемника = ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ТипПриемника");

		// Обработчик "ПередВыгрузкой"
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ЕстьОбработчикПередВыгрузкой") = 1 Тогда
		// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПередВыгрузкой") = 1 Тогда
			
			КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + ?(ПустаяСтрока(ПравилоРодитель) = 1, "", ПравилоРодитель + "_") + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Код")));
			
			Отказ = Шаблон("[ПКС_ПередВыгрузкой_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКС, НомерПКО, ОбъектКоллекции, Значение, ТипПриемника, ИмяПКО, ИмяПКОВидСубконто, Пусто, Выражение, НеЗамещать, УзелКоллекцииСвойств)]");
			
			Если Число(Отказ) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
	
		КонецЕсли;
		
        // Создаем узел свойства
		УзелСвойства = СоздатьУзел(document, "Свойство");
		УстановитьАтрибут(УзелСвойства, "Имя", ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
		
		Если НеЗамещать = 1 Тогда
			
			УстановитьАтрибут(УзелСвойства, "НеЗамещать", "true");
			
		КонецЕсли;
		
		// Возможно правило конвертации уже определено
		НомерПКОСвойств = мПустоеЗначение;
		
		Если ПустаяСтрока(ИмяПКО) = 0 Тогда
			
			НомерПКОСвойств = НайтиПравило(, ИмяПКО);
			
		КонецЕсли;
		
		// Попытка определить тип свойства приемника
		Если ПустаяСтрока(ТипПриемника) = 0 Тогда
			
			УстановитьАтрибут(УзелСвойства, "Тип", ТипПриемника);
			
		ИначеЕсли НомерПКОСвойств <> мПустоеЗначение Тогда
			
			ТипПриемника = ПолучитьРеквизитПКО(НомерПКОСвойств, "Приемник");
			УстановитьАтрибут(УзелСвойства, "Тип", ТипПриемника);
			
		КонецЕсли;

		// Определяем конвертируемое значение
		Если Выражение <> мПустоеЗначение Тогда
			
			ЗаписатьЭлемент(document, УзелСвойства, "Выражение", Выражение);
			ДобавитьПодчиненный(УзелКоллекцииСвойств, УзелСвойства);
			Продолжить;
			
		ИначеЕсли Пусто = 1 Тогда
			
			Если ПустаяСтрока(ТипПриемника) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
			
			ЗаписатьЭлемент(document, УзелСвойства, "Пусто");
			ДобавитьПодчиненный(УзелКоллекцииСвойств, УзелСвойства);
			Продолжить;
			
		ИначеЕсли Значение = мПустоеЗначение Тогда
			
			Если ОбъектКоллекции <> 0 Тогда
				
				Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПолучитьИзВходящихДанных") = 1 Тогда
					
					Попытка
						
						Значение = ПолучитьЗначение(ВходящиеДанные, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
						
					Исключение
						
						ВывестиСообщение("Ошибка получения свойства из входящих данных", "!!!");
						
					КонецПопытки;
					
				ИначеЕсли ПустаяСтрока(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Источник")) = 0 Тогда
					
					Попытка
						
						Значение = ПолучитьЗначение(ОбъектКоллекции, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Источник"));
						
					Исключение
						
						ВывестиСообщение("Ошибка получения свойства из объекта коллекции. Свойство: "+ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"), "!!!");
						
					КонецПопытки;
						
				Иначе

					Попытка
						
						Значение = ПолучитьЗначение(ОбъектКоллекции, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
						
					Исключение
						
						ВывестиСообщение("Ошибка получения свойства из объекта коллекции. Свойство: "+ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"), "!!!");
						
					КонецПопытки;
					
				КонецЕсли;
				
			ИначеЕсли ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПолучитьИзВходящихДанных") = 1 Тогда
				
				Попытка
					
					Значение = ПолучитьЗначение(ВходящиеДанные, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
					
				Исключение
					
				КонецПопытки;
				
			ИначеЕсли ПустаяСтрока(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Источник")) = 0 Тогда
				
				Попытка
					
					Значение = ПолучитьЗначение(Источник, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Источник"));
					
				Исключение
					
				КонецПопытки;
				
			Иначе // получаем конвертируемое значение по имени свойства приемника
				
				Попытка
					
					Значение = ПолучитьЗначение(Источник, ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник"));
					
				Исключение
					
				КонецПопытки;
				
			КонецЕсли;
				
		КонецЕсли;

		Пусто = ПустоеЗначение(Значение);
		
		//Обработчик "ПриВыгрузке"
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ЕстьОбработчикПриВыгрузке") = 1 Тогда
		// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПриВыгрузке") = 1 Тогда
			
			КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + ?(ПустаяСтрока(ПравилоРодитель) = 1, "", ПравилоРодитель + "_") + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Код")));
			
			Отказ = Шаблон("[ПКС_ПриВыгрузке_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКС, НомерПКО, ОбъектКоллекции, Значение, """", """", Пусто, ИмяПКО, ИмяПКОВидСубконто, УзелСвойства)]");
			
			Если Число(Отказ) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
	
		КонецЕсли;
		
		Пусто = ПустоеЗначение(Значение);
		
		Если Пусто = 1 Тогда
			
			Если ПустаяСтрока(ТипПриемника) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
			
			ЗаписатьЭлемент(document, УзелСвойства, "Пусто");
			ДобавитьПодчиненный(УзелКоллекцииСвойств, УзелСвойства);
			Продолжить;
			
		КонецЕсли;
		
		УзелСсылки = мПустоеЗначение;
		
		Если (НомерПКОСвойств <> мПустоеЗначение) ИЛИ (ПустаяСтрока(ИмяПКО) = 0) Тогда
			
			УзелСсылки    = ВыгрузитьПоПравилу(document, Значение,, ИсходящиеДанные,, ИмяПКО,, ВыгрузитьТолькоСсылку, НомерПКОСвойств);
			ТипУзлаСсылки = ТипЗначенияСтр(УзелСсылки);

			Если ПустаяСтрока(ТипПриемника) = 1 Тогда
				
				ТипПриемника = ПолучитьРеквизитПКО(НомерПКОСвойств, "Приемник");
				УстановитьАтрибут(УзелСвойства, "Тип", ТипПриемника);
				
			КонецЕсли;
			
			Если УзелСсылки = мПустоеЗначение Тогда
				
				Продолжить;
				
			ИначеЕсли ТипУзлаСсылки = "Строка" Тогда
				
				Если Найти(УзелСсылки, "</Ссылка>") > 0 Тогда
					
					ДобавитьПодчиненный(УзелСвойства, УзелСсылки);
					
				Иначе
					
					ЗаписатьЭлемент(document, УзелСвойства, "Значение", УзелСсылки);
					
				КонецЕсли;
				
			ИначеЕсли ТипУзлаСсылки = "Число" Тогда
				
				ЗаписатьЭлемент(document, УзелСвойства, "Нпп", УзелСсылки);
				
			Иначе
				
				//ДобавитьПодчиненный(УзелСвойства, УзелСсылки.cloneNode(1));
				КлонироватьПодчиненным(УзелСвойства, УзелСсылки);
				
			КонецЕсли;
			
		Иначе
			
			ТипЗнач = ТипЗначенияСтр(Значение);
			
			Если ТипЗнач = "Строка" Тогда
				
				Если ТипПриемника = "Строка"  Тогда
				ИначеЕсли ТипПриемника = "Число"  Тогда
					
					Значение = Число(Значение);
					
				ИначеЕсли ТипПриемника = "Булево"  Тогда
					
					Значение = Значение;
					
				ИначеЕсли ТипПриемника = "Дата"  Тогда
					
					Значение = Значение;
					
				ИначеЕсли ПустаяСтрока(ТипПриемника) = 1 Тогда
					
					УстановитьАтрибут(УзелСвойства, "Тип", "Строка");
					
				Иначе
					
				КонецЕсли;
				
				ЗаписатьЭлемент(document, УзелСвойства, "Значение", Значение);
				
			ИначеЕсли ТипЗнач = "Число" Тогда
				
				Если ТипПриемника = "Число"  Тогда
				ИначеЕсли ТипПриемника = "Булево"  Тогда
					
					Значение = ПривестиЗначениеКБулево(Значение);
					
				ИначеЕсли ТипПриемника = "Строка"  Тогда
				ИначеЕсли ПустаяСтрока(ТипПриемника) = 1 Тогда
					
					УстановитьАтрибут(УзелСвойства, "Тип", "Число");
					
				Иначе
					
					Продолжить;
					
				КонецЕсли;
				
				ЗаписатьЭлемент(document, УзелСвойства, "Значение", Значение);
				
			ИначеЕсли ТипЗнач = "Дата" Тогда
				
				Если ТипПриемника = "Дата"  Тогда
					
					Значение = ПолучитьДатуV8(Значение);
					
				ИначеЕсли ТипПриемника = "Строка"  Тогда
					
					Значение = Строка(Значение);
					
				ИначеЕсли ПустаяСтрока(ТипПриемника) = 1 Тогда
					
					УстановитьАтрибут(УзелСвойства, "Тип", "Дата");
					
				Иначе
					
					Продолжить;
					
				КонецЕсли;
				
				ЗаписатьЭлемент(document, УзелСвойства, "Значение", Значение);
				
			Иначе
				
				НомерПКОСвойств = НайтиПравило(Значение, "");
				
				Если НомерПКОСвойств > 0 Тогда
					
					ИмяПКО = ПолучитьРеквизитПКО(НомерПКОСвойств, "Код");
					
					Если ПустаяСтрока(ТипПриемника) = 1 Тогда
						
						ТипПриемника  = ПолучитьРеквизитПКО(НомерПКОСвойств, "Приемник");
						УстановитьАтрибут(УзелСвойства, "Тип", ТипПриемника);
						
					КонецЕсли;
					
					УзелСсылки    = ВыгрузитьПоПравилу(document, Значение,, ИсходящиеДанные,, ИмяПКО,, ВыгрузитьТолькоСсылку, НомерПКОСвойств);
					ТипУзлаСсылки = ТипЗначенияСтр(УзелСсылки);
					
					Если УзелСсылки = мПустоеЗначение Тогда
						
						Продолжить;
						
					ИначеЕсли ТипУзлаСсылки = "Строка" Тогда
						
						Если Найти(УзелСсылки, "</Ссылка>") > 0 Тогда
							
							ДобавитьПодчиненный(УзелСвойства, УзелСсылки);
							
						Иначе
							
							ЗаписатьЭлемент(document, УзелСвойства, "Значение", УзелСсылки);
							
						КонецЕсли;
						
					ИначеЕсли ТипУзлаСсылки = "Число" Тогда
						
						ЗаписатьЭлемент(document, УзелСвойства, "Нпп", УзелСсылки);
						
					Иначе
						
						// ДобавитьПодчиненный(УзелСвойства, УзелСсылки.cloneNode(1));
						КлонироватьПодчиненным(УзелСвойства, УзелСсылки);
						
					КонецЕсли;
					
				Иначе
					
					Продолжить;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;

		// Обработчик "ПослеВыгрузки"
		Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ЕстьОбработчикПослеВыгрузки") = 1 Тогда
		// Если ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ПослеВыгрузки") = 1 Тогда
			
			КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код")) + "_" + ?(ПустаяСтрока(ПравилоРодитель) = 1, "", ПравилоРодитель + "_") + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Приемник")) + "_" + СокрЛП(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "ВидПриемника")) + СокрЛП(Строка(ПолучитьРеквизитПКС(КоллекцияПКС, НомерПКС, "Код")));
			
			Отказ = Шаблон("[ПКС_ПослеВыгрузки_" + КодПравила + "(Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКС, НомерПКО, ОбъектКоллекции, Значение, """", """", ИмяПКО, ИмяПКОВидСубконто, УзелСвойства, УзелСсылки)]");
			
			Если Число(Отказ) = 1 Тогда
				
				Продолжить;
				
			КонецЕсли;
	
		КонецЕсли;
		
		ДобавитьПодчиненный(УзелКоллекцииСвойств, УзелСвойства);
		
	КонецЦикла;		//	по ПКС

	ЗавершитьЗамер(ВрмЗамер);

КонецПроцедуры // ВыгрузитьСвойства()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ВыгрузитьПоПравилу(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, ИмяПКО = "", УзелСсылки = "", Знач ТолькоПолучитьУзелСсылки = 0, НомерПКО = 0, ВыгружатьСсылкиУПодчиненныхОбъектов = 1)

	ВрмЗамер = НачатьЗамер("ВыгрузитьПоПравилу", Шаблон("Источник [Строка(Источник)]"));

	rootNode = document.ЭлементДокумента;
	// Поиск ПКО
	Если НомерПКО = 0 Тогда
		
		НомерПКО = НайтиПравило(Источник, ИмяПКО);
		

		
	ИначеЕсли ПустаяСтрока(ИмяПКО) = 0 Тогда
		
		НомерПКО = НайтиПравило(Источник, ИмяПКО);
		
		// Если НомерПКО = 0 Тогда
			
		// 	ВывестиСообщение("Не найдено правило конвертации объекта: " + ИмяПКО, "!!!");
		// 	Возврат мПустоеЗначение;
			
		// КонецЕсли;
			
	КонецЕсли;

	Если НомерПКО = 0 Тогда

		ЗП = ПолучитьСтруктуруЗаписиПротокола(45);
		
		ЗП.Установить("Объект", Источник);
		ЗП.Установить("ТипОбъекта", ПолучитьОписаниеТипа(Источник));
		ЗаписатьВПротоколВыполнения(45, ЗП, 1); // не найдено ПКО
			
		
		//ВывестиСообщение("Не найдено правило конвертации объекта: " + Строка(Источник), "!!!");
		ЗавершитьЗамер(ВрмЗамер);
		Возврат мПустоеЗначение;
		
	КонецЕсли;

	Если мСписокВыгружаемыхОбъектов.НайтиЗначение(Источник) > 0 Тогда

		ТолькоПолучитьУзелСсылки = 0;

	КонецЕсли;
	
	Если мКомментироватьВыгрузкуОбъектов	= 1 Тогда
		
		Попытка
			ИсточникВСтроку = Строка(Источник);
		Исключение
			ИсточникВСтроку = " ";
		КонецПопытки;
		
		ИмяДействия = ?(ТолькоПолучитьУзелСсылки = 1, "Конвертация ссылки на объект", "Конвертация объекта");
		
		ТекстСообщения = "[ИмяДействия]: [Объект]([ТипОбъекта]), ПКО: [ПКО]([НаименованиеПКО])";
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "[ИмяДействия]", ИмяДействия);
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "[Объект]", ИсточникВСтроку);
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "[ТипОбъекта]", ПолучитьОписаниеТипа(Источник));
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "[ПКО]", СокрЛП(ИмяПКО));
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "[НаименованиеПКО]", ПолучитьРеквизитПКО(НомерПКО, "Наименование"));
		
		ЗаписатьВПротоколВыполнения(ТекстСообщения, , 0, ТекущийУровеньВложенностиВыгрузитьПоПравилу + 1, 7);

		//ВывестиСообщение("Конвертация объекта или получение ссылки:  " + Строка(Источник) + "  (" + ТипЗначенияСтр(Источник) + ")");
		
	КонецЕсли;

	НеЗапоминатьВыгруженные     = ПолучитьРеквизитПКО(НомерПКО, "НеЗапоминатьВыгруженные");
	НеВыгружатьОбъектыСвойствПоСсылкам = ПолучитьРеквизитПКО(НомерПКО, "НеВыгружатьОбъектыСвойствПоСсылкам");
	ВыгруженныеОбъекты          = ПолучитьРеквизитПКО(НомерПКО, "Выгруженные");
	ВсеОбъектыВыгружены         = ПолучитьРеквизитПКО(НомерПКО, "ВсеОбъектыВыгружены");
	НеЗамещатьОбъектПриЗагрузке = ПолучитьРеквизитПКО(НомерПКО, "НеЗамещать");
	НеСоздаватьЕслиНеНайден     = ПолучитьРеквизитПКО(НомерПКО, "НеСоздаватьЕслиНеНайден");
	
	РежимЗаписи     			= "";
	РежимПроведения 			= "";
	
	// Ключ выгружаемых данных
	Если (ПустоеЗначение(Источник) = 0) И (НеЗапоминатьВыгруженные = 0) Тогда
		
		КлючВыгружаемыхДанных = ЗначениеВСтрокуВнутр(Источник);
		
	Иначе
		
		КлючВыгружаемыхДанных = НомерПКО;
		НеЗапоминатьВыгруженные = 1;
		
	КонецЕсли;
	
	// Переменная для хранения имени предопределенного элемента
	ИмяПредопределенногоЭлемента = "";

	// Глобальный обработчик "ПередКонвертациейОбъекта"
	Если мКонвертацияПередКонвертациейОбъекта = 1 Тогда
		
		Попытка
			Отказ = Шаблон("[Конвертация_ПередКонвертациейОбъекта(Источник, ВходящиеДанные, ИсходящиеДанные, ИмяПКО, КлючВыгружаемыхДанных, НеЗапоминатьВыгруженные, НеЗамещатьОбъектПриЗагрузке, НеСоздаватьЕслиНеНайден, ВсеОбъектыВыгружены, ТолькоПолучитьУзелСсылки, Приемник, РежимЗаписи, РежимПроведения)]");
		Исключение
			//ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(64, ОписаниеОшибки(), ПКО, Источник,"ПередКонвертациейОбъекта (глобальный)");
			ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(64, ОписаниеОшибки(), НомерПКО, Источник,"ПередКонвертациейОбъекта (глобальный)");
		КонецПопытки;
		
		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат мПустоеЗначение;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Обработчик "ПередВыгрузкой"
	Если ПолучитьРеквизитПКО(НомерПКО, "ПередВыгрузкой") = 1 Тогда
		
		КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код"));
		
		Попытка
			Отказ = Шаблон("[ПКО_ПередВыгрузкой_" + КодПравила + "(Источник, ВходящиеДанные, ИсходящиеДанные, ИмяПКО, КлючВыгружаемыхДанных, НеЗапоминатьВыгруженные, НеЗамещатьОбъектПриЗагрузке, НеСоздаватьЕслиНеНайден, ВсеОбъектыВыгружены, ТолькоПолучитьУзелСсылки, Приемник, РежимЗаписи, РежимПроведения)]");
		Исключение
			//ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(41, ОписаниеОшибки(), ПКО, Источник, "ПередВыгрузкойОбъекта");
			ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(41, ОписаниеОшибки(), НомерПКО, Источник, "ПередВыгрузкойОбъекта");
		КонецПопытки;
		
		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат мПустоеЗначение;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Возможно, такие данные уже выгружались
	Если ВсеОбъектыВыгружены = 0 Тогда
		
		Если НеЗапоминатьВыгруженные = 0 Тогда
			
			УзелСсылки = ВыгруженныеОбъекты.Получить(КлючВыгружаемыхДанных);
			
			Если ПустоеЗначение(УзелСсылки) = 0 Тогда
				
				ЗавершитьЗамер(ВрмЗамер);
				Возврат УзелСсылки;
				
			КонецЕсли;
			
		КонецЕсли;
		                                     
		Состояние("Выгружено объектов: " + мСчетчикВыгруженныхОбъектов);     
		
		мСчетчикВыгруженныхОбъектов = 1 + мСчетчикВыгруженныхОбъектов;
		Нпп = мСчетчикВыгруженныхОбъектов;

		// Это позволит избежать циклических ссылок
		Если НеЗапоминатьВыгруженные = 0 Тогда
			
			ВыгруженныеОбъекты.Установить(КлючВыгружаемыхДанных, Нпп);
			
		КонецЕсли;

	КонецЕсли; 
    
	СписокЗначенийВрем = ПолучитьРеквизитПКО(НомерПКО, "ЗначенияПредопределенныхДанных");
    СписокЗначений = СоздатьОбъект("СписокЗначений");
    СписокЗначенийВрем.выгрузить(СписокЗначений);
	
	// Если (ВерсияПлатформыПриемника = "8.0") Или (ВерсияПлатформыПриемника = "УП") Тогда
		
		Если ТипЗначения(Источник) <> 10 Тогда
			
			// Поиск в списке значений
			Если (ТипЗначения(Источник) = 16) Тогда //вид субконто
				
				ИмяПредопределенногоЭлемента = СписокЗначений.Получить(Строка(Источник.Идентификатор()));
				
			ИначеЕсли (ТипЗначения(Источник) = 14) Тогда //вид расчета
				
				ИмяПредопределенногоЭлемента = СписокЗначений.Получить(Строка(Источник.Код));
			
			Иначе
				
				ВрмИндекс = СписокЗначений.НайтиЗначение(Источник);
				Если ВрмИндекс > 0 Тогда
					СписокЗначений.ПолучитьЗначение(ВрмИндекс, ИмяПредопределенногоЭлемента);
				КонецЕсли;
				// ИмяПредопределенногоЭлемента = СписокЗначений.Получить(Строка(Источник));

			КонецЕсли;
			
			СписокЗначений.УдалитьВсе();
			
		Иначе
			
			ИмяПредопределенногоЭлемента = "";
			
		КонецЕсли;
		
	// КонецЕсли;
	
	НЕВыгружатьПодчиненныеОбъекты = ?((ТолькоПолучитьУзелСсылки = 1) ИЛИ (ВыгружатьСсылкиУПодчиненныхОбъектов = 0), 1, 0);

	Если СписокЗначений.РазмерСписка() = 0 Тогда
		
		СвойстваПоиска = ПолучитьРеквизитПКО(НомерПКО, "СвойстваПоиска");
		
		Если (СвойстваПоиска.КоличествоСтрок() > 0) ИЛИ (ПустаяСтрока(ИмяПредопределенногоЭлемента) = 0) Тогда
			
			Если (НеВыгружатьОбъектыСвойствПоСсылкам = 1) ИЛИ (НЕВыгружатьПодчиненныеОбъекты = 1) Тогда
				ВыгрузитьТолькоСсылку = 1;
			Иначе
		    	ВыгрузитьТолькоСсылку = 0;
			КонецЕсли;
			
			// Формируем узел ссылки
			УзелСсылки = СоздатьУзел(document, "Ссылка");
			
			Если (НеЗапоминатьВыгруженные = 0) И (ВсеОбъектыВыгружены = 0) Тогда
				
				УстановитьАтрибут(УзелСсылки, "Нпп", Нпп);
				
				Если НеСоздаватьЕслиНеНайден = 1 Тогда
					
					УстановитьАтрибут(УзелСсылки, "НеСоздаватьЕслиНеНайден", "true");
					
				КонецЕсли;
				
				ВыгрузитьСвойства(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, ПолучитьРеквизитПКО(НомерПКО, "СвойстваПоиска"), 
					УзелСсылки, , , ИмяПредопределенногоЭлемента, ВыгрузитьТолькоСсылку);
				
				ВыгруженныеОбъекты.Установить(КлючВыгружаемыхДанных, УзелСсылки);
				
			Иначе
				
				ВыгрузитьСвойства(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, ПолучитьРеквизитПКО(НомерПКО, "СвойстваПоиска"), 
					УзелСсылки, , , ИмяПредопределенногоЭлемента, ВыгрузитьТолькоСсылку);
				
			КонецЕсли;
			
		Иначе
			
			УзелСсылки = Нпп;
			
		КонецЕсли;
		
	Иначе
		
		// Поиск в списке значений
		// Если (ТипЗначения(Источник) = 10) ИЛИ (ТипЗначения(Источник) = 16) Тогда //Перечисление или вид субконто
		Если ТипЗначения(Источник) = 16 Тогда //вид субконто
			
			УзелСсылки = СписокЗначений.Получить(Строка(Источник.Идентификатор()));

		Иначе

			УзелСсылки = ""; //СписокЗначений.Получить(Строка(Источник));
			ВрмИндекс = СписокЗначений.НайтиЗначение(Источник);
			Если ВрмИндекс > 0 Тогда
				СписокЗначений.ПолучитьЗначение(ВрмИндекс, УзелСсылки);
			КонецЕсли;

		КонецЕсли;
		
		Если УзелСсылки = мПустоеЗначение Тогда
			
			// Записываем ошибку в протокол выполнения.
			ЗП = ПолучитьСтруктуруЗаписиПротокола();
			ЗП.Установить("ИмяПКО", ИмяПКО);
			ЗП.Установить("Значение", Источник);
			ЗП.Установить("ТипЗначения", ТипЗначенияСтр(Источник));
			ЗП.Установить("КСообщенияОбОшибках", 71);
			
			ЗаписатьВПротоколВыполнения(71, ЗП);

			ВывестиСообщение("Значение не найдено: " + Строка(Источник), "!!!");
			Возврат мПустоеЗначение;
			
		КонецЕсли;
		
		Если НеЗапоминатьВыгруженные = 0 Тогда
			
			ВыгруженныеОбъекты.Установить(КлючВыгружаемыхДанных, УзелСсылки);
			
		КонецЕсли;
		
		ЗавершитьЗамер(ВрмЗамер);
		Возврат УзелСсылки;
	
	КонецЕсли;
		
	Если (ТолькоПолучитьУзелСсылки = 1) ИЛИ (ВсеОбъектыВыгружены = 1) Тогда
		
		ЗавершитьЗамер(ВрмЗамер);
		Возврат УзелСсылки;
		
	КонецЕсли; 
	
	Если Приемник = мПустоеЗначение Тогда
		
		Приемник = СоздатьУзел(document, "Объект");
		УстановитьАтрибут(Приемник, "Нпп", Нпп);
		УстановитьАтрибут(Приемник, "Тип", ПолучитьРеквизитПКО(НомерПКО, "Приемник"));
		УстановитьАтрибут(Приемник, "ИмяПравила", ПолучитьРеквизитПКО(НомерПКО, "Код"));
		
		Если НеЗамещатьОбъектПриЗагрузке = 1 Тогда
			
			УстановитьАтрибут(Приемник, "НеЗамещать", "true");
			
		КонецЕсли;
		
		Если ПустаяСтрока(РежимЗаписи) = 0 Тогда
			
			УстановитьАтрибут(Приемник, "РежимЗаписи",	РежимЗаписи);
			
			Если ПустаяСтрока(РежимПроведения) = 0 Тогда
				
				УстановитьАтрибут(Приемник, "РежимПроведения",	РежимПроведения);
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если ТипЗначенияСтр(УзелСсылки) <> "Число" Тогда
			
			// ДобавитьПодчиненный(Приемник, УзелСсылки.cloneNode(1));
			КлонироватьПодчиненным(Приемник, УзелСсылки);
			
		КонецЕсли;
		
	КонецЕсли;
	
	СтандартнаяОбработка = 1;
   	
	// Обработчик "ПриВыгрузке"
	Если ПолучитьРеквизитПКО(НомерПКО, "ПриВыгрузке") = 1 Тогда
		
		КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код"));
		
		Попытка

			Отказ = Шаблон("[ПКО_ПриВыгрузке_" + КодПравила + "(Источник, ВходящиеДанные, ИсходящиеДанные, ИмяПКО, СтандартнаяОбработка, Приемник, УзелСсылки)]");

		Исключение
			//ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(42, ОписаниеОшибки(), ПКО, Источник, "ПриВыгрузкеОбъекта");
			ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(42, ОписаниеОшибки(), НомерПКО, Источник, "ПриВыгрузкеОбъекта");
		КонецПопытки;

	КонецЕсли;
	
	// Выгрузка свойств
	Если СтандартнаяОбработка = 1 Тогда
		
		Если (НеВыгружатьОбъектыСвойствПоСсылкам = 1) ИЛИ (НЕВыгружатьПодчиненныеОбъекты = 1) Тогда
			ВыгрузитьТолькоСсылку = 1;
		Иначе
			ВыгрузитьТолькоСсылку = 0;
		КонецЕсли;
		
		ВыгрузитьСвойства(document, Источник, Приемник, ВходящиеДанные, ИсходящиеДанные, НомерПКО, ПолучитьРеквизитПКО(НомерПКО, "Свойства"),
			, , , , ВыгрузитьТолькоСсылку);
		
	КонецЕсли; 
	
	// Обработчик ПослеВыгрузки
	Если ПолучитьРеквизитПКО(НомерПКО, "ПослеВыгрузки") = 1 Тогда
		
		КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код"));
		
		Попытка
			Отказ = Шаблон("[ПКО_ПослеВыгрузки_" + КодПравила + "(Источник, ВходящиеДанные, ИсходящиеДанные, ИмяПКО, Приемник, УзелСсылки)]");
		Исключение
			// ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(43, ОписаниеОшибки(), ПКО, Источник, "ПослеВыгрузкиОбъекта");
			ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(43, ОписаниеОшибки(), НомерПКО, Источник, "ПослеВыгрузкиОбъекта");
		КонецПопытки;

		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат УзелСсылки;
			
		КонецЕсли;

	КонецЕсли;
	
	// Запись объекта
	ДобавитьПодчиненный(rootNode, Приемник);
	
	// Обработчик ПослеВыгрузкиВФайлОбмена
	Если ПолучитьРеквизитПКО(НомерПКО, "ПослеВыгрузкиВФайл") = 1 Тогда
		
		КодПравила = СокрЛП(ПолучитьРеквизитПКО(НомерПКО, "Код"));
		
		Попытка
			Отказ = Шаблон("[ПКО_ПослеВыгрузкиВФайлОбмена_" + КодПравила + "(Источник, ВходящиеДанные, ИсходящиеДанные, ИмяПКО, Приемник, УзелСсылки)]");
		Исключение
			// ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(79, ОписаниеОшибки(), ПКО, Источник, "ЕстьОбработчикПослеВыгрузкиВФайл");
			ЗаписатьИнформациюОбОшибкеВыгрузкиОбработчикаПКО(79, ОписаниеОшибки(), НомерПКО, Источник, "ЕстьОбработчикПослеВыгрузкиВФайл");
		КонецПопытки;

		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат УзелСсылки;
			
		КонецЕсли;

	КонецЕсли;
	
	ЗавершитьЗамер(ВрмЗамер);
	Возврат УзелСсылки;

КонецФункции // ВыгрузитьПоПравилу()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//Данные, ПравилоВыгрузкиДанных, , ИсходящиеДанные
// Объект,
// ПравилоВыгрузки, 
// Свойства=Неопределено, 
// ВходящиеДанные = Неопределено,
// НеВыгружатьОбъектыСвойствПоСсылкам = Ложь, 
// ВыгрузкаСтрокиНабораЗаписей = Ложь, 
// УзелПредка = Неопределено, 
// ИмяКонстантыДляВыгрузки = "",
// ИмяПКО = "",
// ВызыватьСобытия = Истина)

Процедура ВыгрузкаОбъектаВыборки(document, Объект, Правило, ВходящиеДанные, НеВыгружатьОбъектыСвойствПоСсылкам = 0)
	
	Перем ИсходящиеДанные;
	
	ВрмЗамер = НачатьЗамер("ВыгрузкаОбъектаВыборки", Шаблон("Объект [Строка(Объект)]"));

	Если мКомментироватьВыгрузкуОбъектов = 1 Тогда
		
		Попытка
			ОбъектСтрока = Строка(Объект);
		Исключение
			ОбъектСтрока = "";
		КонецПопытки;

		Если ОбъектСтрока = "" Тогда
			ПрОбъекта = ОбъектСтрока + "  (" + ПолучитьОписаниеТипа(Объект) + ")";
		Иначе
			ПрОбъекта = ТипЗначенияСтр(Объект);
		КонецЕсли;
		
		ИмяСобытия = Шаблон("ВыгрузкаОбъекта: [ПрОбъекта]");
		
		ЗаписатьВПротоколВыполнения(ИмяСобытия, , 0, 1, 7);

		// Попытка
			
		// 	ПредставлениеОбъекта = Строка(Объект) + "  (" + ТипЗначенияСтр(Объект) + ")";
		// 	ВывестиСообщение("Выгрузка объекта выборки:  " + ПредставлениеОбъекта);
			
		// Исключение
			
		// 	ВывестиСообщение("Выгрузка объекта выборки:  " + ТипЗначенияСтр(Объект));
			
		// КонецПопытки; 
	
	КонецЕсли;
	
	ИмяПКО = Правило.Получить("КодПравилаКонвертации");
	
	НомерПКО = НайтиПравило(, ИмяПКО);
	
	// Глобальный обработчик "ПередВыгрузкойОбъекта"
	Если мКонвертацияПередВыгрузкойОбъекта = 1 Тогда
		
		Попытка
			Отказ = Шаблон("[Конвертация_ПередВыгрузкойОбъекта(ИмяПКО, Правило, Объект, ИсходящиеДанные, ВходящиеДанные)]");
		Исключение
			Отказ = 1;
			ЗаписатьИнформациюОбОшибкеОбработчикиПВД(65, ОписаниеОшибки(), Правило.Имя,"ПередВыгрузкойОбъектаВыборки (глобальный)", Объект);
		КонецПопытки;

		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Обработчик "ПередВыгрузкойОбъекта"
	Если Правило.Получить("ПередВыгрузкойОбъекта") = 1 Тогда
		
		Попытка
			Отказ = Шаблон("[ПВД_ПередВыгрузкойОбъекта_" + СокрЛП(Правило.Получить("Код")) + "(ИмяПКО, Правило, Объект, ИсходящиеДанные, ВходящиеДанные)]");
		Исключение
			Отказ = 1;
			ЗаписатьИнформациюОбОшибкеОбработчикиПВД(33, ОписаниеОшибки(), Правило.Имя, "ПередВыгрузкойОбъектаВыборки", Объект);
		КонецПопытки;
		
		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
			
		КонецЕсли;
		
	КонецЕсли;
	
    УзелСсылки = мПустоеЗначение;
	
	ВыгрузитьПоПравилу(document, Объект,, ИсходящиеДанные,, ИмяПКО, УзелСсылки,, НомерПКО, ?(НеВыгружатьОбъектыСвойствПоСсылкам =0 , 1, 0));
	
	// Глобальный обработчик "ПослеВыгрузкиОбъекта"
	Если мКонвертацияПослеВыгрузкиОбъекта = 1 Тогда
		Попытка
			Отказ = Шаблон("[Конвертация_ПослеВыгрузкиОбъекта(ИмяПКО, Правило, Объект, ИсходящиеДанные, ВходящиеДанные, УзелСсылки)]");
		Исключение
			ЗаписатьИнформациюОбОшибкеОбработчикиПВД(69, ОписаниеОшибки(), Правило.Имя,"ПослеВыгрузкиОбъектаВыборки (глобальный)", Объект);
		КонецПопытки;
	КонецЕсли;

	// Обработчик "ПослеВыгрузкиОбъекта"
	Если Правило.Получить("ПослеВыгрузкиОбъекта") = 1 Тогда
		Попытка
			Отказ = Шаблон("[ПВД_ПослеВыгрузкиОбъекта_" + СокрЛП(Правило.Получить("Код")) + "(ИмяПКО, Правило, Объект, ИсходящиеДанные, ВходящиеДанные, УзелСсылки)]");
		Исключение
			ЗаписатьИнформациюОбОшибкеОбработчикиПВД(34, ОписаниеОшибки(), Правило.Имя, "ПослеВыгрузкиОбъектаВыборки", Объект);
		КонецПопытки;
	КонецЕсли;
	
	ЗавершитьЗамер(ВрмЗамер);
	
КонецПроцедуры // ВыгрузкаОбъектаВыборки()

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ВыгрузитьДанныеПоПравилу(document, ИмяПравилаВыгрузки)
	
	Перем ИсходящиеДанные, ВыборкаДанных;
	
	Перем Индекс;

	ВрмЗамер = НачатьЗамер("ВыгрузитьДанныеПоПравилу", Шаблон("ИмяПравилаВыгрузки [Строка(ИмяПравилаВыгрузки)]"));

	Если Число(мПараметрыВыгрузки.ПолучитьЗначение("ИнтерактивнаяВыгрузка")) = 1 Тогда
		ДатаНачала = мПараметрыВыгрузки.ПолучитьЗначение("ДатаНачала");
		ДатаОкончания = мПараметрыВыгрузки.ПолучитьЗначение("ДатаОкончания");
	КонецЕсли;
	
	мТаблицаПравилВыгрузки.НайтиЗначение(ИмяПравилаВыгрузки, Индекс, "Код");
	
	Если Индекс = 0 Тогда
		
		ВывестиСообщение("Не найдено правило выгрузки: " + ИмяПравилаВыгрузки, "!!");
		ЗавершитьЗамер(ВрмЗамер);
		Возврат;
		
	КонецЕсли;
	
	Правило = мТаблицаПравилВыгрузки;
	ИмяПКО = мТаблицаПравилВыгрузки.КодПравилаКонвертации;
	
	Если мКомментироватьВыгрузкуОбъектов = 1 Тогда
		
		ИмяСобытия = Шаблон("Начало обработки правила выгрузки данных: [ИмяПравилаВыгрузки]");
		ЗаписатьВПротоколВыполнения(ИмяСобытия, , 0, 1, 7);
		
	КонецЕсли;
	
	// Обработчик "ПередОбработкойПравила"
	Если Правило.ПередОбработкойПравила = 1 Тогда
		
		Отказ = Шаблон("[ПВД_ПередОбработкойПравила_" + СокрЛП(Правило.Код) + "(ИмяПКО, Правило, ИсходящиеДанные, ВыборкаДанных)]");
		
		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Выборка данных
	Если Правило.СпособОтбораДанных = "СтандартнаяВыборка" Тогда
		                                                                           
		ЕстьОтбор = 0;
		Если ТипЗначенияСтр(мТаблицаПравилВыгрузки.Отбор) = "ТаблицаЗначений" Тогда
			мТаблицаПравилВыгрузки.Отбор.ВыбратьСтроки();
			Пока мТаблицаПравилВыгрузки.Отбор.ПолучитьСтроку() = 1 Цикл
				Если (мТаблицаПравилВыгрузки.Отбор.Использовать = 2) И (ПустаяСтрока(мТаблицаПравилВыгрузки.Отбор.ПолеОтбора)=0) Тогда
					ЕстьОтбор = 1;
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		ОбъектВыборки = СтрЗаменить(Правило.ОбъектВыборки, "Ссылка", "");
		ИмяТипа = Лев(ОбъектВыборки, Найти(ОбъектВыборки, ".") - 1); 
		
		Если ЕстьОтбор = 1 Тогда      
			                       
			Запрос = СоздатьОбъект("Запрос");
		    ТекстЗапроса = СоздатьЗапрос(ОбъектВыборки, мТаблицаПравилВыгрузки.Отбор);
			Если Запрос.Выполнить(ТекстЗапроса) = 0 Тогда
				Сообщить("Ошибка при выполнении запроса для отбора данных по правилу " + мТаблицаПравилВыгрузки.Наименование,"!"); 
				Сообщить("Выгрузка данных по этому правилу не проведена!","!");
				ЗавершитьЗамер(ВрмЗамер);
			    Возврат;
			КонецЕсли;       
			
			Пока Запрос.Группировка("ПеремОбъект") = 1 Цикл       
				ВыгрузкаОбъектаВыборки(document, Запрос.ПеремОбъект, Правило, ИсходящиеДанные);
			КонецЦикла;
			
		Иначе         
			
			Если ИмяТипа = "Справочник" Тогда
	
				Выборка = СоздатьОбъект(ОбъектВыборки);
				Выборка.ВыбратьЭлементы(0);
				
				Пока Выборка.ПолучитьЭлемент() > 0 Цикл
					
					ВыгрузкаОбъектаВыборки(document, Выборка.ТекущийЭлемент(), Правило, ИсходящиеДанные);
					
				КонецЦикла;
				
			ИначеЕсли ИмяТипа = "Документ" Тогда
				
				Выборка = СоздатьОбъект(ОбъектВыборки);
				Выборка.ВыбратьДокументы(ДатаНачала, ДатаОкончания);
				
				Пока Выборка.ПолучитьДокумент() > 0 Цикл
					
					ВыгрузкаОбъектаВыборки(document, Выборка.ТекущийДокумент(), Правило, ИсходящиеДанные);
					
				КонецЦикла;
			
			ИначеЕсли ОбъектВыборки = "КонстантыНабор" Тогда
				
				ВыгрузкаОбъектаВыборки(document, Константа, Правило, ИсходящиеДанные);
	
			ИначеЕсли ИмяТипа = "ПланСчетов" Тогда
				
				ЗавершитьЗамер(ВрмЗамер);
				Возврат;
				
			Иначе
				
				ЗавершитьЗамер(ВрмЗамер);
				Возврат;
				
			КонецЕсли;

			
		КонецЕсли;
		
			
	ИначеЕсли Правило.СпособОтбораДанных = "ПроизвольныйАлгоритм" Тогда
		
		Если ПустоеЗначение(ВыборкаДанных) = 0 Тогда
			
			Если ТипЗначенияСтр(ВыборкаДанных) = "ТаблицаЗначений" Тогда
				
				ВыборкаДанных.ВыбратьСтроки();
				
				Пока ВыборкаДанных.ПолучитьСтроку() > 0 Цикл
					
					ВыборкаДанных.ТекущаяСтрока(ВыборкаДанных.НомерСтроки);
					ВыгрузкаОбъектаВыборки(document, ВыборкаДанных, Правило, ИсходящиеДанные);
				
				КонецЦикла;                                             
				
			ИначеЕсли ТипЗначенияСтр(ВыборкаДанных) = "СписокЗначений" Тогда
				
				СчетчикЦикла = 0;
				Для СчетчикЦикла = 1 По ВыборкаДанных.РазмерСписка() Цикл     
					
					ОбъектДляВыгрузки = ВыборкаДанных.ПолучитьЗначение(СчетчикЦикла);	
					ВыгрузкаОбъектаВыборки(document, ОбъектДляВыгрузки, Правило, ИсходящиеДанные);
					
				КонецЦикла; 
			
			Иначе
				
				ЗавершитьЗамер(ВрмЗамер);
				Возврат;
				
			КонецЕсли;
			
		Иначе
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
			
		КонецЕсли;
	
	КонецЕсли;
	
	// Обработчик "ПослеОбработкиПравила"
	Если Правило.ПослеОбработкиПравила = 1 Тогда
		
		Отказ = Шаблон("[ПВД_ПослеОбработкиПравила_" + СокрЛП(Правило.Код) + "(ИмяПКО, Правило, ИсходящиеДанные)]");
		
	КонецЕсли;
	
	ЗавершитьЗамер(ВрмЗамер);

КонецПроцедуры // ВыгрузитьДанныеПоПравилу()

// Создает в файле обмена запись об удалении объекта.
//
// Параметры:
//	Ссылка - СправочникСсылка, ДокументСсылка - удаляемый объект.
//	ТипПриемника - Строка - Содержит строковое представление типа приемника.
//	ТипИсточника - Строка - Содержит строковое представление типа источника.
// 
Процедура ЗаписатьВФайлУдалениеОбъекта(document, Ссылка, Знач ТипПриемника, Знач ТипИсточника) Экспорт
	
	ВрмЗамер = НачатьЗамер("ЗаписатьВФайлУдалениеОбъекта");

	rootNode = document.ЭлементДокумента;

	Приемник = СоздатьУзел(document, "УдалениеОбъекта");
	
	УстановитьАтрибут(Приемник, "ТипПриемника", ТипПриемника);
	УстановитьАтрибут(Приемник, "ТипИсточника", ТипИсточника);
	
	УстановитьАтрибут(Приемник, "УникальныйИдентификатор", ПолучитьУникальныйИдентификатор(Ссылка));
	
	ДобавитьПодчиненный(rootNode, Приемник);

	ЗавершитьЗамер(ВрмЗамер);
	
КонецПроцедуры

Процедура ОтработатьУдалениеОбъекта(document, Источник, ВхТипОбъекта, СтрокаСообщенияОбОшибке = "")
	
	ВрмЗамер = НачатьЗамер("ОтработатьУдалениеОбъекта");
	// Ссылка = ДанныеОбУдаленииОбъекта.Ссылка;
	
	ТекстСобытия = "";
	//Если Конвертация.Свойство("ПередОтправкойИнформацииОбУдалении", ТекстСобытия) Тогда
	Если мКонвертацияПередОтправкойИнформацииОбУдалении = 1 Тогда
		
		Отказ = Шаблон("[Конвертация_ПередОтправкойИнформацииОбУдалении(Ссылка, Отказ)]");
		
		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
			
		КонецЕсли;

	КонецЕсли;
	
	НомерПКО = НайтиПравило(Источник);
		
	Если НомерПКО = 0 Тогда
		
		ВывестиСообщение("Не найдено правило конвертации объекта: " + Строка(Источник), "!!!");
		//Возврат мПустоеЗначение;
		
	КонецЕсли;
	
	// Менеджер = Менеджеры[ТипЗнч(Ссылка)];
	
	// // Проверка на существование менеджера и ПКО.
	// Если    Менеджер = Неопределено
	// 	ИЛИ Менеджер.ПКО = Неопределено Тогда
		
	// 	ЗП = ПолучитьСтруктуруЗаписиПротокола(45);
		
	// 	ЗП.Объект = Ссылка;
	// 	ЗП.ТипОбъекта = ТипЗнч(Ссылка);
		
	// 	ЗаписатьВПротоколВыполнения(45, ЗП, Истина);
	// 	Возврат;
		
	// КонецЕсли;

	ТипИсточника          = ПолучитьРеквизитПКО(НомерПКО, "Источник");
	ТипПриемника          = ПолучитьРеквизитПКО(НомерПКО, "Приемник");
	
	ЗаписатьВФайлУдалениеОбъекта(document, Источник, ТипПриемника, ТипИсточника);
	
	ЗавершитьЗамер(ВрмЗамер);

КонецПроцедуры

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ВывестиОбрабатываемоеПравило(ИмяПравила)
	
	Форма.ВывестиОбрабатываемоеПравило.Заголовок(ИмяПравила);

КонецПроцедуры // ВывестиОбрабатываемоеПравило(ИмяПравила)

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ОбработатьПравилаВыгрузки()
	
	// мТаблицаПравилВыгрузки.ВыбратьСтроки();
	
	// Пока мТаблицаПравилВыгрузки.ПолучитьСтроку() = 1 Цикл
		
	// 	Отключено = 0;
		
	// 	Позиция = ПравилаВыгрузкиСписок.НайтиЗначение(мТаблицаПравилВыгрузки.Код);
		
	// 	Если Позиция > 0 Тогда
			
	// 		Отключено = ?(ПравилаВыгрузкиСписок.Пометка(Позиция) = 1, 0, 1);
			
	// 	Иначе
			
	// 		Отключено = мТаблицаПравилВыгрузки.Отключить;
		
	// 	КонецЕсли;
		
	// 	Если Отключено = 1 Тогда
			
	// 		Продолжить;
			
	// 	КонецЕсли; 
	    
	// 	ВывестиОбрабатываемоеПравило(?(ПустоеЗначение(мТаблицаПравилВыгрузки.Наименование) = 1, мТаблицаПравилВыгрузки.Код, мТаблицаПравилВыгрузки.Наименование));
	// 	ВыгрузитьДанныеПоПравилу(мТаблицаПравилВыгрузки.Код);
		
	// КонецЦикла;
		
КонецПроцедуры // ОбработатьПравилаВыгрузки() 

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ИнициализацияФайлаОбмена(ВхПарсерХМЛ, document, rootNode) //, ВхИмяФайлаПравил)
	
	ВрмЗамер = НачатьЗамер("ИнициализацияФайлаОбмена");
	
	//УРБД
	//ДанныеПоОбмену ПланОбмена="_ДемоОбменСБиблиотекойСтандартныхПодсистем" Кому="EX" ОтКого="ДМ" НомерИсходящегоСообщения="78" НомерВходящегоСообщения="3" УдалитьРегистрациюИзменений="true" ВерсияОтправителя="3.0.1.428"
	
	//Общий
	//ФайлОбмена ВерсияФормата="3.1"
	//ДатаВыгрузки="2019-07-17T08:29:51"
	//ИмяКонфигурацииИсточника="БиблиотекаСтандартныхПодсистемДемо"
	//ВерсияКонфигурацииИсточника="2.4.4.65"
	//ИмяКонфигурацииПриемника="БиблиотекаСтандартныхПодсистемДемо"
	//ИдПравилКонвертации="ec46fcaa-aa19-4c1d-bc17-5c1d0e46b7a7"
	УстановитьАтрибут(rootNode, "ВерсияФормата", "2.0");
	УстановитьАтрибут(rootNode, "ДатаВыгрузки",  ПолучитьДатуV8(ТекущаяДата(), ТекущееВремя()));
	УстановитьАтрибут(rootNode, "ИмяКонфигурацииИсточника", мКонфигурацияИсточник);
	УстановитьАтрибут(rootNode, "ИмяКонфигурацииПриемника", мКонфигурацияПриемник);
	УстановитьАтрибут(rootNode, "ИдПравилКонвертации", мИд);

	//Если Число(мПараметрыВыгрузки.Получить("ИнтерактивнаяВыгрузка")) = 1 Тогда
	Если Число(мНастройкиОбмена.Получить("ИнтерактивнаяВыгрузка")) = 1 Тогда
		УстановитьАтрибут(rootNode, "НачалоПериодаВыгрузки", ПолучитьДатуV8(мПараметрыВыгрузки.ПолучитьЗначение("ДатаНачала")));
		УстановитьАтрибут(rootNode, "ОкончаниеПериодаВыгрузки", ПолучитьДатуV8(мПараметрыВыгрузки.ПолучитьЗначение("ДатаОкончания")));
		УстановитьАтрибут(rootNode, "Комментарий", "");
	КонецЕсли;
	
	// Правила обмена
	// УзелПравилаОбмена = СоздатьУзел(document, "ПравилаОбмена");

	// ЗаписатьЭлемент(document, УзелПравилаОбмена, "ВерсияФормата", мВерсияФормата);
	// ЗаписатьЭлемент(document, УзелПравилаОбмена, "Ид", мИд);
	// ЗаписатьЭлемент(document, УзелПравилаОбмена, "Наименование", мНаименование);
	// ЗаписатьЭлемент(document, УзелПравилаОбмена, "ДатаВремяСоздания", мДатаВремяСоздания);
	// ЗаписатьЭлемент(document, УзелПравилаОбмена, "Источник", мКонфигурацияИсточник);
	// ЗаписатьЭлемент(document, УзелПравилаОбмена, "Приемник", мКонфигурацияПриемник);
	
	// // Обработчики
	
	// Если ПустоеЗначение(мКонвертацияПередЗагрузкойДанных) = 0 Тогда
		
	// 	ЗаписатьЭлемент(document, УзелПравилаОбмена, "ПередЗагрузкойДанных", мКонвертацияПередЗагрузкойДанных);
	    
	// КонецЕсли;
	
	// Если ПустоеЗначение(мКонвертацияПередЗагрузкойОбъекта) = 0 Тогда
		
	// 	ЗаписатьЭлемент(document, УзелПравилаОбмена, "ПередЗагрузкойОбъекта", мКонвертацияПередЗагрузкойОбъекта);
	    
	// КонецЕсли;
	
	// Если ПустоеЗначение(мКонвертацияПослеЗагрузкиОбъекта) = 0 Тогда
		
	// 	ЗаписатьЭлемент(document, УзелПравилаОбмена, "ПослеЗагрузкиОбъекта", мКонвертацияПослеЗагрузкиОбъекта);
	    
	// КонецЕсли;
	
	// Если ПустоеЗначение(мКонвертацияПослеЗагрузкиДанных) = 0 Тогда
		
	// 	ЗаписатьЭлемент(document, УзелПравилаОбмена, "ПослеЗагрузкиДанных", мКонвертацияПослеЗагрузкиДанных);
	    
	// КонецЕсли;
	
	// // ПКО
	// УзелПКО = СоздатьУзел(document, "ПравилаКонвертацииОбъектов");
	
	// мТаблицаПравилКонвертацииОбъектов.ВыбратьСтроки();
	// Пока мТаблицаПравилКонвертацииОбъектов.ПолучитьСтроку() > 0 Цикл
		
	// 	УзелПравило = СоздатьУзел(document, "Правило");
		
	// 	ЗаписатьЭлемент(document, УзелПравило, "Код", мТаблицаПравилКонвертацииОбъектов.Код);
	// 	ЗаписатьЭлемент(document, УзелПравило, "Источник", мТаблицаПравилКонвертацииОбъектов.Источник);
	// 	ЗаписатьЭлемент(document, УзелПравило, "Приемник", мТаблицаПравилКонвертацииОбъектов.Приемник);
		
	// 	Если ПустоеЗначение(мТаблицаПравилКонвертацииОбъектов.НеЗамещать) = 0 Тогда
		
	// 		ЗаписатьЭлемент(document, УзелПравило, "НеЗамещать", мТаблицаПравилКонвертацииОбъектов.НеЗамещать);
			
	// 	КонецЕсли;
		
	// 	Если ПустоеЗначение(мТаблицаПравилКонвертацииОбъектов.ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли) = 0 Тогда
		
	// 		ЗаписатьЭлемент(document, УзелПравило, "ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли", мТаблицаПравилКонвертацииОбъектов.ПродолжитьПоискПоПолямПоискаЕслиПоИдентификаторуНеНашли);
			
	// 	КонецЕсли;
		
	// 	Если ПустоеЗначение(мТаблицаПравилКонвертацииОбъектов.ГенерироватьНовыйНомерИлиКодЕслиНеУказан) = 0 Тогда
		
	// 		ЗаписатьЭлемент(document, УзелПравило, "ГенерироватьНовыйНомерИлиКодЕслиНеУказан", мТаблицаПравилКонвертацииОбъектов.ГенерироватьНовыйНомерИлиКодЕслиНеУказан);
			
	// 	КонецЕсли;
		
	// 	Если ПустоеЗначение(мТаблицаПравилКонвертацииОбъектов.ПередЗагрузкой) = 0 Тогда
			
	// 		ЗаписатьЭлемент(document, УзелПравило, "ПередЗагрузкой", мТаблицаПравилКонвертацииОбъектов.ПередЗагрузкой);
			
	// 	КонецЕсли;
		
	// 	Если ПустоеЗначение(мТаблицаПравилКонвертацииОбъектов.ПриЗагрузке) = 0 Тогда
		
	// 		ЗаписатьЭлемент(document, УзелПравило, "ПриЗагрузке", мТаблицаПравилКонвертацииОбъектов.ПриЗагрузке);
		
	// 	КонецЕсли;
		
	// 	Если ПустоеЗначение(мТаблицаПравилКонвертацииОбъектов.ПослеЗагрузки) = 0 Тогда
		
	// 		ЗаписатьЭлемент(document, УзелПравило, "ПослеЗагрузки", мТаблицаПравилКонвертацииОбъектов.ПослеЗагрузки);
		
	// 	КонецЕсли;
		
	// 	Если ПустоеЗначение(мТаблицаПравилКонвертацииОбъектов.ПоследовательностьПолейПоиска) = 0 Тогда
		
	// 		ЗаписатьЭлемент(document, УзелПравило, "ПоследовательностьПолейПоиска", мТаблицаПравилКонвертацииОбъектов.ПоследовательностьПолейПоиска);
		
	// 	КонецЕсли;
		
	// 	ДобавитьПодчиненный(УзелПКО, УзелПравило);
		
	// КонецЦикла;
	
	// ДобавитьПодчиненный(УзелПравилаОбмена, УзелПКО);       
	                                          
	// Если ТаблицаПараметровДляЗагрузки.КоличествоСтрок() > 0 Тогда
	// 	УзелПараметры = СоздатьУзел(document, "Параметры");                    
	// 	ТаблицаПараметровДляЗагрузки.ВыбратьСтроки();
	// 	Пока ТаблицаПараметровДляЗагрузки.ПолучитьСтроку() = 1 Цикл
	// 		УзелПараметр = СоздатьУзел(document, "Параметр");  
	// 		УстановитьАтрибут(УзелПараметр, "Имя", ТаблицаПараметровДляЗагрузки.Имя); 
	// 		УстановитьАтрибут(УзелПараметр, "Наименование", ТаблицаПараметровДляЗагрузки.Наименование);
	// 		ДобавитьПодчиненный(УзелПараметры, УзелПараметр);       
	// 	КонецЦикла;
		
	// 	ДобавитьПодчиненный(УзелПравилаОбмена, УзелПараметры);       
	    
	// КонецЕсли;
	
	// ПОД
	// Попытка
	// 	_DOMDocument = CreateObject("Msxml2.DOMDocument.4.0");
	// Исключение
	// 	_DOMDocument = CreateObject("Msxml2.DOMDocument");
	// КонецПопытки;

	_DOMDocument = ВхПарсерХМЛ.СоздатьДокумент();
	_DOMDocument.Кодировка = "UTF-8";
	
	// _DOMDocument.load(ВхИмяФайлаПравил);
	_DOMDocument.ЗагрузитьИзСтроки(мXMLПравила);
	
	УзелПравила = _DOMDocument.selectSingleNode("ПравилаОбмена");
	// ДобавитьПодчиненный(УзелПравилаОбмена, УзелПОД);
	
	// УзелАлгоритмы = _DOMDocument.selectSingleNode("ПравилаОбмена/Алгоритмы");
    // ДобавитьПодчиненный(УзелПравилаОбмена, УзелАлгоритмы);

    // УзелЗапросы = _DOMDocument.selectSingleNode("ПравилаОбмена/Запросы");
    // ДобавитьПодчиненный(УзелПравилаОбмена, УзелЗапросы);

	ДобавитьПодчиненный(rootNode, УзелПравила);

	_DOMDocument = ПолучитьПустоеЗначение();

	ЗавершитьЗамер(ВрмЗамер);

КонецПроцедуры // ИнициализацияФайлаОбмена()

Процедура ЗаписатьДанныеПоОбмену(document, rootNode, ВхСписокПараметры, ВхНомерПринятого, ВхНомерОтправленного)
	
	ВрмЗамер = НачатьЗамер("ЗаписатьДанныеПоОбмену");

	ВрмПриемник = СоздатьУзел(document, "ДанныеПоОбмену");
	
	УстановитьАтрибут(ВрмПриемник, "ПланОбмена", "СН_Обмен_77");
	УстановитьАтрибут(ВрмПриемник, "Кому", ВхСписокПараметры.Получить("id_remote"));
	УстановитьАтрибут(ВрмПриемник, "ОтКого", ВхСписокПараметры.Получить("id_self"));
	
	// Атрибуты механизма квитирования сообщений обмена.
	УстановитьАтрибут(ВрмПриемник, "НомерИсходящегоСообщения", ВхНомерОтправленного);
	УстановитьАтрибут(ВрмПриемник, "НомерВходящегоСообщения",  ВхНомерПринятого);
	УстановитьАтрибут(ВрмПриемник, "УдалитьРегистрациюИзменений", "true");
	
	//УстановитьАтрибут(ВрмПриемник, "ВерсияОтправителя", СокрЛП(Метаданные.Версия));
	
	ДобавитьПодчиненный(rootNode, ВрмПриемник);
	
	ЗавершитьЗамер(ВрмЗамер);

КонецПроцедуры

//--------------------------------------------------------------------------------------------------
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура ЗафиксироватьОшибку(ТекстОшибки)
	
	СписокОшибок.ДобавитьЗначение(ТекстОшибки);
	
КонецПроцедуры // ЗафиксироватьОшибку()

//--------------------------------------------------------------------------------------------------

Процедура ЗаписатьОшибку(Содержание="", Маркер="")
                        
	Сообщить(Содержание, Маркер);
	// Сообщить("Порядковый номер объекта в файле:  " + гСчетчикЗагруженныхОбъектов);
	
КонецПроцедуры		// ЗаписатьОшибку()

//--------------------------------------------------------------------------------------------------
Процедура ЗаписатьОбъект(Объект, ВхИдентификаторПриемника = "", ВхТипИсточника = "", ВхТипПриемника = "")
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмТип = Лев(ВхТипПриемника, Найти(ВхТипПриемника, ".") - 1);
	// Если ФормФлРежимОтладки = 0 Тогда
	// 	Объект.Записать();
	// Иначе
	НачатьТранзакцию();
		// Попытка
			
			Объект.РегистрацияИзменений(0);
			Объект.Записать();
			Объект.РегистрацияИзменений(1);
			
			ВрмСсылка = ПолучитьПустоеЗначение();
			Если ПустаяСтрока(ВхИдентификаторПриемника) = 1 Тогда
				
			ИначеЕсли ВрмТип = "ДокументСсылка" Тогда
				ВрмСсылка = Объект.ТекущийДокумент();
			ИначеЕсли ВрмТип = "СправочникСсылка" Тогда
				ВрмСсылка = Объект.ТекущийЭлемент();
			КонецЕсли;

			Если ПустоеЗначение(ВрмСсылка) = 0 Тогда
				ВрмИдентификаторИсточника = ПолучитьУникальныйИдентификатор(ВрмСсылка);
				ВрмВозврат = ЗаписатьРегистрСоответствий(ВрмИдентификаторИсточника, ВхИдентификаторПриемника, ВхТипИсточника, ВхТипПриемника);
			КонецЕсли;

			Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда
				а = 1/0;
				//ВызватьИсключение "Неудачная попытка записи объекта: " + ОписаниеОшибки();
			КонецЕсли;

			ЗафиксироватьТранзакцию();

		// Исключение
		// 	ОтменитьТранзакцию();
		// 	ЗаписатьОшибку("Неудачная попытка записи объекта: " + ОписаниеОшибки());
		// КонецПопытки;
	// КонецЕсли;
		
КонецПроцедуры		//	ЗаписатьОбъект()


Функция ПрочитатьИнформациюОТипеРеквизита(ТипОбъекта, ВидОбъекта, Реквизит, Тип="", Вид="", Длина="")
	
    Если ПустоеЗначение(Реквизит) = 1 Тогда Возврат("") КонецЕсли;
	
	МД	=	Метаданные;
	
	Если		ТипОбъекта = "Справочник"		Тогда
		
		Если ПустоеЗначение(ВидОбъекта) = 1 Тогда Возврат("") КонецЕсли;
		ОбъектМД			=	МД.Справочник(ВидОбъекта);
		
		Если		Реквизит	= "Код"				Тогда
			Тип				=	?(ОбъектМД.ТипКода="Числовой", "Число", "Строка");
			Длина			=	ОбъектМД.ДлинаКода;
		ИначеЕсли	Реквизит	= "Наименование"	Тогда
			Тип				=	"Строка";
			Длина			=	ОбъектМД.ДлинаНаименования;
		ИначеЕсли	Реквизит	= "ПометкаУдаления"			Тогда
			Тип			=	"Число";
		ИначеЕсли	Реквизит	= "Родитель"		Тогда
			Тип				=	"Справочник";
			Вид				=	ВидОбъекта;
		ИначеЕсли	Реквизит	= "Владелец"	Тогда
			Тип				=	"Справочник";
			Вид				=	ОбъектМД.Владелец.Идентификатор;
		Иначе
			РеквМД			=	ОбъектМД.Реквизит(Реквизит);
			Если РеквМД.Выбран() = 0 Тогда Возврат("") КонецЕсли;
			Тип				=	РеквМД.Тип;
			Вид				=	РеквМД.Вид;
			Длина			=	РеквМД.Длина;
			//Точность		=	РеквМД.Точность;
			//Периодический	=	РеквМД.Периодический;
			Возврат(РеквМД);
		КонецЕсли;
		
	ИначеЕсли	ТипОбъекта = "Документ"			Тогда
                                           
		Если ПустоеЗначение(ВидОбъекта) = 1 Тогда Возврат("") КонецЕсли;
		ОбъектМД		= МД.Документ(ВидОбъекта);
		
		Если		Реквизит	= "НомерДок"		Тогда
			Тип			=	?(ОбъектМД.ТипНомера="Числовой", "Число", "Строка");
			Длина		=	ОбъектМД.ДлинаНомера;
		ИначеЕсли	Реквизит	= "ДатаДок"			Тогда
			Тип			=	"Дата";
		ИначеЕсли	Реквизит	= "ПометкаУдаления"			Тогда
			Тип			=	"Число";
		ИначеЕсли	Реквизит	= "ВремяДок"		Тогда
			Тип			=	"Строка";
			Длина		=	8;
		ИначеЕсли	Реквизит	= "НомерСтроки"		Тогда
			Тип			=	"Число";
			Длина		=	3;
			//Точность	=	0;
		Иначе
			РеквМД		= МД.ОбщийРеквизитДокумента(Реквизит);
			Если РеквМД.Выбран() = 0 Тогда	РеквМД = ОбъектМД.РеквизитШапки(Реквизит);
				Если РеквМД.Выбран() = 0 Тогда	РеквМД = ОбъектМД.РеквизитТабличнойЧасти(Реквизит)	КонецЕсли;
			КонецЕсли;
			Если РеквМД.Выбран() = 0 Тогда Возврат("") КонецЕсли;
			Тип			=	РеквМД.Тип;
			Вид			=	РеквМД.Вид;
			Длина		=	РеквМД.Длина;
			//Точность	=	РеквМД.Точность;
			Возврат(РеквМД);
		КонецЕсли;
		
	ИначеЕсли	ТипОбъекта = "Операция"			Тогда
		     
		Если		Реквизит	= "Содержание"				Тогда
			Тип			=	"Строка";
			Длина		=	МД.ДлинаСодержанияОперации;
		ИначеЕсли	Реквизит	= "СуммаОперации"			Тогда
			Тип			=	"Число";
			Длина		=	МД.ДлинаСуммыОперация;
			//Точность	=	МД.ТочностьСуммыОперации;
		ИначеЕсли	Реквизит	= "ДатаОперации"			Тогда
			Тип			=	"Дата";
		ИначеЕсли	Реквизит	= "Документ"				Тогда
			Тип			=	"Документ";
		ИначеЕсли	Реквизит	= "Сумма"					Тогда
			Тип			=	"Число";
			Длина		=	МД.ДлинаСуммыПроводки;
			//Точность	=	МД.ТочностьСуммыПроводки;
		ИначеЕсли	Реквизит	= "Количество"				Тогда
			Тип			=	"Число";
			Длина		=	МД.ДлинаКоличестваПроводки;
			//Точность	=	МД.ТочностьКоличестваПроводки;
		ИначеЕсли	Реквизит	= "ВалСумма"				Тогда
			Тип			=	"Число";
			Длина		=	МД.ДлинаВалютнойСуммыПроводки;
			//Точность	=	МД.ТочностьВалютнойСуммыПроводки;
		ИначеЕсли	Реквизит	= "Валюта"					Тогда
			Если МД.Валюта.Выбран() = 0 Тогда Возврат("") КонецЕсли;
			Тип			=	"Справочник";
			Вид			=	МД.Валюта.Идентификатор;
		Иначе
			РеквМД 		= МД.РеквизитОперации(Реквизит);
			Если РеквМД.Выбран() = 0 Тогда	РеквМД = МД.РеквизитПроводки(Реквизит)	КонецЕсли;
			Если РеквМД.Выбран() = 0 Тогда Возврат("") КонецЕсли;
			Тип			=	РеквМД.Тип;
			Вид			=	РеквМД.Вид;
			Длина		=	РеквМД.Длина;
			//Точность	=	РеквМД.Точность;
			Возврат(РеквМД);
		КонецЕсли;
	
	ИначеЕсли	ТипОбъекта = "ВидСубконто"		Тогда
		
		РеквМД		=	МД.ВидСубконто(Реквизит);
		Если РеквМД.Выбран() = 0 Тогда Возврат("") КонецЕсли;
		Тип			=	РеквМД.Тип;
		Вид			=	РеквМД.Вид;
		Длина		=	РеквМД.Длина;
		//Точность	=	РеквМД.Точность;
		Возврат(РеквМД);
		
	ИначеЕсли	ТипОбъекта = "ЖурналРасчетов"	Тогда
		                           
		ОбъектМД				=	МД.ЖурналРасчетов(ВидОбъекта);
		
		Если		Реквизит	= "Документ"					Тогда
			Тип			=	"Документ";
		ИначеЕсли	Реквизит	= "РодительскийДокумент"		Тогда
			Тип			=	"Документ";
		ИначеЕсли	Реквизит	= "Объект"						Тогда
			Тип			=	"Справочник";
			Вид			=	ОбъектМД.ОсновнойСправочник.Идентификатор;
		ИначеЕсли	Реквизит	= "ВидРасч"						Тогда
			Тип			=	"ВидРасчета";
		ИначеЕсли	Реквизит	= "ДатаНачала"					Тогда
			Тип			=	"Дата";
		ИначеЕсли	Реквизит	= "ДатаОкончания"				Тогда
			Тип			=	"Дата";
		ИначеЕсли	Реквизит	= "ПериодДействия"				Тогда
			Тип			=	"Дата";
		ИначеЕсли	Реквизит	= "ПериодРегистрации"			Тогда
			Тип			=	"Дата";
		ИначеЕсли	Реквизит	= "Сторно"						Тогда
			Тип			=	"Число";
			Длина		=	1;
			//Точность	=	0;
		ИначеЕсли	Реквизит	= "Рассчитана"					Тогда
			Тип			=	"Число";
			Длина		=	1;
			//Точность	=	0;
		ИначеЕсли	Реквизит	= "Исправлена"					Тогда
			Тип			=	"Число";
			Длина		=	1;
			//Точность	=	0;
		ИначеЕсли	Реквизит	= "Фиксирована"					Тогда
			Тип			=	"Число";
			Длина		=	1;
			//Точность	=	0;
		ИначеЕсли	Реквизит	= "Перерасчет"					Тогда
			Тип			=	"Число";
			Длина		=	1;
			//Точность	=	0;
		ИначеЕсли	Реквизит	= "ДокументПервичнойЗаписи"		Тогда
			Тип			=	"Документ";
		ИначеЕсли	Реквизит	= "РегистрацияПервичнойЗаписи"	Тогда
			Тип			=	"Дата";
		ИначеЕсли	Реквизит	= "Результат"					Тогда
			Тип			=	"Число";
			Длина		=	ОбъектМД.ДлинаРезультата;
			//Точность	=	ОбъектМД.ТочностьРезультата;
		ИначеЕсли	Реквизит	= "ПервичнаяЗапись"				Тогда
			
		Иначе
			
			РеквМД	= ОбъектМД.Реквизит(Реквизит);
			Если РеквМД.Выбран() = 0 Тогда Возврат("") КонецЕсли;
			Тип			=	РеквМД.Тип;
			Вид			=	РеквМД.Вид;
			Длина		=	РеквМД.Длина;
			//Точность	=	РеквМД.Точность;
			Возврат(РеквМД);
			
		КонецЕсли;
		
	ИначеЕсли	ТипОбъекта = "Константа"		Тогда
		
		РеквМД		=	МД.Константа(Реквизит);
		Если РеквМД.Выбран() = 0 Тогда Возврат("") КонецЕсли;
		Тип			=	РеквМД.Тип;
		Вид			=	РеквМД.Вид;
		Длина		=	РеквМД.Длина;
		//Точность	=	РеквМД.Точность;
		Возврат(РеквМД);
		
	Иначе
		
		Возврат("");
		
	КонецЕсли;    
	
	Возврат("");
	
КонецФункции		//	ПрочитатьИнформациюОТипеРеквизита()


//--------------------------------------------------------------------------------------------------

Функция ВыделитьПрефикс(Знач Стр, ЧисловаяЧасть="")

	Префикс	=	Стр;
	Длина	=	СтрДлина(Стр);
	
	Для Сч = 1 По Длина Цикл
		ЧисловаяЧасть	=	Число(Стр);
		
	    Если (ЧисловаяЧасть >= 1) И (СтрДлина(ЧисловаяЧасть) = Длина - Сч + 1) Тогда 
			Префикс	=	Лев(Префикс, Сч - 1);
			
			Пока Прав(Префикс, 1) = "0" Цикл
			    Префикс = Лев(Префикс, СтрДлина(Префикс)-1);
			КонецЦикла;
			
			Прервать;		    				
	    Иначе
			Стр = Прав(Стр, Длина - Сч);
		КонецЕсли;
		
		Если ЧисловаяЧасть < 0 Тогда	ЧисловаяЧасть = - ЧисловаяЧасть		КонецЕсли;
			
	КонецЦикла;
	                   
	Возврат(Префикс);

КонецФункции		//	ВыделитьПрефикс()

//--------------------------------------------------------------------------------------------------

Функция ПроверкаУникальностиОбъектаСправочника(Справочник, ЕстьКонтроль, ЕстьВладелец, Уникальность, АвтоНумерация)
          
	// проверка на существование других элементов с уникальным кодом
	
	Если ПустоеЗначение(ЕстьКонтроль) = 1 Тогда Возврат(1) КонецЕсли;
	
	Вид			=	Справочник.Вид();
	Конфликт	=	СоздатьОбъект("Справочник." + Вид);
	Если ЕстьВладелец = 1 Тогда Конфликт.ИспользоватьВладельца(Справочник.Владелец) КонецЕсли;
	Если Уникальность = "ВПределахПодчинения" Тогда
		Если Справочник.Родитель.Выбран()=1 Тогда
			Конфликт.ИспользоватьРодителя(Справочник.Родитель);
		КонецЕсли;
		УчитыватьИерархию	=	1;
	Иначе
		УчитыватьИерархию	=	0;
	КонецЕсли;
	Если		Конфликт.НайтиПоКоду(Справочник.Код, УчитыватьИерархию) = 0	Тогда
	ИначеЕсли	Конфликт.ТекущийЭлемент() = Справочник.ТекущийЭлемент()		Тогда
	ИначеЕсли	ПустоеЗначение(АвтоНумерация) = 1							Тогда
		ЗапомнимКонфликт	=	Конфликт.ТекущийЭлемент();
		
		Ошибка = "Код не уникальный - назначен новый код существующему элементу: " + ЗапомнимКонфликт;
		ЗаписатьОшибку(Ошибка, "!");
		
		Конфликт.ПорядокКодов();	//	используем именно этот объект чтобы учесть установленных родителя и владельца
		Конфликт.ОбратныйПорядок(1);
		Конфликт.ВыбратьЭлементы(УчитыватьИерархию);
		Конфликт.ПолучитьЭлемент();
		СчКода				=	"";
		Результат			=	ВыделитьПрефикс(Конфликт.Код, СчКода);
		ДлинаКода			=	Метаданные.Справочник(Вид).ДлинаКода;
		
		//Пока ДлинаКода - СтрДлина(Результат) - СтрДлина(СчКода + 1) > 0 Цикл
		//    Результат		=	Результат + "0";
		//КонецЦикла;
		//НовыйКод			=	Результат + Строка(СчКода + 1);
		
		Пока ДлинаКода - СтрДлина(Результат) - СтрДлина(СчКода + 1) > 0 Цикл
		    СчКода			=	Строка(СчКода) + "0";
		КонецЦикла;
		НовыйКод			=	Результат + Строка(Число(СчКода) + 1);
		
		
		ВспомнимКонфликт	=	СоздатьОбъект("Справочник." + Вид);
		ВспомнимКонфликт.НайтиЭлемент(ЗапомнимКонфликт);
		ВспомнимКонфликт.Код	=	НовыйКод;
		//ВспомнимКонфликт.Записать();
		ЗаписатьОбъект(ВспомнимКонфликт);
	Иначе
		ЗапомнимКонфликт	=	Конфликт.ТекущийЭлемент();
		
		Ошибка = "Код не уникальный - назначен новый код существующему элементу: " + ЗапомнимКонфликт;
		ЗаписатьОшибку(Ошибка, "!");
		
		Конфликт.Новый();	//	используем именно этот объект чтобы учесть установленных родителя и владельца
		Конфликт.УстановитьНовыйКод(ВыделитьПрефикс(Справочник.Код));
		
		ВспомнимКонфликт	=	СоздатьОбъект("Справочник." + Вид);
		ВспомнимКонфликт.НайтиЭлемент(ЗапомнимКонфликт);
		ВспомнимКонфликт.Код	=	Конфликт.Код;
		//ВспомнимКонфликт.Записать();
		ЗаписатьОбъект(ВспомнимКонфликт);
	КонецЕсли;
	
	Возврат(1);
	
КонецФункции		//	ПроверкаУникальностиОбъектаСправочника()

//--------------------------------------------------------------------------------------------------

Функция ПроверкаУникальностиДокумента(Документ, ЕстьКонтроль, Уникальность, АвтоНумерация)
	
	Если ПустоеЗначение(ЕстьКонтроль) = 1 Тогда Возврат(1) КонецЕсли;
	
	Вид			=	Документ.Вид();
	Конфликт	=	СоздатьОбъект("Документ." + Вид);
	Если 		Конфликт.НайтиПоНомеру(Документ.НомерДок, Документ.ДатаДок) = 0 Тогда
	ИначеЕсли	Конфликт.ТекущийДокумент() = Документ.ТекущийДокумент() 		Тогда
	ИначеЕсли	ПустоеЗначение(АвтоНумерация) = 1								Тогда
		Ошибка = "Номер не уникальный - назначен новый номер существующему документу: " + Конфликт;
		//ЗаписатьОшибку(Ошибка);
		
		ЗапомнимКонфликт	=	Конфликт.ТекущийДокумент();
		
		Конфликт.ОбратныйПорядок(1);
		Конфликт.ВыбратьДокументы();
		Конфликт.ПолучитьДокумент();
		
		СчНомера			=	"";
		Результат			=	ВыделитьПрефикс(Конфликт.НомерДок, СчНомера);
		ДлинаНомера			=	Метаданные.Документ(Вид).ДлинаНомера;
		Пока ДлинаНомера - СтрДлина(Результат) - СтрДлина(СчНомера + 1) > 0 Цикл
		    Результат		=	Результат + "0";
		КонецЦикла;
		НовыйНомер			=	Результат + Строка(СчНомера + 1);
		
		ВспомнимКонфликт	=	СоздатьОбъект("Документ." + Вид);
		ВспомнимКонфликт.НайтиДокумент(ЗапомнимКонфликт);
		ВспомнимКонфликт.НомерДок	=	НовыйНомер;
		//ВспомнимКонфликт.Записать();
		ЗаписатьОбъект(ВспомнимКонфликт);
	Иначе
		Ошибка = "Номер не уникальный - назначен новый номер существующему документу: " + Конфликт;
		ЗаписатьОшибку(Ошибка);
		ДокДляПолученияНовогоНомера	=	СоздатьОбъект("Документ." + Вид);
		ДокДляПолученияНовогоНомера.Новый();
		ДокДляПолученияНовогоНомера.ДатаДок	=	Конфликт.ДатаДок;
		ДокДляПолученияНовогоНомера.УстановитьНовыйНомер(ВыделитьПрефикс(Документ.НомерДок));
		
		Конфликт.НомерДок	=	ДокДляПолученияНовогоНомера.НомерДок;
		//Конфликт.Записать();
		ЗаписатьОбъект(Конфликт);
	КонецЕсли;
	
	Возврат(1);

КонецФункции		//	ПроверкаУникальностиДокумента()

//--------------------------------------------------------------------------------------------------
                                                                                                    
Функция ОбъектУжеЗагружен(ТипВид, СтрСсылка, ОбъектИБ)
    
	Перем	НомСтр;
	
	Если мТабЗагруженныхОбъектов.НайтиЗначение(ТипВид, НомСтр, "Вид") = 0	Тогда Возврат(0) КонецЕсли;
	
	ТабОбъектов	=	мТабЗагруженныхОбъектов.ПолучитьЗначение(НомСтр, "ТабОбъектов");
	НомСтр		=	"";
	
	Если ТабОбъектов.НайтиЗначение(СтрСсылка, НомСтр, "Ссылка") = 0		Тогда Возврат(0) КонецЕсли;
	        
	ОбъектИБ	=	ТабОбъектов.ПолучитьЗначение(НомСтр, "Объект");
	
	Возврат(1);
	
КонецФункции		//	ОбъектУжеЗагружен()

//--------------------------------------------------------------------------------------------------

Процедура ЗапомнитьСсылку(Вид, СтрСсылка, ОбъектИБ)

	Перем	НомСтр;
	
	Если мТабЗагруженныхОбъектов.НайтиЗначение(ТипЗначенияСтр(ОбъектИБ) + Вид, НомСтр, "Вид") = 0 Тогда
		мТабЗагруженныхОбъектов.НоваяСтрока();
		мТабЗагруженныхОбъектов.Вид			=	ТипЗначенияСтр(ОбъектИБ) + Вид;
		мТабЗагруженныхОбъектов.ТабОбъектов	=	СоздатьОбъект("ТаблицаЗначений");
		ТабОбъектов							=	мТабЗагруженныхОбъектов.ТабОбъектов;
		ТабОбъектов.НоваяКолонка("Ссылка",	"Строка");
		ТабОбъектов.НоваяКолонка("Объект");
	Иначе
		ТабОбъектов							=	мТабЗагруженныхОбъектов.ПолучитьЗначение(НомСтр, "ТабОбъектов");
	КонецЕсли;
	
	ТабОбъектов.НоваяСтрока();
	ТабОбъектов.Ссылка						=	СтрСсылка;
	ТабОбъектов.Объект						=	ОбъектИБ;
	
КонецПроцедуры		//	ЗапомнитьСсылку()

//--------------------------------------------------------------------------------------------------

Функция ВременныйВладелец(Вид)
    
	СпрВладелец	=	СоздатьОбъект("Справочник." + Вид);
	Если СпрВладелец.НайтиПоНаименованию("###Временный владелец###", 0, 1) = 0 Тогда
		СпрВладелец.Новый();
		СпрВладелец.Наименование	=	"###Временный владелец###";
		ВладелецМД = Метаданные.Справочник(Вид).Владелец;
		Если ВладелецМД.Выбран() = 1 Тогда
			СпрВладелец.Владелец = ВременныйВладелец(ВладелецМД.Идентификатор);
		КонецЕсли;
		СпрВладелец.Записать();
		СпрВладелец.Удалить(0);
		Если ТипЗначенияСтр(мСписокВспомогательныхОбъектов) <> "СписокЗначений" Тогда
			мСписокВспомогательныхОбъектов = СоздатьОбъект("СписокЗначений");
		КонецЕсли;
		мСписокВспомогательныхОбъектов.ДобавитьЗначение(СпрВладелец.ТекущийЭлемент());
	КонецЕсли;
	
	Возврат(СпрВладелец.ТекущийЭлемент());
	
КонецФункции		//	ВременныйВладелец()

//--------------------------------------------------------------------------------------------------

 
Функция ОпределитьСтроковыйТип(СтроковоеИмяТипа)
	
	Если Найти(СтроковоеИмяТипа, "ПланСчетовСсылка") > 0 Тогда
					    
		ТипЗнач = СтрЗаменить(СтроковоеИмяТипа, "ПланСчетовСсылка", "Счет");
		
	Иначе	
	
		ТипЗнач = СтрЗаменить(СтроковоеИмяТипа, "Ссылка", "");
		
	КонецЕсли;	
	
	Возврат ТипЗнач;

КонецФункции


Функция УстановитьРеквизитV8(Реквизит, ТипОбъекта, ВидОбъекта, РеквизитОбъекта)
                                                                            
	Если ПустоеЗначение(Реквизит)			= 1 Тогда	Возврат("")	КонецЕсли;
	Если ПустоеЗначение(РеквизитОбъекта)	= 1	Тогда	Возврат("")	КонецЕсли; 

	ИмяУзла = "";

	УзелРеквизита = Реквизит.ВыбратьУзел("*");
	Если ПустоеЗначение(УзелРеквизита) = 0 Тогда
		ИмяУзла = УзелРеквизита.ИмяТэга;
		// Сообщить("Пустой узел реквизита!");
		// Возврат("");
	КонецЕсли;

	Тип     = ОпределитьСтроковыйТип(Реквизит.ПолучитьАтрибут("Тип"));
	
	Если ИмяУзла = "Значение" Тогда
		СтрЗначение = УзелРеквизита.Значение;
	ИначеЕсли (ИмяУзла = "Пусто") Или (ПустаяСтрока(ИмяУзла) = 1) Тогда
		Если Тип <> "Булево" Тогда
			Возврат ПолучитьПустоеЗначение(Тип);
		Иначе
			Возврат 0;
		КонецЕсли; 
	ИначеЕсли ИмяУзла = "Ссылка" Тогда
		
	ИначеЕсли ИмяУзла = "Выражение" Тогда
		Сообщить("Недопустимый способ указания значения - " + ИмяУзла);
		Возврат("");
	ИначеЕсли ИмяУзла = "Нпп" Тогда
		Сообщить("Недопустимый способ указания значения - " + ИмяУзла);
		Возврат("");
	Иначе
		Сообщить("Неизвестный способ указания значения - " + ИмяУзла);
		Возврат("");
	КонецЕсли;

	Значение = "";
	
	Если		Тип = "Строка"			Тогда
		
		Значение	=	СокрП(СтрЗначение);
		//Если Длина = 0 Тогда
		//	Значение	=	СтрЗаменить(Значение, "#рс#", РазделительСтрок);
		//	Значение	=	СтрЗаменить(Значение, "#ст#", СимволТабуляции);
		//КонецЕсли;
	
	ИначеЕсли	Тип = "Число"			Тогда 
		
		Значение	=	СтрЗначение;
		Если (РеквизитОбъекта = "Код") И (Значение="0") Тогда
		Иначе
			Значение	=	Число(Значение);
		КонецЕсли;
    	
	ИначеЕсли	Тип = "Дата"			Тогда
		
		Значение	=	ДатаИзXML(СтрЗначение);

	ИначеЕсли	Тип = "Булево"			Тогда

		Если СтрЗначение = "true" Тогда
			Возврат 1;
		Иначе
			Возврат 0;
		КонецЕсли;
		
	Иначе
		
		Вид = ОтделитьРазделителем(Тип, ".");
			
		Если	Тип = "Справочник" Тогда
			
			ЭтоГруппа = 0;
			
			УзелЭтоГруппа = УзелРеквизита.ВыбратьУзел("Свойство[@Имя=""ЭтоГруппа""]");
			Если ПустоеЗначение(УзелЭтоГруппа) = 0 Тогда
				ЭтоГруппа = УстановитьРеквизитV8(УзелЭтоГруппа, "Справочник", Вид, "ЭтоГруппа");
				УзелРеквизита.УдалитьПодчиненный(УзелЭтоГруппа);
			КонецЕсли;
			
			СозданНовыйОбъект	=	0;
			ВрмВозврат = УстановитьСправочникПоСсылкеV8(УзелРеквизита, Вид, СозданНовыйОбъект, , , ЭтоГруппа, , 0);
			
			Значение = ВрмВозврат.Получить("Результат");

			// Если ТекущийОбъект = "Ошибка" Тогда Возврат КонецЕсли;
			Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда
			// Если		Значение = "Ошибка"						Тогда
				Значение	=	ПолучитьПустоеЗначение(Тип + ?(Вид="", "", "." + Вид));
			ИначеЕсли	ПустоеЗначение(СозданНовыйОбъект) = 0	Тогда
				//гСписокОбъектовСозданныхПоСсылкам.Установить(ЗначениеВСтрокуВнутр(Значение), 1);
				ОбъектЗначения	=	СоздатьОбъект(Тип + "." + Вид);
				ОбъектЗначения.НайтиЭлемент(Значение);
				ОбъектЗначения.Удалить(0);			//	объект еще не загружен толком
			ИначеЕсли	Значение = "#НеУстановлен" Тогда
				Возврат("#НеУстановлен");
			КонецЕсли;
			
		ИначеЕсли	(Тип = "ПланСчетов")
					ИЛИ (Тип = "Счет") Тогда
			
			Значение	=	СокрЛП(СтрЗначение);
			ПланСчетов = ?(ПустоеЗначение(Вид)=1, ОсновнойПланСчетов(), ПланыСчетов.ЗначениеПоИдентификатору(Вид));
			Если ПустоеЗначение(ПланСчетов)=1 Тогда
				ЗаписатьОшибку("Неверный вид счета " + Вид);
				Возврат("");
			КонецЕсли;
			Если ПустоеЗначение(Значение) = 1 Тогда Возврат("") КонецЕсли;
			Счет		=	СоздатьОбъект("Счет"); 
			Счет.ИспользоватьПланСчетов(ПланСчетов);
			Счет.НайтиПоКоду(Значение);
			Значение	=	Счет.ТекущийСчет();
		
		ИначеЕсли	Тип = "Перечисление"	Тогда
			
			Значение	=	СокрЛП(СтрЗначение);
			ОбъектМД	=	Метаданные.Перечисление(Вид);
			Если ОбъектМД.Выбран()=0 Тогда
				ЗаписатьОшибку("Неверный вид перечисления - " + Вид);
				Возврат("");
			КонецЕсли;
			
			Если ПустоеЗначение(Значение) = 1 Тогда Возврат("") КонецЕсли;
			
			ВидПеречисления	=	Перечисление.ПолучитьАтрибут(Вид);
			СтрЗначение		=	Значение;
			
			// поиск по идентификатору
			Значение		=	ВидПеречисления.ЗначениеПоИдентификатору(СтрЗначение);
			
			Если ПустоеЗначение(Значение) = 0 Тогда Возврат(Значение) КонецЕсли;
	
			// поиск по синониму
			Для СчЗнач = 1 По ОбъектМД.Значение() Цикл
				ЗначениеМД	=	ОбъектМД.Значение(СчЗнач);
				Если СтрЗначение = ЗначениеМД.Представление() Тогда
					Возврат	ВидПеречисления.ЗначениеПоИдентификатору(ЗначениеМД.Идентификатор);
				КонецЕсли;
			КонецЦикла;
			
			Если Число(СтрЗначение) = 0 Тогда
				ЗаписатьОшибку("Неверное значение перечисления " + Вид + "." + СтрЗначение);
				Возврат("");
			КонецЕсли;
			
			// поиск по порядковому номеру
			Значение		=	ВидПеречисления.ЗначениеПоНомеру(СтрЗначение);
		
		ИначеЕсли	Тип = "Документ"		Тогда
			                    
			СозданНовыйОбъект	=	0;
			Значение			=	УстановитьДокументПоСсылкеV8(УзелРеквизита, Вид, СозданНовыйОбъект, , , , 0);
			Если		Значение = "Ошибка"						Тогда
				Значение	=	ПолучитьПустоеЗначение(Тип + ?(Вид="", "", "." + Вид));
			ИначеЕсли	ПустоеЗначение(СозданНовыйОбъект) = 0	Тогда
				//гСписокОбъектовСозданныхПоСсылкам.Установить(ЗначениеВСтрокуВнутр(Значение), 1);
				ОбъектЗначения	=	СоздатьОбъект(Тип + "." + Вид);
				ОбъектЗначения.НайтиДокумент(Значение);
				ОбъектЗначения.Удалить(0);			//	объект еще не загружен толком
			ИначеЕсли	Значение = "#НеУстановлен" Тогда
				Возврат("#НеУстановлен");
			КонецЕсли;
	
		//ИначеЕсли	Тип = "ПланСчетов"		Тогда
		//	
		//	Значение	=	СокрЛП(СтрЗначение);
		//	Значение	=	ПланыСчетов.ЗначениеПоИдентификатору(Значение);
		//
		//ИначеЕсли	Тип = "ВидСубконто"		Тогда
		//	
		//	Значение	=	СокрЛП(СтрЗначение);
		//	Значение	=	ВидыСубконто.ЗначениеПоИдентификатору(Значение);
		//
		//ИначеЕсли	Тип = "Календарь"		Тогда
		//	
		//	Значение	=	СокрЛП(СтрЗначение);
		//	Если Метаданные.Календарь(Значение).Выбран()=0 Тогда
		//		ЗаписатьОшибку("Неверный календарь " + Значение);
		//		ЗаписатьОшибку("Объект: " + ТипОбъекта + "." + ВидОбъекта + "." + РеквизитОбъекта);
		//		Возврат("");
		//	КонецЕсли;
		//	Значение	=	Календари.ПолучитьАтрибут(Значение);
		
		ИначеЕсли	Тип = "ВидРасчета"	Тогда
			
			Значение	=	СокрЛП(СтрЗначение);
			Если Метаданные.ВидРасчета(Значение).Выбран()=0 Тогда
				ЗаписатьОшибку("Неверный вид расчета " + Значение);
				Возврат("");
			КонецЕсли;
			Значение	=	ВидРасчета.ПолучитьАтрибут(Значение);
		
		ИначеЕсли	ПустоеЗначение(Тип) = 0	Тогда
			
			ЗаписатьОшибку("Неверный тип реквизита:  " + ТипОбъекта + "." + ВидОбъекта + "." + РеквизитОбъекта + " - " + Тип);
	
		КонецЕсли;

	КонецЕсли;
	
	Возврат(Значение);
	
КонецФункции		//	УстановитьРеквизитV8()

//--------------------------------------------------------------------------------------------------

Функция СравнитьРеквизитыСправочникаV8(Справочник, РеквизитыПоиска)
	           
	Вид	=	Справочник.Вид();
	
	Для Сч = 0 По РеквизитыПоиска.КоличествоУзлов - 1 Цикл
		
		Реквизит					=	РеквизитыПоиска.ПолучитьУзел(Сч);
		ИдРеквизита					=	одАтрибут(Реквизит, "Строка", "Имя");
		
		//ТипРеквизита				=	"";
		//ПрочитатьИнформациюОТипеРеквизита("Справочник", Вид, ИдРеквизита, ТипРеквизита);
		//Если		ПустоеЗначение(ТипРеквизита) = 1 Тогда
		//	ПредставлениеРеквизита		=	"Справочник." + Вид + "." + ИдРеквизита;
		//	ЗаписатьОшибку("Неверное имя реквизита:" + ПредставлениеРеквизита);
		//	Продолжить;
		//КонецЕсли;
		
		Значение					=	УстановитьРеквизитV8(Реквизит, "Справочник", Вид, ИдРеквизита);
		СуществующееЗначение		=	Справочник.ПолучитьАтрибут(ИдРеквизита);
		
		Если (ТипЗначенияСтр(СуществующееЗначение) = "Строка") Или (ПустоеЗначение(СуществующееЗначение) = 1) Тогда
			СуществующееЗначение	=	СокрЛП(СуществующееЗначение);
			Значение				=	СокрЛП(Значение);
		КонецЕсли;
		
		Если СуществующееЗначение <> Значение Тогда Возврат(0) КонецЕсли;
		
	КонецЦикла;
	
	Возврат(1);
	
КонецФункции		//	СравнитьРеквизитыСправочникаV8()
                
//--------------------------------------------------------------------------------------------------

Функция СравнитьРеквизитыДокументаV8(Документ, РеквизитыПоиска)
                                           
	Вид	=	Документ.Вид();
	
	Для Сч = 0 По РеквизитыПоиска.КоличествоУзлов - 1 Цикл
		
		Реквизит					=	РеквизитыПоиска.ПолучитьУзел(Сч);
		ИдРеквизита					=	одАтрибут(Реквизит, "Строка", "Имя");

		//Если ИдРеквизита <> "ВремяДок" Тогда
			СуществующееЗначение	=	Документ.ПолучитьАтрибут(ИдРеквизита);
		//Иначе
		//	СуществующееЗначение	=	Документ.ПолучитьВремя();
		//КонецЕсли;

		//--------------------------------------------------------------------------------------------------
		
		//РеквизитОперации			=	Реквизит.ПолучитьАтрибут("ЭтоРеквизитОперации");
		//
		//Если ПустоеЗначение(РеквизитОперации) = 1 Тогда
		//	ТипОбъектаРеквизита		=	"Документ";
		//	ВидОбъектаРеквизита		=	Вид;
		//	Если ИдРеквизита <> "ВремяДок" Тогда
		//		СуществующееЗначение	=	Документ.ПолучитьАтрибут(ИдРеквизита);
		//	Иначе
		//		СуществующееЗначение	=	Документ.ПолучитьВремя();
		//	КонецЕсли;
		//Иначе
		//	Если Документ.СуществуетОперация() = 0 Тогда
		//		ЗаписатьОшибку("У документа вида - " + Вид + " - не существует операции!", "!!");
		//		Возврат(0);
		//	КонецЕсли;
		//	ТипОбъектаРеквизита		=	"Операция";
		//	ВидОбъектаРеквизита		=	"";
		//	СуществующееЗначение	=	Документ.Операция.ПолучитьАтрибут(ИдРеквизита);
		//КонецЕсли;
		
		//ТипРеквизита				=	"";
		//ПрочитатьИнформациюОТипеРеквизита(ТипОбъектаРеквизита, ВидОбъектаРеквизита, ИдРеквизита, ТипРеквизита);
		//Если		ПустоеЗначение(ТипРеквизита) = 1 Тогда
		//	ПредставлениеРеквизита		=	ТипОбъектаРеквизита + "." + ВидОбъектаРеквизита + "." + ИдРеквизита;
		//	ЗаписатьОшибку("Неверное имя реквизита:" + ПредставлениеРеквизита);
		//	Продолжить;
		//КонецЕсли;

		Значение = УстановитьРеквизитV8(Реквизит, "Документ", Вид, ИдРеквизита);
		
		Если (ТипЗначенияСтр(СуществующееЗначение) = "Строка") Или (ПустоеЗначение(СуществующееЗначение) = 1) Тогда
			СуществующееЗначение	=	СокрЛП(СуществующееЗначение);
			Значение				=	СокрЛП(Значение);
		КонецЕсли;
		
		Если СуществующееЗначение <> Значение Тогда Возврат(0) КонецЕсли;
		
	КонецЦикла;
	
	Возврат(1);
	
КонецФункции		//	СравнитьРеквизитыДокумента()

//--------------------------------------------------------------------------------------------------

Функция УстановитьСправочникПоСсылкеV8(Ссылка, Вид, СозданНовыйОбъект=0, НовыеНеСоздавать=0, ОбъектМД="", ЭтоГруппа, Объект="", Знач РежимПоискаОсновногоОбъекта)
	Перем	Элемент;

	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмНайденоСоответствиеОбъекта = 0;
	
	ОбъектМД = Метаданные.Справочник(Вид);

	//Ссылка	=	Объект.ВыбратьУзел("Ссылка");
	//Если ПустоеЗначение(Ссылка) = 1 Тогда
	//	ОбъектМД	=	Метаданные.Справочник(Вид);
	//	Если Объект.ИмяТэга = "Ссылка" Тогда
	//		Ссылка	=	Объект;
	//	Иначе
	//		Возврат("");
	//	КонецЕсли;
	//КонецЕсли;
	
	//Если ПустоеЗначение(Вид) = 1 Тогда Вид = Ссылка.ПолучитьАтрибут("Вид")	КонецЕсли;
	
	Если ОбъектМД.Выбран()	= 0 Тогда
		ЗаписатьОшибку("Неверный вид справочника " + Вид);
		ВрмВозврат.Установить("Результат", "Ошибка");	
		Возврат ВрмВозврат;
	КонецЕсли;
    
	Если ПустоеЗначение(Объект) = 1 Тогда
		Объект = Ссылка;
	КонецЕсли;
	
	Если мЗапоминатьЗагруженныеОбъекты = 0 Тогда

	ИначеЕсли ОбъектУжеЗагружен("Справочник" + Вид, Ссылка.ПредставлениеXML, Элемент) = 1 Тогда
		ВрмВозврат.Установить("СтатусВозврата", 1);
		ВрмВозврат.Установить("Результат", Элемент);
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмУникальныйИдентификатор = "";
	ВрмТипИсточника = "";
	ВрмТипПриемника = "";

	УзелУникальныйИдентификатор = Ссылка.ВыбратьУзел("Свойство[@Имя=""{УникальныйИдентификатор}""]");
	Если ПустоеЗначение(УзелУникальныйИдентификатор) = 0 Тогда
		ВрмУникальныйИдентификатор = одЗначениеЭлемента(УзелУникальныйИдентификатор.ВыбратьУзел("Значение"), "Строка");
		ВрмТипИсточника = одАтрибут(УзелУникальныйИдентификатор, "Строка", "ТипИсточника");
		ВрмТипПриемника = одАтрибут(УзелУникальныйИдентификатор, "Строка", "ТипПриемника");
		Ссылка.УдалитьПодчиненный(УзелУникальныйИдентификатор);
		ВрмВозврат.Установить("УникальныйИдентификатор", ВрмУникальныйИдентификатор);
		ВрмВозврат.Установить("ТипИсточника", ВрмТипИсточника);
		ВрмВозврат.Установить("ТипПриемника", ВрмТипПриемника);

		// ВрмВозвратФункции = ПолучитьСсылкуПоИдентификаторуКорреспондента(ВрмУникальныйИдентификатор);
		ВыполнитьЗаменуУникальногоИдентификатораПриНеобходимости(ВрмУникальныйИдентификатор, ВрмТипИсточника, ВрмТипПриемника, РежимПоискаОсновногоОбъекта, ВрмНайденоСоответствиеОбъекта);
		// Если ПолучитьСтатусВозврата(ВрмВозвратФункции) = 0 Тогда
			
		// ИначеЕсли ПустоеЗначение(ВрмВозвратФункции.Получить("Результат")) = 0 Тогда
		// 	ВрмВозврат.Установить("СтатусВозврата", 1);
		// 	ВрмВозврат.Установить("Результат", ВрмВозвратФункции.Получить("Результат"));
		// 	Возврат ВрмВозврат;
		// КонецЕсли;
	КонецЕсли;

	Если ВрмНайденоСоответствиеОбъекта = 1 Тогда
		
		ВрмСсылкаНаОбъект = ПолучитьСсылкуПоИдентификатору(ВрмУникальныйИдентификатор);

		ВрмВозврат.Установить("СтатусВозврата", 1);
		ВрмВозврат.Установить("Результат", ВрмСсылкаНаОбъект);
		Возврат ВрмВозврат;

	КонецЕсли;

	РеквизитыПоиска			=	Ссылка.ВыбратьУзлы("Свойство");
	КолвоРеквизитовПоиска	=	РеквизитыПоиска.КоличествоУзлов;

	Если мЗапоминатьЗагруженныеОбъекты = 0 Тогда
		Если КолвоРеквизитовПоиска = 0 Тогда	//	используется внутренняя ссылка
			Если ОбъектУжеЗагружен("Справочник" + Вид, Ссылка.ПредставлениеXML, Элемент) = 1 Тогда
				ВрмВозврат.Установить("СтатусВозврата", 1);
				ВрмВозврат.Установить("Результат", Элемент);
				Возврат ВрмВозврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	//	Эта возможность временно отключена...
	//СистПр	=	Ссылка.ВыбратьУзел("Свойство[@Имя=""СистемноеПредставление()""]");
	//Если ПустоеЗначение(СистПр) = 0 Тогда
	//	Возврат	ЗначениеИзСтрокиВнутр(СистПр.ПолучитьАтрибут("Значение"));
	//КонецЕсли;
	
	Справочник 				=	СоздатьОбъект("Справочник." + Вид);
	
	ЕстьВладелец			=	ОбъектМД.Владелец.Выбран();
	ЕстьРодитель			=	?(ОбъектМД.КоличествоУровней > 1, 1, 0);
	
	ДлинаКода				=	ОбъектМД.ДлинаКода;
	ДлинаНаименования		=	ОбъектМД.ДлинаНаименования;
	
	Уникальность			=	ОбъектМД.СерииКодов;
	ЕстьКонтроль			=	ОбъектМД.КонтрольУникальности;
	АвтоНумерация			=	ОбъектМД.АвтоНумерация - 1;
	ТипКода					=	ОбъектМД.ТипКода;
	
	ИспользоватьВладельца	=	0;
	ИспользоватьРодителя	=	0;
	УчитыватьИерархию		=	0;
	
	Код="";	Наименование=""; Родитель=""; Владелец="";
	
	Если КолвоРеквизитовПоиска > 0 Тогда
		
		Если	ПустоеЗначение(ДлинаКода)			= 0		Тогда
			Код					=	УстановитьРеквизитV8(Ссылка.ВыбратьУзел("Свойство[@Имя=""Код""]"),			"Справочник", Вид, "Код");
		КонецЕсли;
		Если	ПустоеЗначение(ДлинаНаименования)	= 0		Тогда
			Наименование		=	УстановитьРеквизитV8(Ссылка.ВыбратьУзел("Свойство[@Имя=""Наименование""]"),	"Справочник", Вид, "Наименование");
		КонецЕсли;
		Если	ПустоеЗначение(ЕстьРодитель)		= 0		Тогда
			Родитель			=	УстановитьРеквизитV8(Ссылка.ВыбратьУзел("Свойство[@Имя=""Родитель""]"), 	"Справочник", Вид, "Родитель");
		КонецЕсли;
		Если	ПустоеЗначение(ЕстьВладелец)		= 0		Тогда
			Владелец			=	УстановитьРеквизитV8(Ссылка.ВыбратьУзел("Свойство[@Имя=""Владелец""]"),		"Справочник", Вид, "Владелец");
		КонецЕсли;
	    
		//	ИспользоватьВладельца	для поиска
		Если		ПустоеЗначение(Владелец)		= 0	Тогда
			ИспользоватьВладельца	=	1;
			Справочник.ИспользоватьВладельца(Владелец);
		ИначеЕсли	(Уникальность	= "ВПределахПодчинения") И (ЕстьКонтроль = 1) И (ЕстьВладелец = 1)	Тогда
			//	Попробуем отработать эту ситуацию при создании нового элемента / группы
			
			//ЗаписатьОшибку("Не установлена синхронизация по владельцу подчиненного справочника - " + Вид + "
			//				|	Правило:  " + гПравилоТекущегоОбъекта + "
			//				|	Узел ссылки:  " + Ссылка.ПредставлениеXML, "!!");
			//Возврат("Ошибка");
		КонецЕсли;
	    
		//	ИспользоватьРодителя	для поиска
		
		Если		ПустоеЗначение(Родитель) =	0	Тогда
			ИспользоватьРодителя	=	1;
			Справочник.ИспользоватьРодителя(Родитель);
		ИначеЕсли	(Уникальность	= "ВПределахПодчинения") И (ЕстьКонтроль = 1) И (ЕстьРодитель = 1)	Тогда
			ИспользоватьРодителя	=	1;
			Справочник.ИспользоватьРодителя(ПолучитьПустоеЗначение("Справочник." + Вид));
		КонецЕсли;
		
	КонецЕсли;
	
	Справочник.ИспользоватьДату(РабочаяДата(), 1);	//	хотя вообще-то искать по периодическим реквизитам - плохая затея...
	
	УчитыватьИерархию	=	?(ИспользоватьРодителя + ИспользоватьВладельца > 0,	1,	0);
	
	//--------		Поиск		-------------------------------
	ПолныйПеребор	=	0;

	Если		КолвоРеквизитовПоиска = 0 Тогда
		
			//	Поиск не производим!
		
	ИначеЕсли	(ПустоеЗначение(Код)			= 0)	И	(КолвоРеквизитовПоиска = 1)	Тогда
	    
		Если Справочник.НайтиПоКоду(Код, 0) = 0	Тогда	//	создаем новый
		ИначеЕсли	Справочник.ЭтоГруппа() <> ЭтоГруппа			Тогда	//	создаем новый
		Иначе
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
			ВрмВозврат.Установить("СтатусВозврата", 1);
			ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			Возврат ВрмВозврат;
			// Возврат	Справочник.ТекущийЭлемент();
		КонецЕсли;

	ИначеЕсли	(ПустоеЗначение(Наименование)	= 0)	И	(КолвоРеквизитовПоиска = 1)	Тогда

		Если		Справочник.НайтиПоНаименованию(Наименование, 0, 1) = 0	Тогда	//	создаем новый
		ИначеЕсли	Справочник.ЭтоГруппа() <> ЭтоГруппа Тогда	//	создаем новый
		
			Справочник.ВыбратьЭлементы();
			Пока Справочник.ПолучитьЭлемент() = 1 Цикл
			
			   Если Справочник.Наименование <> Наименование Тогда
			   		Продолжить;
			   КонецЕсли;
			   
			   Если Справочник.ЭтоГруппа() <> ЭтоГруппа Тогда
			   		Продолжить;
			   КонецЕсли;
			   
			   Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда 
			   		ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); 
			   КонецЕсли;

			   ВрмВозврат.Установить("СтатусВозврата", 1);
			   ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			   Возврат ВрмВозврат;
			//    Возврат Справочник.ТекущийЭлемент(); 
			   			   
			КонецЦикла;		
		
		Иначе
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
			ВрмВозврат.Установить("СтатусВозврата", 1);
			ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			Возврат ВрмВозврат;
			// Возврат	Справочник.ТекущийЭлемент();
		КонецЕсли;

	ИначеЕсли	(ПустоеЗначение(Код)			= 0)	И	(1 + ИспользоватьРодителя + ИспользоватьВладельца = КолвоРеквизитовПоиска)	Тогда
	
		Если		Справочник.НайтиПоКоду(Код, 1) = 0					Тогда	//	создаем новый
		ИначеЕсли	Справочник.ЭтоГруппа() <> ЭтоГруппа					Тогда	//	создаем новый
		Иначе
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
			ВрмВозврат.Установить("СтатусВозврата", 1);
			ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			Возврат ВрмВозврат;
			// Возврат	Справочник.ТекущийЭлемент();
		КонецЕсли;
	
	ИначеЕсли	(ПустоеЗначение(Наименование)	= 0)	И	(1 + ИспользоватьРодителя + ИспользоватьВладельца = КолвоРеквизитовПоиска)	Тогда
	
		Если		Справочник.НайтиПоНаименованию(Наименование, 1, 1) = 0	Тогда	//	создаем новый
		ИначеЕсли	Справочник.ЭтоГруппа() <> ЭтоГруппа										Тогда	//	создаем новый
		Иначе
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
			ВрмВозврат.Установить("СтатусВозврата", 1);
			ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			Возврат ВрмВозврат;
			// Возврат	Справочник.ТекущийЭлемент();
		КонецЕсли;
	
	ИначеЕсли	(ЕстьКонтроль			=	1)	И
				(ПустоеЗначение(Код)	=	0)	И
	     		((Уникальность = "ВесьСправочник")	Или	(УчитыватьИерархию=1))	Тогда
		 	
		Если		Справочник.НайтиПоКоду(Код, УчитыватьИерархию)				= 0 		Тогда	//	создаем новый
		ИначеЕсли	Справочник.ЭтоГруппа() <> ЭтоГруппа										Тогда	//	создаем новый
		ИначеЕсли	СравнитьРеквизитыСправочникаV8(Справочник, РеквизитыПоиска)	= 0			Тогда	//	создаем новый
		Иначе
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
			ВрмВозврат.Установить("СтатусВозврата", 1);
			ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			Возврат ВрмВозврат;
			// Возврат	Справочник.ТекущийЭлемент();
		КонецЕсли;
    
	ИначеЕсли	(1 + ИспользоватьРодителя + ИспользоватьВладельца = КолвоРеквизитовПоиска)	Тогда
	            
		РеквизитПоиска	=	Ссылка.ВыбратьУзел("Свойство[(@Имя!=""Владелец"")and(@Имя!=""Родитель"")]");
		     
		Если ПустоеЗначение(РеквизитПоиска) = 1 Тогда ПолныйПеребор = 1 КонецЕсли;
			
		Если ПолныйПеребор = 0 Тогда
			ИдРеквизита		=	одАтрибут(РеквизитПоиска, "Строка", "Имя");
			РеквМД			=	ОбъектМД.Реквизит(ИдРеквизита);
			Сортировка		=	0;
			Если РеквМД.Выбран() = 1 Тогда	Сортировка = РеквМД.Сортировка	КонецЕсли;
			Если Сортировка = 1 Тогда
				Значение	=	УстановитьРеквизитV8(РеквизитПоиска, "Справочник", Вид, ИдРеквизита);
				Если		Справочник.НайтиПоРеквизиту(ИдРеквизита, Значение, 1-УчитыватьИерархию)	= 0	Тогда	//	создаем новый
				ИначеЕсли	Справочник.ЭтоГруппа() <> ЭтоГруппа											Тогда	//	создаем новый
				//ИначеЕсли	СравнитьРеквизитыСправочникаV8(Справочник, РеквизитыПоиска)	= 0				Тогда	//	создаем новый
				Иначе
					Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
					ВрмВозврат.Установить("СтатусВозврата", 1);
					ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
					Возврат ВрмВозврат;
					// Возврат	Справочник.ТекущийЭлемент();
				КонецЕсли;
			Иначе
				ПолныйПеребор = 1;
			КонецЕсли;
		КонецЕсли;
		       
	ИначеЕсли	(ПустоеЗначение(Код)			= 0)	Тогда
	
		Если		Справочник.НайтиПоКоду(Код, УчитыватьИерархию)				= 0 		Тогда	//	создаем новый
		ИначеЕсли	Справочник.ЭтоГруппа() <> ЭтоГруппа										Тогда	ПолныйПеребор = 1;
		ИначеЕсли	СравнитьРеквизитыСправочникаV8(Справочник, РеквизитыПоиска)	= 0			Тогда	ПолныйПеребор = 1;
		Иначе
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
			ВрмВозврат.Установить("СтатусВозврата", 1);
			ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			Возврат ВрмВозврат;
			// Возврат	Справочник.ТекущийЭлемент();
		КонецЕсли;
		            
	ИначеЕсли	(ПустоеЗначение(Наименование)	= 0)	Тогда
	
		Если		Справочник.НайтиПоНаименованию(Наименование, УчитыватьИерархию, 1) = 0	Тогда	//	создаем новый
		ИначеЕсли	Справочник.ЭтоГруппа() <> ЭтоГруппа										Тогда	ПолныйПеребор = 1;
		ИначеЕсли	СравнитьРеквизитыСправочникаV8(Справочник, РеквизитыПоиска)	= 0			Тогда	ПолныйПеребор = 1;
		Иначе
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
			ВрмВозврат.Установить("СтатусВозврата", 1);
			ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			Возврат ВрмВозврат;
			// Возврат	Справочник.ТекущийЭлемент();
		КонецЕсли;
		
	ИначеЕсли КолвоРеквизитовПоиска > 0	Тогда
		                          
		ПолныйПеребор = 1;
		
	КонецЕсли;
	
	//------	Поиск полным перебором элементов	--------------
	Если ПолныйПеребор = 1 Тогда
		Справочник.ВыбратьЭлементы(УчитыватьИерархию);
		Пока Справочник.ПолучитьЭлемент(1-УчитыватьИерархию) = 1 Цикл
			Если 	Справочник.ЭтоГруппа() <> ЭтоГруппа 									Тогда	Продолжить	КонецЕсли;
			Если	СравнитьРеквизитыСправочникаV8(Справочник, РеквизитыПоиска)	= 0			Тогда	Продолжить	КонецЕсли;
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент()); КонецЕсли;
			ВрмВозврат.Установить("СтатусВозврата", 1);
			ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
			Возврат ВрмВозврат;
			// Возврат	Справочник.ТекущийЭлемент();
		КонецЦикла;
	КонецЕсли;
	   
	//------------------------------------------------------------
	Если ПустоеЗначение(НовыеНеСоздавать) = 0 Тогда
		ЗаписатьОшибку("Объект не найден и не создан: Справочник." + Вид + РазделительСтрок + Ссылка.ПредставлениеXML, "!");
		ВрмВозврат.Установить("Результат", "#НеУстановлен");
		Возврат ВрмВозврат;
		// Возврат("#НеУстановлен");
	КонецЕсли;

	//------	Создаем новый объект	--------------------------
	
	// Владелец
	Если   ПустоеЗначение(Владелец) = 0 Тогда
			
		Справочник.ИспользоватьВладельца(Владелец);
		
	ИначеЕсли ЕстьВладелец = 1 Тогда
		// возможно по владельцу просто не синхронизируем
		Владелец = УстановитьРеквизитV8(Объект.ВыбратьУзел("Свойство[@Имя=""Владелец""]"), "Справочник", Вид, "Владелец");
		
		Если ПустоеЗначение(Владелец) = 0 Тогда
			
			Справочник.ИспользоватьВладельца(Владелец);
		
		Иначе	
		
			Справочник.ИспользоватьВладельца( ВременныйВладелец(ОбъектМД.Владелец.Идентификатор) );
		
		КонецЕсли;
	
	КонецЕсли;

	// Родитель

	Если ПустоеЗначение(Родитель)  = 0 Тогда
		Справочник.ИспользоватьРодителя(Родитель);
	КонецЕсли;

	Попытка
		 
		Если ЭтоГруппа = 1 Тогда
			Справочник.НоваяГруппа();
		Иначе
			Справочник.Новый();
		КонецЕсли;
		 
	Исключение
		
		Сообщить("Ошибка создания нового элемента (группы) справочника [Вид: " + Вид + ", Код: " + Код + "]");
		
	КонецПопытки;
	
	СозданНовыйОбъект = 1;
	
	//	Наименование
	
	Если ПустоеЗначение(Наименование)	=	0	Тогда
		Справочник.Наименование	=	Наименование;
	КонецЕсли;
	
	//	Код
	
	Если		ПустоеЗначение(Код)			=	0	Тогда
		Справочник.Код	=	Код;
	ИначеЕсли	ПустоеЗначение(ДлинаКода)	=	0	Тогда
		//	возможно по коду просто не синхронизируем
		Код	=	УстановитьРеквизитV8(Объект.ВыбратьУзел("Свойство[@Имя=""Код""]"), "Справочник", Вид, "Код");
		Если	ПустоеЗначение(Код) = 0 Тогда
			Справочник.Код	=	Код;
		Иначе
			Справочник.УстановитьНовыйКод();
		КонецЕсли;
	КонецЕсли;
			
	НеИспользуется		=	?(ЭтоГруппа=1, "ДляЭлемента", "ДляГруппы");

	Для Сч = 0 По РеквизитыПоиска.КоличествоУзлов - 1 Цикл
		
		Реквизит					=	РеквизитыПоиска.ПолучитьУзел(Сч);
		ИдРеквизита					=	одАтрибут(Реквизит, "Строка", "Имя");
		             
		Если Найти("Код,Наименование,Родитель,Владелец", ИдРеквизита) > 0 Тогда Продолжить КонецЕсли;
		
		Значение					=	УстановитьРеквизитV8(Реквизит, "Справочник", Вид, ИдРеквизита);
		РеквМД						=	ОбъектМД.Реквизит(ИдРеквизита);
		ПредставлениеРеквизита		=	" (Справочник." + Вид + "." + ИдРеквизита + ")";
		Если РеквМД.Выбран()		=	0				Тогда	ЗаписатьОшибку("Неверное имя реквизита:" + ПредставлениеРеквизита);					Продолжить;	КонецЕсли;
		Если РеквМД.Использование	=	НеИспользуется	Тогда	ЗаписатьОшибку("Реквизит используется " + НеИспользуется + ПредставлениеРеквизита);	Продолжить;	КонецЕсли;
		Если РеквМД.Тип="Неопределенный" Тогда
			//ТипЗнач			=	Реквизит.ПолучитьАтрибут("ТипЗначения");
			//ВидЗнач			=	Реквизит.ПолучитьАтрибут("ВидЗначения");
			//Точность		=	0;
			//Если ТипЗнач = "Число" Тогда
			//	СтрТочность	=	Значение;
			//	Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
			//КонецЕсли;
			//Справочник.НазначитьТип(ИдРеквизита, ТипЗнач + ?(ПустоеЗначение(ВидЗнач)=1, "", "." + ВидЗнач), СтрДлина(Значение) + 10, Точность);
			ТипЗнач  = одАтрибут(Реквизит, "Строка", "Тип"); //ОпределитьСтроковыйТип(Реквизит.ПолучитьАтрибут("Тип"));
			Точность = 0;
			Если ТипЗнач = "Число" Тогда
				СтрТочность	=	Значение;
				Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
			КонецЕсли;
			Справочник.НазначитьТип(ИдРеквизита, ТипЗнач, СтрДлина(Значение) + 10, Точность);
		КонецЕсли;
		
		Справочник.УстановитьАтрибут(ИдРеквизита, Значение);
		
	КонецЦикла;
	                                                            
	//	набор условий "от противного"
	Если		ПустоеЗначение(Справочник.Код)	=	0	Тогда	//	код не пустой		- порядок
	ИначеЕсли	ПустоеЗначение(ЕстьКонтроль)	=	1	Тогда	//	контроль отключен	- порядок
	ИначеЕсли	ТипКода = "Числовой"					Тогда	//	код=0				- порядок
	ИначеЕсли	ПустоеЗначение(ДлинаКода)		=	1	Тогда	//	кода вообще нет!	- порядок
	Иначе
		Справочник.Код = "0";
	КонецЕсли;
	
	Если ПроверкаУникальностиОбъектаСправочника(Справочник, ЕстьКонтроль, ЕстьВладелец, Уникальность, АвтоНумерация) = 0 Тогда Возврат("Ошибка") КонецЕсли;
	
	ЗаписатьОбъект(Справочник, ВрмУникальныйИдентификатор, ВрмТипИсточника, ВрмТипПриемника);
	
	Если (мЗапоминатьЗагруженныеОбъекты = 1) Или (КолвоРеквизитовПоиска = 0) Тогда
		ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Справочник.ТекущийЭлемент());
	КонецЕсли;
	
	ВрмВозврат.Установить("СтатусВозврата", 1);
	ВрмВозврат.Установить("Результат", Справочник.ТекущийЭлемент());
	Возврат ВрмВозврат;
	// Возврат	Справочник.ТекущийЭлемент();
	
КонецФункции	//	УстановитьСправочникПоСсылкеV8()

//--------------------------------------------------------------------------------------------------

Функция УстановитьДокументПоСсылкеV8(Ссылка, Вид="", СозданНовыйОбъект=0, НовыеНеСоздавать=0, ОбъектМД="", Объект="", Знач РежимПоискаОсновногоОбъекта)
    
	Перем	Документ;
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмНайденоСоответствиеОбъекта = 0;
	//Ссылка	=	Объект.ВыбратьУзел("Ссылка");
	//Если ПустоеЗначение(Ссылка) = 1 Тогда
	//	ОбъектМД	=	Метаданные.Документ(Вид);
	//	Если Объект.ИмяТэга = "Ссылка" Тогда
	//		Ссылка	=	Объект;
	//	Иначе
	//		Возврат("");
	//	КонецЕсли;
	//КонецЕсли;
	//
	//Если ПустоеЗначение(Вид) = 1 Тогда Вид = Ссылка.ПолучитьАтрибут("Вид")	КонецЕсли;

	ОбъектМД = Метаданные.Документ(Вид);
	
	Если ОбъектМД.Выбран()	= 0 Тогда
		ЗаписатьОшибку("Неверный вид документа " + Вид);
		Возврат("Ошибка");
	КонецЕсли;
	
	Если ПустоеЗначение(Объект) = 1 Тогда
		Объект = Ссылка;
	КонецЕсли;
	
	Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда
		Если ОбъектУжеЗагружен("Документ" + Вид, Ссылка.ПредставлениеXML, Документ) = 1 Тогда Возврат(Документ) КонецЕсли;
	КонецЕсли;

	ВрмУникальныйИдентификатор = "";
	ВрмТипИсточника = "";
	ВрмТипПриемника = "";

	УзелУникальныйИдентификатор = Ссылка.ВыбратьУзел("Свойство[@Имя=""{УникальныйИдентификатор}""]");
	Если ПустоеЗначение(УзелУникальныйИдентификатор) = 0 Тогда
		ВрмУникальныйИдентификатор = одЗначениеЭлемента(УзелУникальныйИдентификатор.ВыбратьУзел("Значение"), "Строка");
		ВрмТипИсточника = одАтрибут(УзелУникальныйИдентификатор, "Строка", "ТипИсточника");
		ВрмТипПриемника = одАтрибут(УзелУникальныйИдентификатор, "Строка", "ТипПриемника");
		Ссылка.УдалитьПодчиненный(УзелУникальныйИдентификатор);
		ВрмВозврат.Установить("УникальныйИдентификатор", ВрмУникальныйИдентификатор);

		// ВрмВозвратФункции = ПолучитьСсылкуПоИдентификаторуКорреспондента(ВрмУникальныйИдентификатор);
		ВыполнитьЗаменуУникальногоИдентификатораПриНеобходимости(ВрмУникальныйИдентификатор, ВрмТипИсточника, ВрмТипПриемника, РежимПоискаОсновногоОбъекта, ВрмНайденоСоответствиеОбъекта);
		// Если ПолучитьСтатусВозврата(ВрмВозвратФункции) = 0 Тогда
			
		// ИначеЕсли ПустоеЗначение(ВрмВозвратФункции.Получить("Результат")) = 0 Тогда
		// 	ВрмВозврат.Установить("СтатусВозврата", 1);
		// 	ВрмВозврат.Установить("Результат", ВрмВозвратФункции.Получить("Результат"));
		// 	Возврат ВрмВозврат;
		// КонецЕсли;
	КонецЕсли;

	Если ВрмНайденоСоответствиеОбъекта = 1 Тогда
		
		ВрмСсылкаНаОбъект = ПолучитьСсылкуПоИдентификатору(ВрмУникальныйИдентификатор);

		ВрмВозврат.Установить("СтатусВозврата", 1);
		ВрмВозврат.Установить("Результат", ВрмСсылкаНаОбъект);
		Возврат ВрмВозврат;

	КонецЕсли;

	РеквизитыПоиска			=	Ссылка.ВыбратьУзлы("Свойство");
	КолвоРеквизитовПоиска	=	РеквизитыПоиска.КоличествоУзлов;

	Если мЗапоминатьЗагруженныеОбъекты = 0 Тогда

		Если КолвоРеквизитовПоиска = 0 Тогда	//	используется внутренняя ссылка
			Если ОбъектУжеЗагружен("Документ" + Вид, Ссылка.ПредставлениеXML, Документ) = 1 Тогда Возврат(Документ) КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	//	Эта возможность временно отключена...
	//СистПр	=	Ссылка.ВыбратьУзел("Свойство[@Имя=""СистемноеПредставление()""]");
	//Если ПустоеЗначение(СистПр) = 0 Тогда
	//	Возврат	ЗначениеИзСтрокиВнутр(СистПр.ПолучитьАтрибут("Значение"));
	//КонецЕсли;
	
	Документ 				=	СоздатьОбъект("Документ." + Вид);
	
	Уникальность			=	ОбъектМД.ПериодичностьНомера;
	ЕстьКонтроль			=	ОбъектМД.КонтрольУникальности;
	АвтоНумерация			=	ОбъектМД.АвтоНумерация - 1;
	ТипНомера				=	ОбъектМД.ТипНомера;
	
	НомерДок=""; ДатаДок="";
	          
	
	Если КолвоРеквизитовПоиска > 0 Тогда
		НомерДок				=	УстановитьРеквизитV8(Ссылка.ВыбратьУзел("Свойство[@Имя=""НомерДок""]"),	"Документ", Вид, "НомерДок");
		ДатаДок					=	УстановитьРеквизитV8(Ссылка.ВыбратьУзел("Свойство[@Имя=""ДатаДок""]"),	"Документ", Вид, "ДатаДок");
	КонецЕсли;
                                    
	//РеквизитыПоиска		=	Ссылка.ВыбратьУзлы("Свойство");
	//КолвоРеквизитовПоиска	=	РеквизитыПоиска.КоличествоУзлов;

	Если (ПустоеЗначение(ДатаДок) = 1) И (КолвоРеквизитовПоиска = 1) Тогда
		//	возможно по дате просто не синхронизируем
		ДатаДок	=	УстановитьРеквизитV8(Объект.ВыбратьУзел("Свойство[@Имя=""ДатаДок""]"),	"Документ", Вид, "ДатаДок");
		Если ПустоеЗначение(ДатаДок) = 1 Тогда
			ДатаДок	=	РабочаяДата();
		КонецЕсли;
	КонецЕсли;
	
	//--------		Поиск		-------------------------------
	Если		КолвоРеквизитовПоиска = 0 Тогда
		
			//	Поиск не производим!
		
	ИначеЕсли	(ПустоеЗначение(НомерДок) = 0)	И	(КолвоРеквизитовПоиска = 1) Тогда
		
		Если		Документ.НайтиПоНомеру(НомерДок, ДатаДок) = 1 Тогда
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Документ.ТекущийДокумент()); КонецЕсли;
			// Возврат	Документ.ТекущийДокумент();
			ВрмВозврат.Установить("Результат", Документ.ТекущийДокумент());
			Возврат ВрмВозврат;
		КонецЕсли;
    
	ИначеЕсли	(ПустоеЗначение(НомерДок) = 0)	И	(ПустоеЗначение(ДатаДок) = 0) И (КолвоРеквизитовПоиска = 2) Тогда

		Если		Документ.НайтиПоНомеру(НомерДок, ДатаДок) = 1 Тогда
			Если Документ.ДатаДок = ДатаДок Тогда
				Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Документ.ТекущийДокумент()); КонецЕсли;
				// Возврат	Документ.ТекущийДокумент();
				ВрмВозврат.Установить("Результат", Документ.ТекущийДокумент());
				Возврат ВрмВозврат;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли   (ЕстьКонтроль 				=	1)	И
				(ПустоеЗначение(НомерДок)	=	0)	И
		     	((Уникальность	=	"Все")	Или	(ПустоеЗначение(ДатаДок) = 0))	Тогда
			 		
		Если		Документ.НайтиПоНомеру(НомерДок, ДатаДок)				= 0 Тогда	//	создаем новый
		ИначеЕсли	СравнитьРеквизитыДокументаV8(Документ, РеквизитыПоиска)	= 1 Тогда
			Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Документ.ТекущийДокумент()); КонецЕсли;
			// Возврат	Документ.ТекущийДокумент();
			ВрмВозврат.Установить("Результат", Документ.ТекущийДокумент());
			Возврат ВрмВозврат;
		КонецЕсли;
		
	ИначеЕсли	КолвоРеквизитовПоиска > 0	Тогда
		
		// поиск перебором документов данного вида
		Документ.ОбратныйПорядок(1);
		
		Если ПустоеЗначение(ДатаДок) = 0 Тогда
			Документ.ВыбратьДокументы(ДатаДок, ДатаДок);
		Иначе
			Документ.ВыбратьДокументы();
		КонецЕсли;
		
		Пока Документ.ПолучитьДокумент() = 1 Цикл
			Если СравнитьРеквизитыДокументаV8(Документ, РеквизитыПоиска) = 1 Тогда
				Если мЗапоминатьЗагруженныеОбъекты = 1 Тогда ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Документ.ТекущийДокумент()); КонецЕсли;
				// Возврат	Документ.ТекущийДокумент();
				ВрмВозврат.Установить("Результат", Документ.ТекущийДокумент());
				Возврат ВрмВозврат;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	//------------------------------------------------------------
	Если ПустоеЗначение(НовыеНеСоздавать) = 0 Тогда
		ЗаписатьОшибку("Объект не найден и не создан: Документ." + Вид + РазделительСтрок + Ссылка.ПредставлениеXML, "!");
		Возврат("#НеУстановлен");
	КонецЕсли;
	     
	//------	создаем новый объект	--------------------------
	
	Документ.Новый();
	СозданНовыйОбъект	=	1;
	
	//	Дата
	
	Если ПустоеЗначение(ДатаДок) = 1 Тогда
		//	возможно по дате просто не синхронизируем
		ДатаДок	=	УстановитьРеквизитV8(Объект.ВыбратьУзел("Свойство[@Имя=""ДатаДок""]"),	"Документ", Вид, "ДатаДок");
		Если ПустоеЗначение(ДатаДок) = 1 Тогда
			ДатаДок	=	РабочаяДата();
		КонецЕсли;
	КонецЕсли;
	Документ.ДатаДок	=	ДатаДок;
			
	//	Номер
	
	Если ПустоеЗначение(НомерДок) = 0 Тогда
		Документ.НомерДок	=	НомерДок;
	Иначе
		НомерДок	=	УстановитьРеквизитV8(Объект.ВыбратьУзел("Свойство[@Имя=""НомерДок""]"),	"Документ", Вид, "НомерДок");
		Если ПустоеЗначение(НомерДок) = 1 Тогда
			Документ.УстановитьНовыйНомер();
		Иначе
			Документ.НомерДок	=	НомерДок;
		КонецЕсли;
	КонецЕсли;
			
	//	Операция
	
	Если ОбъектМД.БухгалтерскийУчет = 1 Тогда
		Если ОбъектМД.СоздаватьОперацию <> "ТолькоПриПроведении" Тогда
			Документ.СуществуетОперация(1);
		КонецЕсли;
	КонецЕсли;

	//	РеквизитыПоиска
			
	Для Сч = 0 По РеквизитыПоиска.КоличествоУзлов - 1 Цикл
		
		Реквизит			=	РеквизитыПоиска.ПолучитьУзел(Сч);
		ИдРеквизита			=	одАтрибут(Реквизит, "Строка", "Имя");
		
		// Если (ИдРеквизита = "НомерДок") Или (ИдРеквизита = "ДатаДок") Тогда Продолжить КонецЕсли;

		Если ИдРеквизита = "НомерДок" Тогда Продолжить КонецЕсли;
		
		//РеквизитОперации	=	Реквизит.ПолучитьАтрибут("ЭтоРеквизитОперации");
		//Если ПустоеЗначение(РеквизитОперации) = 1 Тогда
			ТипОбъектаРеквизита		=	"Документ";
			ВидОбъектаРеквизита		=	Вид;
		//Иначе
		//	Если Документ.СуществуетОперация() = 0 Тогда
		//		ЗаписатьОшибку("У документа вида - " + Вид + " - не существует операции!", "!!");
		//		Продолжить;
		//	КонецЕсли;
		//	ТипОбъектаРеквизита		=	"Операция";
		//	ВидОбъектаРеквизита		=	"";
		//КонецЕсли;
		
		Значение					=	УстановитьРеквизитV8(Реквизит, ТипОбъектаРеквизита, ВидОбъектаРеквизита, ИдРеквизита);
		
		ТипРеквизита				=	"";
		ПрочитатьИнформациюОТипеРеквизита(ТипОбъектаРеквизита, ВидОбъектаРеквизита, ИдРеквизита, ТипРеквизита);
		
		Если		ПустоеЗначение(ТипРеквизита) = 1 Тогда
			
			ПредставлениеРеквизита		=	ТипОбъектаРеквизита + "." + ВидОбъектаРеквизита + "." + ИдРеквизита;
			ЗаписатьОшибку("Неверное имя реквизита:" + ПредставлениеРеквизита);
			Продолжить;
			
		ИначеЕсли	ТипРеквизита = "Неопределенный" Тогда
			
			//ТипЗнач			=	Реквизит.ПолучитьАтрибут("ТипЗначения");
			//ВидЗнач			=	Реквизит.ПолучитьАтрибут("ВидЗначения");
			//Точность		=	0;
			//Если ТипЗнач = "Число" Тогда
			//	СтрТочность	=	Значение;
			//	Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
			//КонецЕсли;
			//Если	ПустоеЗначение(РеквизитОперации) = 1	Тогда
			//	Документ.НазначитьТип(ИдРеквизита, ТипЗнач + ?(ПустоеЗначение(ВидЗнач)=1, "", "." + ВидЗнач), СтрДлина(Значение) + 10, Точность);
			//Иначе
			//	Документ.Операция.НазначитьТип(ИдРеквизита, ТипЗнач + ?(ПустоеЗначение(ВидЗнач)=1, "", "." + ВидЗнач), СтрДлина(Значение) + 10, Точность);
			//КонецЕсли;

			ТипЗнач  = одАтрибут(Реквизит, "Строка", "Тип"); // ОпределитьСтроковыйТип(Реквизит.ПолучитьАтрибут("Тип"));
			Точность = 0;
			Если ТипЗнач = "Число" Тогда
				СтрТочность	=	Значение;
				Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
			КонецЕсли;
			Документ.НазначитьТип(ИдРеквизита, ТипЗнач, СтрДлина(Значение) + 10, Точность);
			
		КонецЕсли;

		Если		ИдРеквизита = "ДатаДок" Тогда	// Дату уже установивли - теперь установим время

			ВремяДокумента = "";
			ДатаДокумента  = ДатаИзXML(Реквизит.ВыбратьУзел("Значение").Значение, ВремяДокумента);
			
			Документ.АвтоВремяОтключить();
		    Документ.УстановитьВремя(Число(Сред(ВремяДокумента, 1, 2)), Число(Сред(ВремяДокумента, 4, 2)), Число(Сред(ВремяДокумента, 7, 2)));
			
		Иначе // Если	ПустоеЗначение(РеквизитОперации) = 1	Тогда
			
			Документ.УстановитьАтрибут(ИдРеквизита, Значение);
			
		//Иначе
		//	
		//	Документ.Операция.УстановитьАтрибут(ИдРеквизита, Значение);
			
		КонецЕсли;
		
	КонецЦикла;

	//	набор условий "от противного"
	Если		ПустоеЗначение(Документ.НомерДок)	=	0	Тогда	//	номер не пустой		- порядок
	ИначеЕсли	ТипНомера = "Числовой"						Тогда	//	номер = 0			- порядок
	Иначе
		// ??? здесь можно написать алгоритм получения нового номера
		
		Документ.НомерДок = "0";
		
		//ЗаписатьОшибку("У документа '" + Вид + "' отлючен режим автоматической нумерации и не задан номер!", "!!");
		//Возврат("Ошибка");
	КонецЕсли;
	
	Если ПроверкаУникальностиДокумента(Документ, ЕстьКонтроль, Уникальность, АвтоНумерация) = 0 Тогда Возврат("Ошибка") КонецЕсли;
	
	ЗаписатьОбъект(Документ, ВрмУникальныйИдентификатор, ВрмТипИсточника, ВрмТипПриемника);
	
	Если (мЗапоминатьЗагруженныеОбъекты = 1) Или (КолвоРеквизитовПоиска = 0) Тогда
		ЗапомнитьСсылку(Вид, Ссылка.ПредставлениеXML, Документ.ТекущийДокумент());
	КонецЕсли;

	// Возврат	Документ.ТекущийДокумент();
	ВрмВозврат.Установить("Результат", Документ.ТекущийДокумент());
	Возврат ВрмВозврат;
	
КонецФункции		//	УстановитьДокументПоСсылкеV8()

//--------------------------------------------------------------------------------------------------

Процедура ЗагрузитьОбъектСправочникаV8(Объект, Вид, ИмяПравила)

	Перем ОбъектМД;

	СозданНовыйОбъект	= 0;
	НовыеНеСоздавать    = 0;
	НеЗамещатьНайденные = 0;
	
	ДатаУстановки =ТекущаяДата();

	УзелСсылки = Объект.ВыбратьУзел("Ссылка");

	ВрмУникальныйИдентификатор = "";
	ВрмТипИсточника = "";
	ВрмТипПриемника = "";

	Если ПустоеЗначение(УзелСсылки) = 0 Тогда

		ЭтоГруппа = 0;
		
		УзелЭтоГруппа = УзелСсылки.ВыбратьУзел("Свойство[@Имя=""ЭтоГруппа""]");
		Если ПустоеЗначение(УзелЭтоГруппа) = 0 Тогда
			ЭтоГруппа = УстановитьРеквизитV8(УзелЭтоГруппа, "Справочник", Вид, "ЭтоГруппа");
			УзелСсылки.УдалитьПодчиненный(УзелЭтоГруппа);
		Иначе
			УзелЭтоГруппа = Объект.ВыбратьУзел("Свойство[@Имя=""ЭтоГруппа""]");
			Если ПустоеЗначение(УзелЭтоГруппа) = 0 Тогда
				ЭтоГруппа = УстановитьРеквизитV8(УзелЭтоГруппа, "Справочник", Вид, "ЭтоГруппа");
				Объект.УдалитьПодчиненный(УзелЭтоГруппа);
			КонецЕсли; 
		КонецЕсли;
		
		ВрмВозврат = УстановитьСправочникПоСсылкеV8(УзелСсылки, Вид, СозданНовыйОбъект, НовыеНеСоздавать, ОбъектМД, ЭтоГруппа, Объект, 1);
		ВрмУникальныйИдентификатор = ВрмВозврат.Получить("УникальныйИдентификатор");
		ВрмТипИсточника = ВрмВозврат.Получить("ТипИсточника");
		ВрмТипПриемника = ВрмВозврат.Получить("ТипПриемника");

		// Если ТекущийОбъект = "Ошибка" Тогда Возврат КонецЕсли;
		Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда Возврат КонецЕсли;
		
		ТекущийОбъект = ВрмВозврат.Получить("Результат");

		ОбъектБД = СоздатьОбъект("Справочник." + Вид);
		
		Если ПустоеЗначение(ТекущийОбъект) = 0 Тогда

			НеЗамещатьНайденные = Объект.ПолучитьАтрибут("НеЗамещать");
			
			Если ПустоеЗначение(СозданНовыйОбъект) = 1 Тогда
				Если ПустоеЗначение(НеЗамещатьНайденные) = 0 Тогда
					Если ТекущийОбъект.ПометкаУдаления() = 0 Тогда	//	этот объект не создан по ссылке из реквизитов других объектов
						Возврат;	//	найденные не замещаем
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			ОбъектБД.НайтиЭлемент(ТекущийОбъект);
		КонецЕсли;
		
	Иначе // Ссылки нет. Необходимо запретить такую возможность

		ЗаписатьОшибку("Ссылки нет " + Вид);

		Возврат;

		// ОбъектМД = Метаданные.Справочник(Вид);
	
		// //Если ПустоеЗначение(НовыеНеСоздавать) = 0 Тогда Возврат КонецЕсли;	//	новые не создаем
		
		// ОбъектБД = СоздатьОбъект("Справочник." + Вид);
		
		// //ЭтоГруппа	=	Число(Объект.ПолучитьАтрибут("ЭтоГруппа"));

		// ЭтоГруппа = 0;

		// УзелЭтоГруппа = Объект.ВыбратьУзел("Свойство[@Имя=""ЭтоГруппа""]");
		// Если ПустоеЗначение(УзелЭтоГруппа) = 0 Тогда
		// 	ЭтоГруппа = УстановитьРеквизитV8(УзелЭтоГруппа, "Справочник", Вид, "ЭтоГруппа");
		// КонецЕсли;
		
		// Если ЭтоГруппа = 1 Тогда
		// 	ОбъектБД.НоваяГруппа();
		// Иначе
		// 	ОбъектБД.Новый();
		// КонецЕсли;
		
		// ОбъектБД.УстановитьНовыйКод();
		// СозданНовыйОбъект	=	1;
		
	КонецЕсли;
	    
	// Локальный обработчик "ПриЗагрузке"
	НомерСтроки = 0;
	Если мТаблицаПравилКонвертацииОбъектов.НайтиЗначение(ИмяПравила, НомерСтроки, "Код") = 1 Тогда
		мТаблицаПравилКонвертацииОбъектов.ПолучитьСтрокуПоНомеру(НомерСтроки);
		// Если мТаблицаПравилКонвертацииОбъектов.ЕстьОбработчикПриЗагрузке = 1 Тогда
		Если мТаблицаПравилКонвертацииОбъектов.ПриЗагрузке = 1 Тогда
			Отказ = Шаблон("[ПКО_ПриЗагрузке_" + ИмяПравила + "(ОбъектБД, ИмяПравила, Объект, ДатаУстановки)]");
			Если Число(Отказ) = 1 Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;                          
	
	ЕстьВладелец				=	ОбъектМД.Владелец.Выбран();
	ЕстьКонтроль				=	ОбъектМД.КонтрольУникальности;
	Уникальность				=	ОбъектМД.СерииКодов;
	АвтоНумерация				=	ОбъектМД.АвтоНумерация - 1;
	
	СпособЗагрузкиПоУмолчанию	=	"ЗамещатьНеПустыми";
	СтатусУдаления				=	"Авто";
	ПометкаУдаления				=	0;
	
                                             
	ОбъектБД.ИспользоватьДату(ДатаУстановки, 1);
	
	НеИспользуется	=	?(ОбъектБД.ЭтоГруппа() = 1, "ДляЭлемента", "ДляГруппы");
	             
	//--------- Заполняем реквизиты --------------------------------------------
	
	Реквизиты	=	Объект.ВыбратьУзлы("Свойство");
	Для Сч = 0 По Реквизиты.КоличествоУзлов - 1 Цикл
		Реквизит					=	Реквизиты.ПолучитьУзел(Сч);
		ИдРеквизита					=	одАтрибут(Реквизит, "Строка", "Имя");
		НеЗамещатьРеквизит			=	одАтрибут(Реквизит, "Булево", "НеЗамещать"); //Реквизит.ПолучитьАтрибут("НеЗамещать");
		Значение					=	УстановитьРеквизитV8(Реквизит, "Справочник", Вид, ИдРеквизита);
		
		Если Значение = "#НеУстановлен" Тогда
			ЗаписатьОшибку("Не установлен реквизит.  Справочник." + Вид + ": " + ОбъектБД + "  Реквизит: " + ИдРеквизита);
			Продолжить;
		КонецЕсли;

		Если СозданНовыйОбъект = 0 Тогда	//	Найден существующий объект
			//Если НеУстанавливатьРеквизит(СпособЗагрузкиПоУмолчанию, СпособЗагрузки, ОбъектБД, ИдРеквизита, Значение, СозданНовыйОбъект) = 1 Тогда Продолжить КонецЕсли;
			Если ПустоеЗначение(НеЗамещатьРеквизит) = 0 Тогда Продолжить КонецЕсли;   
			Если НЕ (ИдРеквизита = "ПометкаУдаления") Тогда
				Если ОбъектБД.ПолучитьАтрибут(ИдРеквизита) = Значение Тогда Продолжить КонецЕсли;	//	значение не изменилось
			КонецЕсли;
		КонецЕсли;

		Если ИдРеквизита = "ПометкаУдаления" Тогда
			ПометкаУдаления = Значение;
		Иначе
			Если Найти("Код,Наименование,Родитель,Владелец", ИдРеквизита) = 0 Тогда
				РеквМД						=	ОбъектМД.Реквизит(ИдРеквизита);
				ПредставлениеРеквизита		=	" (Справочник." + Вид + "." + ИдРеквизита + ")";
				Если РеквМД.Выбран()		=	0				Тогда	ЗаписатьОшибку("Неверное имя реквизита:" + ПредставлениеРеквизита);	Продолжить;					КонецЕсли;
				Если РеквМД.Использование	=	НеИспользуется	Тогда	ЗаписатьОшибку("Реквизит используется " + НеИспользуется + ПредставлениеРеквизита);	Продолжить;	КонецЕсли;
				Если РеквМД.Тип="Неопределенный" Тогда
					ТипЗнач = одАтрибут(Реквизит, "Строка", "Тип"); // ОпределитьСтроковыйТип(Реквизит.ПолучитьАтрибут("Тип"));
					Точность		=	0;
					Если ТипЗнач = "Число" Тогда
						СтрТочность	=	Значение;
						Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
					КонецЕсли;
					ОбъектБД.НазначитьТип(ИдРеквизита, ТипЗнач, СтрДлина(Значение) + 10, Точность);
				КонецЕсли; 
			КонецЕсли;	
			                     
			// // Это помогает при отладке
			// Если ФормФлРежимОтладки = 0 Тогда
			// 	ОбъектБД.УстановитьАтрибут(ИдРеквизита, Значение);
			// Иначе
				Попытка
					ОбъектБД.УстановитьАтрибут(ИдРеквизита, Значение);
				Исключение
					ЗаписатьОшибку("Неудачная попытка установки значения реквизита объекта: " + ОбъектБД + ", Реквизит: " + ИдРеквизита + " - " + ОписаниеОшибки());
				КонецПопытки;
			// КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Если ПроверкаУникальностиОбъектаСправочника(ОбъектБД, ЕстьКонтроль, ЕстьВладелец, Уникальность, АвтоНумерация) = 0 Тогда Возврат КонецЕсли;

	// Глобальный обработчик "ПослеЗагрузкиОбъекта"
	Если мКонвертацияПослеЗагрузкиОбъекта = 1 Тогда
		Отказ = Шаблон("[Конвертация_ПослеЗагрузкиОбъекта(ОбъектБД, ИмяПравила)]");
		Если Число(Отказ) = 1 Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
                                
	// Локальный обработчик "ПослеЗагрузки"
	НомерСтроки = 0;
	Если мТаблицаПравилКонвертацииОбъектов.НайтиЗначение(ИмяПравила, НомерСтроки, "Код") = 1 Тогда
		мТаблицаПравилКонвертацииОбъектов.ПолучитьСтрокуПоНомеру(НомерСтроки);
		// Если мТаблицаПравилКонвертацииОбъектов.ЕстьОбработчикПослеЗагрузки = 1 Тогда
		Если мТаблицаПравилКонвертацииОбъектов.ПослеЗагрузки = 1 Тогда
			Отказ = Шаблон("[ПКО_ПослеЗагрузки_" + ИмяПравила + "(ОбъектБД, ИмяПравила, Объект)]");
			Если Число(Отказ) = 1 Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;                          
	
	ЗаписатьОбъект(ОбъектБД, ВрмУникальныйИдентификатор, ВрмТипИсточника, ВрмТипПриемника);
	
	Если ПустоеЗначение(ПометкаУдаления) = 1 Тогда
		Если ОбъектБД.ПометкаУдаления() = 1 Тогда	ОбъектБД.СнятьПометкуУдаления();	КонецЕсли;
	Иначе
		Если ОбъектБД.ПометкаУдаления() = 0 Тогда	ОбъектБД.Удалить(0);				КонецЕсли;
	КонецЕсли;	                                  
	
КонецПроцедуры		//	ЗагрузитьОбъектСправочникаV8()

//--------------------------------------------------------------------------------------------------
                                                                                 
Процедура ЗагрузитьДокументV8(Объект, Вид, ИмяПравила)
	          
	Перем	ОбъектМД;

	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	
	СозданНовыйОбъект	=	0;
	НовыеНеСоздавать	=	0;
	НеЗамещатьНайденные =	0;

	УзелСсылки = Объект.ВыбратьУзел("Ссылка");

		ВрмУникальныйИдентификатор = "";
	ВрмТипИсточника = "";
	ВрмТипПриемника = "";

	Если ПустоеЗначение(УзелСсылки) = 0 Тогда

		ЭтоГруппа = 0;
		
		УзелЭтоГруппа = УзелСсылки.ВыбратьУзел("Свойство[@Имя=""ЭтоГруппа""]");
		Если ПустоеЗначение(УзелЭтоГруппа) = 0 Тогда
			ЭтоГруппа = УстановитьРеквизитV8(УзелЭтоГруппа, "Справочник", Вид, "ЭтоГруппа");
			УзелСсылки.УдалитьПодчиненный(УзелЭтоГруппа);
		Иначе
			УзелЭтоГруппа = Объект.ВыбратьУзел("Свойство[@Имя=""ЭтоГруппа""]");
			Если ПустоеЗначение(УзелЭтоГруппа) = 0 Тогда
				ЭтоГруппа = УстановитьРеквизитV8(УзелЭтоГруппа, "Справочник", Вид, "ЭтоГруппа");
				Объект.УдалитьПодчиненный(УзелЭтоГруппа);
			КонецЕсли; 
		КонецЕсли;
		
		ВрмВозврат = УстановитьДокументПоСсылкеV8(УзелСсылки, Вид, СозданНовыйОбъект, НовыеНеСоздавать, ОбъектМД, Объект, 1);
		ВрмУникальныйИдентификатор = ВрмВозврат.Получить("УникальныйИдентификатор");
		ВрмТипИсточника = ВрмВозврат.Получить("ТипИсточника");
		ВрмТипПриемника = ВрмВозврат.Получить("ТипПриемника");
		
		// Если ТекущийОбъект = "Ошибка" Тогда Возврат КонецЕсли;
		Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда Возврат КонецЕсли;
		
		ТекущийОбъект = ВрмВозврат.Получить("Результат");
		
		ОбъектБД	=	СоздатьОбъект("Документ." + Вид);    
		
		Если ПустоеЗначение(ТекущийОбъект) = 0 Тогда

			НеЗамещатьНайденные =  одАтрибут(Объект, "Булево", "НеЗамещать"); //Объект.ПолучитьАтрибут("НеЗамещать");
			
			Если СозданНовыйОбъект = 0 Тогда
				Если ПустоеЗначение(НеЗамещатьНайденные) = 0 Тогда
					Если ТекущийОбъект.ПометкаУдаления() = 0 Тогда	//	этот объект не создан по ссылке из реквизитов других объектов
						Возврат;	//	найденные не замещаем
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			// СтатусПроведения	=	гТабКэшПараметровЗагрузки.СтатусПроведения;
			ОтменитьПроведение	=	одАтрибут(Объект, "Булево", "ОтменитьПроведение"); //Число(Объект.ПолучитьАтрибут("ОтменитьПроведение"));
			
			ОбъектБД.НайтиДокумент(ТекущийОбъект);

		КонецЕсли;
			
	Иначе				//	Ссылки нет
		
		//Если ПустоеЗначение(НовыеНеСоздавать) = 0 Тогда Возврат КонецЕсли;	//	новые не создаем
		ОбъектБД = СоздатьОбъект("Документ." + Вид);    
		
		ОбъектМД = Метаданные.Документ(Вид);
		
		ОбъектБД.Новый();
		СозданНовыйОбъект	=	1;
		
		Если ОбъектМД.БухгалтерскийУчет = 1 Тогда
			Если ОбъектМД.СоздаватьОперацию <> "ТолькоПриПроведении" Тогда
				ОбъектБД.СуществуетОперация(1);
			КонецЕсли;
		КонецЕсли;

		ЗначениеНомераДокумента = "";
		УзелНомераДокумента		= Объект.ВыбратьУзел("Свойство[@Имя=""НомерДок""]");
		Если ПустоеЗначение(УзелНомераДокумента) = 0 Тогда
			//ЗначениеНомераДокумента		=	УзелНомераДокумента.ПолучитьАтрибут("Значение");
			ЗначениеНомераДокумента = УстановитьРеквизитV8(УзелНомераДокумента, "Документ", Вид, "НомерДок");
		КонецЕсли;
		Если ПустоеЗначение(ЗначениеНомераДокумента) = 0 Тогда
			ОбъектБД.НомерДок			=	ЗначениеНомераДокумента;
		Иначе
			ЗначениеДатыДокумента		=	"";
			УзелДатыДокумента			=	Объект.ВыбратьУзел("Свойство[@Имя=""ДатаДок""]");
			Если ПустоеЗначение(УзелДатыДокумента) = 0 Тогда
				//ЗначениеДатыДокумента	=	Дата(УзелДатыДокумента.ПолучитьАтрибут("Значение"));
				ЗначениеДатыДокумента	=	УстановитьРеквизитV8(УзелДатыДокумента, "Документ", Вид, "ДатаДок");
			КонецЕсли;
			// Если ПустоеЗначение(ЗначениеДатыДокумента) = 1 Тогда ЗначениеДатыДокумента = ФормДатаКон КонецЕсли;
			ОбъектБД.ДатаДок			=	ЗначениеДатыДокумента;
			ОбъектБД.УстановитьНовыйНомер();
		КонецЕсли;
		
	КонецЕсли;
	
	// Локальный обработчик "ПриЗагрузке"
	НомерСтроки = 0;
	Если мТаблицаПравилКонвертацииОбъектов.НайтиЗначение(ИмяПравила, НомерСтроки, "Код") = 1 Тогда
		мТаблицаПравилКонвертацииОбъектов.ПолучитьСтрокуПоНомеру(НомерСтроки);
		// Если мТаблицаПравилКонвертацииОбъектов.ЕстьОбработчикПриЗагрузке = 1 Тогда
		Если мТаблицаПравилКонвертацииОбъектов.ПриЗагрузке = 1 Тогда
			Отказ = Шаблон("[ПКО_ПриЗагрузке_" + ИмяПравила + "(ОбъектБД, ИмяПравила, Объект)]");
			Если Число(Отказ) = 1 Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;                          
	
	ЕстьКонтроль				=	ОбъектМД.КонтрольУникальности;
	Уникальность				=	ОбъектМД.ПериодичностьНомера;
	АвтоНумерация				=	ОбъектМД.АвтоНумерация - 1;

	СпособЗагрузкиПоУмолчанию	=	"ЗамещатьНеПустыми";
	НеУдалятьСтроки				=	0;
	СтатусУдаления				=	"Авто";
	ПометкаУдаления				=	0;
	                                         
	//--------- Заполняем реквизиты --------------------------------------------
	Реквизиты	=	Объект.ВыбратьУзлы("Свойство");
	Для Сч = 0 По Реквизиты.КоличествоУзлов - 1 Цикл
		
		Реквизит					=	Реквизиты.ПолучитьУзел(Сч);
		ИдРеквизита					=	одАтрибут(Реквизит, "Строка", "Имя"); //Реквизит.ПолучитьАтрибут("Имя");
		НеЗамещатьРеквизит			=	одАтрибут(Реквизит, "Булево", "НеЗамещать"); //Реквизит.ПолучитьАтрибут("НеЗамещать");
		//РеквизитОперации			=	0;

		ТипОбъектаРеквизита		=	"Документ";
		ВидОбъектаРеквизита		=	Вид;
		
		//Если ПустоеЗначение(РеквизитОперации) = 1 Тогда
		//	ТипОбъектаРеквизита		=	"Документ";
		//	ВидОбъектаРеквизита		=	Вид;
		//Иначе
		//	Если ОбъектБД.СуществуетОперация() = 0 Тогда
		//		ЗаписатьОшибку("У документа вида - " + Вид + " - не существует операции!", "!!");
		//		Продолжить;
		//	КонецЕсли;
		//	ТипОбъектаРеквизита		=	"Операция";
		//	ВидОбъектаРеквизита		=	"";
		//КонецЕсли;
		
		Значение					=	УстановитьРеквизитV8(Реквизит, ТипОбъектаРеквизита, ВидОбъектаРеквизита, ИдРеквизита);
		ТипРеквизита				=	"";
		ПрочитатьИнформациюОТипеРеквизита(ТипОбъектаРеквизита, ВидОбъектаРеквизита, ИдРеквизита, ТипРеквизита);

		Если Значение = "#НеУстановлен" Тогда
			ЗаписатьОшибку("Не установлен реквизит.  Документ." + Вид + ": " + ОбъектБД + "  Реквизит: " + ИдРеквизита);
			Продолжить;
		КонецЕсли;
		
		Если		ПустоеЗначение(ТипРеквизита) = 1 Тогда
			
			ПредставлениеРеквизита		=	ТипОбъектаРеквизита + "." + ВидОбъектаРеквизита + "." + ИдРеквизита;
			ЗаписатьОшибку("Неверное имя реквизита:" + ПредставлениеРеквизита);
			Продолжить;
			
		ИначеЕсли	ТипРеквизита = "Неопределенный" Тогда
			
			//ТипЗнач			=	Реквизит.ПолучитьАтрибут("ТипЗначения");
			//ВидЗнач			=	Реквизит.ПолучитьАтрибут("ВидЗначения");
			//Точность		=	0;
			//Если ТипЗнач = "Число" Тогда
			//	СтрТочность	=	Значение;
			//	Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
			//КонецЕсли;
			//Если	ПустоеЗначение(РеквизитОперации) = 1	Тогда
			//	ОбъектБД.НазначитьТип(ИдРеквизита, ТипЗнач + ?(ПустоеЗначение(ВидЗнач)=1, "", "." + ВидЗнач), СтрДлина(Значение) + 10, Точность);
			//Иначе
			//	ОбъектБД.Операция.НазначитьТип(ИдРеквизита, ТипЗнач + ?(ПустоеЗначение(ВидЗнач)=1, "", "." + ВидЗнач), СтрДлина(Значение) + 10, Точность);
			//КонецЕсли;
			
			ТипЗнач  = одАтрибут(Реквизит, "Строка", "Тип"); //ОпределитьСтроковыйТип(Реквизит.ПолучитьАтрибут("Тип"));
			Точность = 0;
			Если ТипЗнач = "Число" Тогда
				СтрТочность	=	Значение;
				Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
			КонецЕсли;
			ОбъектБД.НазначитьТип(ИдРеквизита, ТипЗнач, СтрДлина(Значение) + 10, Точность);
			
		КонецЕсли;

		Если СозданНовыйОбъект = 0 Тогда
			//Если НеУстанавливатьРеквизит(СпособЗагрузкиПоУмолчанию, СпособЗагрузки, ОбъектБД, ИдРеквизита, Значение, СозданНовыйОбъект) = 1 Тогда Продолжить КонецЕсли;
			Если ПустоеЗначение(НеЗамещатьРеквизит) = 0 Тогда Продолжить КонецЕсли;
			Если НЕ ((ИдРеквизита = "ДатаДок") ИЛИ (ИдРеквизита = "ПометкаУдаления")) Тогда
				Если ОбъектБД.ПолучитьАтрибут(ИдРеквизита) = Значение Тогда Продолжить КонецЕсли;	//	значение не изменилось
			КонецЕсли; 
		КонецЕсли;

		Если ИдРеквизита = "ПометкаУдаления" Тогда
			
			ПометкаУдаления = Значение;
			
		ИначеЕсли		ИдРеквизита = "ДатаДок" Тогда

			ВремяДокумента = "";
			ДатаДокумента  = ДатаИзXML(Реквизит.ВыбратьУзел("Значение").Значение, ВремяДокумента);
			
			Если ОбъектБД.Проведен() = 1 Тогда
				Если (ДатаДокумента <> ОбъектБД.ДатаДок) Или (ОбъектБД.ПолучитьВремя() <> ВремяДокумента) Тогда
					ЗаписатьОшибку("Изменены дата или время проведенного документа - " + ОбъектБД + "!
									|Проведение документа отменено.", "!");
					ОбъектБД.СделатьНеПроведенным();
				Иначе
					Продолжить;
				КонецЕсли; 
			КонецЕсли;
			
			//Если СозданНовыйОбъект = 0 Тогда	//	Найден
			//	Если ОбъектБД.ПолучитьВремя() = Значение Тогда Продолжить КонецЕсли;	//	значение не изменилось
			//	Если ОбъектБД.Проведен() = 1 Тогда
			//		ЗаписатьОшибку("Изменено время проведенного документа - " + ОбъектБД + "!
			//						|Проведение документа отменено.", "!");
			//		ОбъектБД.СделатьНеПроведенным();
			//	КонецЕсли;
			//КонецЕсли;

			ОбъектБД.ДатаДок = ДатаДокумента;
			ОбъектБД.АвтоВремяОтключить();
		    ОбъектБД.УстановитьВремя(Число(Сред(ВремяДокумента, 1, 2)), Число(Сред(ВремяДокумента, 4, 2)), Число(Сред(ВремяДокумента, 7, 2)));
		
		//ИначеЕсли	ПустоеЗначение(РеквизитОперации) = 1	Тогда
		Иначе
			
			ОбъектБД.УстановитьАтрибут(ИдРеквизита, Значение);
			
		//Иначе
		//			  
		//	Если СозданНовыйОбъект = 0 Тогда	//	Найден
		//		Если ОбъектБД.Операция.ПолучитьАтрибут(ИдРеквизита) = Значение Тогда Продолжить КонецЕсли;	//	значение не изменилось
		//	КонецЕсли;
		//	
		//	ОбъектБД.Операция.УстановитьАтрибут(ИдРеквизита, Значение);
			
		КонецЕсли;
		
	КонецЦикла;

	//--------- ТабличнаяЧасть ----------------------------------------------------------

	ТЧ = Объект.ВыбратьУзел("ТабличнаяЧасть");

	Если ПустоеЗначение(ТЧ) = 0 Тогда
	
		НеЗамещатьТЧ    = одАтрибут(ТЧ, "Булево", "НеЗамещать"); //ТЧ.ПолучитьАтрибут("НеЗамещать");

		Строки			=	ТЧ.ВыбратьУзлы("Запись");
		КоличествоСтрок	=	Строки.КоличествоУзлов;
		
		Если ПустоеЗначение(НеЗамещатьТЧ) = 1 Тогда
			Если ПустоеЗначение(КоличествоСтрок) = 0 Тогда ОбъектБД.УдалитьСтроки() КонецЕсли;
		КонецЕсли;
		
		Для СчСтрок = 0 По КоличествоСтрок - 1 Цикл
			СтрокаДокумента	=	Строки.ПолучитьУзел(СчСтрок);

			Реквизиты		=	СтрокаДокумента.ВыбратьУзлы("Свойство");
			КолвоРеквизитов	=	Реквизиты.КоличествоУзлов;
			               
			Если ПустоеЗначение(КолвоРеквизитов) = 0 Тогда
				ОбъектБД.НоваяСтрока();
			Иначе
				Продолжить;
			КонецЕсли;
			
			Для Сч = 0 По КолвоРеквизитов - 1 Цикл
				Реквизит					=	Реквизиты.ПолучитьУзел(Сч);
				ИдРеквизита					=	одАтрибут(Реквизит, "Строка", "Имя"); //Реквизит.ПолучитьАтрибут("Имя");
				Значение					=	УстановитьРеквизитV8(Реквизит, "Документ", Вид, ИдРеквизита);
				
				Если Значение = "#НеУстановлен" Тогда
					ЗаписатьОшибку("Не установлен реквизит.  Документ." + Вид + ": " + ОбъектБД + "  Реквизит: " + ИдРеквизита);
					Продолжить;
				КонецЕсли;
				
				ТипРеквизита				=	"";
				ПрочитатьИнформациюОТипеРеквизита("Документ", Вид, ИдРеквизита, ТипРеквизита);
				Если 		ПустоеЗначение(ТипРеквизита) = 1 Тогда
					ПредставлениеРеквизита		=	"Документ." + Вид + "." + ИдРеквизита;
					ЗаписатьОшибку("Неверное имя реквизита:" + ПредставлениеРеквизита);
					Продолжить;
				ИначеЕсли	ТипРеквизита = "Неопределенный" Тогда
					//ТипЗнач			=	Реквизит.ПолучитьАтрибут("ТипЗначения");
					//ВидЗнач			=	Реквизит.ПолучитьАтрибут("ВидЗначения");
					//Точность		=	0;
					//Если ТипЗнач = "Число" Тогда
					//	СтрТочность	=	Значение;
					//	Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
					//КонецЕсли;
					//ОбъектБД.НазначитьТип(ИдРеквизита, ТипЗнач + ?(ПустоеЗначение(ВидЗнач)=1, "", "." + ВидЗнач), СтрДлина(Значение) + 10, Точность);
					ТипЗнач  = одАтрибут(Реквизит, "Строка", "Тип"); //ОпределитьСтроковыйТип(Реквизит.ПолучитьАтрибут("Тип"));
					Точность = 0;
					Если ТипЗнач = "Число" Тогда
						СтрТочность	=	Значение;
						Точность	=	СтрДлина(	ОтделитьРазделителем(СтрТочность, ".")	);
					КонецЕсли;
					ОбъектБД.НазначитьТип(ИдРеквизита, ТипЗнач, СтрДлина(Значение) + 10, Точность);
				КонецЕсли;
				ОбъектБД.УстановитьАтрибут(ИдРеквизита, Значение);
			КонецЦикла;
			
		КонецЦикла;

	КонецЕсли; // загрузка табл. части
	
	//--------------------------------------------------------------------------
	
	Если ПроверкаУникальностиДокумента(ОбъектБД, ЕстьКонтроль, Уникальность, АвтоНумерация) = 0 Тогда Возврат КонецЕсли;
	                         
	// Глобальный обработчик "ПослеЗагрузкиОбъекта"
	Если мКонвертацияПослеЗагрузкиОбъекта = 1 Тогда
		Отказ = Шаблон("[Конвертация_ПослеЗагрузкиОбъекта(ОбъектБД, ИмяПравила)]");
		Если Число(Отказ) = 1 Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
                                
	// Локальный обработчик "ПослеЗагрузки"
	НомерСтроки = 0;
	Если мТаблицаПравилКонвертацииОбъектов.НайтиЗначение(ИмяПравила, НомерСтроки, "Код") = 1 Тогда
		мТаблицаПравилКонвертацииОбъектов.ПолучитьСтрокуПоНомеру(НомерСтроки);
		// Если мТаблицаПравилКонвертацииОбъектов.ЕстьОбработчикПослеЗагрузки = 1 Тогда
		Если мТаблицаПравилКонвертацииОбъектов.ПослеЗагрузки = 1 Тогда
			Отказ = Шаблон("[ПКО_ПослеЗагрузки_" + ИмяПравила + "(ОбъектБД, ИмяПравила, Объект)]");
			Если Число(Отказ) = 1 Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;                          

	ЗаписатьОбъект(ОбъектБД, ВрмУникальныйИдентификатор, ВрмТипИсточника, ВрмТипПриемника);
	
	Если ПустоеЗначение(ПометкаУдаления) = 1 Тогда
		Если ОбъектБД.ПометкаУдаления() = 1 Тогда	ОбъектБД.СнятьПометкуУдаления();	КонецЕсли;
	Иначе
		Если ОбъектБД.ПометкаУдаления() = 0 Тогда	ОбъектБД.Удалить(0);				КонецЕсли;
	КонецЕсли;	                                  
	
КонецПроцедуры		//	ЗагрузитьДокументV8()
                    
//--------------------------------------------------------------------------------------------------

Процедура ЗагрузитьОбъектV8(ВхДокументXML)

	Объект     = ВхДокументXML;

	ТипОбъекта = одАтрибут(Объект, "Строка", "Тип"); //Объект.ПолучитьАтрибут("Тип"); 
	ИмяПравила = одАтрибут(Объект, "Строка", "ИмяПравила"); //Объект.ПолучитьАтрибут("ИмяПравила");
	ВидОбъекта = ОтделитьРазделителем(ТипОбъекта, ".");
                                                
	// Глобальный обработчик "ПередЗагрузкойОбъекта"
	Если мКонвертацияПередЗагрузкойОбъекта = 1 Тогда
		Отказ = Шаблон("[Конвертация_ПередЗагрузкойОбъекта(ИмяПравила)]");
		Если Число(Отказ) = 1 Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	// Локальный обработчик "ПередЗагрузкой"
	НомерСтроки = 0;
	Если мТаблицаПравилКонвертацииОбъектов.НайтиЗначение(ИмяПравила, НомерСтроки, "Код") = 1 Тогда
		мТаблицаПравилКонвертацииОбъектов.ПолучитьСтрокуПоНомеру(НомерСтроки);
		// Если мТаблицаПравилКонвертацииОбъектов.ЕстьОбработчикПередЗагрузкой = 1 Тогда
		Если мТаблицаПравилКонвертацииОбъектов.ПередЗагрузкой = 1 Тогда
			Отказ = Шаблон("[ПКО_ПередЗагрузкой_" + ИмяПравила + "(ИмяПравила)]");
			Если Число(Отказ) = 1 Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;                          

	Если ТипОбъекта = "СправочникСсылка" Тогда
		ЗагрузитьОбъектСправочникаV8(Объект, ВидОбъекта, ИмяПравила);
	ИначеЕсли ТипОбъекта = "ДокументСсылка" Тогда
		ЗагрузитьДокументV8(Объект, ВидОбъекта, ИмяПравила);
	КонецЕсли;

КонецПроцедуры		//	ЗагрузитьОбъектV8()

Функция ПрочитатьИнформациюОРегистрацииОбъекта(ВхУзел)

	// Для ВрмИндексУзел = 1 По ВхВыборкаУзлов.КоличествоУзлов Цикл
	
	// // Присваиваем ПЕРЕКРЕСТНЫЕ значения переменным; РС симметричен.
	УникальныйИдентификаторПриемника = одАтрибут(ВхУзел, "Строка", "УникальныйИдентификаторИсточника");
	УникальныйИдентификаторИсточника = одАтрибут(ВхУзел, "Строка", "УникальныйИдентификаторПриемника");
	ТипПриемника                     = одАтрибут(ВхУзел, "Строка", "ТипИсточника");
	ТипИсточника                     = одАтрибут(ВхУзел, "Строка", "ТипПриемника");
	// ПустойНабор                      =  одАтрибут(ФайлОбмена, "Булево", "ПустойНабор");

	Попытка
		ВрмСсылка = ПолучитьСсылкуПоИдентификатору(УникальныйИдентификаторИсточника);
	Исключение
		
		Возврат 0;
		
	КонецПопытки;
	
	ЗаписатьРегистрСоответствий(УникальныйИдентификаторИсточника, УникальныйИдентификаторПриемника, ТипИсточника, ТипПриемника, 1);
	
	// // Получаем структуру свойств источника по типу источника.
	// Попытка
	// 	СтруктураСвойств = Менеджеры[Тип(ТипИсточника)];
	// Исключение
	// 	одПропустить(ФайлОбмена, "ИнформацияОРегистрацииОбъекта");
	// 	Возврат Неопределено;
	// КонецПопытки;
	
	// // Получаем ссылку источника по GUID.
	// УникальныйИдентификаторИсточника = СтруктураСвойств.Менеджер.ПолучитьСсылку(УникальныйИдентификаторИсточника);
	
	// // Если ссылка не получена, то записывать такой набор не следует.
	// Если Не ЗначениеЗаполнено(УникальныйИдентификаторИсточника) Тогда
	// 	одПропустить(ФайлОбмена, "ИнформацияОРегистрацииОбъекта");
	// 	Возврат Неопределено;
	// КонецЕсли;
	
	// НаборЗаписей = МенеджерРегистраСоответствийОбъектов.СоздатьНаборЗаписей();
	
	// // отбор для набора записей
	// НаборЗаписей.Отбор.УзелИнформационнойБазы.Установить(УзелОбменаЗагрузкаДанных);
	// НаборЗаписей.Отбор.УникальныйИдентификаторИсточника.Установить(УникальныйИдентификаторИсточника);
	// НаборЗаписей.Отбор.УникальныйИдентификаторПриемника.Установить(УникальныйИдентификаторПриемника);
	// НаборЗаписей.Отбор.ТипИсточника.Установить(ТипИсточника);
	// НаборЗаписей.Отбор.ТипПриемника.Установить(ТипПриемника);
	
	// Если Не ПустойНабор Тогда
		
	// 	// Добавляем одну запись в набор.
	// 	СтрокаНабора = НаборЗаписей.Добавить();
		
	// 	СтрокаНабора.УзелИнформационнойБазы           = УзелОбменаЗагрузкаДанных;
	// 	СтрокаНабора.УникальныйИдентификаторИсточника = УникальныйИдентификаторИсточника;
	// 	СтрокаНабора.УникальныйИдентификаторПриемника = УникальныйИдентификаторПриемника;
	// 	СтрокаНабора.ТипИсточника                     = ТипИсточника;
	// 	СтрокаНабора.ТипПриемника                     = ТипПриемника;
		
	// КонецЕсли;
	
	// // записываем набор записей
	// ЗаписатьОбъектВИБ(НаборЗаписей, "РегистрСведенийНаборЗаписей.СоответствияОбъектовИнформационныхБаз");
	
	// одПропустить(ФайлОбмена, "ИнформацияОРегистрацииОбъекта");
	
	// Возврат НаборЗаписей;
	
КонецФункции

Процедура ВыгрузитьЗаписьСоответствияОбъектовИнформационныхБаз(ВхУзел, СтрокаНабора, ПустойНабор)
	
	ВрмЗамер = НачатьЗамер("ВыгрузитьЗаписьСоответствияОбъектовИнформационныхБаз");

	ВрмПриемник = ЗаписатьПодчиненныйЭлемент(ВхУзел, "ИнформацияОРегистрацииОбъекта");
	
	УстановитьАтрибут(ВрмПриемник, "УникальныйИдентификаторИсточника", Строка(СтрокаНабора.id_src));
	УстановитьАтрибут(ВрмПриемник, "УникальныйИдентификаторПриемника",        СтрокаНабора.id_dst);
	УстановитьАтрибут(ВрмПриемник, "ТипИсточника",                            СтрокаНабора.type_src);
	УстановитьАтрибут(ВрмПриемник, "ТипПриемника",                            СтрокаНабора.type_dst);
	
	УстановитьАтрибут(ВрмПриемник, "ПустойНабор", ПустойНабор);

	ЗавершитьЗамер(ВрмЗамер);
	
КонецПроцедуры

Функция ВыполнитьВыгрузкуРегистраСопоставленияОбъектов(ВхУзел, ВрмНомерОтправленного)
	
	ВрмЗамер = НачатьЗамер("ВыполнитьВыгрузкуРегистраСопоставленияОбъектов");

	ВрмВозврат = РС_ВыбратьИзменения();

	Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмВыборкаИзменений = ВрмВозврат.Получить("Результат");

	Для ВрмИндексСтроки = 1 По ВрмВыборкаИзменений.КоличествоСтрок() Цикл
		
		ВрмВыборкаИзменений.ПолучитьСтрокуПоНомеру(ВрмИндексСтроки);

		ВыгрузитьЗаписьСоответствияОбъектовИнформационныхБаз(ВхУзел, ВрмВыборкаИзменений, 0);

	КонецЦикла;

	ЗавершитьЗамер(ВрмЗамер);

КонецФункции

Функция ПрочитатьДанныеПоОбмену(ВрмУзелДанныеПоОбмену, ВхСписокПараметры)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ВрмПолеИмяПланаОбмена           = одАтрибут(ВрмУзелДанныеПоОбмену, "Строка", "ПланОбмена"); //ВрмУзелДанныеПоОбмену.ПолучитьАтрибут("ПланОбмена");
	ВрмКодОтКого                    = одАтрибут(ВрмУзелДанныеПоОбмену, "Строка", "ОтКого"); //ВрмУзелДанныеПоОбмену.ПолучитьАтрибут("ОтКого");
	ВрмНомерСообщения           = одАтрибут(ВрмУзелДанныеПоОбмену, "Число" , "НомерИсходящегоСообщения");
	ВрмНомерПринятогоКорреспондентом  = одАтрибут(ВрмУзелДанныеПоОбмену, "Число", "НомерВходящегоСообщения"); //Число(ВрмУзелДанныеПоОбмену.ПолучитьАтрибут("НомерВходящегоСообщения"));
	ВрмУдалитьРегистрациюИзменений  = одАтрибут(ВрмУзелДанныеПоОбмену, "Булево" , "УдалитьРегистрациюИзменений");

	ВрмУзелОбменаИдентификатор = ВхСписокПараметры.Получить("id_remote");
	// ВерсияОтправителя            = ВрмУзелДанныеПоОбмену.ПолучитьАтрибут("ВерсияОтправителя");

	// проверка на правильность указания плана обмена в сообщении обмена.
	// Если ВрмПолеИмяПланаОбмена <> ВхСписокПараметры.Получить("ExchangePlan") Тогда
	// 	ВрмВозврат.Установить("ОписаниеОшибки", Шаблон("Не найден план обмена для загрузки данных. Код: [ВрмПолеИмяПланаОбмена]"));
	// 	Возврат ВрмВозврат;
	// КонецЕсли;

	// проверка на правильность указания узла получателя в сообщении обмена.
	Если ВрмКодОтКого <> ВрмУзелОбменаИдентификатор Тогда
		ВрмВозврат.Установить("ОписаниеОшибки", Шаблон("Не найден узел обмена для загрузки данных. Код: [ВрмКодОтКого]"));
		Возврат ВрмВозврат;
	КонецЕсли;
	
	ВрмНомерПринятого = ПолучитьНомерПринятого(ВрмУзелОбменаИдентификатор);
	
	Если ВрмНомерПринятого >= ВрмНомерСообщения Тогда // Номер сообщения меньше либо равен ранее принятому.

		// ВрмВозврат.Установить("ОписаниеОшибки", "Сообщение обмена было принято ранее");
		// Возврат ВрмВозврат;

	КонецЕсли;
	
	Если ВрмУдалитьРегистрациюИзменений = 1 Тогда // Удаляем регистрацию изменений.
		
		ВрмВозврат = УдалитьРегистрациюИзменений(ВрмУзелОбменаИдентификатор, ВрмНомерПринятогоКорреспондентом);

		Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда
			Возврат ВрмВозврат;
		КонецЕсли;
		
	КонецЕсли;
	
	// {Обработчик: ПослеПолученияИнформацииОбУзлахОбмена} Начало
	Если мКонвертацияПослеПолученияИнформацииОбУзлахОбмена = 1 Тогда

		Попытка
			Отказ = Шаблон("[Конвертация_ПослеПолученияИнформацииОбУзлахОбмена()]");
		Исключение
			ЗаписатьИнформациюОбОшибкеОбработчикиКонвертации(176, ОписаниеОшибки(), "ПослеПолученияИнформацииОбУзлахОбмена (конвертация)");
			Возврат ВрмВозврат;
		КонецПопытки;

	КонецЕсли;
	// {Обработчик: ПослеПолученияИнформацииОбУзлахОбмена} Окончание
	ВрмВозврат.Установить("НомерПринятогоКорреспондентом", ВрмНомерПринятогоКорреспондентом);
	ВрмВозврат.Установить("НомерСообщения", ВрмНомерСообщения);
	ВрмВозврат.Установить("СтатусВозврата", 1);
	Возврат ВрмВозврат;
	
КонецФункции

Процедура ВыполнитьВыгрузкуЗарегистрированныхДанных(document, ВхУзелОбменаИдентификатор, СтрокаСообщенияОбОшибке, ВхТаблицаПравилВыгрузкиИспользуемые, ВхПакетНомер)

	// Переменные-заглушки для поддержки механизма отладки кода обработчиков событий.
	Перем Отказ, ИмяПКО, ВыборкаДанных, ИсходящиеДанные;

	ВрмЗамер = НачатьЗамер("ВыполнитьВыгрузкуЗарегистрированныхДанных");
	
	// Глобальный обработчик "ПередПолучениемИзмененныхОбъектов"
	Если мКонвертацияПередПолучениемИзмененныхОбъектов = 1 Тогда

		Попытка
			Отказ = Шаблон("[Конвертация_ПередПолучениемИзмененныхОбъектов()]");
		Исключение
			ЗаписатьИнформациюОбОшибкеОбработчикиКонвертации(175, ОписаниеОшибки(),"ПередПолучениемИзмененныхОбъектов (конвертация)");
			ЗавершитьЗамер(ВрмЗамер);
			Возврат;
		КонецПопытки;

	КонецЕсли;

	ВрмТаблицаВыгружаемыхМетаданных = СоздатьОбъект("ТаблицаЗначений");
	ВхТаблицаПравилВыгрузкиИспользуемые.Выгрузить(ВрмТаблицаВыгружаемыхМетаданных, , , "Ид");
	
	// НачальнаяВыгрузкаДанных = ОбменДаннымиСервер.УстановленПризнакНачальнойВыгрузкиДанных(ЗаписьСообщения.Получатель);

	// ВЫБОРКА ИЗМЕНЕНИЙ
	ВыборкаИзменений = ВыбратьИзменения(ВхУзелОбменаИдентификатор, ВрмТаблицаВыгружаемыхМетаданных, ВхПакетНомер);

	// ВывестиСодержаниеТЗ(ВыборкаИзменений);
	
	ОбъектМетаданныхПредыдущий      = 0;
	ПравилоВыгрузкиДанныхПредыдущее = ПолучитьПустоеЗначение();
	ПравилоВыгрузкиДанных           = ПолучитьПустоеЗначение();
	НомерФайлаВыгрузки              = 0;
	СтрокаФайла                     = ПолучитьПустоеЗначение();
	ВыгружаетсяРегистр              = 0;
	ВыгружаютсяКонстанты            = 0;
	
	// Попытка
		КоличествоОбъектовКВыгрузке = ВыборкаИзменений.КоличествоСтрок();

		// 	УзелДляОбменаОбъект = УзелДляОбмена.ПолучитьОбъект();
		
		Для ВрмИндексСтрокиИзменений = 1 По ВыборкаИзменений.КоличествоСтрок() Цикл
							
			// 		Инкремент(ПолеСчетчикВыгруженныхОбъектов);
			// 		ОбменДаннымиСервер.РассчитатьПроцентВыгрузки(СчетчикВыгруженныхОбъектов(), КоличествоОбъектовКВыгрузке);
			ОбъектМетаданныхТекущий = ВыборкаИзменений.ПолучитьЗначение(ВрмИндексСтрокиИзменений, "TYPEID");
			ИдентификаторОбъектаВнутр = ВыборкаИзменений.ПолучитьЗначение(ВрмИндексСтрокиИзменений, "OBJID");
			
			Данные = ВыборкаИзменений.ПолучитьЗначение(ВрмИндексСтрокиИзменений, "Объект");
			//ВыборкаИзменений.Получить();
				
			ТипДанныхДляВыгрузки = ВыборкаИзменений.ПолучитьЗначение(ВрмИндексСтрокиИзменений, "DELETED");
				
			// Выгружается новый тип объекта метаданных.
			Если ОбъектМетаданныхПредыдущий <> ОбъектМетаданныхТекущий Тогда
					
				Если ОбъектМетаданныхПредыдущий <> 0 Тогда
					
					// {ОБРАБОТЧИК ПослеОбработки ПВД}
					Если ПравилоВыгрузкиДанныхПредыдущее.РазмерСписка() = 0 Тогда

					ИначеЕсли ПравилоВыгрузкиДанныхПредыдущее.Получить("ПослеОбработки") = 1 Тогда
						
						Попытка
							
							Отказ = Шаблон("[ПВД_ПослеОбработкиПравила_" + СокрЛП(ПравилоВыгрузкиДанныхПредыдущее.Получить("Код")) + "(ИмяПКО, Правило, ИсходящиеДанные)]");
							
						Исключение
							ЗаписатьИнформациюОбОшибкеОбработчикиПВД(32, ОписаниеОшибки(), ПравилоВыгрузкиДанныхПредыдущее.Имя, "ПослеОбработкиВыгрузкиДанных");
						КонецПопытки;
						
					КонецЕсли;
					// {ОБРАБОТЧИК ПослеОбработки ПВД}
					
				КонецЕсли;
				
				ОбъектМетаданныхПредыдущий = ОбъектМетаданныхТекущий;
				
				ВыгружаетсяРегистр = 0;
				ВыгружаютсяКонстанты = 0;
				
				// СтруктураДанных = МенеджерыДляПлановОбмена[ОбъектМетаданныхТекущий];
				
				// Если СтруктураДанных = Неопределено Тогда
					
				// 	ВыгружаютсяКонстанты = Метаданные.Константы.Содержит(ОбъектМетаданныхТекущий);
					
				// ИначеЕсли СтруктураДанных.ЭтоРегистр = Истина Тогда
					
				// 	ВыгружаетсяРегистр = Истина;
					
				// КонецЕсли;
				
				// Если ВыгружаютсяКонстанты Тогда
					
				// 	ПравилоВыгрузкиДанных = ТаблицаПравилВыгрузкиИспользуемые.Найти(Тип("КонстантыНабор"), "ОбъектВыборкиМетаданные");
					
				// Иначе
					ВрмИндексПравилоВыгрузкиДанных = 0;
					ВхТаблицаПравилВыгрузкиИспользуемые.НайтиЗначение(ОбъектМетаданныхТекущий, ВрмИндексПравилоВыгрузкиДанных, "Ид");
					ПравилоВыгрузкиДанных = ПолучитьСтрокуТаблицыСписком(ВхТаблицаПравилВыгрузкиИспользуемые, ВрмИндексПравилоВыгрузкиДанных);
					
				// КонецЕсли;
				
				ПравилоВыгрузкиДанныхПредыдущее = ПравилоВыгрузкиДанных;
				
				// {ОБРАБОТЧИК ПередОбработкой ПВД}
				ИсходящиеДанные = ПолучитьПустоеЗначение();
				
				Если ПравилоВыгрузкиДанных.РазмерСписка() = 0 Тогда

				ИначеЕсли ПравилоВыгрузкиДанных.Получить("ПередОбработкой") = 1 Тогда
					
					Попытка

						Отказ = Шаблон("[ПВД_ПередОбработкойПравила_" + СокрЛП(ПравилоВыгрузкиДанных.Получить("Код")) + "(ИмяПКО, Правило, ИсходящиеДанные, ВыборкаДанных)]");
						
					Исключение
						ЗаписатьИнформациюОбОшибкеОбработчикиПВД(31, ОписаниеОшибки(), ПравилоВыгрузкиДанных.Имя, "ПередОбработкойВыгрузкиДанных");
					КонецПопытки;
					
				КонецЕсли;
				// {ОБРАБОТЧИК ПередОбработкой ПВД}
					
			КонецЕсли;

			// Отрабатываем удаление объекта.
			Если ТипДанныхДляВыгрузки = "D" Тогда
					
				ОтработатьУдалениеОбъекта(document, Данные, ПравилоВыгрузкиДанных.Получить("ОбъектВыборки"));
				Продолжить;

			КонецЕсли;
				
		// 		// ВЫГРУЗКА ОБЪЕКТА
		// 		Если ВыгружаетсяРегистр Тогда
					
		// 			// выгрузка регистра
		// 			ВыгрузкаРегистра(Данные, ПравилоВыгрузкиДанных, ИсходящиеДанные, НеВыгружатьОбъектыПоСсылкам);
					
		// 		ИначеЕсли ВыгружаютсяКонстанты Тогда
					
		// 			// выгрузка набора констант
		// 			Свойства = Менеджеры[Тип("КонстантыНабор")];
					
		// 			ВыгрузитьНаборКонстант(ПравилоВыгрузкиДанных, Свойства, ИсходящиеДанные, ОбъектМетаданныхТекущий.Имя);
					
		// 		Иначе
					
				// выгрузка ссылочных типов
				ВыгрузкаОбъектаВыборки(document, Данные, ПравилоВыгрузкиДанных, ИсходящиеДанные, мНеВыгружатьОбъектыПоСсылкам);
					
		// 		КонецЕсли;
				
		КонецЦикла;

		Если ОбъектМетаданныхПредыдущий <> 0 Тогда
					
			// {ОБРАБОТЧИК ПослеОбработки ПВД}
			Если ПравилоВыгрузкиДанныхПредыдущее.РазмерСписка() = 0 Тогда

			ИначеЕсли ПравилоВыгрузкиДанныхПредыдущее.Получить("ПослеОбработки") = 1 Тогда
				
				Попытка
					
					Отказ = Шаблон("[ПВД_ПослеОбработкиПравила_" + СокрЛП(ПравилоВыгрузкиДанныхПредыдущее.Получить("Код")) + "(ИмяПКО, Правило, ИсходящиеДанные)]");
					
				Исключение
					ЗаписатьИнформациюОбОшибкеОбработчикиПВД(32, ОписаниеОшибки(), ПравилоВыгрузкиДанных.Имя, "ПослеОбработкиВыгрузкиДанных");
				КонецПопытки;
				
			КонецЕсли;
			// {ОБРАБОТЧИК ПослеОбработки ПВД}
			
		КонецЕсли;
		
	// Исключение
		
	// 	// ВызватьИсключение(НСтр("ru = 'Ошибка при отправке данных" + ": " + ОписаниеОшибки());
		
	// КонецПопытки
	ЗавершитьЗамер(ВрмЗамер);
	
КонецПроцедуры

Процедура ПроизвестиЧтениеДанных(ВхУзелФайлОбмена)
	
	СтрокаСообщенияОбОшибке = "";
	
	ВрмУзлыОбъект = ВхУзелФайлОбмена.ВыбратьУзлы("Объект");

	Для ВрмИндексУзелОбъект = 0 По ВрмУзлыОбъект.КоличествоУзлов - 1 Цикл
		
		ВрмУзелОбъект = ВрмУзлыОбъект.ПолучитьУзел(ВрмИндексУзелОбъект);
		ЗагрузитьОбъектV8(ВрмУзелОбъект);
		// ОбменДаннымиСервер.РассчитатьПроцентЗагрузки(СчетчикЗагруженныхОбъектов(), КоличествоОбъектовКЗагрузке, РазмерФайлаСообщенияОбмена);
		// ПоследнийОбъектЗагрузки = ПрочитатьОбъект();
			
		// ОбработатьОкончаниеЧтенияНовогоЭлемента(ПоследнийОбъектЗагрузки);

	КонецЦикла;
	
	ВрмУзлыНаборЗаписейРегистра = ВхУзелФайлОбмена.ВыбратьУзлы("НаборЗаписейРегистра");

	Для ВрмИндексУзелНаборЗаписейРегистра = 0 По ВрмУзлыНаборЗаписейРегистра.КоличествоУзлов - 1 Цикл
		
		// набор записей регистра
		// ПоследнийОбъектЗагрузки = ПрочитатьНаборЗаписейРегистра();
		
		// ОбработатьОкончаниеЧтенияНовогоЭлемента(ПоследнийОбъектЗагрузки);

	КонецЦикла;

	ВрмУзлыУдалениеОбъекта = ВхУзелФайлОбмена.ВыбратьУзлы("УдалениеОбъекта");

	Для ВрмИндексУзелУдалениеОбъекта = 0 По ВрмУзлыУдалениеОбъекта.КоличествоУзлов - 1 Цикл
		
		// набор записей регистра
		// ПоследнийОбъектЗагрузки = ПрочитатьНаборЗаписейРегистра();
		
		// ОбработатьОкончаниеЧтенияНовогоЭлемента(ПоследнийОбъектЗагрузки);

	КонецЦикла;

	
	ВрмУзлыИнформацияОРегистрацииОбъекта = ВхУзелФайлОбмена.ВыбратьУзлы("ИнформацияОРегистрацииОбъекта");

	Для ВрмИндексУзелИнформацияОРегистрацииОбъекта = 0 По ВрмУзлыИнформацияОРегистрацииОбъекта.КоличествоУзлов - 1 Цикл
		
		ВрмУзелИнформацияОРегистрацииОбъекта = ВрмУзлыИнформацияОРегистрацииОбъекта.ПолучитьУзел(ВрмИндексУзелИнформацияОРегистрацииОбъекта);
		// ЕстьИнформацияОРегистрацииОбъекта = Истина;
			
		ПоследнийОбъектЗагрузки = ПрочитатьИнформациюОРегистрацииОбъекта(ВрмУзелИнформацияОРегистрацииОбъекта);
		
		// ОбработатьОкончаниеЧтенияНовогоЭлемента(ПоследнийОбъектЗагрузки);
	КонецЦикла;

	ВрмУзлыКорректировкаИнформацииОРегистрацииОбъекта = ВхУзелФайлОбмена.ВыбратьУзлы("КорректировкаИнформацииОРегистрацииОбъекта");

	Для ВрмИндексУзелКорректировкаИнформацииОРегистрацииОбъекта = 0 По ВрмУзлыКорректировкаИнформацииОРегистрацииОбъекта.КоличествоУзлов - 1 Цикл
		
		// ЕстьКорректировкаИнформацииОРегистрацииОбъекта = Истина;
			
		// ПрочитатьКорректировкуИнформацииСопоставления();
	КонецЦикла;

	ВрмУзлыОбщиеДанныеУзлов = ВхУзелФайлОбмена.ВыбратьУзлы("ОбщиеДанныеУзлов");

	Для ВрмИндексУзелОбщиеДанныеУзлов = 0 По ВрмУзлыОбщиеДанныеУзлов.КоличествоУзлов - 1 Цикл
		
		// ПрочитатьОбщиеДанныеУзлов(ЧтениеСообщения);
	
	КонецЦикла;

	// Прерываем цикл чтения файла в случае возникновения ошибки загрузки.
	// Если ФлагОшибки() Тогда
	// 	ВызватьИсключение НСтр("ru = 'Возникли ошибки при загрузке данных.'");
	// КонецЕсли;
			
КонецПроцедуры

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция ВыполнитьВыгрузку(ВхУзелОбменаИдентификатор, ВхСписокПараметры, ВхИмяФайлаДанных = "")
	
	ВрмЗамер = НачатьЗамер("ВыполнитьВыгрузку");

	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмВозврат.Установить("СтатусВозврата", 0);
	ВрмВыгрузитьИнформациюСопоставления = 0;

	мСчетчикВыгруженныхОбъектов = 0;
	
	// Если ПустаяСтрока(ВхИмяФайлаДанных) = 1 Тогда
		
	// 	Если Форма.МодальныйРежим() = 0 Тогда
	// 		Предупреждение("Не указано имя файла данных!");
	// 	Иначе
	// 		Сообщить("Не указано имя файла данных!");
	// 	КонецЕсли;
	// 	Возврат;
		
	// КонецЕсли;

	// ВрмИмяФайлаПравил = ВхСписокПараметры.Получить("rules");
	// ВхИмяФайлаДанных = ВрмИмяФайлаПравил + ".xml";


	// Инициализация правил
	// ИнициализацияПравилВыгрузки();
	// ИнициализацияПравилКонвертацииОбъектов();

	// Инициализация таблицы настройки параметров
	ИнициализацияТаблицыНастройкиПараметров();
	
	ТекущийУровеньВложенностиВыгрузитьПоПравилу = 0;
	
	ИнициализироватьМенеджерыИСообщения();
	
	ВывестиСообщение("Начало выгрузки:   " + ТекущаяДата() + " " + ТекущееВремя());
	
	Если ТипЗначенияСтр(Параметры) = "ТаблицаЗначений" Тогда
		
        Параметры.УдалитьСтроки();
		Параметры.НоваяСтрока();
		Параметры.ТекущаяСтрока(Параметры.КоличествоСтрок());
	    
	КонецЕсли;
	
	// Попытка
	// 	DOMDocument = CreateObject("Msxml2.DOMDocument.4.0");
	// Исключение
	// 	DOMDocument = CreateObject("Msxml2.DOMDocument");
	// КонецПопытки;
	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	
	DOMDocument = ВрмПарсерХМЛ.СоздатьДокумент();
	DOMDocument.Кодировка = "UTF-8";
	//DOMDocument = ПолучитьCOMОбъект("AddIn.XMLParser");;
	
	rootNode = DOMDocument.createNode(1, "ФайлОбмена", "");
	DOMDocument.appendChild(rootNode);

	// ИнициализацияФайлаОбмена(ВрмПарсерХМЛ, DOMDocument, rootNode, ВрмИмяФайлаПравил);    
	ИнициализацияФайлаОбмена(ВрмПарсерХМЛ, DOMDocument, rootNode);
	                                   
	// Сохраняем текущие настройки отбора 
	// СохранитьНастройкиОтбора();

	// Устанавливат значения парамтров в структуре Параметры 
	// по таблице мТаблицаНастройкиПараметров
    // мТаблицаНастройкиПараметров.ВыбратьСтроки();
	// Пока мТаблицаНастройкиПараметров.ПолучитьСтроку() = 1 Цикл
	// 	Параметры.УстановитьЗначение(1, СокрЛП(мТаблицаНастройкиПараметров.Имя), мТаблицаНастройкиПараметров.Значение);
	// КонецЦикла;
	
	// Глобальный обработчик "ПередВыгрузкойДанных"
	Если ПустоеЗначение(мКонвертация.Получить("ПередВыгрузкойДанных")) = 0 Тогда
		
		Попытка
			Отказ = Шаблон("[Конвертация_ПередВыгрузкойДанных()]");
		Исключение
			ЗаписатьИнформациюОбОшибкеОбработчикиКонвертации(62, ОписаниеОшибки(),"ПередВыгрузкойДанных (конвертация)");
			Отказ = 1;
		КонецПопытки;

		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьВедениеПротоколаОбмена();
			ЗавершитьЗамер(ВрмЗамер);
			Возврат ВрмВозврат;
			
		КонецЕсли;
		
	КонецЕсли;
	
	ВрмНомерПринятого = ПолучитьНомерПринятого(ВхУзелОбменаИдентификатор);
	ВрмНомерОтправленного = ПолучитьНомерОтправленного(ВхУзелОбменаИдентификатор) + ?(ВрмВыгрузитьИнформациюСопоставления = 1, 2, 1);
	
	ЗаписатьДанныеПоОбмену(DOMDocument, rootNode, ВхСписокПараметры, ВрмНомерПринятого, ВрмНомерОтправленного);

	// ВЫПОЛНЯЕМ ВЫГРУЗКУ РЕГИСТРА СОПОСТАВЛЕНИЯ
	ВыполнитьВыгрузкуРегистраСопоставленияОбъектов(rootNode, ВрмНомерОтправленного);

	// выгружаем измененные
	//
	// ОбработатьПравилаВыгрузки();

	ВрмТаблицаМетаданные = мНастройкиОбмена.Получить("Метаданные");

	ВрмТаблицаПравилВыгрузкиИспользуемые = СоздатьОбъект("ТаблицаЗначений");
	ВрмТаблицаПравилВыгрузкиИспользуемые.Загрузить(мТаблицаПравилВыгрузки);
	ВрмТаблицаПравилВыгрузкиИспользуемые.НоваяКолонка("Ид", "Число");
	ВрмТаблицаПравилВыгрузкиИспользуемые.УдалитьКолонку("НомерГруппы");
	ВрмТаблицаПравилВыгрузкиИспользуемые.УдалитьКолонку("Отбор");
	ВрмТаблицаПравилВыгрузкиИспользуемые.УдалитьКолонку("Комментарий");
	ВрмТаблицаПравилВыгрузкиИспользуемые.УдалитьКолонку("Описание");

	ВрмСписокУдаляемые = СоздатьОбъект("СписокЗначений");
	Для ВрмИндексПравила = 1 По ВрмТаблицаПравилВыгрузкиИспользуемые.КоличествоСтрок() Цикл
		Если ВрмТаблицаПравилВыгрузкиИспользуемые.ПолучитьЗначение(ВрмИндексПравила, "Включить") = 0 Тогда
			ВрмСписокУдаляемые.Установить(ВрмИндексПравила, ВрмИндексПравила);
			Продолжить;
		ИначеЕсли ВрмТаблицаПравилВыгрузкиИспользуемые.ПолучитьЗначение(ВрмИндексПравила, "ЭтоГруппа") = 1 Тогда
			ВрмСписокУдаляемые.Установить(ВрмИндексПравила, ВрмИндексПравила);
			Продолжить;
		КонецЕсли;

		ВрмСтрокаМетаданныеПолноеИмя = СтрЗаменить(ВрмТаблицаПравилВыгрузкиИспользуемые.ПолучитьЗначение(ВрмИндексПравила, "ОбъектВыборки"), "Ссылка", "");

		ВрмИндексМетаданные = 0;
		Если ВрмТаблицаМетаданные.НайтиЗначение(ВрмСтрокаМетаданныеПолноеИмя, ВрмИндексМетаданные, "ПолноеИмя") = 1 Тогда
			ВрмЗначение = ВрмТаблицаМетаданные.ПолучитьЗначение(ВрмИндексМетаданные, "Ид");
			ВрмТаблицаПравилВыгрузкиИспользуемые.УстановитьЗначение(ВрмИндексПравила, "Ид", ВрмЗначение);
			//Сообщить("[" + ВрмСтрокаМетаданныеПолноеИмя + "][" + ВрмЗначение + "]");
		Иначе
			ВрмВозврат.Установить("ОписаниеОшибки", "Ошибка метаданные [" + ВрмСтрокаМетаданныеПолноеИмя + "] не найдены");
			ЗавершитьЗамер(ВрмЗамер);
			Возврат ВрмВозврат;
			//Сообщить("Ошибка метаданные [" + ВрмСтрокаМетаданныеПолноеИмя + "] не найдены");
		КонецЕсли;

	КонецЦикла;
	ВрмСписокУдаляемые.Сортировать(1);
	Для ВрмИндексЭлементаСпискаУдаляемых = 1 По ВрмСписокУдаляемые.РазмерСписка() Цикл
		ВрмТаблицаПравилВыгрузкиИспользуемые.УдалитьСтроку(ВрмСписокУдаляемые.ПолучитьЗначение(ВрмИндексЭлементаСпискаУдаляемых));
	КонецЦикла;
	// ВЫПОЛНЯЕМ ВЫГРУЗКУ ЗАРЕГИСТРИРОВАННЫХ ДАННЫХ
	// ЗаписьXML = Новый ЗаписьXML;
	// ЗаписьXML.УстановитьСтроку();
	// ЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();
	// ЗаписьСообщения.НачатьЗапись(ЗаписьXML, УзелДляОбмена);

	СтрокаСообщенияОбОшибке = "";

	// Попытка
	ВыполнитьВыгрузкуЗарегистрированныхДанных(DOMDocument, ВхУзелОбменаИдентификатор, СтрокаСообщенияОбОшибке, ВрмТаблицаПравилВыгрузкиИспользуемые, ВрмНомерОтправленного);
	// Исключение
	// 	Отказ = 1;
	// 	//ЗаписатьВПротоколВыполнения(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	// 	ЗаписатьВПротоколВыполнения(ОписаниеОшибки());
	// КонецПопытки;

	
	// Глобальный обработчик "ПослеВыгрузкиДанных"
	Если мКонвертацияПослеВыгрузкиДанных = 1 Тогда

		Попытка
			Отказ = Шаблон("[Конвертация_ПослеВыгрузкиДанных()]");
		Исключение
			ЗаписатьИнформациюОбОшибкеОбработчикиКонвертации(63, ОписаниеОшибки(),"ПослеВыгрузкиДанных (конвертация)");
			Отказ = 1;
		КонецПопытки;

		Если Число(Отказ) = 1 Тогда
			
			ЗавершитьВедениеПротоколаОбмена();
			ЗавершитьЗамер(ВрмЗамер);
			Возврат ВрмВозврат;
			
		КонецЕсли;
		
	КонецЕсли;

	DOMDocument.save(ВхИмяФайлаДанных);

	Если Отказ = 1 Тогда
	// 	ЗаписьСообщения.ПрерватьЗапись();
	Иначе
	// 	ЗаписьСообщения.ЗакончитьЗапись();
		ОбновитьНомерОтправленного(ВхУзелОбменаИдентификатор, ВрмНомерОтправленного);
		РС_ОбновитьНомерОтправленного(ВрмНомерОтправленного);
	КонецЕсли;
	
	// ЗаписьXML.Закрыть();
	// ЗаписьXML = Неопределено;

	//УстановитьНомерОтправленного(ВхУзелОбменаИдентификатор, ВрмНомерОтправленного);
	
	DOMDocument = 0;
	ВрмПарсерХМЛ = 0;

	ВрмВозврат.Установить("СтатусВозврата", 1);

	ВывестиСообщение("Выгружено объектов:   " + мСчетчикВыгруженныхОбъектов);
	
	ВывестиСообщение("Окончание выгрузки:   " + ТекущаяДата() + " " + ТекущееВремя());

	ЗавершитьЗамер(ВрмЗамер);
	Возврат ВрмВозврат;

КонецФункции // ВыполнитьВыгрузку()


Функция одПолучитьЗначениеПоСтроке(ВхЗначение, ВхТипВид)

	Значение = ПолучитьПустоеЗначение();
	ВрмТип = Лев(ВхТипВид, Найти(ВхТипВид, ".") - 1);
	Вид = ОтделитьРазделителем(ВхТипВид, ".");

	Если	(ВрмТип = "ПланСчетовСсылка")
					ИЛИ (ВрмТип = "СчетСсылка") Тогда
		
		Значение	=	СокрЛП(ВхЗначение);
		ПланСчетов = ?(ПустоеЗначение(Вид)=1, ОсновнойПланСчетов(), ПланыСчетов.ЗначениеПоИдентификатору(Вид));
		Если ПустоеЗначение(ПланСчетов)=1 Тогда
			ЗаписатьОшибку("Неверный вид счета " + Вид);
			Возврат("");
		КонецЕсли;
		Если ПустоеЗначение(Значение) = 1 Тогда Возврат("") КонецЕсли;
		Счет		=	СоздатьОбъект("Счет"); 
		Счет.ИспользоватьПланСчетов(ПланСчетов);
		Счет.НайтиПоКоду(Значение);
		Значение	=	Счет.ТекущийСчет();
	
	ИначеЕсли	ВрмТип = "ПеречислениеСсылка"	Тогда
		
		Значение	=	СокрЛП(ВхЗначение);
		ОбъектМД	=	Метаданные.Перечисление(Вид);
		Если ОбъектМД.Выбран()=0 Тогда
			ЗаписатьОшибку("Неверный вид перечисления - " + Вид);
			Возврат("");
		КонецЕсли;
		
		Если ПустоеЗначение(Значение) = 1 Тогда Возврат("") КонецЕсли;
		
		ВидПеречисления	=	Перечисление.ПолучитьАтрибут(Вид);
		СтрЗначение		=	Значение;
		
		// поиск по идентификатору
		Значение		=	ВидПеречисления.ЗначениеПоИдентификатору(СтрЗначение);
		
		Если ПустоеЗначение(Значение) = 0 Тогда Возврат(Значение) КонецЕсли;

		// поиск по синониму
		Для СчЗнач = 1 По ОбъектМД.Значение() Цикл
			ЗначениеМД	=	ОбъектМД.Значение(СчЗнач);
			Если СтрЗначение = ЗначениеМД.Представление() Тогда
				Возврат	ВидПеречисления.ЗначениеПоИдентификатору(ЗначениеМД.Идентификатор);
			КонецЕсли;
		КонецЦикла;
		
		Если Число(СтрЗначение) = 0 Тогда
			ЗаписатьОшибку("Неверное значение перечисления " + Вид + "." + СтрЗначение);
			Возврат("");
		КонецЕсли;
		
		// поиск по порядковому номеру
		Значение		=	ВидПеречисления.ЗначениеПоНомеру(СтрЗначение);
	КонецЕсли;
	
	Возврат Значение;

КонецФункции

Процедура ПолучитьЗначенияПредопределенныхДанных(Знач ПКО)
	
	ПКО.ЗначенияПредопределенныхДанных = СоздатьОбъект("СписокЗначений");
	ВрмЭлементы = ПКО.ЗначенияПредопределенныхДанныхПрочитанные;

	Для ВрмИндекс = 1 По ВрмЭлементы.РазмерСписка() Цикл
		ВрмКлюч = "";
		ВрмЗначение = ВрмЭлементы.ПолучитьЗначение(ВрмИндекс, ВрмКлюч);
		ПКО.ЗначенияПредопределенныхДанных.ДобавитьЗначение(одПолучитьЗначениеПоСтроке(ВрмКлюч, ПКО.Источник), ВрмЗначение);
		
	КонецЦикла;
	
КонецПроцедуры

// возвращает структуру правил обмена.
Функция ПолучитьСтруктуруПравилОбмена(ВхИсточник)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	ЗагрузитьПравилаОбмена(ВхИсточник, "XMLФайл");
	
	Если ФлагОшибки() = 1 Тогда
		Возврат ВрмВозврат;
	КонецЕсли;
	
	// Если РежимОбмена = "Загрузка" Тогда
	// 	ТаблицаРеквизитовРегистрацииОбъектов = Неопределено;
	// Иначе
	// 	// Получаем таблицу реквизитов регистрации для механизма выборочной регистрации объектов.
	// 	ТаблицаРеквизитовРегистрацииОбъектов = ПолучитьТаблицуРеквизитовРегистрацииОбъектов();
	// КонецЕсли;
	
	// сохраняем запросы
	ЗапросыДляСохранения = СоздатьОбъект("СписокЗначений");
	
	// Для Каждого ЭлементСтруктуры Из Запросы Цикл
		
	// 	ЗапросыДляСохранения.Установить(ЭлементСтруктуры.Ключ, ЭлементСтруктуры.Значение.Текст);
		
	// КонецЦикла;
	
	// сохраняем параметры
	ПараметрыДляСохранения = СоздатьОбъект("СписокЗначений");
	
	// Для Каждого ЭлементСтруктуры Из Параметры Цикл
		
	// 	ПараметрыДляСохранения.Вставить(ЭлементСтруктуры.Ключ, Неопределено);
		
	// КонецЦикла;
	
	СтруктураПравилОбмена = СоздатьОбъект("СписокЗначений");
	
	// СтруктураПравилОбмена.Установить("ВерсияФорматаХраненияПравил", ВерсияФорматаХраненияПравилОбмена());
	
	СтруктураПравилОбмена.Установить("Конвертация", мКонвертация);
	
	СтруктураПравилОбмена.Установить("ТаблицаНастройкиПараметров", мТаблицаНастройкиПараметров);
	СтруктураПравилОбмена.Установить("ТаблицаПравилВыгрузки",      мТаблицаПравилВыгрузки);
	СтруктураПравилОбмена.Установить("ТаблицаПравилКонвертации",   мТаблицаПравилКонвертацииОбъектов);

	СтруктураПравилОбмена.Установить("Алгоритмы", мАлгоритмы);
	СтруктураПравилОбмена.Установить("Параметры", Параметры); //ПараметрыДляСохранения);
	СтруктураПравилОбмена.Установить("Запросы",   ЗапросыДляСохранения);
	
	СтруктураПравилОбмена.Установить("XMLПравила",              мXMLПравила);
	// СтруктураПравилОбмена.Установить("СтрокаТиповДляПриемника", СтрокаТиповДляПриемника);
	
	// СтруктураПравилОбмена.Установить("ПравилаВыборочнойРегистрацииОбъектов", ТаблицаРеквизитовРегистрацииОбъектов);

	ЗначениеВСтрокуВнутр(СтруктураПравилОбмена);
	
	ВрмВозврат.Установить("СтатусВозврата", 1);
	ВрмВозврат.Установить("Результат", СтруктураПравилОбмена);
	Возврат ВрмВозврат;
	
КонецФункции

// Восстанавливает правила из внутреннего формата.
//
// Параметры:
// 
Функция ВосстановитьПравилаИзВнутреннегоФормата(ВхИсточник)
	
	ВрмЗамер = НачатьЗамер("ВосстановитьПравилаИзВнутреннегоФормата");

	ВрмВозврат = СоздатьОбъект("СписокЗначений");

	Если ТипЗначенияСтр(ВхИсточник) <> "СписокЗначений" Тогда
		ВрмВозврат.Установить("ОписаниеОшибки", "Формат хранения правил обмена не соответствует ожидаемому.
				|Требуется выполнить загрузку правил обмена повторно.");

		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;
	
	СтруктураПравил = ВхИсточник;
	
	// Выполняем проверку на версию формата хранения правил обмена.
	// ВерсияФорматаХраненияПравил = Неопределено;
	// СтруктураПравил.Свойство("ВерсияФорматаХраненияПравил", ВерсияФорматаХраненияПравил);
	// Если ВерсияФорматаХраненияПравил <> ВерсияФорматаХраненияПравилОбмена() Тогда
	// 	ВызватьИсключение НСтр("ru = 'Версия формата хранения правил обмена не соответствует ожидаемой.
	// 		|Требуется выполнить загрузку правил обмена повторно.'");
	// КонецЕсли;
	
	мКонвертация                = СтруктураПравил.Получить("Конвертация");
	мТаблицаПравилВыгрузки      = СтруктураПравил.Получить("ТаблицаПравилВыгрузки");
	мТаблицаПравилКонвертацииОбъектов   = СтруктураПравил.Получить("ТаблицаПравилКонвертации");
	мТаблицаНастройкиПараметров = СтруктураПравил.Получить("ТаблицаНастройкиПараметров");
	
	мАлгоритмы                  = СтруктураПравил.Получить("Алгоритмы");
	ЗапросыДляВосстановления   = СтруктураПравил.Получить("Запросы");
	Параметры                  = СтруктураПравил.Получить("Параметры");
	
	мXMLПравила                = СтруктураПравил.Получить("XMLПравила");
	// СтрокаТиповДляПриемника   = СтруктураПравил.Получить("СтрокаТиповДляПриемника");
	
	// ЕстьГлобальныйОбработчикПередВыгрузкойОбъекта    = Не ПустаяСтрока(мКонвертация.ПередВыгрузкойОбъекта);
	// ЕстьГлобальныйОбработчикПослеВыгрузкиОбъекта     = Не ПустаяСтрока(мКонвертация.ПослеВыгрузкиОбъекта);
	// ЕстьГлобальныйОбработчикПередЗагрузкойОбъекта    = Не ПустаяСтрока(мКонвертация.ПередЗагрузкойОбъекта);
	// ЕстьГлобальныйОбработчикПослеЗагрузкиОбъекта     = Не ПустаяСтрока(мКонвертация.ПослеЗагрузкиОбъекта);
	// ЕстьГлобальныйОбработчикПередКонвертациейОбъекта = Не ПустаяСтрока(мКонвертация.ПередКонвертациейОбъекта);

	// Восстанавливаем запросы
	// Запросы.Очистить();
	// Для Каждого ЭлементСтруктуры Из ЗапросыДляВосстановления Цикл
	// 	Запрос = Новый Запрос(ЭлементСтруктуры.Значение);
	// 	Запросы.Вставить(ЭлементСтруктуры.Ключ, Запрос);
	// КонецЦикла;
	
	ИнициализироватьМенеджерыИСообщения();
	
	// Правила.Очистить();
	
	Для ВрмИндекс = 1 По мТаблицаПравилКонвертацииОбъектов.КоличествоСтрок() Цикл
		
		мТаблицаПравилКонвертацииОбъектов.ПолучитьСтрокуПоНомеру(ВрмИндекс);

		Если мРежимОбмена = "Выгрузка" Тогда
			
			ПолучитьЗначенияПредопределенныхДанных(мТаблицаПравилКонвертацииОбъектов);
			
		КонецЕсли;
		
	// 	Правила.Вставить(СтрокаТаблицы.Имя, СтрокаТаблицы);
		
	// 	Если мРежимОбмена = "Выгрузка" И СтрокаТаблицы.Источник <> Неопределено Тогда
			
	// 		Попытка
	// 			Если ТипЗнч(СтрокаТаблицы.Источник) = ТипСтрока Тогда
	// 				Менеджеры[Тип(СтрокаТаблицы.Источник)].ПКО = СтрокаТаблицы;
	// 			Иначе
	// 				Менеджеры[СтрокаТаблицы.Источник].ПКО = СтрокаТаблицы;
	// 			КонецЕсли;
	// 		Исключение
	// 			ЗаписатьИнформациюОбОшибкеВПротокол(11, ОписаниеОшибки(), Строка(СтрокаТаблицы.Источник));
	// 		КонецПопытки;
			
	// 	КонецЕсли;
		
	КонецЦикла;
	
	ВрмВозврат.Установить("СтатусВозврата", 1);

	ЗавершитьЗамер(ВрмЗамер);
	Возврат ВрмВозврат;
	
КонецФункции

Функция ВыполнитьВыгрузкуДанных(ВхУзелОбменаИдентификатор, ВхСписокПараметры)
	
	ВрмЗамер = НачатьЗамер("ВыполнитьВыгрузкуДанных");

	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмВозврат.Установить("СтатусВозврата", 0);

	ПолеСтрокаСообщенияОбОшибке = "";

	ВрмИнфо = ПолучитьCOMОбъект("AddIn.V7SysInfo");
	ВрмИдСообщения = ВрмИнфо.СоздатьGUID();
	ВрмИнфо = ПолучитьПустоеЗначение();

	мИмяФайлаРегистрСоответствия = Шаблон("[мКаталогОбмена][ВхУзелОбменаИдентификатор]\exchange.sqlite3");
	// мИмяФайлаИндексаРегистрСоответствия = Шаблон("[мКаталогОбмена][ВхУзелОбменаИдентификатор]\ref7ref8.cdx");

	ВрмПутьКаталогИсходящихСообщений = Шаблон("[мКаталогОбмена][ВхУзелОбменаИдентификатор]\Out\");
	ВрмПутьКаталогФайла = Шаблон("[ВрмПутьКаталогИсходящихСообщений][ВрмИдСообщения]\");
	ВрмПутьКаталогСообщения = Шаблон("[ВрмПутьКаталогФайла]data\");
	
	ВрмПутьФайлСообщения = Шаблон("[ВрмПутьКаталогСообщения]Message{[ВрмИдСообщения]}.xml");
	
	Если ФС.СуществуетФайл(ВрмПутьКаталогИсходящихСообщений) = 0 Тогда
		ФС.СоздатьКаталог(ВрмПутьКаталогИсходящихСообщений);
	КонецЕсли;

	Если ФС.СуществуетФайл(ВрмПутьКаталогФайла) = 0 Тогда
		ФС.СоздатьКаталог(ВрмПутьКаталогФайла);
	КонецЕсли;

	Если ФС.СуществуетФайл(ВрмПутьКаталогСообщения) = 0 Тогда
		ФС.СоздатьКаталог(ВрмПутьКаталогСообщения);
	КонецЕсли;

	ИнициализироватьВедениеПротоколаОбмена(ВхУзелОбменаИдентификатор);

	ВрмПравилаЗачитанные = ЗначениеИзСтрокиВнутр(ВхСписокПараметры.Получить("ПравилаЗачитанные"));

	ВрмВозврат = ВосстановитьПравилаИзВнутреннегоФормата(ВрмПравилаЗачитанные);
	Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	// ВЫГРУЗКА ДАННЫХ
	// Попытка
		ВрмВозврат = ВыполнитьВыгрузку(ВхУзелОбменаИдентификатор, ВхСписокПараметры, ВрмПутьФайлСообщения);
	// Исключение
	// 	// ЗаписатьВПротоколВыполнения(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	// 	ЗавершитьВедениеПротоколаОбмена();
	// 	// ФайлОбмена = Неопределено;
	// 	// ПолеВыгруженныеПоСсылкеОбъекты = Неопределено;
	// 	// ПолеСозданныеПриВыгрузкеОбъекты = Неопределено;
	// 	// ПолеВыгружаемыеПоСсылкеОбъектыМетаданных = Неопределено;
	// 	Возврат ВрмВозврат;

	// КонецПопытки;

	ВрмВозврат = ОтправитьДанные(ВхУзелОбменаИдентификатор, ВхСписокПараметры, ВрмПутьФайлСообщения);
	
	ЗавершитьВедениеПротоколаОбмена();

	ЗавершитьЗамер(ВрмЗамер);
	Возврат ВрмВозврат;

КонецФункции // ВыполнитьВыгрузкуДанных()
 
//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Функция СоздатьЗапрос(ОбъектВыборки, ТабОтбор)  
	
	ПрефиксЗапроса    = "Обрабатывать Все; "; 
	ПрефиксЗапросаДок = "ОбрабатыватьДокументы Все; ";
	
	Если Найти(ОбъектВыборки, "Справочник.") = 1 Тогда 
		стрТекущий = ".ТекущийЭлемент";  
	Иначе                                
		стрТекущий = ".ТекущийДокумент";  
	КонецЕсли;
	
	ТекстЗапроса = "ПеремОбъект = " +  ОбъектВыборки +  стрТекущий + ";";

	ТабОтбор.ВыбратьСтроки();		   
	Пока ТабОтбор.ПолучитьСтроку() = 1 Цикл   
		Если (ТабОтбор.ПолеОтбора = "ТекущийЭлемент") ИЛИ (ТабОтбор.ПолеОтбора = "ТекущийДокумент") Тогда
			Продолжить;
		КонецЕсли;
		Если (ТабОтбор.Использовать = 1) ИЛИ (ПустаяСтрока(ТабОтбор.ПолеОтбора) = 1) Тогда
			Продолжить;
		КонецЕсли;
                                                   
		Если (ТабОтбор.Объект = "ПометкаУдаления") Тогда
			Если ТабОтбор.Значение = 0 Тогда
				ПрефиксЗапроса = "Обрабатывать НеПомеченныеНаУдаление; ";
			Иначе	                                                          
				ПрефиксЗапроса = "Обрабатывать ПомеченныеНаУдаление; ";
			КонецЕсли;   
			Продолжить;
		КонецЕсли;

		Если (ТабОтбор.Объект = "Проведен") Тогда
			Если ТабОтбор.Значение = 0 Тогда
				ПрефиксЗапросаДок = "ОбрабатыватьДокументы Непроведенные; ";
			Иначе	                                                          
				ПрефиксЗапросаДок = "ОбрабатыватьДокументы Проведенные; ";
			КонецЕсли; 
			Продолжить;
		КонецЕсли;
		
		ТекстЗапроса = ТекстЗапроса + " Перем" + ТабОтбор.НомерСтроки +" = " +  ОбъектВыборки + "." + ТабОтбор.ПолеОтбора + ";";//" Группировка ПеремОбъект; Без Итогов;";
	КонецЦикла;

	ТекстЗапроса = ТекстЗапроса + " Группировка ПеремОбъект;";    
	
	ТабОтбор.ВыбратьСтроки();		   
	Пока ТабОтбор.ПолучитьСтроку() = 1 Цикл
		ЗначенияДляОтбора[ТабОтбор.НомерСтроки] = ТабОтбор.Значение; 
		Если (ТабОтбор.Использовать = 1) ИЛИ (ПустаяСтрока(ТабОтбор.ПолеОтбора) = 1) Тогда
			Продолжить;
		КонецЕсли;
		
		Если (ТабОтбор.ПолеОтбора = "ТекущийЭлемент") ИЛИ (ТабОтбор.ПолеОтбора = "ТекущийДокумент") Тогда
			ИмяПеременной = "ПеремОбъект";   
		ИначеЕсли (ТабОтбор.Объект = "ПометкаУдаления") ИЛИ (ТабОтбор.Объект = "Проведен") Тогда	
			Продолжить;
		Иначе	                          
			ИмяПеременной = "Перем" + ТабОтбор.НомерСтроки;
		КонецЕсли;                                                 
		Если ТабОтбор.Условие = "НЕ В" Тогда                                                                                                   
			ТекстЗапроса = ТекстЗапроса + "Условие (НЕ (" + ИмяПеременной + " В  ЗначенияДляОтбора[" + ТабОтбор.НомерСтроки + "]));";
		Иначе    
			ТекстЗапроса = ТекстЗапроса + "Условие (" + ИмяПеременной + " "+ ТабОтбор.Условие + " ЗначенияДляОтбора[" + ТабОтбор.НомерСтроки + "]);";
		КонецЕсли;
	КонецЦикла;                 
	                     
	Если Найти(ОбъектВыборки, "Документ.") = 1 Тогда 
		ТекстЗапроса = ПрефиксЗапроса + ПрефиксЗапросаДок + ТекстЗапроса;  
	Иначе                                
		ТекстЗапроса = ПрефиксЗапроса + ТекстЗапроса;  
	КонецЕсли;
                              
	Возврат ТекстЗапроса;
	
КонецФункции

//******************************************************************************
//
//
// Параметры:
//
// Возвращаемое значение:
// 
// Описание:
//
Процедура Выгрузить(ВхИмяФайлаПравил, ВхИмяФайлаДанных)

	ВыполнитьВыгрузкуДанных(ВхИмяФайлаПравил, ВхИмяФайлаДанных);
	
	Если Форма.МодальныйРежим() = 0 Тогда
		Предупреждение("Выгрузка данных завершена.");
	Иначе
		Сообщить("Выгрузка данных завершена.");
	КонецЕсли;
	
	Форма.Параметр = СписокОшибок;
	
КонецПроцедуры // Выгрузить()

Функция ВыполнитьЗагрузку(ВхИмяФайла, ВхУзелОбменаИдентификатор, ВхСписокПараметры, ВхАнализДанных = 0)

	ВрмЗамер = НачатьЗамер("ВыполнитьЗагрузку");

	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	
	// мРежимОбмена = "Загрузка";

	ПолеСтрокаСообщенияОбОшибке = "";
	// ПолеСостояниеОбменаДанными = Неопределено;
	// ПолеРезультатВыполненияОбмена = Неопределено;
	// ПолеСоответствиеТиповДанныхДляЗагрузки = Неопределено;
	ПолеСчетчикЗагруженныхОбъектов = 0;
	ПолеДокументыДляОтложенногоПроведения = ПолучитьПустоеЗначение();
	ПолеОбъектыДляОтложеннойЗаписи = ПолучитьПустоеЗначение();
	// СоответствиеДокументовДляОтложенногоПроведения = Неопределено;
	// ПолеСвойстваУзлаПланаОбмена = Неопределено;
	// ПолеВерсияФорматаВходящегоСообщенияОбмена = Неопределено;
	// ЕстьКорректировкаИнформацииОРегистрацииОбъекта = Ложь;
	// ЕстьИнформацияОРегистрацииОбъекта = Ложь;
	
	// ГлобальныйСтекНеЗаписанныхОбъектов = Новый Соответствие;
	НомерПоследнегоПоискаПоСсылке = 0;
	
	ИнициализироватьМенеджерыИСообщения();
	
	УстановитьФлагОшибки(0);
	
	// ИнициализироватьКомментарииПриВыгрузкеИЗагрузкеДанных();
	
	ИнициализироватьВедениеПротоколаОбмена(ВхУзелОбменаИдентификатор);
	// ИнициализацияПравилКонвертацииОбъектов();
	// ИнформацияОПользовательскихПоляхПоискаПриЗагрузкеДанных = Новый Соответствие;
	
	// СоответствиеДопПараметровПоиска = Новый Соответствие;
	// СоответствиеПравилКонвертации = Новый Соответствие;
	
	КоличествоВыполненныхОтложенныхДвиженийДокументов = 0;
	
	// Если ПродолжитьПриОшибке = 1 Тогда
	// 	ИспользоватьТранзакции = 0;
	// КонецЕсли;
	
	// Если КоличествоОбработанныхОбъектовДляОбновленияСтатуса = 0 Тогда
	// 	КоличествоОбработанныхОбъектовДляОбновленияСтатуса = 100;
	// КонецЕсли;
	
	// РезультатПодсчетаДанныхКЗагрузке = ОбменДаннымиСервер.РезультатПодсчетаДанныхКЗагрузке(ИмяФайлаОбмена, Ложь);
	// РазмерФайлаСообщенияОбмена = РезультатПодсчетаДанныхКЗагрузке.РазмерФайлаСообщенияОбмена;
	// КоличествоОбъектовКЗагрузке = РезультатПодсчетаДанныхКЗагрузке.КоличествоОбъектовКЗагрузке;
	
	// ИмяПрофиляБезопасности = ИнициализироватьОбработки();
	
	// Если ИмяПрофиляБезопасности <> Неопределено Тогда
	// 	УстановитьБезопасныйРежим(ИмяПрофиляБезопасности);
	// КонецЕсли;

	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	
	ВрмДокументXML = ВрмПарсерХМЛ.СоздатьДокумент();
	ВрмДокументXML.Кодировка = "UTF-8";
	Попытка
		ВрмДокументXML.Загрузить(ВхИмяФайла);
	Исключение
		ВрмВозврат.Установить("ОписаниеОшибки", Шаблон("Ошибка открытия сообщения обмена: [ВхИмяФайла]"));
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецПопытки;

	ВрмУзелФайлОбмена = ВрмДокументXML.ВыбратьУзел("ФайлОбмена");

	Если ПустоеЗначение(ВрмУзелФайлОбмена) = 1 Тогда
		ВрмВозврат.Установить("ОписаниеОшибки", "Ошибка формата сообщения обмена.");
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	ПолеВерсияФорматаВходящегоСообщенияОбмена = одАтрибут(ВрмУзелФайлОбмена, "Строка", "ВерсияФормата"); //ВрмУзелФайлОбмена.ПолучитьАтрибут("ВерсияФормата");
	
	// ВерсияКонфигурацииИсточника = "";
	// Конвертация.Свойство("ВерсияКонфигурацииИсточника", ВерсияКонфигурацииИсточника);
	// ВерсияИсточникаИзПравил = одАтрибут(ФайлОбмена, ТипСтрока, "ВерсияКонфигурацииИсточника");
	// ТекстСообщения = "";
	
	// Если ОбменДаннымиСервер.РазличаютсяВерсииКорреспондента(ИмяПланаОбмена(), КлючСообщенияЖурналаРегистрации(),
	// 	ВерсияКонфигурацииИсточника, ВерсияИсточникаИзПравил, ТекстСообщения) Тогда
		
	// 	ВызватьИсключение ТекстСообщения;
		
	// КонецЕсли;

	ВрмУзелПравилаОбмена = ВрмУзелФайлОбмена.ВыбратьУзел("ПравилаОбмена");

	Если ПустоеЗначение(ВрмУзелПравилаОбмена) = 1 Тогда
		ВрмВозврат.Установить("ОписаниеОшибки", "Ошибка формата сообщения обмена.");
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	ИначеЕсли мТаблицаПравилКонвертацииОбъектов.КоличествоСтрок() = 0 Тогда
		ЗагрузитьПравилаОбмена(ВрмУзелПравилаОбмена, "ЧтениеXML");
	КонецЕсли;

	Если ФлагОшибки() = 1 Тогда
		ВрмВозврат.Установить("ОписаниеОшибки", "При загрузке правил обмена данными возникли ошибки.");
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	// ЗагрузитьПравилаКонвертации(ВрмУзелПравилаОбмена);

	// Глобальный обработчик "ПередЗагрузкойДанных"
	Если мКонвертацияПередЗагрузкойДанных = 1 Тогда
		Отказ = Шаблон("[Конвертация_ПередЗагрузкойДанных()]");
		Если Число(Отказ) = 1 Тогда
			//ВрмВозврат.Установить("ОписаниеОшибки", "Ошибка формата сообщения обмена.");
			ЗавершитьЗамер(ВрмЗамер);
			Возврат ВрмВозврат;
		КонецЕсли;
	КонецЕсли;
	
	ВрмУзелНастройкаПользовательскогоПоиска = ВрмУзелФайлОбмена.ВыбратьУзел("НастройкаПользовательскогоПоиска");
	// НастройкаПользовательскогоПоиска (необязательный)
	Если ПустоеЗначение(ВрмУзелНастройкаПользовательскогоПоиска) = 0 Тогда
		// ЗагрузитьИнформациюОПользовательскихПоляхПоиска();
	КонецЕсли;
	
	ВрмУзелИнформацияОТипахДанных = ВрмУзелФайлОбмена.ВыбратьУзел("ИнформацияОТипахДанных");
	// ИнформацияОТипахДанных (необязательный)
	Если ПустоеЗначение(ВрмУзелИнформацияОТипахДанных) = 0 Тогда
		// Если СоответствиеТиповДанныхДляЗагрузки().Количество() > 0 Тогда
		// 	одПропустить(ФайлОбмена);
		// Иначе
		// 	ЗагрузитьИнформациюОТипахДанных();
		// 	Если ФлагОшибки() Тогда
		// 		ВызватьИсключение НСтр("ru = 'При загрузке информации о типах данных возникли ошибки.'");
		// 	КонецЕсли;
		// КонецЕсли;
	КонецЕсли;
	
	ВрмУзлыЗначениеПараметра = ВрмУзелФайлОбмена.ВыбратьУзлы("ЗначениеПараметра");
		// ЗначениеПараметра (необязательный) (несколько).
	Если ВрмУзлыЗначениеПараметра.КоличествоУзлов > 0 Тогда
		
		Для ВрмИндексУзелЗначениеПараметра = 0 По ВрмУзлыЗначениеПараметра.КоличествоУзлов - 1 Цикл
			
			// ЗагрузитьЗначенияПараметровОбменаДанными(ВрмУзлыЗначениеПараметра.ПолучитьУзел(ВрмИндексУзелЗначениеПараметра));
			
		КонецЦикла;
		
	КонецЕсли;
	
	ВрмУзелАлгоритмПослеЗагрузкиПараметров = ВрмУзелФайлОбмена.ВыбратьУзел("АлгоритмПослеЗагрузкиПараметров");
	// АлгоритмПослеЗагрузкиПараметров (необязательный)
	Если ПустоеЗначение(ВрмУзелАлгоритмПослеЗагрузкиПараметров) = 0 Тогда
		// ВыполнитьАлгоритмПослеЗагрузкиПараметров(одЗначениеЭлемента(ФайлОбмена, ТипСтрока));
	КонецЕсли;
	
	ВрмУзелДанныеПоОбмену = ВрмУзелФайлОбмена.ВыбратьУзел("ДанныеПоОбмену");
	// ДанныеПоОбмену (обязательный)
	Если ПустоеЗначение(ВрмУзелДанныеПоОбмену) = 1 Тогда
		ВрмВозврат.Установить("ОписаниеОшибки", "Ошибка формата сообщения обмена.");
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;
	
	ВрмВозврат = ПрочитатьДанныеПоОбмену(ВрмУзелДанныеПоОбмену, ВхСписокПараметры);
	Если ПолучитьСтатусВозврата(ВрмВозврат) = 0 Тогда
		ЗавершитьЗамер(ВрмЗамер);
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмНомерСообщения = ВрмВозврат.Получить("НомерСообщения");
	ВрмНомерПринятогоКорреспондентом = ВрмВозврат.Получить("НомерПринятогоКорреспондентом");
	
	// Попытка
	
		// Если ИспользоватьТранзакции = 1 Тогда
		// 	НачатьТранзакцию();
		// КонецЕсли;
		
		ПроизвестиЧтениеДанных(ВрмУзелФайлОбмена);
		
		Если ФлагОшибки() = 1 Тогда
			// ВызватьИсключение НСтр("ru = 'Возникли ошибки при загрузке данных.'");
		КонецЕсли;
		
		// Отложенная запись того, что не записали.
		// ПровестиЗаписьНеЗаписанныхОбъектов();
		
		// ВыполнитьОбработчикПослеЗагрузкиДанных();
		
		Если ФлагОшибки() = 1 Тогда
			// ВызватьИсключение НСтр("ru = 'Возникли ошибки при загрузке данных.'");
		КонецЕсли;
		
		// Если ИспользоватьТранзакции = 1 Тогда
		// 	ЗафиксироватьТранзакцию();
		// КонецЕсли;
	// Исключение
	// 	// Если ИспользоватьТранзакции = 1 Тогда
	// 	// 	ОтменитьТранзакцию();
	// 	// КонецЕсли;
	// 	// ПрерватьЧтениеСообщения(ЧтениеСообщения);
	// 	// ВызватьИсключение;
	// КонецПопытки;
	
	// Выполняем проведение документов в очереди.
	// ВыполнитьОтложенноеПроведениеДокументов();
	// ВыполнитьОтложеннуюЗаписьОбъектов();
	
	// ЗакончитьЧтениеСообщения(ЧтениеСообщения);
	
	ЗакончитьЧтениеСообщения(ВхУзелОбменаИдентификатор, ВрмНомерСообщения, ВрмНомерПринятогоКорреспондентом);
	РС_ЗакончитьЧтениеСообщения(ВрмНомерСообщения, ВрмНомерПринятогоКорреспондентом);

	// Сбрасываем модальные переменные перед помещением обработки в платформенный кэш.
	ПолеДокументыДляОтложенногоПроведения = ПолучитьПустоеЗначение();
	ПолеОбъектыДляОтложеннойЗаписи = ПолучитьПустоеЗначение();
	// СоответствиеДокументовДляОтложенногоПроведения = Неопределено;
	// ПолеСоответствиеТиповДанныхДляЗагрузки = Неопределено;
	// ГлобальныйСтекНеЗаписанныхОбъектов = Неопределено;
	// СоответствиеПравилКонвертации = Неопределено;
	// ОтключитьОбработкуДляОтладки();
	// ФайлОбмена = Неопределено;
	
	ВрмВозврат.Установить("СтатусВозврата", 1);

	ЗавершитьЗамер(ВрмЗамер);
	Возврат ВрмВозврат;

КонецФункции // ВыполнитьЗагрузку()

Функция ВыполнитьЗагрузкуДанных(ВхУзелОбменаИдентификатор, ВхСписокПараметры)

	мИмяФайлаРегистрСоответствия = Шаблон("[мКаталогОбмена][ВхУзелОбменаИдентификатор]\exchange.sqlite3");
	// мИмяФайлаИндексаРегистрСоответствия = Шаблон("[мКаталогОбмена][ВхУзелОбменаИдентификатор]\ref7ref8.cdx");

	ВрмПравилаЗачитанные = ЗначениеИзСтрокиВнутр(ВхСписокПараметры.Получить("ПравилаЗачитанныеКорреспондента"));

	ВосстановитьПравилаИзВнутреннегоФормата(ВрмПравилаЗачитанные);

	// ВрмВозврат = ПолучитьДанные(ВхУзелОбменаИдентификатор, ВхСписокПараметры);
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	ВрмВозврат.Установить("СтатусВозврата", 1);
	ВрмВозврат.Установить("Результат", "z:\base64Decoded2.xml");

	Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмИмяФайла = ВрмВозврат.Получить("Результат");
	// Попытка

		ВрмВозврат = ВыполнитьЗагрузку(ВрмИмяФайла, ВхУзелОбменаИдентификатор, ВхСписокПараметры);
		
	// Исключение
	// 	Если ЧтениеСообщения <> Неопределено
	// 		И ЧтениеСообщения.СообщениеБылоПринятоРанее Тогда
	// 		ЗаписатьВПротоколВыполнения(174,,,,,,
	// 			Перечисления.РезультатыВыполненияОбмена.Предупреждение_СообщениеОбменаБылоРанееПринято);
	// 	Иначе
	// 		ЗаписатьВПротоколВыполнения(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	// 	КонецЕсли;
	// КонецПопытки;
	
	ЗавершитьВедениеПротоколаОбмена();
	
	Возврат ВрмВозврат;

КонецФункции // ВыполнитьЗагрузкуДанных()

////////////////////////////////////////////////////////////////////////////////
// ФУНКЦИИ РАБОТЫ С НАСТРОЙКАМИ ОБМЕНА
////////////////////////////////////////////////////////////////////////////////

Процедура ЗаполнитьСписокМетаданныхПоТипу(ВхТаблицаМетаданные, ВхМета, ВхТип)
	
	ВрмВозврат = СоздатьОбъект("СписокЗначений");
	
	Если ВхТип="Документ" Тогда
		
		ВрмМетаданные = Метаданные.Документ();
		
	ИначеЕсли ВхТип="Справочник" Тогда
		
		ВрмМетаданные = Метаданные.Справочник();
		
	Иначе
		
		Возврат;
		
	КонецЕсли;
	
	Для ВрмИнд = 1 По ВрмМетаданные Цикл
		
		ВрмИД = "";

		Если ВхТип = "Документ" Тогда
			
			ВрмЭлементМД = Метаданные.Документ(ВрмИнд);
			ВрмИД = ВхМета.GetDocID(ВрмЭлементМД.Идентификатор);
		
		ИначеЕсли ВхТип = "Справочник" Тогда
			
			ВрмЭлементМД = Метаданные.Справочник(ВрмИнд);
			ВрмИД = ВхМета.GetRefID(ВрмЭлементМД.Идентификатор);

		Иначе

			Продолжить;
			
		КонецЕсли;
		
		ВхТаблицаМетаданные.НоваяСтрока();
		ВхТаблицаМетаданные.ТекущаяСтрока(ВхТаблицаМетаданные.КоличествоСтрок());

		ВхТаблицаМетаданные.Ид = ВрмИД;
		ВхТаблицаМетаданные.ИдБД = СокрЛП(_idtostr(ВрмИД));
		ВхТаблицаМетаданные.ПолноеИмя = ВхТип + "." + ВрмЭлементМД.Идентификатор;
		ВхТаблицаМетаданные.Тип = ВхТип;
		ВхТаблицаМетаданные.Вид = ВрмЭлементМД.Идентификатор;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьСписокМетаданныхИзМД(ВхТаблицаМетаданные)
	
	ВрмМета = СоздатьОбъект("MetaDataWork");
	
	ЗаполнитьСписокМетаданныхПоТипу(ВхТаблицаМетаданные, ВрмМета, "Справочник");
	ЗаполнитьСписокМетаданныхПоТипу(ВхТаблицаМетаданные, ВрмМета, "Документ");

	мНастройкиОбмена.Установить("СохранитьНастройки", 1);
	
	ВрмМета = 0;
	
КонецПроцедуры

Процедура ИнициализироватьНастрокиОбмена()
	
	мНастройкиОбмена = СоздатьОбъект("СписокЗначений");
	мНастройкиОбмена.ДобавитьЗначение(0, "СохранитьНастройки");
	мНастройкиОбмена.ДобавитьЗначение(0, "НастройкиЗагружены");
	мНастройкиОбмена.ДобавитьЗначение(0, "КаталогОбменаСуществует");
	мНастройкиОбмена.ДобавитьЗначение(СоздатьОбъект("СписокЗначений"), "УзлыОбмена");

	ВрмТаблицаМетаданные = СоздатьОбъект("ТаблицаЗначений");
	ВрмТаблицаМетаданные.НоваяКолонка("Ид", "Число");
	ВрмТаблицаМетаданные.НоваяКолонка("ИдБД", "Строка");
	ВрмТаблицаМетаданные.НоваяКолонка("ПолноеИмя", "Строка");
	ВрмТаблицаМетаданные.НоваяКолонка("Тип", "Строка");
	ВрмТаблицаМетаданные.НоваяКолонка("Вид", "Строка");

	мНастройкиОбмена.ДобавитьЗначение(ВрмТаблицаМетаданные, "Метаданные");
		
КонецПроцедуры

Функция ЗагрузитьНастройкиОбмена()

	ВрмВозврат = 0;

	ВрмИмяФайлаНастройки = мКаталогОбмена + "settings.xml";
	
	ИнициализироватьНастрокиОбмена();
	
	мНастройкиОбмена.Установить("КаталогОбменаСуществует", ФС.СуществуетФайл(мКаталогОбмена));
	
	Если ФС.СуществуетФайл(ВрмИмяФайлаНастройки) = 0 Тогда

		Возврат 1;
		
	КонецЕсли;
	
	ВрмСписокУзловОбмена = СоздатьОбъект("СписокЗначений");
	
	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	
	ВрмДокументXML = ВрмПарсерХМЛ.СоздатьДокумент();
	ВрмДокументXML.Кодировка = "UTF-8";
	ВрмДокументXML.Загрузить(ВрмИмяФайлаНастройки);
	
	ВрмУзлыОбъекты = ВрмДокументXML.ВыбратьУзлы("//exchanges/object");
	
	Для ВрмИндексУзелОбъект = 0 По ВрмУзлыОбъекты.КоличествоУзлов - 1 Цикл
		
		ВрмУзелОбъект = ВрмУзлыОбъекты.ПолучитьУзел(ВрмИндексУзелОбъект);
		//Сообщить(ВрмУзелОбъект.ПредставлениеXML);
		ВрмУзелОбменаИдентификатор = ВрмУзелОбъект.ПолучитьАтрибут("id");
		
		ВрмСписокПараметры = СоздатьОбъект("СписокЗначений");

		ВрмУзлыПараметры = ВрмУзелОбъект.ВыбратьУзлы(".//param");
		Для ВрмИндексУзелПараметр = 0 По ВрмУзлыПараметры.КоличествоУзлов - 1 Цикл
		
			ВрмУзелПараметр = ВрмУзлыПараметры.ПолучитьУзел(ВрмИндексУзелПараметр);
			ВрмПараметрИмя = ВрмУзелПараметр.ПолучитьАтрибут("name");
			//ВрмПараметрЗначение = ВрмУзелПараметр.ПолучитьАтрибут("value");
			ВрмПараметрЗначение = ВрмУзелПараметр.Значение;
			Если Найти(ВрмПараметрИмя, "ПравилаЗачитанные") > 0 Тогда
				ВрмПараметрЗначение = StrBase64ToStr(ВрмПараметрЗначение);
			КонецЕсли;
			ВрмСписокПараметры.ДобавитьЗначение(ВрмПараметрЗначение, ВрмПараметрИмя);
			//Сообщить("[" + ВрмУзелОбменаИдентификатор + "][" + ВрмПараметрИмя + "][" + ВрмПараметрЗначение + "]");
			ВрмУзелПараметр = 0;

		КонецЦикла;
		
		ВрмСписокУзловОбмена.ДобавитьЗначение(ВрмСписокПараметры, ВрмУзелОбменаИдентификатор);
		
		ВрмУзелОбъект = 0;
		ВрмУзлыПараметры = 0;

	КонецЦикла;
	
	Если ВрмСписокУзловОбмена.РазмерСписка() = 0 Тогда
		ЗаполнитьСписокУзловИзБД(ВрмСписокУзловОбмена);
	КонецЕсли;

	мНастройкиОбмена.Установить("УзлыОбмена", ВрмСписокУзловОбмена);

	ВрмУзлыОбъекты = 0;

	//ВрмСписокМетаданных = СоздатьОбъект("СписокЗначений");
	ВрмТаблицаМетаданные = мНастройкиОбмена.Получить("Метаданные");
	ВрмУзлыЭлементы = ВрмДокументXML.ВыбратьУзлы("//metadata/object");
		
	Для ВрмИнд = 0 По ВрмУзлыЭлементы.КоличествоУзлов - 1 Цикл	
		
		ВрмУзелЭлемент	= ВрмУзлыЭлементы.ПолучитьУзел(ВрмИнд);
		// ВрмПредставление = ВрмУзелЭлемент.ПолучитьАтрибут("name");
		// ВрмИд = Число(ВрмУзелЭлемент.ПолучитьАтрибут("id"));
		
		ВрмТаблицаМетаданные.НоваяСтрока();
		ВрмТаблицаМетаданные.ТекущаяСтрока(ВрмТаблицаМетаданные.КоличествоСтрок());

		ВрмТаблицаМетаданные.Ид = Число(ВрмУзелЭлемент.ПолучитьАтрибут("id"));
		ВрмТаблицаМетаданные.ИдБД = ВрмУзелЭлемент.ПолучитьАтрибут("id_db");
		ВрмТаблицаМетаданные.ПолноеИмя = ВрмУзелЭлемент.ПолучитьАтрибут("name");
		ВрмТаблицаМетаданные.Тип = ВрмУзелЭлемент.ПолучитьАтрибут("type");
		ВрмТаблицаМетаданные.Вид = ВрмУзелЭлемент.ПолучитьАтрибут("kind");
		
		ВрмУзелЭлемент = 0;

	КонецЦикла;

	Если ВрмТаблицаМетаданные.КоличествоСтрок() = 0 Тогда
		ЗаполнитьСписокМетаданныхИзМД(ВрмТаблицаМетаданные);
	КонецЕсли;
	
	мНастройкиОбмена.Установить("Метаданные", ВрмТаблицаМетаданные);
	мНастройкиОбмена.Установить("НастройкиЗагружены", 1);

	ВрмУзлыЭлементы = 0;

	ВрмДокументXML = 0;
	ВрмПарсерХМЛ = 0;
	
	Возврат 1;

КонецФункции

Функция СохранитьНастройкиОбмена(ВхНастройкиОбмена)
	
	ВрмВозврат = 0;

	Если ПустоеЗначение(ВхНастройкиОбмена) = 1 Тогда
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмИмяФайлаНастройки = мКаталогОбмена + "settings.xml";

	Если Число(ВхНастройкиОбмена.Получить("КаталогОбменаСуществует")) = 0 Тогда
		ФС.СоздатьКаталог(мКаталогОбмена);
	КонецЕсли;

	Если Число(ВхНастройкиОбмена.Получить("СохранитьНастройки")) = 1 Тогда

	ИначеЕсли Число(ВхНастройкиОбмена.Получить("НастройкиЗагружены")) = 0 Тогда
		
	Иначе
		Возврат ВрмВозврат;
	КонецЕсли;

	ВрмПарсерХМЛ = ПолучитьCOMОбъект("AddIn.XMLParser");
	
	ВрмДокументXML = ВрмПарсерХМЛ.СоздатьДокумент();
	ВрмДокументXML.Кодировка = "UTF-8";
	
	ВрмУзелНастройки = ЗаписатьЭлемент(ВрмДокументXML, ВрмДокументXML, "settings");

	//Узлы обмена
	ВрмУзелОбъекты = ЗаписатьЭлемент(ВрмДокументXML, ВрмУзелНастройки, "exchanges");

	ВрмСписокУзловОбмена = ВхНастройкиОбмена.Получить("УзлыОбмена");
	
	Для ВрмИндексСпискаПараметров = 1 По ВрмСписокУзловОбмена.РазмерСписка() Цикл

		ВрмУзелОбменаИдентификатор = "";
		ВрмСписокПараметры = ВрмСписокУзловОбмена.ПолучитьЗначение(ВрмИндексСпискаПараметров, ВрмУзелОбменаИдентификатор);
		
		ВрмУзелОбъект = ЗаписатьЭлемент(ВрмДокументXML, ВрмУзелОбъекты, "object");
		УстановитьАтрибут(ВрмУзелОбъект, "id", ВрмУзелОбменаИдентификатор);

		Для ВрмИндексПараметр = 1 По ВрмСписокПараметры.РазмерСписка() Цикл
			
			ВрмУзелПараметр = ЗаписатьЭлемент(ВрмДокументXML, ВрмУзелОбъект, "param");

			ВрмПараметрИмя = "";
			ВрмПараметрЗначение = ВрмСписокПараметры.ПолучитьЗначение(ВрмИндексПараметр, ВрмПараметрИмя);
			
			УстановитьАтрибут(ВрмУзелПараметр, "name", ВрмПараметрИмя);
			
			Если Найти(ВрмПараметрИмя, "ПравилаЗачитанные") > 0 Тогда
				ВрмПараметрЗначение = StrToStrBase64(ВрмПараметрЗначение);
			КонецЕсли;
			
			//УстановитьАтрибут(ВрмУзелПараметр, "value", ВрмПараметрЗначение);
			ВрмУзелПараметр.Значение = ВрмПараметрЗначение;

			ВрмУзелПараметр = 0;

		КонецЦикла;

		ВрмУзелОбъект = 0;
		
	КонецЦикла;

	ВрмУзелОбъекты = 0;

	//Метаданные
	ВрмУзелМетаданные = ЗаписатьЭлемент(ВрмДокументXML, ВрмУзелНастройки, "metadata");
	
	ВрмТаблицаМетаданные = ВхНастройкиОбмена.Получить("Метаданные");
	
	Для ВрмИндексМетаданные = 1 По ВрмТаблицаМетаданные.КоличествоСтрок() Цикл
		
		ВрмУзелЭлемент = ЗаписатьЭлемент(ВрмДокументXML, ВрмУзелМетаданные, "object");
		УстановитьАтрибут(ВрмУзелЭлемент, "id", ВрмТаблицаМетаданные.ПолучитьЗначение(ВрмИндексМетаданные, "Ид"));
		УстановитьАтрибут(ВрмУзелЭлемент, "id_db", ВрмТаблицаМетаданные.ПолучитьЗначение(ВрмИндексМетаданные, "ИдБД"));
		УстановитьАтрибут(ВрмУзелЭлемент, "name", ВрмТаблицаМетаданные.ПолучитьЗначение(ВрмИндексМетаданные, "ПолноеИмя"));
		УстановитьАтрибут(ВрмУзелЭлемент, "type", ВрмТаблицаМетаданные.ПолучитьЗначение(ВрмИндексМетаданные, "Тип"));
		УстановитьАтрибут(ВрмУзелЭлемент, "kind", ВрмТаблицаМетаданные.ПолучитьЗначение(ВрмИндексМетаданные, "Вид"));

		ВрмУзелЭлемент = 0;
		
	КонецЦикла;

	ВрмУзелМетаданные = 0;

	Попытка
		ВрмДокументXML.Записать(ВрмИмяФайлаНастройки);
		ВрмВозврат = 1;
	Исключение

	КонецПопытки;

	ВрмУзлыОбъекты = 0;
	ВрмДокументXML = 0;
	ВрмПарсерХМЛ = 0;
	
	Возврат ВрмВозврат;
		
КонецФункции

Функция ТестСоединения(ВхURLВебСервиса, ВхСписокПараметры)

	// http://192.168.132.1:2000/local_file_buch_demo
	// ВрмВозврат = СоздатьОбъект("СписокЗначений");
	// ВрмВозврат.Установить("СтатусВозврата", 0);

	ВрмНомерВерсияСервиса = "2.0.1.6";

	ВрмПараметры = СоздатьОбъект("СписокЗначений");
	ВрмПараметры.Установить("InterfaceName", "ОбменДанными");

	ВрмТелоЗапроса = ПолучитьТекстЗапрооса("GetVersions", "http://www.1c.ru/SaaS/1.0/WS", ВрмПараметры);
	ВрмВозврат = ЗапросSOAP(ВхURLВебСервиса, "InterfaceVersion", ВрмТелоЗапроса);

	Если Число(ВрмВозврат.Получить("СтатусВозврата")) = 0 Тогда
		Возврат ВрмВозврат;
	КонецЕсли;
	
	ВрмВерсииСервиса = ПолучитьВерсииСервиса(ВрмВозврат.Получить("Результат"));

	ВрмНайденаТребуемаяВерсия = 0;

	Для ВрмИндексВерсииСервиса = 1 По ВрмВерсииСервиса.РазмерСписка() Цикл

		Если ВрмВерсииСервиса.ПолучитьЗначение(ВрмИндексВерсииСервиса) = ВрмНомерВерсияСервиса Тогда
			ВрмНайденаТребуемаяВерсия = 1;
			Прервать;
		КонецЕсли;

	КонецЦикла;

	Если ВрмНайденаТребуемаяВерсия = 0 Тогда
		ВрмВозврат.Установить("СтатусВозврата", 0);
		ВрмВозврат.Установить("ОписаниеОшибки", "Требуется версия сервиса " + ВрмНомерВерсияСервиса);
	КонецЕсли;
	
	ВхСписокПараметры.Установить("soap_uri", ВхURLВебСервиса);
	ВхСписокПараметры.Установить("soap_ver", ВрмНомерВерсияСервиса);

	Возврат ВрмВозврат;

КонецФункции

//*****************************************************************************

Функция ИнициализироватьКомпонент(ВхКомпонента)
	
	ВрмВозврат = 0;

	Компоненты = СоздатьОбъект("ТаблицаЗначений");
	Компоненты.НоваяКолонка("Путь");
	Компоненты.НоваяКолонка("МожноЗагружать");
	
	Компоненты.НоваяСтрока();
	Компоненты.Путь				= КаталогПрограммы() + ВхКомпонента;
	Компоненты.МожноЗагружать	= 0;
	Компоненты.НоваяСтрока();
	Компоненты.Путь				= КаталогИБ() + ВхКомпонента;
	Компоненты.МожноЗагружать	= 0;
	Компоненты.НоваяСтрока();
	Компоненты.Путь				= КаталогИБ() + "ExtForms\" + ВхКомпонента;
	Компоненты.МожноЗагружать	= 0;

	Компоненты.ВыбратьСтроки();
	Пока Компоненты.ПолучитьСтроку() = 1 Цикл
		Компоненты.МожноЗагружать = ФС.СуществуетФайл(Компоненты.Путь);
	КонецЦикла;
	
	Если Компоненты.Итог("МожноЗагружать") = 0 Тогда
		ТекстОшибки = "Компонента " + ВхКомпонента + " не найдена!";
		
		Если Форма.МодальныйРежим() = 0 Тогда
			Предупреждение(ТекстОшибки, 60);
		Иначе
			Сообщить(ТекстОшибки);
			
			// Если ПустаяСтрока(ИмяКоманды) = 0 Тогда
			// 	ЗафиксироватьОшибку(ТекстОшибки);
			// 	Форма.Параметр = СписокОшибок;
			// 	СтатусВозврата(0);
			// 	Возврат ВрмВозврат;
			// КонецЕсли;
			
		КонецЕсли;
		
		Возврат ВрмВозврат;
	КонецЕсли;
	
	//КомпонентаУспешноЗагружена = 0;
	Компоненты.ВыбратьСтроки();
	Пока Компоненты.ПолучитьСтроку() = 1 Цикл
		Если Компоненты.МожноЗагружать = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		ВрмВозврат = ЗагрузитьВнешнююКомпоненту(Компоненты.Путь);
		
		Если ВрмВозврат = 1 Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если ВрмВозврат = 0 Тогда
		ТекстОшибки = "Компонента " + ВхКомпонента + " не найдена!";
		
		Если Форма.МодальныйРежим() = 0 Тогда
			Предупреждение(ТекстОшибки, 60);
		Иначе
			Сообщить(ТекстОшибки);
			
			// Если ПустаяСтрока(ИмяКоманды) = 0 Тогда
			// 	ЗафиксироватьОшибку(ТекстОшибки);
			// 	Форма.Параметр = СписокОшибок;
			// 	СтатусВозврата(0);
			// 	Возврат;
			// КонецЕсли;
			
		КонецЕсли;
		
		Возврат ВрмВозврат;
	КонецЕсли;

	// СписокВозможныхМест	=	СоздатьОбъект("СписокЗначений");
	// СписокВозможныхМест.ДобавитьЗначение(КаталогИБ()		+	ВхКомпонента);
	// СписокВозможныхМест.ДобавитьЗначение(КаталогПрограммы()	+	ВхКомпонента);
	// СписокВозможныхМест.ДобавитьЗначение(КаталогИБ()		+	"ExtForms\"	+ ВхКомпонента);
	
	// ВрмПутьОбъекта = НайтиПервыйСуществующийФайл(СписокВозможныхМест);
	
	// Если ЗагрузитьВнешнююКомпоненту(ВрмПутьОбъекта) <> 1	Тогда
	// 	Предупреждение("Компонента " + ВхКомпонента + " не найдена!");
	// 	Возврат 0;
	// КонецЕсли; 
	
	Возврат ВрмВозврат;
	
КонецФункции

Функция ИнициализироватьКомпоненты()
	
	ВрмВозврат = ИнициализироватьКомпонент("v7plus.dll");
	Если ВрмВозврат = 1 Тогда
		ВрмВозврат = ИнициализироватьКомпонент("1cpp.dll");
	КонецЕсли;
	Если ВрмВозврат = 1 Тогда
		ВрмВозврат = ИнициализироватьКомпонент("1sqlite.dll");
	КонецЕсли;

	Возврат ВрмВозврат;

КонецФункции

Функция УстановитьПеременную(ВхПеременная, ВхЗначение)

	ВхПеременная = ВхЗначение;

КонецФункции

Процедура ИнициализироватьГлобальныеПеременные(ВхГлобальныеПеременные)

	Если ТипЗначенияСтр(ВхГлобальныеПеременные) <> "СписокЗначений" Тогда
		Возврат;
	КонецЕсли;

	Для ВрмИндекс = 1 По ВхГлобальныеПеременные.РазмерСписка() Цикл
		ВрмПредставление = "";
		ВрмЗначение = ВхГлобальныеПеременные.ПолучитьЗначение(ВрмИндекс, ВрмПредставление);
		Шаблон("[УстановитьПеременную(" + ВрмПредставление + ",  ВрмЗначение)]");
	КонецЦикла;

КонецПроцедуры

Процедура ПриОткрытии()

	СтатусВозврата(0);

	Если ПустоеЗначение(Форма.Параметр) = 1 Тогда           
		Сообщить("Служебная обработка. Не для интерактивного режима.");
		Возврат;
	ИначеЕсли ТипЗначенияСтр(Форма.Параметр) <> "СписокЗначений" Тогда
		Сообщить("Не корректно передан параметр.");
		Возврат;
	КонецЕсли;
	
	ВрмСтатусВозврата = 0;

	ВрмФормаПараметры = Форма.Параметр;

	ВрмКоманда = ВрмФормаПараметры.Получить("Команда");
	ВрмГлобальныеПеременные = ВрмФормаПараметры.Получить("ГлобальныеПеременные");
	ВрмПараметрыКоманды = ВрмФормаПараметры.Получить("ПараметрыКоманды");

	ИнициализироватьГлобальныеПеременные(ВрмГлобальныеПеременные);
	ИнициализироватьКомпоненты();

	Если ВрмКоманда = "ЗагрузитьНастройкиОбмена" Тогда
		ВрмСтатусВозврата = ЗагрузитьНастройкиОбмена();
		ВрмФормаПараметры.Установить("НастройкиОбмена", мНастройкиОбмена);
	ИначеЕсли ВрмКоманда = "СохранитьНастройкиОбмена" Тогда
		ВрмСтатусВозврата = СохранитьНастройкиОбмена(ВрмПараметрыКоманды.Получить("НастройкиОбмена"));
	ИначеЕсли ВрмКоманда = "АктивироватьУзелОбмена" Тогда
		ВрмСписокПараметры = ВрмПараметрыКоманды.Получить("СписокПараметры");
		ВрмСтатусВозврата = АктивироватьУзелОбмена(ВрмПараметрыКоманды.Получить("УзелОбменаИдентификатор"), ВрмСписокПараметры);
		ВрмФормаПараметры.Установить("СписокПараметры", ВрмСписокПараметры);
	ИначеЕсли ВрмКоманда = "ПолучитьСтруктуруПравилОбмена" Тогда
		ВрмВозврат = ПолучитьСтруктуруПравилОбмена(ВрмПараметрыКоманды.Получить("Источник"));
		ЗаполнитьЗначенияСвойств(ВрмФормаПараметры, ВрмВозврат);
		Возврат;
	ИначеЕсли ВрмКоманда = "ВыполнитьВыгрузкуДанных" Тогда
		ВрмСписокПараметры = ВрмПараметрыКоманды.Получить("СписокПараметры");
		// мНастройкиОбмена = ВрмПараметрыКоманды.Получить("НастройкиОбмена");
		ВрмРезультат = ВыполнитьВыгрузкуДанных(ВрмПараметрыКоманды.Получить("УзелОбменаИдентификатор"), ВрмСписокПараметры);
		ЗаполнитьЗначенияСвойств(ВрмФормаПараметры, ВрмРезультат, "Результат");
		Возврат;
		// ВрмФормаПараметры.Установить("СписокПараметры", ВрмСписокПараметры);
	ИначеЕсли ВрмКоманда = "ВыполнитьЗагрузкуДанных" Тогда
		ВрмСписокПараметры = ВрмПараметрыКоманды.Получить("СписокПараметры");
		// мНастройкиОбмена = ВрмПараметрыКоманды.Получить("НастройкиОбмена");
		ВрмРезультат = ВыполнитьЗагрузкуДанных(ВрмПараметрыКоманды.Получить("УзелОбменаИдентификатор"), ВрмСписокПараметры);
		ЗаполнитьЗначенияСвойств(ВрмФормаПараметры, ВрмРезультат, "Результат");
		Возврат;
	ИначеЕсли ВрмКоманда = "ТестСоединения" Тогда
		ВрмСписокПараметры = ВрмПараметрыКоманды.Получить("СписокПараметры");
		ВрмРезультат = ТестСоединения(ВрмПараметрыКоманды.Получить("URLВебСервиса"), ВрмСписокПараметры);
		ВрмСтатусВозврата = ВрмРезультат.Получить("СтатусВозврата");
		ВрмФормаПараметры.Установить("ОписаниеОшибки", ВрмРезультат.Получить("ОписаниеОшибки"));
	Иначе
		ВрмФормаПараметры.Установить("ОписаниеОшибки", "Команда [" + ВрмКоманда + "] отсутствет.");
	КонецЕсли;

	ВрмФормаПараметры.Установить("СтатусВозврата", ВрмСтатусВозврата);

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ
////////////////////////////////////////////////////////////////////////////////

мКаталогОбмена = КаталогИБ() + "Exchange\";

мКомментироватьВыгрузкуОбъектов = 1;
ВыводВПротоколИнформационныхСообщений = 1;
мВыводСообщений = 0;

мНачалоНовогоЭлемента = 1;
мИнструкцияОбработки = 2;
мКонецУровня = 3;
мКонецДокумента = 4;

// мКонвертацияПередВыгрузкойДанных = 0;
мКонвертацияПередВыгрузкойОбъекта = 0;
мКонвертацияПередКонвертациейОбъекта = 0;
мКонвертацияПередОтправкойИнформацииОбУдалении = 0;
мКонвертацияПослеВыгрузкиОбъекта = 0;
мКонвертацияПослеВыгрузкиДанных = 0;

мПустоеЗначение = ПолучитьПустоеЗначение();          
мXMLПравила = "";
                            
ТаблицаПараметровДляЗагрузки = СоздатьОбъект("ТаблицаЗначений");
ТаблицаПараметровДляЗагрузки.НоваяКолонка("Имя");        
ТаблицаПараметровДляЗагрузки.НоваяКолонка("Наименование");           

СписокОшибок = СоздатьОбъект("СписокЗначений");

мСообщенияОбОшибках			= СоздатьОбъект("СписокЗначений");

ВрмСтруктураОшибки = СоздатьОбъект("СписокЗначений");
ВрмСтруктураОшибки.ИзСтрокиСРазделителями("ИмяПКО,ИмяПОД,Нпп,ГНпп,Источник,ТипОбъекта,Свойство,Значение,ТипЗначения,ПКО,ПКС,ПКГС,ПВД,ПОД,Объект,СвойствоПриемника,КонвертируемоеЗначение,Обработчик,ОписаниеОшибки,ПозицияМодуля,Текст,КСообщенияОбОшибках,УзелПланаОбмена");
мСтруктураОшибки = СоздатьОбъект("СписокЗначений");
Для ВрмИндексОшибки = 1 По ВрмСтруктураОшибки.РазмерСписка() Цикл
	ВрмПредставление = ВрмСтруктураОшибки.ПолучитьЗначение(ВрмИндексОшибки);
	мСтруктураОшибки.Установить(ВрмПредставление, ПолучитьПустоеЗначение());
КонецЦикла;

ИнициализацияРеквизитовИМодульныхПеременных();

ИнициализацияТаблицыПравилКонвертации();
ИнициализацияТаблицыПравилВыгрузки();
ИнициализацияТаблицыПравилОчистки();
ИнициализацияТаблицыНастройкиПараметров();
ИнициализацияТаблицыЗамеров();

мСписокВыгружаемыхОбъектов = ЗначениеИзСтрокиВнутр("{""VL"",{}}");